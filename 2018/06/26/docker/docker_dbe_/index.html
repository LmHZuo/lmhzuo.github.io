<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#33363b">
    <meta name="msapplication-TileColor" content="#33363b">
    
    
    
    <meta name="keywords" content="Life, ARIA, Hexo">
    
    
    <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png">
    
    
    <link rel="icon" type="image/png" sizes="192x192" href="/favicons/android-chrome-192x192.png">
    
    
    <link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png">
    
    
    <link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png">
    
    
    <link rel="mask-icon" href="/favicons/safari-pinned-tab.svg" color="#33363b">
    
    
    <link rel="manifest" href="/favicons/site.webmanifest">
    
    
    <meta name="msapplication-config" content="/favicons/browserconfig.xml">
    
    
    <link rel="alternate" href="/atom.xml" title="程序猿的日常" type="application/atom+xml" />
    
    
    <link rel="shortcut icon" type="image/x-icon" href="/favicons/favicon.ico">
    
    
    <link rel="stylesheet" type="text/css" href="/css/normalize.css">
    <link rel="stylesheet" type="text/css" href="/css/index.css">
    
    <link rel="stylesheet" type="text/css" href="/css/sidebar.css">
    
    
<link rel="stylesheet" type="text/css" href="/css/page.css">
<link rel="stylesheet" type="text/css" href="/css/post.css">

    <link rel="stylesheet" type="text/css" href="/css/custom.css">
    <link rel="stylesheet" type="text/css" href="/css/atom-one-dark.css">
    <link rel="stylesheet" type="text/css" href="/css/lightgallery.min.css">
    <script type="text/javascript" src="/js/jquery.min.js"></script>
    <script defer type="text/javascript" src="/js/util.js"></script>
    <script defer type="text/javascript" src="/js/scrollspy.js"></script>
    <script defer type="text/javascript" src="/js/fontawesome-all.min.js"></script>
    <script defer type="text/javascript" src="/js/lightgallery.min.js"></script>
    <script defer type="text/javascript" src="/js/lg-fullscreen.min.js"></script>
    <script defer type="text/javascript" src="/js/lg-hash.min.js"></script>
    <script defer type="text/javascript" src="/js/lg-pager.min.js"></script>
    <script defer type="text/javascript" src="/js/lg-thumbnail.min.js"></script>
    <script defer type="text/javascript" src="/js/lg-zoom.min.js"></script>
    
    <script defer src="/js/busuanzi.pure.mini.js"></script>
    
    
    <script defer type="text/javascript" src="/js/search.js"></script>
    <script type="text/javascript">
    $(document).ready(function () {
      var searchPath = "search.xml";
      if (searchPath.length === 0) {
        searchPath = "search.xml";
      }
      var path = "/" + searchPath;
      searchFunc(path, "search-input", "search-result");
    });
    </script>
    
    
    <script defer type="text/javascript" src="/js/index.js"></script>
    
    <script defer type="text/javascript" src="/js/custom.js"></script>
    <title>docker  一台虚拟机安装部署分布式web 前后端分离集群 | 程序猿的日常</title>
  </head>
  <body itemscope itemtype="http://schema.org/WebPage" lang="default"  data-spy="scroll" data-target=".list-group">
    
<header id="header" class="header" style="background: #33363b;">
  <div class="container">
    <div class="header-container">
      <div class="header-title">
        <h1 class="title"><a href="/">程序猿的日常</a></h1>
        <h2 class="subtitle"></h2>
      </div>
      <div class="logo">
        <img src="/images/ARIA_logo.png" alt="logo">
      </div>
    </div>
    
<nav id="nav" class="nav">
  <a id="nav-toggle" class="nav-toggle"><i class="fas fa-bars"></i></a>
  <ul id="menu">
    
    <li><a href="/">首页</a></li>
    
    <li><a href="/archives/">归档</a></li>
    
  </ul>
</nav>


  </div>
</header>


    <main id="main" class="main">
      <div class="container">
        <div class="main-container">
          <div class="content">
            
<div id="post" class="post">
  
  <article class="post-container card" itemscope itemtype="http://schema.org/Article">
    <div class="post-block">
      <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/26/docker/docker_dbe_/">
      <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
       <meta itemprop="name" content="龙门小左">
       <meta itemprop="description" content="">
       <meta itemprop="image" content="/images/avatar.png">
      </span>
      <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
       <meta itemprop="name" content="程序猿的日常">
      </span>
    </div>
    <header class="post-header">
      <h1 class="post-title" itemprop="name headline">docker  一台虚拟机安装部署分布式web 前后端分离集群</h1>
      <div class="post-meta">
        
        <span class="post-date">
          <i class="far fa-calendar-plus"></i><span><time title="post-date" itemprop="dateCreated datePublished" datetime="2018-06-26T10:00:00+08:00">2018-06-26 10:00:00</time></span>
        </span>
        
        
        
      </div>
    </header>
    <main class="post-main" itemprop="articleBody">
      <h1 id="docker-安装部署分布式web-前后端分离集群"><a href="#docker-安装部署分布式web-前后端分离集群" class="headerlink" title="docker  安装部署分布式web 前后端分离集群"></a>docker  安装部署分布式web 前后端分离集群</h1><table>
<thead>
<tr>
<th style="text-align:center">版本</th>
<th style="text-align:center">作者</th>
<th style="text-align:center">内容</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">2018.06.29</td>
<td style="text-align:center">huangzuo</td>
<td style="text-align:center">首次发布</td>
</tr>
</tbody>
</table>
<h3 id="学习内容简介"><a href="#学习内容简介" class="headerlink" title="学习内容简介"></a>学习内容简介</h3><p>   相关课程指令脚本可以在百度云下载<br><a href="https://pan.baidu.com/s/15aVny_MRi0AQBQJE7myUOg" target="_blank" rel="noopener">https://pan.baidu.com/s/15aVny_MRi0AQBQJE7myUOg</a> 密码：j413</p>
<pre><code>本章节主要大概介绍如何使用docker虚拟机，部署分布式web 前后端分离集群，包过
1、人人网开源前后端分离项目
2、配置docker加载器
3、安装mysql pxc集群
4、安装redis 集群
5、部署后端的项目
6、安装ngxin 集群
7、前端项目部署与负载均衡
8、多台虚拟机安装docker sware 集群
9、界面安装
</code></pre><h3 id="人人网开源前后端分离项目"><a href="#人人网开源前后端分离项目" class="headerlink" title="人人网开源前后端分离项目"></a>人人网开源前后端分离项目</h3><p>地址: <a href="http://www.renren.io/,项目renren-fast" target="_blank" rel="noopener">http://www.renren.io/,项目renren-fast</a> </p>
<p>功能:<br><img src="images/renren.jpg" alt=""></p>
<h3 id="配置docker加载器"><a href="#配置docker加载器" class="headerlink" title="配置docker加载器"></a>配置docker加载器</h3><p>由于docker仓库在国外，需要配置国内远程镜像加速下载速度<br>访问地址:<a href="https://www.daocloud.io/" target="_blank" rel="noopener">https://www.daocloud.io/</a> 注册账号<br>执行对应的语句<br><img src="images/docker1.jpg" alt=""></p>
<h3 id="几个重要的docker指令"><a href="#几个重要的docker指令" class="headerlink" title="几个重要的docker指令"></a>几个重要的docker指令</h3><h4 id="查看容器运行日志"><a href="#查看容器运行日志" class="headerlink" title="查看容器运行日志"></a>查看容器运行日志</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker logs -f -t --tail 10 h1</span><br><span class="line"></span><br><span class="line">docker logs h1</span><br></pre></td></tr></table></figure>
<p>h1:容器名称</p>
<p>10:最近10行</p>
<h4 id="进入容器"><a href="#进入容器" class="headerlink" title="进入容器"></a>进入容器</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it h1 bash</span><br></pre></td></tr></table></figure>
<h3 id="mysql-pxc集群安装"><a href="#mysql-pxc集群安装" class="headerlink" title="mysql pxc集群安装"></a>mysql pxc集群安装</h3><h4 id="下载pxc"><a href="#下载pxc" class="headerlink" title="下载pxc"></a>下载pxc</h4><p>访问网站<a href="https://hub.docker.com/r/percona/percona-xtradb-cluster/" target="_blank" rel="noopener">https://hub.docker.com/r/percona/percona-xtradb-cluster/</a> 里面有关percona/percona-xtradb-cluster集群安装相关描述<br>xshell 执行下面代码，下载镜像<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull percona/percona-xtradb-cluster</span><br></pre></td></tr></table></figure></p>
<p>修改容器名称，删除原来的容器</p>
<p>修改<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker tag docker.io/percona-xtradb-cluster pxc</span><br></pre></td></tr></table></figure></p>
<p>删除<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rm docker.io/percona-xtradb-cluster</span><br></pre></td></tr></table></figure></p>
<h4 id="安装mysql集群"><a href="#安装mysql集群" class="headerlink" title="安装mysql集群"></a>安装mysql集群</h4><p>在一台服务器安装5个pxc容器，即5台数据库，修改其中一台数据库的信息，其他四台也会同步修改</p>
<h5 id="设置网段"><a href="#设置网段" class="headerlink" title="设置网段"></a>设置网段</h5><p>处于安全考虑，需要给PXC集群实例创建docker内部网络<br>创建<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network create net1</span><br></pre></td></tr></table></figure></p>
<p>查看<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network inspect net1</span><br></pre></td></tr></table></figure></p>
<p>删除<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network rm net1</span><br></pre></td></tr></table></figure></p>
<p>默认的网段是172.17.0.0 ，可以设置自己的网段<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network create --subnet=172.18.0.0/24 net1</span><br></pre></td></tr></table></figure></p>
<h5 id="创建docker卷"><a href="#创建docker卷" class="headerlink" title="创建docker卷"></a>创建docker卷</h5><p>容器是一个独立的空间，可编辑、删除等操作，为了保存容器的数据，需要把数据的路径映射到宿主机目录下。即把容器中的数据保存在宿主机中，就算容器被删数据还是保留下来</p>
<p>创建docker卷语句<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker volume create v1</span><br></pre></td></tr></table></figure></p>
<p>查看docker卷，可知道在宿主机的目录<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker volume inspect v1</span><br></pre></td></tr></table></figure></p>
<p><img src="images/docker2.jpg" alt=""><br>删除docker卷<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker volume rm v1</span><br></pre></td></tr></table></figure></p>
<h5 id="创建pxc容器集群"><a href="#创建pxc容器集群" class="headerlink" title="创建pxc容器集群"></a>创建pxc容器集群</h5><p>创建pxc容器集群：第一个pxc容器和其他容器不一样</p>
<h6 id="创建第一个pxc容器"><a href="#创建第一个pxc容器" class="headerlink" title="创建第一个pxc容器"></a>创建第一个pxc容器</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 3307:3306 -e MYSQL_ROOT_PASSWORD=root -e CLUSTER_NAME=PXC -e XTRABACKUP_PASSWORD=root -v v1:/var/lib/mysql -v backup:/data --privileged --name=node1 --net=net1 --ip 172.18.0.2 pxc</span><br></pre></td></tr></table></figure>
<p>3307:3306:3307是宿主机端口，3306为容器mysql端口，为了在外面能访问到容器mysql，需要把端口映射到宿主机上</p>
<p>1、MYSQL_ROOT_PASSWORD=root：设置mysql 的root账户密码</p>
<p>2、CLUSTER_NAME=PXC:集群名称</p>
<p>3、XTRABACKUP_PASSWORD=root:mysql 之间通讯的密码</p>
<p>4、-v v1:/var/lib/mysql -v backup:/data :v1是docker卷,映射宿主机docker卷和容器的目录，每一个容器一个docker卷</p>
<p>5、–privileged:赋予容器修改宿主机目录文件的权限</p>
<p>6、–name=node1:容器名称</p>
<p>7、–net=net1 –ip 172.18.0.2:网络ip地址</p>
<p>8、pxc:镜像名称</p>
<h6 id="创建其他pxc容器"><a href="#创建其他pxc容器" class="headerlink" title="创建其他pxc容器"></a>创建其他pxc容器</h6><p>创建其他容器和第一个容器有所不同，主要添加CLUSTER_JOIN=node1 ，意思是和node1（第一个容器）容器同步数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 3308:3306 -e MYSQL_ROOT_PASSWORD=root -e CLUSTER_NAME=PXC -e XTRABACKUP_PASSWORD=root  -e  CLUSTER_JOIN=node1 -v v2:/var/lib/mysql -v backup:/data --privileged --name=node2 --net=net1 --ip 172.18.0.3 pxc</span><br><span class="line"></span><br><span class="line">docker run -d -p 3309:3306 -e MYSQL_ROOT_PASSWORD=root -e CLUSTER_NAME=PXC -e XTRABACKUP_PASSWORD=root  -e  CLUSTER_JOIN=node1 -v v3:/var/lib/mysql -v backup:/data --privileged --name=node3 --net=net1 --ip 172.18.0.4 pxc</span><br><span class="line"></span><br><span class="line">docker run -d -p 3310:3306 -e MYSQL_ROOT_PASSWORD=root -e CLUSTER_NAME=PXC -e XTRABACKUP_PASSWORD=root  -e  CLUSTER_JOIN=node1 -v v4:/var/lib/mysql -v backup:/data --privileged --name=node4 --net=net1 --ip 172.18.0.5 pxc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker run -d -p 3311:3306 -e MYSQL_ROOT_PASSWORD=root -e CLUSTER_NAME=PXC -e XTRABACKUP_PASSWORD=root  -e  CLUSTER_JOIN=node1 -v v5:/var/lib/mysql -v backup:/data --privileged --name=node5 --net=net1 --ip 172.18.0.6 pxc</span><br></pre></td></tr></table></figure>
<p>注意事项<br>1、3308:3306:3308宿主机的端口不能相同，每台映射到宿主机的端口都不一样</p>
<p>2、 CLUSTER_JOIN=node1:添加关联第一台容器</p>
<p>3、 -v v2:/var/lib/mysql：v2是docker卷,每台容器docker卷都不一样</p>
<p>4、–name=node2:每台容器名称都不一样</p>
<p>5、–net=net1 –ip 172.18.0.3:每台容器ip地址不一样</p>
<h5 id="测试集群"><a href="#测试集群" class="headerlink" title="测试集群"></a>测试集群</h5><p>pxc集群安装完，使用navicat连接数据库测试，注意连接对应的映射宿主机端口号，只要修改其中一台数据库的数据，其他数据库也会同步发生变化<br><img src="images/docker4.jpg" alt=""></p>
<h3 id="数据库负载均衡"><a href="#数据库负载均衡" class="headerlink" title="数据库负载均衡"></a>数据库负载均衡</h3><h4 id="负载均衡的必要性"><a href="#负载均衡的必要性" class="headerlink" title="负载均衡的必要性"></a>负载均衡的必要性</h4><p>pxc集群有多台数据库，如何能做到用户均匀访问不同数据库，提高网站访问并发量和性能、高可用？？</p>
<p><img src="images/docker5.jpg" alt=""></p>
<h4 id="Haproxy中间件做负载均衡"><a href="#Haproxy中间件做负载均衡" class="headerlink" title="Haproxy中间件做负载均衡"></a>Haproxy中间件做负载均衡</h4><p>haproxy 只做转发，均匀转发访问到不同数据库</p>
<p><img src="images/docker6.jpg" alt=""></p>
<h4 id="中间件比较"><a href="#中间件比较" class="headerlink" title="中间件比较"></a>中间件比较</h4><p><img src="images/docker7.jpg" alt=""></p>
<h4 id="docker安装Haproxy镜像"><a href="#docker安装Haproxy镜像" class="headerlink" title="docker安装Haproxy镜像"></a>docker安装Haproxy镜像</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull haproxy</span><br></pre></td></tr></table></figure>
<h4 id="设置Haproxy配置文件"><a href="#设置Haproxy配置文件" class="headerlink" title="设置Haproxy配置文件"></a>设置Haproxy配置文件</h4><p>在宿主机上创建Haproxy 配置文件，haproxy.cfg文件在百度云相关指令上</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">touch /home/soft/haproxy.cfg</span><br></pre></td></tr></table></figure>
<p>通过映射方式到haproxy容器目录中，haproxy.cfg详情需要参考网站<a href="https://zhangge.net/5125.html" target="_blank" rel="noopener">https://zhangge.net/5125.html</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">global</span><br><span class="line">	<span class="comment">#工作目录</span></span><br><span class="line">	chroot /usr/<span class="built_in">local</span>/etc/haproxy</span><br><span class="line">	<span class="comment">#日志文件，使用rsyslog服务中local5日志设备（/var/log/local5），等级info</span></span><br><span class="line">	<span class="built_in">log</span> 127.0.0.1 local5 info</span><br><span class="line">	<span class="comment">#守护进程运行</span></span><br><span class="line">	daemon</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">	<span class="built_in">log</span>	global</span><br><span class="line">	mode	http</span><br><span class="line">	<span class="comment">#日志格式</span></span><br><span class="line">	option	httplog</span><br><span class="line">	<span class="comment">#日志中不记录负载均衡的心跳检测记录</span></span><br><span class="line">	option	dontlognull</span><br><span class="line">    <span class="comment">#连接超时（毫秒）</span></span><br><span class="line">	timeout connect 5000</span><br><span class="line">    <span class="comment">#客户端超时（毫秒）</span></span><br><span class="line">	timeout client  50000</span><br><span class="line">	<span class="comment">#服务器超时（毫秒）</span></span><br><span class="line">    timeout server  50000</span><br><span class="line"></span><br><span class="line"><span class="comment">#监控界面	</span></span><br><span class="line">listen  admin_stats</span><br><span class="line">	<span class="comment">#监控界面的访问的IP和端口</span></span><br><span class="line">	<span class="built_in">bind</span>  0.0.0.0:8888</span><br><span class="line">	<span class="comment">#访问协议</span></span><br><span class="line">    mode        http</span><br><span class="line">	<span class="comment">#URI相对地址</span></span><br><span class="line">    stats uri   /dbs</span><br><span class="line">	<span class="comment">#统计报告格式</span></span><br><span class="line">    stats realm     Global\ statistics</span><br><span class="line">	<span class="comment">#登陆帐户信息</span></span><br><span class="line">    stats auth  admin:admin</span><br><span class="line"><span class="comment">#数据库负载均衡</span></span><br><span class="line">listen  proxy-mysql</span><br><span class="line">	<span class="comment">#访问的IP和端口</span></span><br><span class="line">	<span class="built_in">bind</span>  0.0.0.0:3306  </span><br><span class="line">    <span class="comment">#网络协议</span></span><br><span class="line">	mode  tcp</span><br><span class="line">	<span class="comment">#负载均衡算法（轮询算法）</span></span><br><span class="line">	<span class="comment">#轮询算法：roundrobin</span></span><br><span class="line">	<span class="comment">#权重算法：static-rr</span></span><br><span class="line">	<span class="comment">#最少连接算法：leastconn</span></span><br><span class="line">	<span class="comment">#请求源IP算法：source </span></span><br><span class="line">    balance  roundrobin</span><br><span class="line">	<span class="comment">#日志格式</span></span><br><span class="line">    option  tcplog</span><br><span class="line">	<span class="comment">#在MySQL中创建一个没有权限的haproxy用户，密码为空。Haproxy使用这个账户对MySQL数据库心跳检测</span></span><br><span class="line">    option  mysql-check user haproxy</span><br><span class="line">    server  MySQL_1 172.18.0.2:3306 check weight 1 maxconn 2000  </span><br><span class="line">    server  MySQL_2 172.18.0.3:3306 check weight 1 maxconn 2000  </span><br><span class="line">	server  MySQL_3 172.18.0.4:3306 check weight 1 maxconn 2000 </span><br><span class="line">	server  MySQL_4 172.18.0.5:3306 check weight 1 maxconn 2000</span><br><span class="line">	server  MySQL_5 172.18.0.6:3306 check weight 1 maxconn 2000</span><br><span class="line">	<span class="comment">#使用keepalive检测死链</span></span><br><span class="line">    option  tcpka</span><br></pre></td></tr></table></figure></p>
<p>主要是关注下面和数据库有关的配置<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">listen  proxy-mysql</span><br><span class="line">	<span class="comment">#访问的IP和端口</span></span><br><span class="line">	<span class="built_in">bind</span>  0.0.0.0:3306  </span><br><span class="line">    <span class="comment">#网络协议</span></span><br><span class="line">	mode  tcp</span><br><span class="line">	<span class="comment">#负载均衡算法（轮询算法）</span></span><br><span class="line">	<span class="comment">#轮询算法：roundrobin</span></span><br><span class="line">	<span class="comment">#权重算法：static-rr</span></span><br><span class="line">	<span class="comment">#最少连接算法：leastconn</span></span><br><span class="line">	<span class="comment">#请求源IP算法：source </span></span><br><span class="line">    balance  roundrobin</span><br><span class="line">	<span class="comment">#日志格式</span></span><br><span class="line">    option  tcplog</span><br><span class="line">	<span class="comment">#在MySQL中创建一个没有权限的haproxy用户，密码为空。Haproxy使用这个账户对MySQL数据库心跳检测</span></span><br><span class="line">    option  mysql-check user haproxy</span><br><span class="line">    server  MySQL_1 172.18.0.2:3306 check weight 1 maxconn 2000  </span><br><span class="line">    server  MySQL_2 172.18.0.3:3306 check weight 1 maxconn 2000  </span><br><span class="line">	server  MySQL_3 172.18.0.4:3306 check weight 1 maxconn 2000 </span><br><span class="line">	server  MySQL_4 172.18.0.5:3306 check weight 1 maxconn 2000</span><br><span class="line">	server  MySQL_5 172.18.0.6:3306 check weight 1 maxconn 2000</span><br><span class="line">	<span class="comment">#使用keepalive检测死链</span></span><br></pre></td></tr></table></figure></p>
<p>bind  0.0.0.0:3306:表示所有的ip地址都能访问数据库的3306端口</p>
<p>balance  roundrobin:负载均衡分发的请求算法</p>
<p>option  mysql-check user haproxy:需要检测haproxy 和数据库直接的连接，在MySQL中创建一个没有权限的haproxy用户，密码为空。Haproxy使用这个账户对MySQL数据库心跳检测</p>
<p>server  MySQL_1 172.18.0.2:3306 check weight 1 maxconn 2000  :MySQL数据库心跳检测</p>
<h4 id="创建mysql没有权限的haproxy用户，密码为空"><a href="#创建mysql没有权限的haproxy用户，密码为空" class="headerlink" title="创建mysql没有权限的haproxy用户，密码为空"></a>创建mysql没有权限的haproxy用户，密码为空</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create user <span class="string">'haproxy'</span>@<span class="string">'%'</span> IDENTIFIED BY <span class="string">''</span>;</span><br></pre></td></tr></table></figure>
<h4 id="创建Haproxy容器"><a href="#创建Haproxy容器" class="headerlink" title="创建Haproxy容器"></a>创建Haproxy容器</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建第1个Haproxy负载均衡服务器</span></span><br><span class="line">docker run -it -d -p 4001:8888 -p 4002:3306 -v /home/soft/haproxy:/usr/<span class="built_in">local</span>/etc/haproxy --name h1 --privileged --net=net1 --ip 172.18.0.7 haproxy</span><br><span class="line"><span class="comment">#进入h1容器，启动Haproxy</span></span><br><span class="line">docker <span class="built_in">exec</span> -it h1 bash</span><br><span class="line">haproxy -f /usr/<span class="built_in">local</span>/etc/haproxy/haproxy.cfg</span><br><span class="line"><span class="comment">#创建第2个Haproxy负载均衡服务器</span></span><br><span class="line">docker run -it -d -p 4003:8888 -p 4004:3306 -v /home/soft/haproxy:/usr/<span class="built_in">local</span>/etc/haproxy --name h2 --privileged --net=net1 --ip 172.18.0.8 haproxy</span><br><span class="line"><span class="comment">#进入h2容器，启动Haproxy</span></span><br><span class="line">docker <span class="built_in">exec</span> -it h2 bash</span><br><span class="line">haproxy -f /usr/<span class="built_in">local</span>/etc/haproxy/haproxy.cfg</span><br></pre></td></tr></table></figure>
<p>访问haproxy 第一个容器页面，账户密码在haproxy.cfg里面-登陆帐户信息<br>stats auth  admin:admin，我设置了admin/admin<br><a href="http://192.168.157.129:4001/dbs" target="_blank" rel="noopener">http://192.168.157.129:4001/dbs</a></p>
<p><img src="images/docker8.jpg" alt=""></p>
<p>在 navicat新建数据库连接h1， 端口号是上面对应的宿主机端口(h1是4002)和ip地址，账号密码是数据库账号密码，新增数据可以看到在node1到node5都有了数据，说明配置成功</p>
<p><img src="images/docker9.jpg" alt=""></p>
<h4 id="Haproxy高可用，创建多个haproxy"><a href="#Haproxy高可用，创建多个haproxy" class="headerlink" title="Haproxy高可用，创建多个haproxy"></a>Haproxy高可用，创建多个haproxy</h4><p>  单节点的haproxy没有高可用性能，单个haproxy挂了，整个服务就挂了<br>  <img src="images/docker10.jpg" alt=""><br>  多节点haproxy安装需要用到Keepalived，多节点会争抢虚拟ip，抢到的节点作为主节点运行，其他节点作为备份，节点之间发送心跳检测，当主节点挂了，其他备份节点会争抢成为主节点，实现高可用<br>    <img src="images/docker11.jpg" alt=""><br>  多节点haproxy方案<br>    <img src="images/docker12.jpg" alt=""></p>
<h4 id="Haproxy容器内安装Keepalived，设置虚拟IP"><a href="#Haproxy容器内安装Keepalived，设置虚拟IP" class="headerlink" title="Haproxy容器内安装Keepalived，设置虚拟IP"></a>Haproxy容器内安装Keepalived，设置虚拟IP</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#进入h1容器</span></span><br><span class="line">docker <span class="built_in">exec</span> -it h1 bash</span><br><span class="line"><span class="comment">#更新软件包</span></span><br><span class="line">apt-get update</span><br><span class="line"><span class="comment">#安装VIM</span></span><br><span class="line">apt-get install vim</span><br><span class="line"><span class="comment">#安装Keepalived</span></span><br><span class="line">apt-get install keepalived</span><br><span class="line"><span class="comment">#编辑Keepalived配置文件（参考下方配置文件）</span></span><br><span class="line">vim /etc/keepalived/keepalived.conf</span><br><span class="line"><span class="comment">#启动Keepalived</span></span><br><span class="line">service keepalived start</span><br><span class="line"><span class="comment">#宿主机执行ping命令</span></span><br><span class="line">ping 172.18.0.201</span><br></pre></td></tr></table></figure>
<p>keepalived.conf 配置文件 争抢虚拟IP<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">vrrp_instance  VI_1 &#123;</span><br><span class="line">    state  MASTER</span><br><span class="line">    interface  eth0</span><br><span class="line">    virtual_router_id  51</span><br><span class="line">    priority  100</span><br><span class="line">    advert_int  1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type  PASS</span><br><span class="line">        auth_pass  123456</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        172.18.0.201</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>配置文件解析<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">VI_1:配置信息的名字，可以修改</span><br><span class="line"></span><br><span class="line">state  MASTER:Keepalived节点身份信息-MASTER主服务（可以多个），BACKUP备服务器（可以多个），节点启动时主服务抢占虚拟IP,备用服务器不会抢占IP</span><br><span class="line"></span><br><span class="line">interface  eth0:网卡设置，定义的虚拟IP要设置在那个网卡里面，eth0是docker虚拟机的网卡，宿主机能访问，局域网不能访问，局域网要想访问，需要在宿主机上把eth0网卡映射到局域网上某个虚拟ip上，所以宿主机也需要安装keepalived</span><br><span class="line"></span><br><span class="line">virtual_router_id  51:给Keepalived集群组起ID-虚拟路由标识，MASTER和BACKUPB的虚拟路由标识必须一致，标识可以是2~255</span><br><span class="line"></span><br><span class="line">priority  100:权重，值越大争抢到虚拟IP几率越大</span><br><span class="line"></span><br><span class="line">advert_int  1:心跳检测，MASTER和BACKUPB节点之间同步检测时间间隔，单位秒，1每一秒检测一次，主备之间必须一致</span><br><span class="line"></span><br><span class="line">authentication &#123; auth_type  PASS  auth_pass  123456 &#125;:心跳检测需要开放的账户密码</span><br><span class="line"></span><br><span class="line">virtual_ipaddress &#123;  172.18.0.201 &#125;:eth0定义的虚拟IP,可以设置多个虚拟IP地址，每行一个，只在docker内部能看得见</span><br></pre></td></tr></table></figure></p>
<p><font color="#660000">注意问题:</font><br><br>1、在执行apt-get update，发现docker 机无法解析dns，需要修改/etc/resolv.conf的nameserver 值为主机的值</p>
<p> <img src="images/docker13.jpg" alt=""></p>
<p> 主机DNS值<br> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmcli dev show | grep IP4.DNS</span><br></pre></td></tr></table></figure></p>
<p> 发现在ubuntu不能使用命令vi ，前提是要apt-get update，直接使用touch，echo</p>
<p> 备份<br> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv resolv.conf resolv.conf-bak</span><br></pre></td></tr></table></figure></p>
<p>  创建<br> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">touch resolv.conf</span><br></pre></td></tr></table></figure></p>
<p> 添加数据<br>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> nameserver 192.168.157.2 &gt; resolv.conf</span><br><span class="line"><span class="built_in">echo</span> options ndots:0 &gt;&gt;resolv.conf</span><br></pre></td></tr></table></figure></p>
<p> 2、apt-get镜像在国外，下载速度比较慢，添加阿里云镜像，修改vim /etc/apt/sources.list 文件，如果不能使用vim，可以先使用echo &gt;&gt; sources.list<br> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial main restricted universe multiverse</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial-security main restricted universe multiverse</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial-updates main restricted universe multiverse</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial-proposed main restricted universe multiverse</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial-backports main restricted universe multiverse</span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ xenial main restricted universe multiverse</span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ xenial-security main restricted universe multiverse</span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ xenial-updates main restricted universe multiverse</span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ xenial-proposed main restricted universe multiverse</span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ xenial-backports main restricted universe multiverse</span><br></pre></td></tr></table></figure></p>
<h4 id="宿主机安装Keepalived"><a href="#宿主机安装Keepalived" class="headerlink" title="宿主机安装Keepalived"></a>宿主机安装Keepalived</h4><p>安装Keepalived<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#宿主机执行安装Keepalived</span></span><br><span class="line">yum -y install keepalived</span><br><span class="line"><span class="comment">#修改Keepalived配置文件</span></span><br><span class="line">vi /etc/keepalived/keepalived.conf</span><br><span class="line"><span class="comment">#启动Keepalived</span></span><br><span class="line">service keepalived start</span><br></pre></td></tr></table></figure></p>
<p>Keepalived配置文件如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens33</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">       	192.168.157.135</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">virtual_server 192.168.157.135 8888 &#123;</span><br><span class="line">    delay_loop 3</span><br><span class="line">    lb_algo rr </span><br><span class="line">    lb_kind NAT</span><br><span class="line">    persistence_timeout 50</span><br><span class="line">    protocol TCP</span><br><span class="line"></span><br><span class="line">    real_server 172.18.0.201 8888 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">virtual_server 192.168.157.135 3306 &#123;</span><br><span class="line">    delay_loop 3</span><br><span class="line">    lb_algo rr </span><br><span class="line">    lb_kind NAT</span><br><span class="line">    persistence_timeout 50</span><br><span class="line">    protocol TCP</span><br><span class="line"></span><br><span class="line">    real_server 172.18.0.201 3306 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>配置文件解析<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">192.168.157.135：宿主机局域网的IP地址</span><br><span class="line"></span><br><span class="line">8888:对应容器Haproxy服务端口</span><br><span class="line"></span><br><span class="line">3306:对应容器Haproxy数据库端口</span><br><span class="line"></span><br><span class="line">172.18.0.201:keepalived争抢的IP地址</span><br></pre></td></tr></table></figure></p>
<h4 id="检测Keepalived高可用"><a href="#检测Keepalived高可用" class="headerlink" title="检测Keepalived高可用"></a>检测Keepalived高可用</h4><p>1、访问 Haproxy服务，ip地址是192.168.157.135，端口号上面设置8888<br> <img src="images/docker14.jpg" alt=""></p>
<p>2、使用navicat 登录 ，ip地址是192.168.157.135，端口号3306，账号密码自己设置的数据库账户密码<br> <img src="images/docker15.jpg" alt=""><br> <img src="images/docker16.jpg" alt=""></p>
<p>3、暂停其中的一个haproxy容器，查看是否还能使用</p>
<p>暂停容器<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pause h1</span><br></pre></td></tr></table></figure></p>
<p>运行暂停的容器<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker unpause h1</span><br></pre></td></tr></table></figure></p>
<p>可见集群还是能使用</p>
<h3 id="暂停-pxc集群方法"><a href="#暂停-pxc集群方法" class="headerlink" title="暂停 pxc集群方法"></a>暂停 pxc集群方法</h3><p>当要关闭Linux虚拟机，pxc如何关闭并如何保存，这些是有顺序的。最好是直接挂起虚拟机，而不是直接关闭虚拟机。挂起虚拟机，重新开启虚拟机，容器会直接恢复启动，但docker虚拟机得不到网络。从挂起状态恢复运行状态，为内部进程虚拟机分配网络，宿主机需要修改下面配置<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/sysctl.conf</span><br><span class="line"><span class="comment">#文件中添加 net.ipv4.ip_forward=1 这个配置</span></span><br><span class="line">systemctl restart network</span><br></pre></td></tr></table></figure></p>
<h3 id="数据库备份"><a href="#数据库备份" class="headerlink" title="数据库备份"></a>数据库备份</h3><p>1、冷备份-暂停数据库运行<br> <img src="images/docker17.jpg" alt=""></p>
<p>2、热备份-数据库运行中<br><img src="images/docker18.jpg" alt=""></p>
<p>IVM :linux 自带的备份方式，分区里面的数据，可以备份多种数据库，备份要加锁，只读，不能写</p>
<p>XtraBackup :能读能写<br><img src="images/docker20.jpg" alt=""></p>
<p>热备份数据</p>
<p><img src="images/docker19.jpg" alt=""><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#宿主机</span></span><br><span class="line"></span><br><span class="line">docker <span class="built_in">exec</span> -it node1 bash</span><br><span class="line"><span class="comment">#更新软件包</span></span><br><span class="line">apt-get update</span><br><span class="line"><span class="comment">#安装热备工具</span></span><br><span class="line">apt-get install percona-xtrabackup-24</span><br><span class="line"><span class="comment">#全量热备到backup</span></span><br><span class="line">innobackupex --user=root --password=root /data/backup/full</span><br></pre></td></tr></table></figure></p>
<h3 id="数据库还原-只有冷还原"><a href="#数据库还原-只有冷还原" class="headerlink" title="数据库还原-只有冷还原"></a>数据库还原-只有冷还原</h3><p><img src="images/docker21.jpg" alt=""><br>冷还原数据 停止其余4个节点，并删除节点</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker stop node2</span><br><span class="line">docker stop node3</span><br><span class="line">docker stop node4</span><br><span class="line">docker stop node5</span><br><span class="line">docker rm node2</span><br><span class="line">docker rm node3</span><br><span class="line">docker rm node4</span><br><span class="line">docker rm node5</span><br></pre></td></tr></table></figure>
<p>node1容器中删除MySQL的数据<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#删除数据</span></span><br><span class="line">rm -rf /var/lib/mysql/*</span><br><span class="line"><span class="comment">#清空事务</span></span><br><span class="line">innobackupex --user=root --password=abc123456 --apply-back /data/backup/full/2018-04-15_05-09-07/</span><br><span class="line"><span class="comment">#还原数据</span></span><br><span class="line">innobackupex --user=root --password=abc123456 --copy-back  /data/backup/full/2018-04-15_05-09-07/</span><br></pre></td></tr></table></figure></p>
<p>重新创建其余4个节点，组件PXC集群</p>
<h3 id="安装redis-集群"><a href="#安装redis-集群" class="headerlink" title="安装redis 集群"></a>安装redis 集群</h3><h4 id="高速缓存结束"><a href="#高速缓存结束" class="headerlink" title="高速缓存结束"></a>高速缓存结束</h4><p><img src="images/redis1.jpg" alt=""></p>
<h4 id="redis介绍"><a href="#redis介绍" class="headerlink" title="redis介绍"></a>redis介绍</h4><p><img src="images/redis2.jpg" alt=""></p>
<h4 id="redis集群介绍"><a href="#redis集群介绍" class="headerlink" title="redis集群介绍"></a>redis集群介绍</h4><p>主要使用RedisCluster方案<br><img src="images/redis3.jpg" alt=""></p>
<h4 id="RedisCluster方案介绍"><a href="#RedisCluster方案介绍" class="headerlink" title="RedisCluster方案介绍"></a>RedisCluster方案介绍</h4><p><img src="images/redis4.jpg" alt=""><br>主从同步</p>
<p><img src="images/redis5.jpg" alt=""></p>
<p>RedisCluster集群的高可用<br><img src="images/redis6.jpg" alt=""></p>
<h4 id="安装redis镜像，配置RedisCluster集群"><a href="#安装redis镜像，配置RedisCluster集群" class="headerlink" title="安装redis镜像，配置RedisCluster集群"></a>安装redis镜像，配置RedisCluster集群</h4><h5 id="安装Redis镜像"><a href="#安装Redis镜像" class="headerlink" title="安装Redis镜像"></a>安装Redis镜像</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull yyyyttttwwww/redis</span><br></pre></td></tr></table></figure>
<h5 id="创建net2网段"><a href="#创建net2网段" class="headerlink" title="创建net2网段"></a>创建net2网段</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network create --subnet=172.19.0.0/16 net2</span><br></pre></td></tr></table></figure>
<h5 id="创建6节点Redis容器"><a href="#创建6节点Redis容器" class="headerlink" title="创建6节点Redis容器"></a>创建6节点Redis容器</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker run -it -d --name r1 -p 5001:6379 --net=net2 --ip 172.19.0.2 redis bash</span><br><span class="line">docker run -it -d --name r2 -p 5002:6379 --net=net2 --ip 172.19.0.3 redis bash</span><br><span class="line">docker run -it -d --name r3 -p 5003:6379 --net=net2 --ip 172.19.0.4 redis bash</span><br><span class="line">docker run -it -d --name r4 -p 5004:6379 --net=net2 --ip 172.19.0.5 redis bash</span><br><span class="line">docker run -it -d --name r5 -p 5005:6379 --net=net2 --ip 172.19.0.6 redis bash</span><br><span class="line">docker run -it -d --name r6 -p 5006:6379 --net=net2 --ip 172.19.0.7 redis bash</span><br></pre></td></tr></table></figure>
<h5 id="启动6节点Redis服务器"><a href="#启动6节点Redis服务器" class="headerlink" title="启动6节点Redis服务器"></a>启动6节点Redis服务器</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#进入r1节点</span></span><br><span class="line">docker <span class="built_in">exec</span> -it r1 bash</span><br><span class="line">vi /usr/redis/redis.conf</span><br><span class="line"><span class="built_in">cd</span> /usr/redis/src</span><br><span class="line">./redis-server ../redis.conf</span><br><span class="line"><span class="comment">#进入r2节点</span></span><br><span class="line">docker <span class="built_in">exec</span> -it r2 bash</span><br><span class="line">vi /usr/redis/redis.conf</span><br><span class="line"><span class="built_in">cd</span> /usr/redis/src</span><br><span class="line">./redis-server ../redis.conf</span><br><span class="line"><span class="comment">#进入r3节点</span></span><br><span class="line">docker <span class="built_in">exec</span> -it r3 bash</span><br><span class="line">vi /usr/redis/redis.conf</span><br><span class="line"><span class="built_in">cd</span> /usr/redis/src</span><br><span class="line">./redis-server ../redis.conf</span><br><span class="line"><span class="comment">#进入r4节点</span></span><br><span class="line">docker <span class="built_in">exec</span> -it r4 bash</span><br><span class="line">vi /usr/redis/redis.conf</span><br><span class="line"><span class="built_in">cd</span> /usr/redis/src</span><br><span class="line">./redis-server ../redis.conf</span><br><span class="line"><span class="comment">#进入r5节点</span></span><br><span class="line">docker <span class="built_in">exec</span> -it r5 bash</span><br><span class="line">vi /usr/redis/redis.conf</span><br><span class="line"><span class="built_in">cd</span> /usr/redis/src</span><br><span class="line">./redis-server ../redis.conf</span><br><span class="line"><span class="comment">#进入r6节点</span></span><br><span class="line">docker <span class="built_in">exec</span> -it r6 bash</span><br><span class="line">vi /usr/redis/redis.conf</span><br><span class="line"><span class="built_in">cd</span> /usr/redis/src</span><br><span class="line">./redis-server ../redis.conf</span><br></pre></td></tr></table></figure>
<p>redis.conf配置文件修改的地方<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">daemonize yes</span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file nodes.conf</span><br><span class="line">cluster-node-timeout 15000</span><br><span class="line"><span class="built_in">bind</span> 0.0.0.0  <span class="comment">#设置其他IP地址能访问，Cluster集群中的redis需要互相访问</span></span><br><span class="line">appendonly yes</span><br></pre></td></tr></table></figure></p>
<p><img src="images/redis8.jpg" alt=""></p>
<h5 id="创建Cluster集群"><a href="#创建Cluster集群" class="headerlink" title="创建Cluster集群"></a>创建Cluster集群</h5><p>cluster是ruby写的，需要安装ruby环境，但上面方式安装的redis已经集成了，不再需要安装<br><img src="images/redis7.jpg" alt=""><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在r1节点上执行下面的指令</span></span><br><span class="line"><span class="built_in">cd</span> /usr/redis/src</span><br><span class="line">mkdir -p ../cluster</span><br><span class="line">cp redis-trib.rb ../cluster/</span><br><span class="line"><span class="built_in">cd</span> ../cluster</span><br><span class="line"><span class="comment">#创建Cluster集群</span></span><br><span class="line">./redis-trib.rb create --replicas 1 172.19.0.2:6379 172.19.0.3:6379 172.19.0.4:6379 172.19.0.5:6379 172.19.0.6:6379 172.19.0.7:6379</span><br></pre></td></tr></table></figure></p>
<h5 id="重启redis"><a href="#重启redis" class="headerlink" title="重启redis"></a>重启redis</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ps -ef|grep redis <span class="comment">#查看进程</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">kill</span> -9 进程id  <span class="comment">#杀死进程</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> /usr/redis/src</span><br><span class="line"></span><br><span class="line">./redis-server ../redis.conf</span><br></pre></td></tr></table></figure>
<h3 id="部署后端的项目"><a href="#部署后端的项目" class="headerlink" title="部署后端的项目"></a>部署后端的项目</h3><h4 id="修改数据源配置"><a href="#修改数据源配置" class="headerlink" title="修改数据源配置"></a>修改数据源配置</h4><p>application_dev.yml</p>
<h4 id="修改redis配置"><a href="#修改redis配置" class="headerlink" title="修改redis配置"></a>修改redis配置</h4><p>application.yml<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#host: localhost</span></span><br><span class="line">  <span class="comment">#port: 6379</span></span><br><span class="line">  <span class="comment">#password:    # 密码（默认为空）</span></span><br><span class="line">  timeout: 6000ms  <span class="comment"># 连接超时时长（毫秒）</span></span><br><span class="line">  cluster:</span><br><span class="line">    nodes:</span><br><span class="line">    - 172.19.0.2:6379</span><br><span class="line">    - 172.19.0.3:6379</span><br><span class="line">    - 172.19.0.4:6379</span><br><span class="line">    - 172.19.0.5:6379</span><br><span class="line">    - 172.19.0.6:6379</span><br><span class="line">    - 172.19.0.7:6379</span><br><span class="line">  jedis:</span><br></pre></td></tr></table></figure></p>
<h4 id="进入人人开源后端项目，执行打包（修改配置文件，更改端口，打包三次生成三个JAR文件）"><a href="#进入人人开源后端项目，执行打包（修改配置文件，更改端口，打包三次生成三个JAR文件）" class="headerlink" title="进入人人开源后端项目，执行打包（修改配置文件，更改端口，打包三次生成三个JAR文件）"></a>进入人人开源后端项目，执行打包（修改配置文件，更改端口，打包三次生成三个JAR文件）</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn clean install -Dmaven.test.skip=<span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h4 id="安装Java镜像"><a href="#安装Java镜像" class="headerlink" title="安装Java镜像"></a>安装Java镜像</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull java</span><br></pre></td></tr></table></figure>
<h4 id="创建3节点Java容器"><a href="#创建3节点Java容器" class="headerlink" title="创建3节点Java容器"></a>创建3节点Java容器</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建数据卷，上传JAR文件</span></span><br><span class="line">docker volume create j1</span><br><span class="line"><span class="comment">#启动容器</span></span><br><span class="line">docker run -it -d --name j1 -v j1:/home/soft --net=host java</span><br><span class="line"><span class="comment">#进入j1容器</span></span><br><span class="line">docker <span class="built_in">exec</span> -it j1 bash</span><br><span class="line"><span class="comment">#启动Java项目</span></span><br><span class="line">nohup java -jar /home/soft/renren-fast.jar</span><br><span class="line"><span class="comment">#查看日志</span></span><br><span class="line">tail -fn 50 nohup.out</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建数据卷，上传JAR文件</span></span><br><span class="line">docker volume create j2</span><br><span class="line"><span class="comment">#启动容器</span></span><br><span class="line">docker run -it -d --name j2 -v j2:/home/soft --net=host java</span><br><span class="line"><span class="comment">#进入j1容器</span></span><br><span class="line">docker <span class="built_in">exec</span> -it j2 bash</span><br><span class="line"><span class="comment">#启动Java项目</span></span><br><span class="line">nohup java -jar /home/soft/renren-fast.jar</span><br><span class="line"><span class="comment">#查看日志</span></span><br><span class="line">tail -fn 50 nohup.out</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建数据卷，上传JAR文件</span></span><br><span class="line">docker volume create j3</span><br><span class="line"><span class="comment">#启动容器</span></span><br><span class="line">docker run -it -d --name j3 -v j3:/home/soft --net=host java</span><br><span class="line"><span class="comment">#进入j1容器</span></span><br><span class="line">docker <span class="built_in">exec</span> -it j3 bash</span><br><span class="line"><span class="comment">#启动Java项目</span></span><br><span class="line">nohup java -jar /home/soft/renren-fast.jar</span><br><span class="line"><span class="comment">#查看日志</span></span><br><span class="line">tail -fn 50 nohup.out</span><br></pre></td></tr></table></figure>
<h4 id="访问网站"><a href="#访问网站" class="headerlink" title="访问网站"></a>访问网站</h4><p><a href="http://192.168.157.129:6001/renren-fast/swagger/index.html" target="_blank" rel="noopener">http://192.168.157.129:6001/renren-fast/swagger/index.html</a><br><img src="images/renren1.jpg" alt=""></p>
<h3 id="nginx-负载均衡"><a href="#nginx-负载均衡" class="headerlink" title="nginx 负载均衡"></a>nginx 负载均衡</h3><h4 id="安装Nginx镜像"><a href="#安装Nginx镜像" class="headerlink" title="安装Nginx镜像"></a>安装Nginx镜像</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull nginx</span><br></pre></td></tr></table></figure>
<h4 id="创建Nginx容器，配置负载均衡"><a href="#创建Nginx容器，配置负载均衡" class="headerlink" title="创建Nginx容器，配置负载均衡"></a>创建Nginx容器，配置负载均衡</h4><p><img src="images/renren3.jpg" alt=""></p>
<h5 id="宿主机上-home-n1-nginx-conf配置文件内容如下："><a href="#宿主机上-home-n1-nginx-conf配置文件内容如下：" class="headerlink" title="宿主机上/home/n1/nginx.conf配置文件内容如下："></a>宿主机上/home/n1/nginx.conf配置文件内容如下：</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">user  nginx;</span><br><span class="line">worker_processes  1;</span><br><span class="line">error_log  /var/<span class="built_in">log</span>/nginx/error.log warn;</span><br><span class="line">pid        /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       /etc/nginx/mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format  main  <span class="string">'$remote_addr - $remote_user [$time_local] "$request" '</span></span><br><span class="line">                      <span class="string">'$status $body_bytes_sent "$http_referer" '</span></span><br><span class="line">                      <span class="string">'"$http_user_agent" "$http_x_forwarded_for"'</span>;</span><br><span class="line"></span><br><span class="line">    access_log  /var/<span class="built_in">log</span>/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    <span class="comment">#tcp_nopush     on;</span></span><br><span class="line"></span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#gzip  on;</span></span><br><span class="line">	</span><br><span class="line">	proxy_redirect          off;</span><br><span class="line">	proxy_set_header        Host <span class="variable">$host</span>;</span><br><span class="line">	proxy_set_header        X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">	proxy_set_header        X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">	client_max_body_size    10m;</span><br><span class="line">	client_body_buffer_size   128k;</span><br><span class="line">	proxy_connect_timeout   5s;</span><br><span class="line">	proxy_send_timeout      5s;</span><br><span class="line">	proxy_read_timeout      5s;</span><br><span class="line">	proxy_buffer_size        4k;</span><br><span class="line">	proxy_buffers           4 32k;</span><br><span class="line">	proxy_busy_buffers_size  64k;</span><br><span class="line">	proxy_temp_file_write_size 64k;</span><br><span class="line">	</span><br><span class="line">	upstream tomcat &#123;</span><br><span class="line">		server 192.168.99.104:6001;</span><br><span class="line">		server 192.168.99.104:6002;</span><br><span class="line">		server 192.168.99.104:6003;</span><br><span class="line">	&#125;</span><br><span class="line">	server &#123;</span><br><span class="line">        listen       6101;</span><br><span class="line">        server_name  192.168.99.104; </span><br><span class="line">        location / &#123;  </span><br><span class="line">            proxy_pass   http://tomcat;</span><br><span class="line">            index  index.html index.htm;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="创建第1个Nginx节点"><a href="#创建第1个Nginx节点" class="headerlink" title="创建第1个Nginx节点"></a>创建第1个Nginx节点</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it -d --name n1 -v /home/n1/nginx.conf:/etc/nginx/nginx.conf --net=host --privileged nginx</span><br></pre></td></tr></table></figure>
<h5 id="宿主机上-home-n2-nginx-conf配置文件内容如下："><a href="#宿主机上-home-n2-nginx-conf配置文件内容如下：" class="headerlink" title="宿主机上/home/n2/nginx.conf配置文件内容如下："></a>宿主机上/home/n2/nginx.conf配置文件内容如下：</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">user  nginx;</span><br><span class="line">worker_processes  1;</span><br><span class="line">error_log  /var/<span class="built_in">log</span>/nginx/error.log warn;</span><br><span class="line">pid        /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       /etc/nginx/mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format  main  <span class="string">'$remote_addr - $remote_user [$time_local] "$request" '</span></span><br><span class="line">                      <span class="string">'$status $body_bytes_sent "$http_referer" '</span></span><br><span class="line">                      <span class="string">'"$http_user_agent" "$http_x_forwarded_for"'</span>;</span><br><span class="line"></span><br><span class="line">    access_log  /var/<span class="built_in">log</span>/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    <span class="comment">#tcp_nopush     on;</span></span><br><span class="line"></span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#gzip  on;</span></span><br><span class="line">	</span><br><span class="line">	proxy_redirect          off;</span><br><span class="line">	proxy_set_header        Host <span class="variable">$host</span>;</span><br><span class="line">	proxy_set_header        X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">	proxy_set_header        X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">	client_max_body_size    10m;</span><br><span class="line">	client_body_buffer_size   128k;</span><br><span class="line">	proxy_connect_timeout   5s;</span><br><span class="line">	proxy_send_timeout      5s;</span><br><span class="line">	proxy_read_timeout      5s;</span><br><span class="line">	proxy_buffer_size        4k;</span><br><span class="line">	proxy_buffers           4 32k;</span><br><span class="line">	proxy_busy_buffers_size  64k;</span><br><span class="line">	proxy_temp_file_write_size 64k;</span><br><span class="line">	</span><br><span class="line">	upstream tomcat &#123;</span><br><span class="line">		server 192.168.99.104:6001;</span><br><span class="line">		server 192.168.99.104:6002;</span><br><span class="line">		server 192.168.99.104:6003;</span><br><span class="line">	&#125;</span><br><span class="line">	server &#123;</span><br><span class="line">        listen       6102;</span><br><span class="line">        server_name  192.168.99.104; </span><br><span class="line">        location / &#123;  </span><br><span class="line">            proxy_pass   http://tomcat;</span><br><span class="line">            index  index.html index.htm;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="创建第2个Nginx节点"><a href="#创建第2个Nginx节点" class="headerlink" title="创建第2个Nginx节点"></a>创建第2个Nginx节点</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it -d --name n2 -v /home/n2/nginx.conf:/etc/nginx/nginx.conf --net=host --privileged nginx</span><br></pre></td></tr></table></figure>
<h3 id="后端项目双机热备负载均衡"><a href="#后端项目双机热备负载均衡" class="headerlink" title="后端项目双机热备负载均衡"></a>后端项目双机热备负载均衡</h3><p><img src="images/renren2.jpg" alt=""></p>
<h4 id="在Nginx容器安装Keepalived"><a href="#在Nginx容器安装Keepalived" class="headerlink" title="在Nginx容器安装Keepalived"></a>在Nginx容器安装Keepalived</h4><h5 id="n1节点keepalived"><a href="#n1节点keepalived" class="headerlink" title="n1节点keepalived"></a>n1节点keepalived</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#进入n1节点</span></span><br><span class="line">docker <span class="built_in">exec</span> -it n1 bash</span><br><span class="line"><span class="comment">#更新软件包</span></span><br><span class="line">apt-get update</span><br><span class="line"><span class="comment">#安装VIM</span></span><br><span class="line">apt-get install vim</span><br><span class="line"><span class="comment">#安装Keepalived</span></span><br><span class="line">apt-get install keepalived</span><br><span class="line"><span class="comment">#编辑Keepalived配置文件(如下)</span></span><br><span class="line">vim /etc/keepalived/keepalived.conf</span><br><span class="line"><span class="comment">#启动Keepalived</span></span><br><span class="line">service keepalived start</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens33</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 123456</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.99.151</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">virtual_server 192.168.99.151 6201 &#123;</span><br><span class="line">    delay_loop 3</span><br><span class="line">    lb_algo rr</span><br><span class="line">    lb_kind NAT</span><br><span class="line">    persistence_timeout 50</span><br><span class="line">    protocol TCP</span><br><span class="line">    real_server 192.168.99.104 6101 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="n2节点keepalived"><a href="#n2节点keepalived" class="headerlink" title="n2节点keepalived"></a>n2节点keepalived</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#进入n2节点</span></span><br><span class="line">docker <span class="built_in">exec</span> -it n2 bash</span><br><span class="line"><span class="comment">#更新软件包</span></span><br><span class="line">apt-get update</span><br><span class="line"><span class="comment">#安装VIM</span></span><br><span class="line">apt-get install vim</span><br><span class="line"><span class="comment">#安装Keepalived</span></span><br><span class="line">apt-get install keepalived</span><br><span class="line"><span class="comment">#编辑Keepalived配置文件(如下)</span></span><br><span class="line">vim /etc/keepalived/keepalived.conf</span><br><span class="line"><span class="comment">#启动Keepalived</span></span><br><span class="line">service keepalived start</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens33</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 123456</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.99.151</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">virtual_server 192.168.99.151 6201 &#123;</span><br><span class="line">    delay_loop 3</span><br><span class="line">    lb_algo rr</span><br><span class="line">    lb_kind NAT</span><br><span class="line">    persistence_timeout 50</span><br><span class="line">    protocol TCP</span><br><span class="line">    real_server 192.168.99.104 6102 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="前端项目部署与负载均衡"><a href="#前端项目部署与负载均衡" class="headerlink" title="前端项目部署与负载均衡"></a>前端项目部署与负载均衡</h3><p><img src="images/docker22.jpg" alt=""></p>
<h4 id="设置前端连接后端的ip地址"><a href="#设置前端连接后端的ip地址" class="headerlink" title="设置前端连接后端的ip地址"></a>设置前端连接后端的ip地址</h4><p>比如<a href="http://192.168.157.129:6101/renren-fast" target="_blank" rel="noopener">http://192.168.157.129:6101/renren-fast</a><br><img src="images/renren4.jpg" alt=""></p>
<h4 id="打包部署前端项目"><a href="#打包部署前端项目" class="headerlink" title="打包部署前端项目"></a>打包部署前端项目</h4><h4 id="使用淘宝镜像-加速下载速度"><a href="#使用淘宝镜像-加速下载速度" class="headerlink" title="使用淘宝镜像,加速下载速度"></a>使用淘宝镜像,加速下载速度</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install -g cnpm --registry=https://registry.npm.taobao.org</span><br></pre></td></tr></table></figure>
<h4 id="在前端项目路径下执行打包指令"><a href="#在前端项目路径下执行打包指令" class="headerlink" title="在前端项目路径下执行打包指令"></a>在前端项目路径下执行打包指令</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm run build</span><br><span class="line"><span class="comment">#安装了淘宝镜像</span></span><br><span class="line">cnpm run build</span><br></pre></td></tr></table></figure>
<p>dish（build）目录的文件拷贝到宿主机的/home/fn1/renren-vue、/home/fn2/renren-vue、/home/fn3/renren-vue的目录下面</p>
<h4 id="创建3节点的Nginx，部署前端项目"><a href="#创建3节点的Nginx，部署前端项目" class="headerlink" title="创建3节点的Nginx，部署前端项目"></a>创建3节点的Nginx，部署前端项目</h4><h5 id="nginx-第一个节点"><a href="#nginx-第一个节点" class="headerlink" title="nginx 第一个节点"></a>nginx 第一个节点</h5><p>宿主机/home/fn1/nginx.conf的配置文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">user  nginx;</span><br><span class="line">worker_processes  1;</span><br><span class="line">error_log  /var/<span class="built_in">log</span>/nginx/error.log warn;</span><br><span class="line">pid        /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       /etc/nginx/mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format  main  <span class="string">'$remote_addr - $remote_user [$time_local] "$request" '</span></span><br><span class="line">                      <span class="string">'$status $body_bytes_sent "$http_referer" '</span></span><br><span class="line">                      <span class="string">'"$http_user_agent" "$http_x_forwarded_for"'</span>;</span><br><span class="line"></span><br><span class="line">    access_log  /var/<span class="built_in">log</span>/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    <span class="comment">#tcp_nopush     on;</span></span><br><span class="line"></span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#gzip  on;</span></span><br><span class="line">	</span><br><span class="line">	proxy_redirect          off;</span><br><span class="line">	proxy_set_header        Host <span class="variable">$host</span>;</span><br><span class="line">	proxy_set_header        X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">	proxy_set_header        X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">	client_max_body_size    10m;</span><br><span class="line">	client_body_buffer_size   128k;</span><br><span class="line">	proxy_connect_timeout   5s;</span><br><span class="line">	proxy_send_timeout      5s;</span><br><span class="line">	proxy_read_timeout      5s;</span><br><span class="line">	proxy_buffer_size        4k;</span><br><span class="line">	proxy_buffers           4 32k;</span><br><span class="line">	proxy_busy_buffers_size  64k;</span><br><span class="line">	proxy_temp_file_write_size 64k;</span><br><span class="line">	</span><br><span class="line">	server &#123;</span><br><span class="line">		listen 6501;</span><br><span class="line">		server_name  192.168.99.104;</span><br><span class="line">		location  /  &#123;</span><br><span class="line">			root  /home/fn1/renren-vue;</span><br><span class="line">			index  index.html;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#启动第fn1节点</span></span><br><span class="line">docker run -it -d --name fn1 -v /home/fn1/nginx.conf:/etc/nginx/nginx.conf -v /home/fn1/renren-vue:/home/fn1/renren-vue --privileged --net=host nginx</span><br></pre></td></tr></table></figure></p>
<h5 id="nginx-第二个节点"><a href="#nginx-第二个节点" class="headerlink" title="nginx 第二个节点"></a>nginx 第二个节点</h5><p>宿主机/home/fn2/nginx.conf的配置文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">user  nginx;</span><br><span class="line">worker_processes  1;</span><br><span class="line">error_log  /var/<span class="built_in">log</span>/nginx/error.log warn;</span><br><span class="line">pid        /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       /etc/nginx/mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format  main  <span class="string">'$remote_addr - $remote_user [$time_local] "$request" '</span></span><br><span class="line">                      <span class="string">'$status $body_bytes_sent "$http_referer" '</span></span><br><span class="line">                      <span class="string">'"$http_user_agent" "$http_x_forwarded_for"'</span>;</span><br><span class="line"></span><br><span class="line">    access_log  /var/<span class="built_in">log</span>/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    <span class="comment">#tcp_nopush     on;</span></span><br><span class="line"></span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#gzip  on;</span></span><br><span class="line">	</span><br><span class="line">	proxy_redirect          off;</span><br><span class="line">	proxy_set_header        Host <span class="variable">$host</span>;</span><br><span class="line">	proxy_set_header        X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">	proxy_set_header        X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">	client_max_body_size    10m;</span><br><span class="line">	client_body_buffer_size   128k;</span><br><span class="line">	proxy_connect_timeout   5s;</span><br><span class="line">	proxy_send_timeout      5s;</span><br><span class="line">	proxy_read_timeout      5s;</span><br><span class="line">	proxy_buffer_size        4k;</span><br><span class="line">	proxy_buffers           4 32k;</span><br><span class="line">	proxy_busy_buffers_size  64k;</span><br><span class="line">	proxy_temp_file_write_size 64k;</span><br><span class="line">	</span><br><span class="line">	server &#123;</span><br><span class="line">		listen 6502;</span><br><span class="line">		server_name  192.168.99.104;</span><br><span class="line">		location  /  &#123;</span><br><span class="line">			root  /home/fn2/renren-vue;</span><br><span class="line">			index  index.html;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#启动第fn2节点</span></span><br><span class="line">docker run -it -d --name fn2 -v /home/fn2/nginx.conf:/etc/nginx/nginx.conf -v /home/fn2/renren-vue:/home/fn2/renren-vue --privileged --net=host nginx</span><br></pre></td></tr></table></figure></p>
<h5 id="nginx-第三个节点"><a href="#nginx-第三个节点" class="headerlink" title="nginx 第三个节点"></a>nginx 第三个节点</h5><p>宿主机/home/fn3/nginx.conf的配置文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">user  nginx;</span><br><span class="line">worker_processes  1;</span><br><span class="line">error_log  /var/<span class="built_in">log</span>/nginx/error.log warn;</span><br><span class="line">pid        /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       /etc/nginx/mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format  main  <span class="string">'$remote_addr - $remote_user [$time_local] "$request" '</span></span><br><span class="line">                      <span class="string">'$status $body_bytes_sent "$http_referer" '</span></span><br><span class="line">                      <span class="string">'"$http_user_agent" "$http_x_forwarded_for"'</span>;</span><br><span class="line"></span><br><span class="line">    access_log  /var/<span class="built_in">log</span>/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    <span class="comment">#tcp_nopush     on;</span></span><br><span class="line"></span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#gzip  on;</span></span><br><span class="line">	</span><br><span class="line">	proxy_redirect          off;</span><br><span class="line">	proxy_set_header        Host <span class="variable">$host</span>;</span><br><span class="line">	proxy_set_header        X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">	proxy_set_header        X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">	client_max_body_size    10m;</span><br><span class="line">	client_body_buffer_size   128k;</span><br><span class="line">	proxy_connect_timeout   5s;</span><br><span class="line">	proxy_send_timeout      5s;</span><br><span class="line">	proxy_read_timeout      5s;</span><br><span class="line">	proxy_buffer_size        4k;</span><br><span class="line">	proxy_buffers           4 32k;</span><br><span class="line">	proxy_busy_buffers_size  64k;</span><br><span class="line">	proxy_temp_file_write_size 64k;</span><br><span class="line">	</span><br><span class="line">	server &#123;</span><br><span class="line">		listen 6503;</span><br><span class="line">		server_name  192.168.99.104;</span><br><span class="line">		location  /  &#123;</span><br><span class="line">			root  /home/fn3/renren-vue;</span><br><span class="line">			index  index.html;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">启动fn3节点</span><br><span class="line"></span><br><span class="line"><span class="comment">#启动第fn3节点</span></span><br><span class="line">docker run -it -d --name fn3 -v /home/fn3/nginx.conf:/etc/nginx/nginx.conf -v /home/fn3/renren-vue:/home/fn3/renren-vue --privileged --net=host nginx</span><br></pre></td></tr></table></figure></p>
<h5 id="利用keepalived配置负载均衡"><a href="#利用keepalived配置负载均衡" class="headerlink" title="利用keepalived配置负载均衡"></a>利用keepalived配置负载均衡</h5><h6 id="ff1-keepalived-nginx节点"><a href="#ff1-keepalived-nginx节点" class="headerlink" title="ff1  keepalived-nginx节点"></a>ff1  keepalived-nginx节点</h6><p>宿主机/home/ff1/nginx.conf配置文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">user  nginx;</span><br><span class="line">worker_processes  1;</span><br><span class="line">error_log  /var/<span class="built_in">log</span>/nginx/error.log warn;</span><br><span class="line">pid        /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       /etc/nginx/mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format  main  <span class="string">'$remote_addr - $remote_user [$time_local] "$request" '</span></span><br><span class="line">                      <span class="string">'$status $body_bytes_sent "$http_referer" '</span></span><br><span class="line">                      <span class="string">'"$http_user_agent" "$http_x_forwarded_for"'</span>;</span><br><span class="line"></span><br><span class="line">    access_log  /var/<span class="built_in">log</span>/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    <span class="comment">#tcp_nopush     on;</span></span><br><span class="line"></span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#gzip  on;</span></span><br><span class="line">	</span><br><span class="line">	proxy_redirect          off;</span><br><span class="line">	proxy_set_header        Host <span class="variable">$host</span>;</span><br><span class="line">	proxy_set_header        X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">	proxy_set_header        X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">	client_max_body_size    10m;</span><br><span class="line">	client_body_buffer_size   128k;</span><br><span class="line">	proxy_connect_timeout   5s;</span><br><span class="line">	proxy_send_timeout      5s;</span><br><span class="line">	proxy_read_timeout      5s;</span><br><span class="line">	proxy_buffer_size        4k;</span><br><span class="line">	proxy_buffers           4 32k;</span><br><span class="line">	proxy_busy_buffers_size  64k;</span><br><span class="line">	proxy_temp_file_write_size 64k;</span><br><span class="line">	</span><br><span class="line">	upstream fn &#123;</span><br><span class="line">		server 192.168.99.104:6501;</span><br><span class="line">		server 192.168.99.104:6502;</span><br><span class="line">		server 192.168.99.104:6503;</span><br><span class="line">	&#125;</span><br><span class="line">	server &#123;</span><br><span class="line">        listen       6601;</span><br><span class="line">        server_name  192.168.99.104; </span><br><span class="line">        location / &#123;  </span><br><span class="line">            proxy_pass   http://fn;</span><br><span class="line">            index  index.html index.htm;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#启动ff1节点</span></span><br><span class="line">docker run -it -d --name ff1 -v /home/ff1/nginx.conf:/etc/nginx/nginx.conf --net=host --privileged nginx</span><br></pre></td></tr></table></figure></p>
<h6 id="ff2-keepalived-nginx节点"><a href="#ff2-keepalived-nginx节点" class="headerlink" title="ff2  keepalived-nginx节点"></a>ff2  keepalived-nginx节点</h6><p>宿主机/home/ff2/nginx.conf配置文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">user  nginx;</span><br><span class="line">worker_processes  1;</span><br><span class="line">error_log  /var/<span class="built_in">log</span>/nginx/error.log warn;</span><br><span class="line">pid        /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       /etc/nginx/mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format  main  <span class="string">'$remote_addr - $remote_user [$time_local] "$request" '</span></span><br><span class="line">                      <span class="string">'$status $body_bytes_sent "$http_referer" '</span></span><br><span class="line">                      <span class="string">'"$http_user_agent" "$http_x_forwarded_for"'</span>;</span><br><span class="line"></span><br><span class="line">    access_log  /var/<span class="built_in">log</span>/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    <span class="comment">#tcp_nopush     on;</span></span><br><span class="line"></span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#gzip  on;</span></span><br><span class="line">	</span><br><span class="line">	proxy_redirect          off;</span><br><span class="line">	proxy_set_header        Host <span class="variable">$host</span>;</span><br><span class="line">	proxy_set_header        X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">	proxy_set_header        X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">	client_max_body_size    10m;</span><br><span class="line">	client_body_buffer_size   128k;</span><br><span class="line">	proxy_connect_timeout   5s;</span><br><span class="line">	proxy_send_timeout      5s;</span><br><span class="line">	proxy_read_timeout      5s;</span><br><span class="line">	proxy_buffer_size        4k;</span><br><span class="line">	proxy_buffers           4 32k;</span><br><span class="line">	proxy_busy_buffers_size  64k;</span><br><span class="line">	proxy_temp_file_write_size 64k;</span><br><span class="line">	</span><br><span class="line">	upstream fn &#123;</span><br><span class="line">		server 192.168.99.104:6501;</span><br><span class="line">		server 192.168.99.104:6502;</span><br><span class="line">		server 192.168.99.104:6503;</span><br><span class="line">	&#125;</span><br><span class="line">	server &#123;</span><br><span class="line">        listen       6602;</span><br><span class="line">        server_name  192.168.99.104; </span><br><span class="line">        location / &#123;  </span><br><span class="line">            proxy_pass   http://fn;</span><br><span class="line">            index  index.html index.htm;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#启动ff2节点</span></span><br><span class="line">docker run -it -d --name ff2 -v /home/ff2/nginx.conf:/etc/nginx/nginx.conf --net=host --privileged nginx</span><br></pre></td></tr></table></figure></p>
<h5 id="配置双机热备"><a href="#配置双机热备" class="headerlink" title="配置双机热备"></a>配置双机热备</h5><h6 id="ff1节点安装keepalived"><a href="#ff1节点安装keepalived" class="headerlink" title="ff1节点安装keepalived"></a>ff1节点安装keepalived</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#进入ff1节点</span></span><br><span class="line">docker <span class="built_in">exec</span> -it ff1 bash</span><br><span class="line"><span class="comment">#更新软件包</span></span><br><span class="line">apt-get update</span><br><span class="line"><span class="comment">#安装VIM</span></span><br><span class="line">apt-get install vim</span><br><span class="line"><span class="comment">#安装Keepalived</span></span><br><span class="line">apt-get install keepalived</span><br><span class="line"><span class="comment">#编辑Keepalived配置文件(如下)</span></span><br><span class="line">vim /etc/keepalived/keepalived.conf</span><br><span class="line"><span class="comment">#启动Keepalived</span></span><br><span class="line">service keepalived start</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens33</span><br><span class="line">    virtual_router_id 52</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 123456</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.99.152</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">virtual_server 192.168.99.151 6701 &#123;</span><br><span class="line">    delay_loop 3</span><br><span class="line">    lb_algo rr</span><br><span class="line">    lb_kind NAT</span><br><span class="line">    persistence_timeout 50</span><br><span class="line">    protocol TCP</span><br><span class="line">    real_server 192.168.99.104 6601 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="ff2节点安装keepalived"><a href="#ff2节点安装keepalived" class="headerlink" title="ff2节点安装keepalived"></a>ff2节点安装keepalived</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#进入ff2节点</span></span><br><span class="line">docker <span class="built_in">exec</span> -it ff2 bash</span><br><span class="line"><span class="comment">#更新软件包</span></span><br><span class="line">apt-get update</span><br><span class="line"><span class="comment">#安装VIM</span></span><br><span class="line">apt-get install vim</span><br><span class="line"><span class="comment">#安装Keepalived</span></span><br><span class="line">apt-get install keepalived</span><br><span class="line"><span class="comment">#编辑Keepalived配置文件(如下)</span></span><br><span class="line">vim /etc/keepalived/keepalived.conf</span><br><span class="line"><span class="comment">#启动Keepalived</span></span><br><span class="line">service keepalived start</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens33</span><br><span class="line">    virtual_router_id 52</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 123456</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.99.152</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">virtual_server 192.168.99.151 6701 &#123;</span><br><span class="line">    delay_loop 3</span><br><span class="line">    lb_algo rr</span><br><span class="line">    lb_kind NAT</span><br><span class="line">    persistence_timeout 50</span><br><span class="line">    protocol TCP</span><br><span class="line">    real_server 192.168.99.104 6602 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="多台虚拟机安装docker-swarm-集群"><a href="#多台虚拟机安装docker-swarm-集群" class="headerlink" title="多台虚拟机安装docker swarm 集群"></a>多台虚拟机安装docker swarm 集群</h3><p>上面只是在一台虚拟机安装集群，不过实际应用上，是在多台虚拟机安装集群，<br>docker有三服务:</p>
<p>docker-machine：容器服务</p>
<p>docker-compose:脚本执行服务，简化脚本编写</p>
<p>docker-swarm：容器集群技术</p>
<h4 id="docker-swarm-去中心化的设计"><a href="#docker-swarm-去中心化的设计" class="headerlink" title="docker-swarm 去中心化的设计"></a>docker-swarm 去中心化的设计</h4><p>docker-swarm 集群节点有俩种节点：</p>
<p>1、manager节点管理集群的，本身承担worker节点工作，可以有多个manager节点，但同时只有一个manager节点工作，一个manager节点挂掉，会选择新的manager节点工作</p>
<p>2、work节点:工作节点，部署容器项目，有多个work节点</p>
<h4 id="创建swarm集群"><a href="#创建swarm集群" class="headerlink" title="创建swarm集群"></a>创建swarm集群</h4><p>命令<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker swarm init</span><br></pre></td></tr></table></figure></p>
<p>后面添加的参数，可加-可不加:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">--listen-addr ip:port <span class="comment">#管理者节点，一个swarm必须有管理者节点，可以选择多个管理者节点ip</span></span><br><span class="line"></span><br><span class="line">--advertise-addr <span class="comment">#广播地址，其他节点通过ip加入到集群</span></span><br></pre></td></tr></table></figure></p>
<h4 id="加入swarm集群"><a href="#加入swarm集群" class="headerlink" title="加入swarm集群"></a>加入swarm集群</h4><p>在主机器上执行下面命令，会输出加入manager，work 命令<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker swarm join-token manager <span class="comment"># 以manager身份加入</span></span><br><span class="line"></span><br><span class="line">docker swarm join-token manager <span class="comment"># 以work身份加入</span></span><br></pre></td></tr></table></figure></p>
<p>比如:第一个命令 docker swarm join .…. 是以work身份加入集群，<br>第二个命令 docker swarm join .…. 是以manager身份加入集群，<br><img src="images/docker24.jpg" alt=""></p>
<h4 id="查看swarm集群节点"><a href="#查看swarm集群节点" class="headerlink" title="查看swarm集群节点"></a>查看swarm集群节点</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker node ls <span class="comment">#只能在manager节点执行</span></span><br></pre></td></tr></table></figure>
<h4 id="查看swarm集群网络"><a href="#查看swarm集群网络" class="headerlink" title="查看swarm集群网络"></a>查看swarm集群网络</h4><p>创建集群时，集群会生成一个共享网络，这个只是manag节点管理集群的网络，ingress<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network ls</span><br></pre></td></tr></table></figure></p>
<p><img src="images/docker25.jpg" alt=""></p>
<h4 id="创建swarm集群容器通讯共享网络"><a href="#创建swarm集群容器通讯共享网络" class="headerlink" title="创建swarm集群容器通讯共享网络"></a>创建swarm集群容器通讯共享网络</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network create -d overlay --attachable swarm_test</span><br></pre></td></tr></table></figure>
<p><img src="images/docker26.jpg" alt=""></p>
<h4 id="创建pxc集群"><a href="#创建pxc集群" class="headerlink" title="创建pxc集群"></a>创建pxc集群</h4><p>下载安装pxc镜像<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull percona/percona-xtradb-cluster</span><br></pre></td></tr></table></figure></p>
<p>假如5个mysql数据库，分布安装在四台虚拟主机，俩台manager，俩台work，一台manager主机安装俩个数据库，其他每台机器安装一个数据库</p>
<h5 id="创建第一个pxc容器-1"><a href="#创建第一个pxc容器-1" class="headerlink" title="创建第一个pxc容器"></a>创建第一个pxc容器</h5><p>主要是设置共享网络–net=swarm_test<br><img src="images/docker27.jpg" alt=""></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 3306:3306 -e MYSQL_ROOT_PASSWORD=root -e CLUSTER_NAME=PXC -e XTRABACKUP_PASSWORD=root -v v1:/var/lib/mysql -v backup:/data --privileged --name=node1 --net=swarm_test  pxc</span><br></pre></td></tr></table></figure>
<p>3306:3306:3307是宿主机端口，3306为容器mysql端口，为了在外面能访问到容器mysql，需要把端口映射到宿主机上</p>
<p>1、MYSQL_ROOT_PASSWORD=root：设置mysql 的root账户密码</p>
<p>2、CLUSTER_NAME=PXC:集群名称</p>
<p>3、XTRABACKUP_PASSWORD=root:mysql 之间通讯的密码</p>
<p>4、-v v1:/var/lib/mysql -v backup:/data :v1是docker卷,映射宿主机docker卷和容器的目录，每一个容器一个docker卷</p>
<p>5、–privileged:赋予容器修改宿主机目录文件的权限</p>
<p>6、–name=node1:容器名称</p>
<p>7、–net=swarm_test:共享网络ip地址</p>
<p>8、pxc:镜像名称</p>
<h5 id="创建其他pxc容器-1"><a href="#创建其他pxc容器-1" class="headerlink" title="创建其他pxc容器"></a>创建其他pxc容器</h5><p>创建其他容器和第一个容器有所不同，主要添加CLUSTER_JOIN=node1 ，意思是和node1（第一个容器）容器同步数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 3307:3306 -e MYSQL_ROOT_PASSWORD=root -e CLUSTER_NAME=PXC -e XTRABACKUP_PASSWORD=root  -e  CLUSTER_JOIN=node1 -v v2:/var/lib/mysql -v backup:/data --privileged --name=node2 --net=swarm_test  pxc</span><br><span class="line"></span><br><span class="line">docker run -d -p 3306:3306 -e MYSQL_ROOT_PASSWORD=root -e CLUSTER_NAME=PXC -e XTRABACKUP_PASSWORD=root  -e  CLUSTER_JOIN=node1 -v v3:/var/lib/mysql -v backup:/data --privileged --name=node3 --net=swarm_test  pxc</span><br><span class="line"></span><br><span class="line">docker run -d -p 3306:3306 -e MYSQL_ROOT_PASSWORD=root -e CLUSTER_NAME=PXC -e XTRABACKUP_PASSWORD=root  -e  CLUSTER_JOIN=node1 -v v4:/var/lib/mysql -v backup:/data --privileged --name=node4 --net=swarm_test  pxc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker run -d -p 3306:3306 -e MYSQL_ROOT_PASSWORD=root -e CLUSTER_NAME=PXC -e XTRABACKUP_PASSWORD=root  -e  CLUSTER_JOIN=node1 -v v5:/var/lib/mysql -v backup:/data --privileged --name=node5 --net=swarm_test  pxc</span><br></pre></td></tr></table></figure>
<p>注意事项<br>1、3306:3306:3308，因为宿主机的不同，每台映射到宿主机的端口可以一样</p>
<p>2、 CLUSTER_JOIN=node1:添加关联第一台容器</p>
<p>3、 -v v2:/var/lib/mysql：v2是docker卷</p>
<p>4、–name=node2:每台容器名称都不一样</p>
<p>5、–net=swarm_test:共享网络ip地址</p>
<h5 id="查看节点容器swarm-test共享网络ip"><a href="#查看节点容器swarm-test共享网络ip" class="headerlink" title="查看节点容器swarm_test共享网络ip"></a>查看节点容器swarm_test共享网络ip</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker inspect node1</span><br></pre></td></tr></table></figure>
<p>“IPAdress”:”10.0.0.2”-共享swarm_test共享网络容器ip</p>
<h4 id="删除集群节点"><a href="#删除集群节点" class="headerlink" title="删除集群节点"></a>删除集群节点</h4><p>1、删除虚拟机上的容器</p>
<p>2、退出集群</p>
<p>3、删除集群<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service docker stop</span><br></pre></td></tr></table></figure></p>
<h5 id="主动退出集群，"><a href="#主动退出集群，" class="headerlink" title="主动退出集群，"></a>主动退出集群，</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker swarm leave --force <span class="comment"># manager 退出集群必须使用--force 参数</span></span><br></pre></td></tr></table></figure>
<h5 id="被动退出集群"><a href="#被动退出集群" class="headerlink" title="被动退出集群"></a>被动退出集群</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker  node demote 9v8gylom..... <span class="comment"># manager节点先降级成work</span></span><br><span class="line"></span><br><span class="line">docker node rm 9v8gylom..... <span class="comment"># 删除节点</span></span><br><span class="line"></span><br><span class="line">docker node ls <span class="comment"># 查看当前集群有多少节点，节点情况</span></span><br></pre></td></tr></table></figure>
<p><img src="images/docker28.jpg" alt=""></p>
<h3 id="docker图形界面"><a href="#docker图形界面" class="headerlink" title="docker图形界面"></a>docker图形界面</h3><p>portainer管理集群，网络，容器</p>
<h4 id="下载portainer镜像"><a href="#下载portainer镜像" class="headerlink" title="下载portainer镜像"></a>下载portainer镜像</h4><p><img src="images/docker29.jpg" alt=""><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull portainer/portainer</span><br></pre></td></tr></table></figure></p>
<h4 id="开放docker网络管理端口，所有主机都修改"><a href="#开放docker网络管理端口，所有主机都修改" class="headerlink" title="开放docker网络管理端口，所有主机都修改"></a>开放docker网络管理端口，所有主机都修改</h4><p><img src="images/docker30.jpg" alt=""><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/sysconfig/docker</span><br><span class="line">添加如下内容,开放2375端口</span><br><span class="line">OPTIONS=<span class="string">'-Htcp://0.0.0.0:2375 -H unix:///var/run/docker.sock'</span></span><br><span class="line">重启docker service</span><br><span class="line">service docker restart</span><br></pre></td></tr></table></figure></p>
<p>启动portainer 容器，所有主机都要执行<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 9000:9000 portainer/portainer -H tcp:192.168.157.196:2375</span><br></pre></td></tr></table></figure></p>
<p> tcp:192.168.157.196:2375：portainer安装在那台宿主机上，宿主机的ip,管理虚拟机</p>
<p> 访问地址端口9000，注册账号密码192.168.157.196:9000: 管理镜像、容器、网络、数据卷等<br> <img src="images/docker31.jpg" alt=""></p>
<h4 id="虚拟机创建"><a href="#虚拟机创建" class="headerlink" title="虚拟机创建"></a>虚拟机创建</h4><p>默认创建了192.168.157.196还要创建其他虚拟机</p>
<p>点击左侧菜单:Endpoints 添加其他虚拟机，点左侧上面CHANCE ENVIRONMENT,切换虚拟机<br> <img src="images/docker32.jpg" alt=""></p>
<h4 id="swarm创建"><a href="#swarm创建" class="headerlink" title="swarm创建"></a>swarm创建</h4><p>在portainaer无法创建swarm，具体步骤查看上面创建swarm集群，在shell里面执行：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker swarm init</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>查看页面左侧菜单swarm</p>
<p> <img src="images/docker33.jpg" alt=""></p>
<p>创建共享网络swarm_test</p>
<p> <img src="images/docker34.jpg" alt=""></p>
<h4 id="容器创建"><a href="#容器创建" class="headerlink" title="容器创建"></a>容器创建</h4><p>1、创建数据卷<br> <img src="images/docker37.jpg" alt=""><br>2、创建容器<br>容器界面<br> <img src="images/docker35.jpg" alt=""><br> 参数:volume:数据卷，network：网络，env:-e 参数，runtime&amp;resources：权限–privileged ，点击Deploy the container 创建容器<br> <img src="images/docker36.jpg" alt=""></p>
<p> 注意work节点 看不到swarm-test网络，需要在命令行执行创建</p>
<p> 部署方案haproxy ,keepalived<br>  <img src="images/docker39.jpg" alt=""></p>
<h3 id="云平台部署"><a href="#云平台部署" class="headerlink" title="云平台部署"></a>云平台部署</h3>
    </main>
    <footer class="post-footer">
      
      
    </footer>
  </article>
  
  
<div class="reward" id="reward">
  <p>坚持原创技术分享，您的支持是我前进的动力！</p>
  <button id="reward-button" class="button" disable="enable">打赏</button>
  <div id="qr" class="qr" style="display: none;">
    
    
    
  </div>
</div>


  
  
  <div class="post-nav">
    <div class="post-nav-next post-nav-item">
      
      <a href="/2018/06/26/concurrencyPlan/concurrency_plan/" rel="next" title="JAVA并发编程与高并发解决方案 - 高并发解决方案"><i class="fas fa-angle-left"></i><span class="nav-title">JAVA并发编程与高并发解决方案 - 高并发解决方案</span></a>
      
    </div>
    <div class="post-nav-prev post-nav-item">
      
      <a href="/2018/07/12/spring_security/2.SpringSecurityFormAuthentication/" rel="prev" title="使用 Maven Module 搭建spring boot项目（整合Spring Security、Spring Social、spring OAuth）二"><span class="nav-title">使用 Maven Module 搭建spring boot项目（整合Spring Security、Spring Social、spring OAuth）二</span><i class="fas fa-angle-right"></i></a>
      
    </div>
  </div>
  
  
</div>

          </div>
          
          
          
<aside class="sidebar" id="sidebar" style="background: url(/images/sidebar_background.png);">
  
  <div class="search">
    <div class="form-group">
      <i class="fas fa-search"></i><input type="search" id="search-input" name="q" results="0" placeholder="搜索" class="form-control"/>
    </div>
  </div>
  <div class="search-result-box" id="search-result"></div>
  
  
<div class="info sidebar-item" id="info">
  
  <img class="author-avatar" src="/images/avatar.png" alt="龙门小左">
  
  <h1 class="author-name">龙门小左</h1>
  <h2 class="author-description"> </h2>
  <div class="site-count">
    
    <div class="archives-count">
      <div class="site-count-title">归档</div>
      <div><a href="/archives/">21</a></div>
    </div>
    
    
    
  </div>
  
  <div class="rss">
    <a class="rss-link button sidebar-item" href="/atom.xml"><i class="fas fa-rss"></i>RSS</a>
  </div>
  
</div>


  <div class="sidebar-sticky">
    
    




<hr>
<div class="post-toc sidebar-item" id="toc-div">
  <div><i class="fas fa-list-ol"></i>文章目录</div>
  <div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#docker-安装部署分布式web-前后端分离集群"><span class="toc-text">docker  安装部署分布式web 前后端分离集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#学习内容简介"><span class="toc-text">学习内容简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#人人网开源前后端分离项目"><span class="toc-text">人人网开源前后端分离项目</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置docker加载器"><span class="toc-text">配置docker加载器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#几个重要的docker指令"><span class="toc-text">几个重要的docker指令</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#查看容器运行日志"><span class="toc-text">查看容器运行日志</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#进入容器"><span class="toc-text">进入容器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mysql-pxc集群安装"><span class="toc-text">mysql pxc集群安装</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#下载pxc"><span class="toc-text">下载pxc</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#安装mysql集群"><span class="toc-text">安装mysql集群</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#设置网段"><span class="toc-text">设置网段</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#创建docker卷"><span class="toc-text">创建docker卷</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#创建pxc容器集群"><span class="toc-text">创建pxc容器集群</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#创建第一个pxc容器"><span class="toc-text">创建第一个pxc容器</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#创建其他pxc容器"><span class="toc-text">创建其他pxc容器</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#测试集群"><span class="toc-text">测试集群</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#数据库负载均衡"><span class="toc-text">数据库负载均衡</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#负载均衡的必要性"><span class="toc-text">负载均衡的必要性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Haproxy中间件做负载均衡"><span class="toc-text">Haproxy中间件做负载均衡</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#中间件比较"><span class="toc-text">中间件比较</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#docker安装Haproxy镜像"><span class="toc-text">docker安装Haproxy镜像</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#设置Haproxy配置文件"><span class="toc-text">设置Haproxy配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#创建mysql没有权限的haproxy用户，密码为空"><span class="toc-text">创建mysql没有权限的haproxy用户，密码为空</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#创建Haproxy容器"><span class="toc-text">创建Haproxy容器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Haproxy高可用，创建多个haproxy"><span class="toc-text">Haproxy高可用，创建多个haproxy</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Haproxy容器内安装Keepalived，设置虚拟IP"><span class="toc-text">Haproxy容器内安装Keepalived，设置虚拟IP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#宿主机安装Keepalived"><span class="toc-text">宿主机安装Keepalived</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#检测Keepalived高可用"><span class="toc-text">检测Keepalived高可用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#暂停-pxc集群方法"><span class="toc-text">暂停 pxc集群方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#数据库备份"><span class="toc-text">数据库备份</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#数据库还原-只有冷还原"><span class="toc-text">数据库还原-只有冷还原</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安装redis-集群"><span class="toc-text">安装redis 集群</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#高速缓存结束"><span class="toc-text">高速缓存结束</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#redis介绍"><span class="toc-text">redis介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#redis集群介绍"><span class="toc-text">redis集群介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RedisCluster方案介绍"><span class="toc-text">RedisCluster方案介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#安装redis镜像，配置RedisCluster集群"><span class="toc-text">安装redis镜像，配置RedisCluster集群</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#安装Redis镜像"><span class="toc-text">安装Redis镜像</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#创建net2网段"><span class="toc-text">创建net2网段</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#创建6节点Redis容器"><span class="toc-text">创建6节点Redis容器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#启动6节点Redis服务器"><span class="toc-text">启动6节点Redis服务器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#创建Cluster集群"><span class="toc-text">创建Cluster集群</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#重启redis"><span class="toc-text">重启redis</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#部署后端的项目"><span class="toc-text">部署后端的项目</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#修改数据源配置"><span class="toc-text">修改数据源配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#修改redis配置"><span class="toc-text">修改redis配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#进入人人开源后端项目，执行打包（修改配置文件，更改端口，打包三次生成三个JAR文件）"><span class="toc-text">进入人人开源后端项目，执行打包（修改配置文件，更改端口，打包三次生成三个JAR文件）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#安装Java镜像"><span class="toc-text">安装Java镜像</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#创建3节点Java容器"><span class="toc-text">创建3节点Java容器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#访问网站"><span class="toc-text">访问网站</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nginx-负载均衡"><span class="toc-text">nginx 负载均衡</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#安装Nginx镜像"><span class="toc-text">安装Nginx镜像</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#创建Nginx容器，配置负载均衡"><span class="toc-text">创建Nginx容器，配置负载均衡</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#宿主机上-home-n1-nginx-conf配置文件内容如下："><span class="toc-text">宿主机上/home/n1/nginx.conf配置文件内容如下：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#创建第1个Nginx节点"><span class="toc-text">创建第1个Nginx节点</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#宿主机上-home-n2-nginx-conf配置文件内容如下："><span class="toc-text">宿主机上/home/n2/nginx.conf配置文件内容如下：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#创建第2个Nginx节点"><span class="toc-text">创建第2个Nginx节点</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#后端项目双机热备负载均衡"><span class="toc-text">后端项目双机热备负载均衡</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#在Nginx容器安装Keepalived"><span class="toc-text">在Nginx容器安装Keepalived</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#n1节点keepalived"><span class="toc-text">n1节点keepalived</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#n2节点keepalived"><span class="toc-text">n2节点keepalived</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#前端项目部署与负载均衡"><span class="toc-text">前端项目部署与负载均衡</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#设置前端连接后端的ip地址"><span class="toc-text">设置前端连接后端的ip地址</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#打包部署前端项目"><span class="toc-text">打包部署前端项目</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用淘宝镜像-加速下载速度"><span class="toc-text">使用淘宝镜像,加速下载速度</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#在前端项目路径下执行打包指令"><span class="toc-text">在前端项目路径下执行打包指令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#创建3节点的Nginx，部署前端项目"><span class="toc-text">创建3节点的Nginx，部署前端项目</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#nginx-第一个节点"><span class="toc-text">nginx 第一个节点</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#nginx-第二个节点"><span class="toc-text">nginx 第二个节点</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#nginx-第三个节点"><span class="toc-text">nginx 第三个节点</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#利用keepalived配置负载均衡"><span class="toc-text">利用keepalived配置负载均衡</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#ff1-keepalived-nginx节点"><span class="toc-text">ff1  keepalived-nginx节点</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#ff2-keepalived-nginx节点"><span class="toc-text">ff2  keepalived-nginx节点</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#配置双机热备"><span class="toc-text">配置双机热备</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#ff1节点安装keepalived"><span class="toc-text">ff1节点安装keepalived</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#ff2节点安装keepalived"><span class="toc-text">ff2节点安装keepalived</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#多台虚拟机安装docker-swarm-集群"><span class="toc-text">多台虚拟机安装docker swarm 集群</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#docker-swarm-去中心化的设计"><span class="toc-text">docker-swarm 去中心化的设计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#创建swarm集群"><span class="toc-text">创建swarm集群</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#加入swarm集群"><span class="toc-text">加入swarm集群</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#查看swarm集群节点"><span class="toc-text">查看swarm集群节点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#查看swarm集群网络"><span class="toc-text">查看swarm集群网络</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#创建swarm集群容器通讯共享网络"><span class="toc-text">创建swarm集群容器通讯共享网络</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#创建pxc集群"><span class="toc-text">创建pxc集群</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#创建第一个pxc容器-1"><span class="toc-text">创建第一个pxc容器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#创建其他pxc容器-1"><span class="toc-text">创建其他pxc容器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#查看节点容器swarm-test共享网络ip"><span class="toc-text">查看节点容器swarm_test共享网络ip</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#删除集群节点"><span class="toc-text">删除集群节点</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#主动退出集群，"><span class="toc-text">主动退出集群，</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#被动退出集群"><span class="toc-text">被动退出集群</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#docker图形界面"><span class="toc-text">docker图形界面</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#下载portainer镜像"><span class="toc-text">下载portainer镜像</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#开放docker网络管理端口，所有主机都修改"><span class="toc-text">开放docker网络管理端口，所有主机都修改</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#虚拟机创建"><span class="toc-text">虚拟机创建</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#swarm创建"><span class="toc-text">swarm创建</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#容器创建"><span class="toc-text">容器创建</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#云平台部署"><span class="toc-text">云平台部署</span></a></li></ol></li></ol></li></ol></div>
</div>



    
    
    
<hr>
<div class="social-link sidebar-item">
  <div><i class="far fa-address-card"></i>社交链接</p></div>
  <ul>
    
    <li><i class="fas fa-envelope"></i><a href="mailto:youremail@youremailhost" target="_blank">E-Mail</a></li>
    
    <li><i class="fab fa-github"></i><a href="https://github.com/" target="_blank">GitHub</a></li>
    
    <li><i class="fab fa-weibo"></i><a href="https://weibo.com/" target="_blank">Weibo</a></li>
    
  </ul>
</div>


    
    
    
<hr>
<div class="blogroll sidebar-item">
  <div><i class="fas fa-link"></i>友情链接</div>
  <ul>
    
    <li><a href="https://github.com/" target="_blank">GitHub</a></li>
    
    <li><a href="https://developer.mozilla.org/" target="_blank">MDN</a></li>
    
    <li><a href="https://mozilla.github.io/nunjucks/" target="_blank">Nunjucks</a></li>
    
  </ul>
</div>


    
  </div>
</aside>


          
        </div>
      </div>
    </main>
    
<footer id="footer" class="footer" style="background: #33363b;">
  <div class="container">
    <div class="back-to-top">
      <a id="back-to-top"><i class="fas fa-angle-double-up"></i></a>
    </div>
    <div class="footer-container">
      <div class="footer-left">
        <div class="copyright">
          <span class="author">龙门小左</span><span class="year"><i class="far fa-copyright"></i>2018</span>
        </div>
        
        
<div class="busuanzi">
  <span id="busuanzi_container_site_pv"><i class="fas fa-eye"></i><span id="busuanzi_value_site_pv"></span></span><span id="busuanzi_container_site_uv"><i class="fas fa-user"></i><span id="busuanzi_value_site_uv"></span></span><span id="busuanzi_container_page_pv"><i class="far fa-file-alt"></i><span id="busuanzi_value_page_pv"></span></span>
</div>


        
      </div>
      <div class="footer-right">
        <div class="custom-info">
          
          托管于<i class="fab fa-github-alt"></i><a href="https://pages.github.com/" target="_blank">GitHub Pages</a>
          
        </div>
        <div class="powered-by">
          由 <a href="https://hexo.io/" target="_blank">Hexo</a> 强力驱动 | 主题 <a href="https://github.com/AlynxZhou/hexo-theme-aria/" target="_blank">ARIA</a>
        </div>
      </div>
    </div>
  </div>
</footer>


  </body>
</html>
