<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#33363b">
    <meta name="msapplication-TileColor" content="#33363b">
    
    
    
    <meta name="keywords" content="Life, ARIA, Hexo">
    
    
    <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png">
    
    
    <link rel="icon" type="image/png" sizes="192x192" href="/favicons/android-chrome-192x192.png">
    
    
    <link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png">
    
    
    <link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png">
    
    
    <link rel="mask-icon" href="/favicons/safari-pinned-tab.svg" color="#33363b">
    
    
    <link rel="manifest" href="/favicons/site.webmanifest">
    
    
    <meta name="msapplication-config" content="/favicons/browserconfig.xml">
    
    
    <link rel="alternate" href="/atom.xml" title="程序猿的日常" type="application/atom+xml" />
    
    
    <link rel="shortcut icon" type="image/x-icon" href="/favicons/favicon.ico">
    
    
    <link rel="stylesheet" type="text/css" href="/css/normalize.css">
    <link rel="stylesheet" type="text/css" href="/css/index.css">
    
    <link rel="stylesheet" type="text/css" href="/css/sidebar.css">
    
    
    <link rel="stylesheet" type="text/css" href="/css/custom.css">
    <link rel="stylesheet" type="text/css" href="/css/atom-one-dark.css">
    <link rel="stylesheet" type="text/css" href="/css/lightgallery.min.css">
    <script type="text/javascript" src="/js/jquery.min.js"></script>
    <script defer type="text/javascript" src="/js/util.js"></script>
    <script defer type="text/javascript" src="/js/scrollspy.js"></script>
    <script defer type="text/javascript" src="/js/fontawesome-all.min.js"></script>
    <script defer type="text/javascript" src="/js/lightgallery.min.js"></script>
    <script defer type="text/javascript" src="/js/lg-fullscreen.min.js"></script>
    <script defer type="text/javascript" src="/js/lg-hash.min.js"></script>
    <script defer type="text/javascript" src="/js/lg-pager.min.js"></script>
    <script defer type="text/javascript" src="/js/lg-thumbnail.min.js"></script>
    <script defer type="text/javascript" src="/js/lg-zoom.min.js"></script>
    
    <script defer src="/js/busuanzi.pure.mini.js"></script>
    
    
    <script defer type="text/javascript" src="/js/search.js"></script>
    <script type="text/javascript">
    $(document).ready(function () {
      var searchPath = "search.xml";
      if (searchPath.length === 0) {
        searchPath = "search.xml";
      }
      var path = "/" + searchPath;
      searchFunc(path, "search-input", "search-result");
    });
    </script>
    
    
    <script defer type="text/javascript" src="/js/index.js"></script>
    
    <script defer type="text/javascript" src="/js/custom.js"></script>
    <title>程序猿的日常</title>
  </head>
  <body itemscope itemtype="http://schema.org/WebPage" lang="default"  data-spy="scroll" data-target=".list-group">
    
<header id="header" class="header" style="background: #33363b;">
  <div class="container">
    <div class="header-container">
      <div class="header-title">
        <h1 class="title"><a href="/">程序猿的日常</a></h1>
        <h2 class="subtitle"></h2>
      </div>
      <div class="logo">
        <img src="/images/ARIA_logo.png" alt="logo">
      </div>
    </div>
    
<nav id="nav" class="nav">
  <a id="nav-toggle" class="nav-toggle"><i class="fas fa-bars"></i></a>
  <ul id="menu">
    
    <li><a href="/" class="current">首頁</a></li>
    
    <li><a href="/archives/">歸檔</a></li>
    
  </ul>
</nav>


  </div>
</header>


    <main id="main" class="main">
      <div class="container">
        <div class="main-container">
          <div class="content">
            

<div id="index" class="index">
  
  <article class="index-post card" itemscope itemtype="http://schema.org/Article">
    <div class="post-block">
      <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/17/Nexus搭建Maven私服及使用教程/">
      <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
        <meta itemprop="name" content="龙门小左">
        <meta itemprop="description" content="">
        <meta itemprop="image" content="/images/avatar.png">
      </span>
      <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
        <meta itemprop="name" content="程序猿的日常">
      </span>
    </div>
    <header class="post-header">
      <h1 class="post-title" itemprop="name headline">
        <a class="post-title-link post-title-link-external" href="/2018/09/17/Nexus搭建Maven私服及使用教程/" itemprop="url"></a>
      </h1>
      <div class="post-meta">
        
        <span class="post-date">
          <i class="far fa-calendar-plus"></i><span><time title="post-date" itemprop="dateCreated datePublished" datetime="2018-09-17T00:57:35+08:00">2018-09-17 00:57:35</time></span>
        </span>
        
        
        
      </div>
    </header>
    <main class="post-main" itemprop="articleBody">
      
      <p>[TOC]</p>
<h1 id="Nexus-3-x搭建Maven私服及使用教程"><a href="#Nexus-3-x搭建Maven私服及使用教程" class="headerlink" title="Nexus 3.x搭建Maven私服及使用教程"></a>Nexus 3.x搭建Maven私服及使用教程</h1><table>
<thead>
<tr>
<th style="text-align:center">版本</th>
<th style="text-align:center">备注</th>
<th style="text-align:center">编制人</th>
<th style="text-align:center">日期</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">V1.0</td>
<td style="text-align:center">Nexus 3.x搭建Maven私服及使用</td>
<td style="text-align:center">huangz</td>
<td style="text-align:center">2017-07-07</td>
</tr>
</tbody>
</table>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>一般maven项目开发，我们所需的所有构件都需要通过maven的中央仓库和第三方的Maven仓库下载到本地。而一个团队中的所有人都重复地从maven仓库下载构件无疑加大了仓库的负载和浪费了外网带宽，如果网速慢的话，还会影响项目的进程。很多情况下，项目的开发都是在内网进行的，连接不到maven仓库怎么办呢？开发的公共构件怎么让其它项目使用？这个时候我们都会选择为自己的团队搭建属于自己的maven私服，这样既节省了网络带宽也会加速项目搭建的进程，当然前提条件就是你的私服中拥有项目所需的所有构件。</p>
<p>这里的私服是指私有服务器，是架设在局域网的一种特殊的远程仓库，目的是代理远程仓库及部署第三方构件。有了私服之后，当 Maven 需要下载构件时，直接请求私服，私服上存在则下载到本地仓库；否则，私服请求外部的远程仓库，将构件下载到私服，再提供给本地仓库下载（见下图）。</p>
<p>搭建Maven私服，我们选择的是Nexus Repository OSS。它是一个强大的Maven仓库管理器，它极大地简化了本地内部仓库的维护和外部仓库的访问，最重要的是，它是免费开源的！</p>
<p><img src="img/私服示例图.png" alt="" title="私服示例图"></p>
<blockquote>
<p>注：</p>
</blockquote>
<blockquote>
<p>图中的远程仓库处于外网，而私服和本地仓库处于内网</p>
</blockquote>
<h2 id="搭建Maven私服前的说明或准备"><a href="#搭建Maven私服前的说明或准备" class="headerlink" title="搭建Maven私服前的说明或准备"></a>搭建Maven私服前的说明或准备</h2><ul>
<li><p>搭建操作系统为Ubuntu 16.04，Windows也有安装包，但没有尝试过</p>
</li>
<li><p>Apache Maven版本为3.3.9，需要提前安装好，安装过程这里不做讲解，有需要自行谷歌或百度</p>
</li>
<li><p>Intellij IDEA版本为2017.1.3，用于项目发布构建到私服上的测试</p>
</li>
</ul>
<h2 id="搭建Maven私服步骤"><a href="#搭建Maven私服步骤" class="headerlink" title="搭建Maven私服步骤"></a>搭建Maven私服步骤</h2><h3 id="1、到官网下载Nexus安装包"><a href="#1、到官网下载Nexus安装包" class="headerlink" title="1、到官网下载Nexus安装包"></a>1、到官网下载Nexus安装包</h3><ul>
<li><p>Nexus Repository OSS是免费开源的，我们这里下载与操作系统相对应的最新版<code>Nexus Repository Manager OSS 3.x - Unix</code></p>
</li>
<li><p>其下载链接为：<a href="https://www.sonatype.com/download-oss-sonatype" target="_blank" rel="noopener">https://www.sonatype.com/download-oss-sonatype</a> ，该链接可能需要翻墙，打开得比较慢</p>
</li>
</ul>
<h3 id="2、解压安装Nexus"><a href="#2、解压安装Nexus" class="headerlink" title="2、解压安装Nexus"></a>2、解压安装Nexus</h3><ul>
<li><p>将下载好的安装包拷贝到要解压的目录下</p>
</li>
<li><p>然后在终端进入安装包所在的目录，使用命令<code>tar -zxvf ./nexus-3.3.2-02-unix.tar.gz</code>进行解压</p>
</li>
<li><p>解压完后，通过<code>cd nexus</code>命令进入目录，执行<code>ls</code>命令可看到如下图的文件：</p>
</li>
</ul>
<p><img src="img/解压文件.png" alt="无效" title="解压文件"></p>
<blockquote>
<p>注：</p>
</blockquote>
<blockquote>
<p>其中，nexus-3.3.2-02目录中存放启动和关闭文件，以及配置文件，而sonatype-work一般存放数据文件，比如构件的数据</p>
</blockquote>
<h3 id="3、启动Nexus"><a href="#3、启动Nexus" class="headerlink" title="3、启动Nexus"></a>3、启动Nexus</h3><ul>
<li><p>在上一步的终端，通过<code>cd nexus-3.3.2-02/bin</code>进入启动文件目录</p>
</li>
<li><p>然后，通过命令<code>./nexus start</code>或<code>./nexus run</code>启动Nexus，其中<code>start</code>是后台启动，而<code>run</code>不是，会在终端控制台打印出启动信息</p>
</li>
<li><p>启动完成后，打开浏览器，访问<a href="http://localhost:8081/" target="_blank" rel="noopener">http://localhost:8081/</a> 即可看到运行的Nexus，如下图：</p>
</li>
</ul>
<p><img src="img/运行成功.png" alt="无效" title="运行成功"></p>
<h2 id="Nexus使用"><a href="#Nexus使用" class="headerlink" title="Nexus使用"></a>Nexus使用</h2><h3 id="1、说明"><a href="#1、说明" class="headerlink" title="1、说明"></a>1、说明</h3><ul>
<li><p>仓库类型说明</p>
<ul>
<li><p>group(仓库组类型)：又叫组仓库，用于方便开发人员自己设定仓库</p>
</li>
<li><p>hosted(宿主类型)：内部项目的发布仓库（内部开发人员，发布上去存放的仓库），包括为<code>release(发行版)</code>仓库和<code>snapshot(调试版)</code>仓库，创建时最好选择允许重新部署</p>
</li>
<li><p>proxy(代理类型)：从远程中央仓库中寻找数据的仓库</p>
</li>
<li><p>virtual(虚拟类型)：虚拟仓库（这个基本用不到，重点关注上面三个仓库的使用）</p>
</li>
</ul>
</li>
<li><p>自带仓库(组)说明</p>
<ul>
<li><p>maven-central：proxy类型仓库，是Maven中央库，默认从<a href="https://repo1.maven.org/maven2/" target="_blank" rel="noopener">https://repo1.maven.org/maven2/</a> 拉取jar 包</p>
</li>
<li><p>maven-releases：hosted类型仓库，存放私库发行版jar 包</p>
</li>
<li><p>maven-snapshots：hosted类型仓库，存放私库快照（调试版本）jar 包</p>
</li>
<li><p>maven-public：仓库组类型，把上面三个仓库组合在一起对外提供服务，默认包括<code>maven-central</code>、<code>maven-releases</code>和<code>maven-snapshots</code>三个仓库</p>
</li>
</ul>
</li>
<li><p>理解图示：</p>
</li>
</ul>
<p><img src="img/理解图示.png" alt="无效" title="理解图示"></p>
<h3 id="2、登录"><a href="#2、登录" class="headerlink" title="2、登录"></a>2、登录</h3><ul>
<li>点击右上交的<code>Sign in</code>，输入账号密码（初始化账号为<code>admin</code>，密码为<code>admin123</code>）进行登录，如下图所示：</li>
</ul>
<p><img src="img/登录.png" alt="无效" title="登录"></p>
<blockquote>
<p>注：</p>
</blockquote>
<blockquote>
<p>登录后建议立即修改密码，点击右上角的<code>admin</code>即可进行修改，这里不做详述</p>
</blockquote>
<h3 id="3、添加用户账号"><a href="#3、添加用户账号" class="headerlink" title="3、添加用户账号"></a>3、添加用户账号</h3><ul>
<li>Nexus允许添加用户账号，然后，对不同的用户进行不同权限的授权，如下图所示：</li>
</ul>
<p><img src="img/添加用户.png" alt="无效" title="添加用户"></p>
<blockquote>
<p>注：</p>
</blockquote>
<blockquote>
<p>所有字段都是必填的，ID将作为用户名</p>
</blockquote>
<blockquote>
<p>Granted为新建账号进行权限授权，<code>nx-admin</code>为管理员角色，里面配置了最大的权限，不可修改，而<code>nx-anonymous</code>为匿名用户角色，不需要登录，只能查看和下载构件，权限可由管理员进行修改</p>
</blockquote>
<blockquote>
<p>关于权限和角色配置模块，这里就不作介绍了，有兴趣可以查看页面左边的<code>Privileges</code>和<code>Roles</code>菜单</p>
</blockquote>
<h3 id="4、将Maven项目CommonUtils发布到Maven私服"><a href="#4、将Maven项目CommonUtils发布到Maven私服" class="headerlink" title="4、将Maven项目CommonUtils发布到Maven私服"></a>4、将Maven项目CommonUtils发布到Maven私服</h3><ul>
<li>在Maven的配置文件setting.xml的<code>&lt;servers&gt;&lt;/servers&gt;</code>标签中间添加以下配置：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">server</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">id</span>&gt;</span>nexus<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">username</span>&gt;</span>admin<span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">password</span>&gt;</span>******<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>注：</p>
</blockquote>
<blockquote>
<p>其中的id可以任意取，password为Nexus的<code>admin</code>用户的密码，默认为admin123</p>
</blockquote>
<ul>
<li>用Intellij IDEA打开CommonUtils项目，并在pom.xml文件中添加下面配置:</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">distributionManagement</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">id</span>&gt;</span>nexus<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">name</span>&gt;</span>Nexus Release<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">url</span>&gt;</span>http://192.168.1.20:8081/repository/maven-releases/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">snapshotRepository</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">id</span>&gt;</span>nexus<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">name</span>&gt;</span>Nexus Snapshot<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">url</span>&gt;</span>http://192.168.1.20:8081/repository/maven-snapshots/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">snapshotRepository</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">distributionManagement</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>注：</p>
</blockquote>
<blockquote>
<p><code>&lt;repository&gt;&lt;/repository&gt;</code>中配置release仓库，<code>&lt;snapshotRepository&gt;&lt;/snapshotRepository&gt;</code>中配置snapshot仓库</p>
</blockquote>
<blockquote>
<p>其中的id就是Maven的setting.xml文件的server的id，用于发布构件到Maven私服时的认证</p>
</blockquote>
<blockquote>
<p>name可以任意取，url则分别对应release仓库和snapshot仓库的地址，url中的IP就是Maven私服的IP地址</p>
</blockquote>
<blockquote>
<p>发布构件到Maven私服时，会根据pom.xml中的<code>&lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;</code>是否有<code>SNAPSHOT</code>选择发布到哪个仓库中，有则发布到snapshot仓库，否则发布到release仓库</p>
</blockquote>
<ul>
<li>打开Intellij IDEA的Maven Projects，双击<code>deploy</code>进行发布构件到Maven私服，如下图所示:</li>
</ul>
<p><img src="img/发布构件.png" alt="无效" title="发布构件"></p>
<blockquote>
<p>注：</p>
</blockquote>
<blockquote>
<p>发布时，如果pom.xml中的<code>&lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;</code>有<code>SNAPSHOT</code>则发布到snapshot仓库，否则发布到release仓库</p>
</blockquote>
<h3 id="5、发布第三方jar包-以发布支付宝依赖为例子"><a href="#5、发布第三方jar包-以发布支付宝依赖为例子" class="headerlink" title="5、发布第三方jar包(以发布支付宝依赖为例子)"></a>5、发布第三方jar包(以发布支付宝依赖为例子)</h3><ul>
<li>调出终端，执行下面命令</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mvn deploy:deploy-file </span><br><span class="line">  -DgroupId=com.alipay</span><br><span class="line">  -DartifactId=api</span><br><span class="line">  -Dversion=1.0</span><br><span class="line">  -Dpackaging=jar </span><br><span class="line">  -Dfile=/home/quandong/alipay.jar</span><br><span class="line">  -Durl=http://localhost:8081/repository/maven-releases/</span><br><span class="line">  -DrepositoryId=nexus</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注:</p>
</blockquote>
<blockquote>
<p>执行命令前确定安装了Maven</p>
</blockquote>
<blockquote>
<p><code>DgroupId</code>构件的组名</p>
</blockquote>
<blockquote>
<p><code>DartifactId</code>构件名称</p>
</blockquote>
<blockquote>
<p><code>Dversion</code>构件版本号</p>
</blockquote>
<blockquote>
<p><code>Dpackaging</code>构件类型，一般为jar</p>
</blockquote>
<blockquote>
<p><code>Dfile</code>构件所在本地路径</p>
</blockquote>
<blockquote>
<p><code>Durl</code>存放构件的仓库url</p>
</blockquote>
<blockquote>
<p><code>DrepositoryId</code>发布构件时的认证身份，之前在Maven的setting.xml文件中配置的server的id</p>
</blockquote>
<h3 id="6、发布结果"><a href="#6、发布结果" class="headerlink" title="6、发布结果"></a>6、发布结果</h3><ul>
<li>到Maven私服查看发布的构件，如下图所示:</li>
</ul>
<p><img src="img/发布结果.png" alt="无效" title="发布结果"></p>
<h3 id="7、其他项目引用发布的CommonUtils构件-引用api构件也一样"><a href="#7、其他项目引用发布的CommonUtils构件-引用api构件也一样" class="headerlink" title="7、其他项目引用发布的CommonUtils构件(引用api构件也一样)"></a>7、其他项目引用发布的CommonUtils构件(引用api构件也一样)</h3><ul>
<li>在其他项目的pom.xml文件中引入下面的配置，使得项目可以从Maven私服中下载CommonUtils构件</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">id</span>&gt;</span>maven-public<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">name</span>&gt;</span>maven-public<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">url</span>&gt;</span>http://192.168.1.20:8081/repository/maven-public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">releases</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">releases</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.turingdi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commonutils<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>注：</p>
</blockquote>
<blockquote>
<p>其中的url是仓库组的url，仓库组中包括了代理仓库、宿主发行版仓库和宿主调试版仓库</p>
</blockquote>
<blockquote>
<p>保存后，项目会自动从Maven私服中下载CommonUtils构件</p>
</blockquote>
<blockquote>
<p><code>dependency</code>的<code>groupId</code>、<code>artifactId</code>和<code>version</code>要和CommonUtils项目的pom.xml文件配置一样，忘记了可以在Nexus上面的对应构件中查看</p>
</blockquote>
<p><strong>至此，Nexus搭建Maven私服就完成了</strong></p>
<p><strong>欢迎阅读，并希望能指出其中的失误之处，感谢!</strong></p>

      
    </main>
    <footer class="post-footer">
      
    </footer>
  </article>
  
  <article class="index-post card" itemscope itemtype="http://schema.org/Article">
    <div class="post-block">
      <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/17/hello-world/">
      <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
        <meta itemprop="name" content="龙门小左">
        <meta itemprop="description" content="">
        <meta itemprop="image" content="/images/avatar.png">
      </span>
      <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
        <meta itemprop="name" content="程序猿的日常">
      </span>
    </div>
    <header class="post-header">
      <h1 class="post-title" itemprop="name headline">
        <a class="post-title-link post-title-link-external" href="/2018/09/17/hello-world/" itemprop="url">Hello World</a>
      </h1>
      <div class="post-meta">
        
        <span class="post-date">
          <i class="far fa-calendar-plus"></i><span><time title="post-date" itemprop="dateCreated datePublished" datetime="2018-09-17T00:57:35+08:00">2018-09-17 00:57:35</time></span>
        </span>
        
        
        
      </div>
    </header>
    <main class="post-main" itemprop="articleBody">
      
      <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>

      
    </main>
    <footer class="post-footer">
      
    </footer>
  </article>
  
  <article class="index-post card" itemscope itemtype="http://schema.org/Article">
    <div class="post-block">
      <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/17/docker/">
      <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
        <meta itemprop="name" content="龙门小左">
        <meta itemprop="description" content="">
        <meta itemprop="image" content="/images/avatar.png">
      </span>
      <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
        <meta itemprop="name" content="程序猿的日常">
      </span>
    </div>
    <header class="post-header">
      <h1 class="post-title" itemprop="name headline">
        <a class="post-title-link post-title-link-external" href="/2018/09/17/docker/" itemprop="url"></a>
      </h1>
      <div class="post-meta">
        
        <span class="post-date">
          <i class="far fa-calendar-plus"></i><span><time title="post-date" itemprop="dateCreated datePublished" datetime="2018-09-17T00:57:35+08:00">2018-09-17 00:57:35</time></span>
        </span>
        
        
        
      </div>
    </header>
    <main class="post-main" itemprop="articleBody">
      
      <h1 id="《Docker环境下的前后端分离部署与运维》课程脚本"><a href="#《Docker环境下的前后端分离部署与运维》课程脚本" class="headerlink" title="《Docker环境下的前后端分离部署与运维》课程脚本"></a>《Docker环境下的前后端分离部署与运维》课程脚本</h1><h2 id="Docker虚拟机常用命令"><a href="#Docker虚拟机常用命令" class="headerlink" title="Docker虚拟机常用命令"></a>Docker虚拟机常用命令</h2><ol>
<li><p>先更新软件包</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y update</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装Docker虚拟机</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y docker</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行、重启、关闭Docker虚拟机</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">service docker start</span><br><span class="line">service docker start</span><br><span class="line">service docker stop</span><br></pre></td></tr></table></figure>
</li>
<li><p>搜索镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker search 镜像名称</span><br></pre></td></tr></table></figure>
</li>
<li><p>下载镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull 镜像名称</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker images</span><br></pre></td></tr></table></figure>
</li>
<li><p>删除镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rmi 镜像名称</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行容器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run 启动参数  镜像名称</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看容器列表</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker ps -a</span><br></pre></td></tr></table></figure>
</li>
<li><p>停止、挂起、恢复容器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker stop 容器ID</span><br><span class="line">docker pause 容器ID</span><br><span class="line">docker unpase 容器ID</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看容器信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker inspect 容器ID</span><br></pre></td></tr></table></figure>
</li>
<li><p>删除容器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rm 容器ID</span><br></pre></td></tr></table></figure>
</li>
<li><p>数据卷管理</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker volume create 数据卷名称  #创建数据卷</span><br><span class="line">docker volume rm 数据卷名称  #删除数据卷</span><br><span class="line">docker volume inspect 数据卷名称  #查看数据卷</span><br></pre></td></tr></table></figure>
</li>
<li><p>网络管理</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker network ls 查看网络信息</span><br><span class="line">docker network create --subnet=网段 网络名称</span><br><span class="line">docker network rm 网络名称</span><br></pre></td></tr></table></figure>
</li>
<li><p>避免VM虚拟机挂起恢复之后，Docker虚拟机断网</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/sysctl.conf</span><br></pre></td></tr></table></figure>
<p>文件中添加<code>net.ipv4.ip_forward=1</code>这个配置</p>
<p>​<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">重启网络服务</span></span><br><span class="line">systemctl  restart network</span><br><span class="line">​</span><br></pre></td></tr></table></figure></p>
</li>
</ol>
<h2 id="安装PXC集群，负载均衡，双机热备"><a href="#安装PXC集群，负载均衡，双机热备" class="headerlink" title="安装PXC集群，负载均衡，双机热备"></a>安装PXC集群，负载均衡，双机热备</h2><ol>
<li><p>安装PXC镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull percona/percona-xtradb-cluster</span><br></pre></td></tr></table></figure>
</li>
<li><p>为PXC镜像改名</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker tag percona/percona-xtradb-cluster pxc</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建net1网段</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network create --subnet=172.18.0.0/16 net1</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建5个数据卷</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker volume create --name v1</span><br><span class="line">docker volume create --name v2</span><br><span class="line">docker volume create --name v3</span><br><span class="line">docker volume create --name v4</span><br><span class="line">docker volume create --name v5</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建备份数据卷（用于热备份数据）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker volume create --name backup</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建5节点的PXC集群</p>
<p>注意，每个MySQL容器创建之后，因为要执行PXC的初始化和加入集群等工作，耐心等待1分钟左右再用客户端连接MySQL。另外，必须第1个MySQL节点启动成功，用MySQL客户端能连接上之后，再去创建其他MySQL节点。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">创建第1个MySQL节点</span></span><br><span class="line">docker run -d -p 3306:3306 -e MYSQL_ROOT_PASSWORD=abc123456 -e CLUSTER_NAME=PXC -e XTRABACKUP_PASSWORD=abc123456 -v v1:/var/lib/mysql -v backup:/data --privileged --name=node1 --net=net1 --ip 172.18.0.2 pxc</span><br><span class="line"><span class="meta">#</span><span class="bash">创建第2个MySQL节点</span></span><br><span class="line">docker run -d -p 3307:3306 -e MYSQL_ROOT_PASSWORD=abc123456 -e CLUSTER_NAME=PXC -e XTRABACKUP_PASSWORD=abc123456 -e CLUSTER_JOIN=node1 -v v2:/var/lib/mysql -v backup:/data --privileged --name=node2 --net=net1 --ip 172.18.0.3 pxc</span><br><span class="line"><span class="meta">#</span><span class="bash">创建第3个MySQL节点</span></span><br><span class="line">docker run -d -p 3308:3306 -e MYSQL_ROOT_PASSWORD=abc123456 -e CLUSTER_NAME=PXC -e XTRABACKUP_PASSWORD=abc123456 -e CLUSTER_JOIN=node1 -v v3:/var/lib/mysql --privileged --name=node3 --net=net1 --ip 172.18.0.4 pxc</span><br><span class="line"><span class="meta">#</span><span class="bash">创建第4个MySQL节点</span></span><br><span class="line">docker run -d -p 3309:3306 -e MYSQL_ROOT_PASSWORD=abc123456 -e CLUSTER_NAME=PXC -e XTRABACKUP_PASSWORD=abc123456 -e CLUSTER_JOIN=node1 -v v4:/var/lib/mysql --privileged --name=node4 --net=net1 --ip 172.18.0.5 pxc</span><br><span class="line"><span class="meta">#</span><span class="bash">创建第5个MySQL节点</span></span><br><span class="line">docker run -d -p 3310:3306 -e MYSQL_ROOT_PASSWORD=abc123456 -e CLUSTER_NAME=PXC -e XTRABACKUP_PASSWORD=abc123456 -e CLUSTER_JOIN=node1 -v v5:/var/lib/mysql -v backup:/data --privileged --name=node5 --net=net1 --ip 172.18.0.6 pxc</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装Haproxy镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull haproxy</span><br></pre></td></tr></table></figure>
</li>
<li><p>宿主机上编写Haproxy配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /home/soft/haproxy.cfg</span><br></pre></td></tr></table></figure>
<p>配置文件如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">global</span><br><span class="line">	#工作目录</span><br><span class="line">	chroot /usr/local/etc/haproxy</span><br><span class="line">	#日志文件，使用rsyslog服务中local5日志设备（/var/log/local5），等级info</span><br><span class="line">	log 127.0.0.1 local5 info</span><br><span class="line">	#守护进程运行</span><br><span class="line">	daemon</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">	log	global</span><br><span class="line">	mode	http</span><br><span class="line">	#日志格式</span><br><span class="line">	option	httplog</span><br><span class="line">	#日志中不记录负载均衡的心跳检测记录</span><br><span class="line">	option	dontlognull</span><br><span class="line">    #连接超时（毫秒）</span><br><span class="line">	timeout connect 5000</span><br><span class="line">    #客户端超时（毫秒）</span><br><span class="line">	timeout client  50000</span><br><span class="line">	#服务器超时（毫秒）</span><br><span class="line">    timeout server  50000</span><br><span class="line"></span><br><span class="line">#监控界面	</span><br><span class="line">listen  admin_stats</span><br><span class="line">	#监控界面的访问的IP和端口</span><br><span class="line">	bind  0.0.0.0:8888</span><br><span class="line">	#访问协议</span><br><span class="line">    mode        http</span><br><span class="line">	#URI相对地址</span><br><span class="line">    stats uri   /dbs</span><br><span class="line">	#统计报告格式</span><br><span class="line">    stats realm     Global\ statistics</span><br><span class="line">	#登陆帐户信息</span><br><span class="line">    stats auth  admin:abc123456</span><br><span class="line">#数据库负载均衡</span><br><span class="line">listen  proxy-mysql</span><br><span class="line">	#访问的IP和端口</span><br><span class="line">	bind  0.0.0.0:3306  </span><br><span class="line">    #网络协议</span><br><span class="line">	mode  tcp</span><br><span class="line">	#负载均衡算法（轮询算法）</span><br><span class="line">	#轮询算法：roundrobin</span><br><span class="line">	#权重算法：static-rr</span><br><span class="line">	#最少连接算法：leastconn</span><br><span class="line">	#请求源IP算法：source </span><br><span class="line">    balance  roundrobin</span><br><span class="line">	#日志格式</span><br><span class="line">    option  tcplog</span><br><span class="line">	#在MySQL中创建一个没有权限的haproxy用户，密码为空。Haproxy使用这个账户对MySQL数据库心跳检测</span><br><span class="line">    option  mysql-check user haproxy</span><br><span class="line">    server  MySQL_1 172.18.0.2:3306 check weight 1 maxconn 2000  </span><br><span class="line">    server  MySQL_2 172.18.0.3:3306 check weight 1 maxconn 2000  </span><br><span class="line">	server  MySQL_3 172.18.0.4:3306 check weight 1 maxconn 2000 </span><br><span class="line">	server  MySQL_4 172.18.0.5:3306 check weight 1 maxconn 2000</span><br><span class="line">	server  MySQL_5 172.18.0.6:3306 check weight 1 maxconn 2000</span><br><span class="line">	#使用keepalive检测死链</span><br><span class="line">    option  tcpka</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建两个Haproxy容器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">创建第1个Haproxy负载均衡服务器</span></span><br><span class="line">docker run -it -d -p 4001:8888 -p 4002:3306 -v /home/soft/haproxy:/usr/local/etc/haproxy --name h1 --privileged --net=net1 --ip 172.18.0.7 haproxy</span><br><span class="line"><span class="meta">#</span><span class="bash">进入h1容器，启动Haproxy</span></span><br><span class="line">docker exec -it h1 bash</span><br><span class="line">haproxy -f /usr/local/etc/haproxy/haproxy.cfg</span><br><span class="line"><span class="meta">#</span><span class="bash">创建第2个Haproxy负载均衡服务器</span></span><br><span class="line">docker run -it -d -p 4003:8888 -p 4004:3306 -v /home/soft/haproxy:/usr/local/etc/haproxy --name h2 --privileged --net=net1 --ip 172.18.0.8 haproxy</span><br><span class="line"><span class="meta">#</span><span class="bash">进入h2容器，启动Haproxy</span></span><br><span class="line">docker exec -it h2 bash</span><br><span class="line">haproxy -f /usr/local/etc/haproxy/haproxy.cfg</span><br></pre></td></tr></table></figure>
</li>
<li><p>Haproxy容器内安装Keepalived，设置虚拟IP</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">进入h1容器</span></span><br><span class="line">docker exec -it h1 bash</span><br><span class="line"><span class="meta">#</span><span class="bash">更新软件包</span></span><br><span class="line">apt-get update</span><br><span class="line"><span class="meta">#</span><span class="bash">安装VIM</span></span><br><span class="line">apt-get install vim</span><br><span class="line"><span class="meta">#</span><span class="bash">安装Keepalived</span></span><br><span class="line">apt-get install keepalived</span><br><span class="line"><span class="meta">#</span><span class="bash">编辑Keepalived配置文件（参考下方配置文件）</span></span><br><span class="line">vim /etc/keepalived/keepalived.conf</span><br><span class="line"><span class="meta">#</span><span class="bash">启动Keepalived</span></span><br><span class="line">service keepalived start</span><br><span class="line"><span class="meta">#</span><span class="bash">宿主机执行ping命令</span></span><br><span class="line">ping 172.18.0.201</span><br></pre></td></tr></table></figure>
<p>配置文件内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">vrrp_instance  VI_1 &#123;</span><br><span class="line">    state  MASTER</span><br><span class="line">    interface  eth0</span><br><span class="line">    virtual_router_id  51</span><br><span class="line">    priority  100</span><br><span class="line">    advert_int  1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type  PASS</span><br><span class="line">        auth_pass  123456</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        172.18.0.201</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">进入h2容器</span></span><br><span class="line">docker exec -it h2 bash</span><br><span class="line"><span class="meta">#</span><span class="bash">更新软件包</span></span><br><span class="line">apt-get update</span><br><span class="line"><span class="meta">#</span><span class="bash">安装VIM</span></span><br><span class="line">apt-get install vim</span><br><span class="line"><span class="meta">#</span><span class="bash">安装Keepalived</span></span><br><span class="line">apt-get install keepalived</span><br><span class="line"><span class="meta">#</span><span class="bash">编辑Keepalived配置文件</span></span><br><span class="line">vim /etc/keepalived/keepalived.conf</span><br><span class="line"><span class="meta">#</span><span class="bash">启动Keepalived</span></span><br><span class="line">service keepalived start</span><br><span class="line"><span class="meta">#</span><span class="bash">宿主机执行ping命令</span></span><br><span class="line">ping 172.18.0.201</span><br></pre></td></tr></table></figure>
<p>配置文件内容如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">vrrp_instance  VI_1 &#123;</span><br><span class="line">    state  MASTER</span><br><span class="line">    interface  eth0</span><br><span class="line">    virtual_router_id  51</span><br><span class="line">    priority  100</span><br><span class="line">    advert_int  1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type  PASS</span><br><span class="line">        auth_pass  123456</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        172.18.0.201</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>宿主机安装Keepalived，实现双击热备</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">宿主机执行安装Keepalived</span></span><br><span class="line">yum -y install keepalived</span><br><span class="line"><span class="meta">#</span><span class="bash">修改Keepalived配置文件</span></span><br><span class="line">vi /etc/keepalived/keepalived.conf</span><br><span class="line"><span class="meta">#</span><span class="bash">启动Keepalived</span></span><br><span class="line">service keepalived start</span><br></pre></td></tr></table></figure>
<p>Keepalived配置文件如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens33</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">       	192.168.99.150</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">virtual_server 192.168.99.150 8888 &#123;</span><br><span class="line">    delay_loop 3</span><br><span class="line">    lb_algo rr </span><br><span class="line">    lb_kind NAT</span><br><span class="line">    persistence_timeout 50</span><br><span class="line">    protocol TCP</span><br><span class="line"></span><br><span class="line">    real_server 172.18.0.201 8888 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">virtual_server 192.168.99.150 3306 &#123;</span><br><span class="line">    delay_loop 3</span><br><span class="line">    lb_algo rr </span><br><span class="line">    lb_kind NAT</span><br><span class="line">    persistence_timeout 50</span><br><span class="line">    protocol TCP</span><br><span class="line"></span><br><span class="line">    real_server 172.18.0.201 3306 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>热备份数据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">进入node1容器</span></span><br><span class="line">docker exec -it node1 bash</span><br><span class="line"><span class="meta">#</span><span class="bash">更新软件包</span></span><br><span class="line">apt-get update</span><br><span class="line"><span class="meta">#</span><span class="bash">安装热备工具</span></span><br><span class="line">apt-get install percona-xtrabackup-24</span><br><span class="line"><span class="meta">#</span><span class="bash">全量热备</span></span><br><span class="line">innobackupex --user=root --password=abc123456 /data/backup/full</span><br></pre></td></tr></table></figure>
</li>
<li><p>冷还原数据<br>停止其余4个节点，并删除节点</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker stop node2</span><br><span class="line">docker stop node3</span><br><span class="line">docker stop node4</span><br><span class="line">docker stop node5</span><br><span class="line">docker rm node2</span><br><span class="line">docker rm node3</span><br><span class="line">docker rm node4</span><br><span class="line">docker rm node5</span><br></pre></td></tr></table></figure>
<p>node1容器中删除MySQL的数据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">删除数据</span></span><br><span class="line">rm -rf /var/lib/mysql/*</span><br><span class="line"><span class="meta">#</span><span class="bash">清空事务</span></span><br><span class="line">innobackupex --user=root --password=abc123456 --apply-back /data/backup/full/2018-04-15_05-09-07/</span><br><span class="line"><span class="meta">#</span><span class="bash">还原数据</span></span><br><span class="line">innobackupex --user=root --password=abc123456 --copy-back  /data/backup/full/2018-04-15_05-09-07/</span><br></pre></td></tr></table></figure>
<p>重新创建其余4个节点，组件PXC集群</p>
</li>
</ol>
<h2 id="安装Redis，配置RedisCluster集群"><a href="#安装Redis，配置RedisCluster集群" class="headerlink" title="安装Redis，配置RedisCluster集群"></a>安装Redis，配置RedisCluster集群</h2><ol>
<li><p>安装Redis镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull yyyyttttwwww/redis</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建net2网段</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network create --subnet=172.19.0.0/16 net2</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建6节点Redis容器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker run -it -d --name r1 -p 5001:6379 --net=net2 --ip 172.19.0.2 redis bash</span><br><span class="line">docker run -it -d --name r2 -p 5002:6379 --net=net2 --ip 172.19.0.3 redis bash</span><br><span class="line">docker run -it -d --name r3 -p 5003:6379 --net=net2 --ip 172.19.0.4 redis bash</span><br><span class="line">docker run -it -d --name r4 -p 5004:6379 --net=net2 --ip 172.19.0.5 redis bash</span><br><span class="line">docker run -it -d --name r5 -p 5005:6379 --net=net2 --ip 172.19.0.6 redis bash</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动6节点Redis服务器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">进入r1节点</span></span><br><span class="line">docker exec -it r1 bash</span><br><span class="line">cp /home/redis/redis.conf /usr/redis/redis.conf</span><br><span class="line">cd /usr/redis/src</span><br><span class="line">./redis-server ../redis.conf</span><br><span class="line"><span class="meta">#</span><span class="bash">进入r2节点</span></span><br><span class="line">docker exec -it r2 bash</span><br><span class="line">cp /home/redis/redis.conf /usr/redis/redis.conf</span><br><span class="line">cd /usr/redis/src</span><br><span class="line">./redis-server ../redis.conf</span><br><span class="line"><span class="meta">#</span><span class="bash">进入r3节点</span></span><br><span class="line">docker exec -it r3 bash</span><br><span class="line">cp /home/redis/redis.conf /usr/redis/redis.conf</span><br><span class="line">cd /usr/redis/src</span><br><span class="line">./redis-server ../redis.conf</span><br><span class="line"><span class="meta">#</span><span class="bash">进入r4节点</span></span><br><span class="line">docker exec -it r4 bash</span><br><span class="line">cp /home/redis/redis.conf /usr/redis/redis.conf</span><br><span class="line">cd /usr/redis/src</span><br><span class="line">./redis-server ../redis.conf</span><br><span class="line"><span class="meta">#</span><span class="bash">进入r5节点</span></span><br><span class="line">docker exec -it r5 bash</span><br><span class="line">cp /home/redis/redis.conf /usr/redis/redis.conf</span><br><span class="line">cd /usr/redis/src</span><br><span class="line">./redis-server ../redis.conf</span><br><span class="line"><span class="meta">#</span><span class="bash">进入r6节点</span></span><br><span class="line">docker exec -it r6 bash</span><br><span class="line">cp /home/redis/redis.conf /usr/redis/redis.conf</span><br><span class="line">cd /usr/redis/src</span><br><span class="line">./redis-server ../redis.conf</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建Cluster集群</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">在r1节点上执行下面的指令</span></span><br><span class="line">cd /usr/redis/src</span><br><span class="line">mkdir -p ../cluster</span><br><span class="line">cp redis-trib.rb ../cluster/</span><br><span class="line">cd ../cluster</span><br><span class="line"><span class="meta">#</span><span class="bash">创建Cluster集群</span></span><br><span class="line">./redis-trib.rb create --replicas 1 172.19.0.2:6379 172.19.0.3:6379 172.19.0.4:6379 172.19.0.5:6379 172.19.0.6:6379 172.19.0.7:6379</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="打包部署后端项目"><a href="#打包部署后端项目" class="headerlink" title="打包部署后端项目"></a>打包部署后端项目</h2><ol>
<li><p>进入人人开源后端项目，执行打包（修改配置文件，更改端口，打包三次生成三个JAR文件）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn clean install -Dmaven.test.skip=true</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装Java镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull java</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建3节点Java容器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">创建数据卷，上传JAR文件</span></span><br><span class="line">docker volume create j1</span><br><span class="line"><span class="meta">#</span><span class="bash">启动容器</span></span><br><span class="line">docker run -it -d --name j1 -v j1:/home/soft --net=host java</span><br><span class="line"><span class="meta">#</span><span class="bash">进入j1容器</span></span><br><span class="line">docker exec -it j1 bash</span><br><span class="line"><span class="meta">#</span><span class="bash">启动Java项目</span></span><br><span class="line">nohup java -jar /home/soft/renren-fast.jar</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">创建数据卷，上传JAR文件</span></span><br><span class="line">docker volume create j2</span><br><span class="line"><span class="meta">#</span><span class="bash">启动容器</span></span><br><span class="line">docker run -it -d --name j2 -v j2:/home/soft --net=host java</span><br><span class="line"><span class="meta">#</span><span class="bash">进入j1容器</span></span><br><span class="line">docker exec -it j2 bash</span><br><span class="line"><span class="meta">#</span><span class="bash">启动Java项目</span></span><br><span class="line">nohup java -jar /home/soft/renren-fast.jar</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">创建数据卷，上传JAR文件</span></span><br><span class="line">docker volume create j3</span><br><span class="line"><span class="meta">#</span><span class="bash">启动容器</span></span><br><span class="line">docker run -it -d --name j3 -v j3:/home/soft --net=host java</span><br><span class="line"><span class="meta">#</span><span class="bash">进入j1容器</span></span><br><span class="line">docker exec -it j3 bash</span><br><span class="line"><span class="meta">#</span><span class="bash">启动Java项目</span></span><br><span class="line">nohup java -jar /home/soft/renren-fast.jar</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装Nginx镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull nginx</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建Nginx容器，配置负载均衡</p>
<p>宿主机上/home/n1/nginx.conf配置文件内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">user  nginx;</span><br><span class="line">worker_processes  1;</span><br><span class="line">error_log  /var/log/nginx/error.log warn;</span><br><span class="line">pid        /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       /etc/nginx/mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format  main  &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;</span><br><span class="line">                      &apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;</span><br><span class="line">                      &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;</span><br><span class="line"></span><br><span class="line">    access_log  /var/log/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    #tcp_nopush     on;</span><br><span class="line"></span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    #gzip  on;</span><br><span class="line">	</span><br><span class="line">	proxy_redirect          off;</span><br><span class="line">	proxy_set_header        Host $host;</span><br><span class="line">	proxy_set_header        X-Real-IP $remote_addr;</span><br><span class="line">	proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">	client_max_body_size    10m;</span><br><span class="line">	client_body_buffer_size   128k;</span><br><span class="line">	proxy_connect_timeout   5s;</span><br><span class="line">	proxy_send_timeout      5s;</span><br><span class="line">	proxy_read_timeout      5s;</span><br><span class="line">	proxy_buffer_size        4k;</span><br><span class="line">	proxy_buffers           4 32k;</span><br><span class="line">	proxy_busy_buffers_size  64k;</span><br><span class="line">	proxy_temp_file_write_size 64k;</span><br><span class="line">	</span><br><span class="line">	upstream tomcat &#123;</span><br><span class="line">		server 192.168.99.104:6001;</span><br><span class="line">		server 192.168.99.104:6002;</span><br><span class="line">		server 192.168.99.104:6003;</span><br><span class="line">	&#125;</span><br><span class="line">	server &#123;</span><br><span class="line">        listen       6101;</span><br><span class="line">        server_name  192.168.99.104; </span><br><span class="line">        location / &#123;  </span><br><span class="line">            proxy_pass   http://tomcat;</span><br><span class="line">            index  index.html index.htm;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建第1个Nginx节点</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it -d --name n1 -v /home/n1/nginx.conf:/etc/nginx/nginx.conf --net=host --privileged nginx</span><br></pre></td></tr></table></figure>
<p>宿主机上/home/n2/nginx.conf配置文件内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">user  nginx;</span><br><span class="line">worker_processes  1;</span><br><span class="line">error_log  /var/log/nginx/error.log warn;</span><br><span class="line">pid        /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       /etc/nginx/mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format  main  &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;</span><br><span class="line">                      &apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;</span><br><span class="line">                      &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;</span><br><span class="line"></span><br><span class="line">    access_log  /var/log/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    #tcp_nopush     on;</span><br><span class="line"></span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    #gzip  on;</span><br><span class="line">	</span><br><span class="line">	proxy_redirect          off;</span><br><span class="line">	proxy_set_header        Host $host;</span><br><span class="line">	proxy_set_header        X-Real-IP $remote_addr;</span><br><span class="line">	proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">	client_max_body_size    10m;</span><br><span class="line">	client_body_buffer_size   128k;</span><br><span class="line">	proxy_connect_timeout   5s;</span><br><span class="line">	proxy_send_timeout      5s;</span><br><span class="line">	proxy_read_timeout      5s;</span><br><span class="line">	proxy_buffer_size        4k;</span><br><span class="line">	proxy_buffers           4 32k;</span><br><span class="line">	proxy_busy_buffers_size  64k;</span><br><span class="line">	proxy_temp_file_write_size 64k;</span><br><span class="line">	</span><br><span class="line">	upstream tomcat &#123;</span><br><span class="line">		server 192.168.99.104:6001;</span><br><span class="line">		server 192.168.99.104:6002;</span><br><span class="line">		server 192.168.99.104:6003;</span><br><span class="line">	&#125;</span><br><span class="line">	server &#123;</span><br><span class="line">        listen       6102;</span><br><span class="line">        server_name  192.168.99.104; </span><br><span class="line">        location / &#123;  </span><br><span class="line">            proxy_pass   http://tomcat;</span><br><span class="line">            index  index.html index.htm;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建第2个Nginx节点</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it -d --name n2 -v /home/n2/nginx.conf:/etc/nginx/nginx.conf --net=host --privileged nginx</span><br></pre></td></tr></table></figure>
</li>
<li><p>在Nginx容器安装Keepalived</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">进入n1节点</span></span><br><span class="line">docker exec -it n1 bash</span><br><span class="line"><span class="meta">#</span><span class="bash">更新软件包</span></span><br><span class="line">apt-get update</span><br><span class="line"><span class="meta">#</span><span class="bash">安装VIM</span></span><br><span class="line">apt-get install vim</span><br><span class="line"><span class="meta">#</span><span class="bash">安装Keepalived</span></span><br><span class="line">apt-get install keepalived</span><br><span class="line"><span class="meta">#</span><span class="bash">编辑Keepalived配置文件(如下)</span></span><br><span class="line">vim /etc/keepalived/keepalived.conf</span><br><span class="line"><span class="meta">#</span><span class="bash">启动Keepalived</span></span><br><span class="line">service keepalived start</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens33</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 123456</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.99.151</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">virtual_server 192.168.99.151 6201 &#123;</span><br><span class="line">    delay_loop 3</span><br><span class="line">    lb_algo rr</span><br><span class="line">    lb_kind NAT</span><br><span class="line">    persistence_timeout 50</span><br><span class="line">    protocol TCP</span><br><span class="line">    real_server 192.168.99.104 6101 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">进入n1节点</span></span><br><span class="line">docker exec -it n2 bash</span><br><span class="line"><span class="meta">#</span><span class="bash">更新软件包</span></span><br><span class="line">apt-get update</span><br><span class="line"><span class="meta">#</span><span class="bash">安装VIM</span></span><br><span class="line">apt-get install vim</span><br><span class="line"><span class="meta">#</span><span class="bash">安装Keepalived</span></span><br><span class="line">apt-get install keepalived</span><br><span class="line"><span class="meta">#</span><span class="bash">编辑Keepalived配置文件(如下)</span></span><br><span class="line">vim /etc/keepalived/keepalived.conf</span><br><span class="line"><span class="meta">#</span><span class="bash">启动Keepalived</span></span><br><span class="line">service keepalived start</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens33</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 123456</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.99.151</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">virtual_server 192.168.99.151 6201 &#123;</span><br><span class="line">    delay_loop 3</span><br><span class="line">    lb_algo rr</span><br><span class="line">    lb_kind NAT</span><br><span class="line">    persistence_timeout 50</span><br><span class="line">    protocol TCP</span><br><span class="line">    real_server 192.168.99.104 6102 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="打包部署后端项目-1"><a href="#打包部署后端项目-1" class="headerlink" title="打包部署后端项目"></a>打包部署后端项目</h2><ol>
<li><p>在前端项目路径下执行打包指令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm run build</span><br></pre></td></tr></table></figure>
</li>
<li><p>build目录的文件拷贝到宿主机的/home/fn1/renren-vue、/home/fn2/renren-vue、/home/fn3/renren-vue的目录下面</p>
</li>
<li><p>创建3节点的Nginx，部署前端项目</p>
<p>宿主机/home/fn1/nginx.conf的配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">user  nginx;</span><br><span class="line">worker_processes  1;</span><br><span class="line">error_log  /var/log/nginx/error.log warn;</span><br><span class="line">pid        /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       /etc/nginx/mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format  main  &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;</span><br><span class="line">                      &apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;</span><br><span class="line">                      &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;</span><br><span class="line"></span><br><span class="line">    access_log  /var/log/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    #tcp_nopush     on;</span><br><span class="line"></span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    #gzip  on;</span><br><span class="line">	</span><br><span class="line">	proxy_redirect          off;</span><br><span class="line">	proxy_set_header        Host $host;</span><br><span class="line">	proxy_set_header        X-Real-IP $remote_addr;</span><br><span class="line">	proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">	client_max_body_size    10m;</span><br><span class="line">	client_body_buffer_size   128k;</span><br><span class="line">	proxy_connect_timeout   5s;</span><br><span class="line">	proxy_send_timeout      5s;</span><br><span class="line">	proxy_read_timeout      5s;</span><br><span class="line">	proxy_buffer_size        4k;</span><br><span class="line">	proxy_buffers           4 32k;</span><br><span class="line">	proxy_busy_buffers_size  64k;</span><br><span class="line">	proxy_temp_file_write_size 64k;</span><br><span class="line">	</span><br><span class="line">	server &#123;</span><br><span class="line">		listen 6501;</span><br><span class="line">		server_name  192.168.99.104;</span><br><span class="line">		location  /  &#123;</span><br><span class="line">			root  /home/fn1/renren-vue;</span><br><span class="line">			index  index.html;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">启动第fn1节点</span></span><br><span class="line">docker run -it -d --name fn1 -v /home/fn1/nginx.conf:/etc/nginx/nginx.conf -v /home/fn1/renren-vue:/home/fn1/renren-vue --privileged --net=host nginx</span><br></pre></td></tr></table></figure>
<p>宿主机/home/fn2/nginx.conf的配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">user  nginx;</span><br><span class="line">worker_processes  1;</span><br><span class="line">error_log  /var/log/nginx/error.log warn;</span><br><span class="line">pid        /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       /etc/nginx/mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '</span><br><span class="line">                      '$status $body_bytes_sent "$http_referer" '</span><br><span class="line">                      '"$http_user_agent" "$http_x_forwarded_for"';</span><br><span class="line"></span><br><span class="line">    access_log  /var/log/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    #tcp_nopush     on;</span><br><span class="line"></span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    #gzip  on;</span><br><span class="line">	</span><br><span class="line">	proxy_redirect          off;</span><br><span class="line">	proxy_set_header        Host $host;</span><br><span class="line">	proxy_set_header        X-Real-IP $remote_addr;</span><br><span class="line">	proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">	client_max_body_size    10m;</span><br><span class="line">	client_body_buffer_size   128k;</span><br><span class="line">	proxy_connect_timeout   5s;</span><br><span class="line">	proxy_send_timeout      5s;</span><br><span class="line">	proxy_read_timeout      5s;</span><br><span class="line">	proxy_buffer_size        4k;</span><br><span class="line">	proxy_buffers           4 32k;</span><br><span class="line">	proxy_busy_buffers_size  64k;</span><br><span class="line">	proxy_temp_file_write_size 64k;</span><br><span class="line">	</span><br><span class="line">	server &#123;</span><br><span class="line">		listen 6502;</span><br><span class="line">		server_name  192.168.99.104;</span><br><span class="line">		location  /  &#123;</span><br><span class="line">			root  /home/fn2/renren-vue;</span><br><span class="line">			index  index.html;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">启动第fn2节点</span></span><br><span class="line">docker run -it -d --name fn2 -v /home/fn2/nginx.conf:/etc/nginx/nginx.conf -v /home/fn2/renren-vue:/home/fn2/renren-vue --privileged --net=host nginx</span><br></pre></td></tr></table></figure>
<p>宿主机/home/fn3/nginx.conf的配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">user  nginx;</span><br><span class="line">worker_processes  1;</span><br><span class="line">error_log  /var/log/nginx/error.log warn;</span><br><span class="line">pid        /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       /etc/nginx/mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '</span><br><span class="line">                      '$status $body_bytes_sent "$http_referer" '</span><br><span class="line">                      '"$http_user_agent" "$http_x_forwarded_for"';</span><br><span class="line"></span><br><span class="line">    access_log  /var/log/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    #tcp_nopush     on;</span><br><span class="line"></span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    #gzip  on;</span><br><span class="line">	</span><br><span class="line">	proxy_redirect          off;</span><br><span class="line">	proxy_set_header        Host $host;</span><br><span class="line">	proxy_set_header        X-Real-IP $remote_addr;</span><br><span class="line">	proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">	client_max_body_size    10m;</span><br><span class="line">	client_body_buffer_size   128k;</span><br><span class="line">	proxy_connect_timeout   5s;</span><br><span class="line">	proxy_send_timeout      5s;</span><br><span class="line">	proxy_read_timeout      5s;</span><br><span class="line">	proxy_buffer_size        4k;</span><br><span class="line">	proxy_buffers           4 32k;</span><br><span class="line">	proxy_busy_buffers_size  64k;</span><br><span class="line">	proxy_temp_file_write_size 64k;</span><br><span class="line">	</span><br><span class="line">	server &#123;</span><br><span class="line">		listen 6503;</span><br><span class="line">		server_name  192.168.99.104;</span><br><span class="line">		location  /  &#123;</span><br><span class="line">			root  /home/fn3/renren-vue;</span><br><span class="line">			index  index.html;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>启动fn3节点</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">启动第fn3节点</span></span><br><span class="line">docker run -it -d --name fn3 -v /home/fn3/nginx.conf:/etc/nginx/nginx.conf -v /home/fn3/renren-vue:/home/fn3/renren-vue --privileged --net=host nginx</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置负载均衡</p>
<p>宿主机/home/ff1/nginx.conf配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">user  nginx;</span><br><span class="line">worker_processes  1;</span><br><span class="line">error_log  /var/log/nginx/error.log warn;</span><br><span class="line">pid        /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       /etc/nginx/mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '</span><br><span class="line">                      '$status $body_bytes_sent "$http_referer" '</span><br><span class="line">                      '"$http_user_agent" "$http_x_forwarded_for"';</span><br><span class="line"></span><br><span class="line">    access_log  /var/log/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    #tcp_nopush     on;</span><br><span class="line"></span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    #gzip  on;</span><br><span class="line">	</span><br><span class="line">	proxy_redirect          off;</span><br><span class="line">	proxy_set_header        Host $host;</span><br><span class="line">	proxy_set_header        X-Real-IP $remote_addr;</span><br><span class="line">	proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">	client_max_body_size    10m;</span><br><span class="line">	client_body_buffer_size   128k;</span><br><span class="line">	proxy_connect_timeout   5s;</span><br><span class="line">	proxy_send_timeout      5s;</span><br><span class="line">	proxy_read_timeout      5s;</span><br><span class="line">	proxy_buffer_size        4k;</span><br><span class="line">	proxy_buffers           4 32k;</span><br><span class="line">	proxy_busy_buffers_size  64k;</span><br><span class="line">	proxy_temp_file_write_size 64k;</span><br><span class="line">	</span><br><span class="line">	upstream fn &#123;</span><br><span class="line">		server 192.168.99.104:6501;</span><br><span class="line">		server 192.168.99.104:6502;</span><br><span class="line">		server 192.168.99.104:6503;</span><br><span class="line">	&#125;</span><br><span class="line">	server &#123;</span><br><span class="line">        listen       6601;</span><br><span class="line">        server_name  192.168.99.104; </span><br><span class="line">        location / &#123;  </span><br><span class="line">            proxy_pass   http://fn;</span><br><span class="line">            index  index.html index.htm;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">启动ff1节点</span></span><br><span class="line">docker run -it -d --name ff1 -v /home/ff1/nginx.conf:/etc/nginx/nginx.conf --net=host --privileged nginx</span><br></pre></td></tr></table></figure>
<p>宿主机/home/ff2/nginx.conf配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">user  nginx;</span><br><span class="line">worker_processes  1;</span><br><span class="line">error_log  /var/log/nginx/error.log warn;</span><br><span class="line">pid        /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       /etc/nginx/mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '</span><br><span class="line">                      '$status $body_bytes_sent "$http_referer" '</span><br><span class="line">                      '"$http_user_agent" "$http_x_forwarded_for"';</span><br><span class="line"></span><br><span class="line">    access_log  /var/log/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    #tcp_nopush     on;</span><br><span class="line"></span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    #gzip  on;</span><br><span class="line">	</span><br><span class="line">	proxy_redirect          off;</span><br><span class="line">	proxy_set_header        Host $host;</span><br><span class="line">	proxy_set_header        X-Real-IP $remote_addr;</span><br><span class="line">	proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">	client_max_body_size    10m;</span><br><span class="line">	client_body_buffer_size   128k;</span><br><span class="line">	proxy_connect_timeout   5s;</span><br><span class="line">	proxy_send_timeout      5s;</span><br><span class="line">	proxy_read_timeout      5s;</span><br><span class="line">	proxy_buffer_size        4k;</span><br><span class="line">	proxy_buffers           4 32k;</span><br><span class="line">	proxy_busy_buffers_size  64k;</span><br><span class="line">	proxy_temp_file_write_size 64k;</span><br><span class="line">	</span><br><span class="line">	upstream fn &#123;</span><br><span class="line">		server 192.168.99.104:6501;</span><br><span class="line">		server 192.168.99.104:6502;</span><br><span class="line">		server 192.168.99.104:6503;</span><br><span class="line">	&#125;</span><br><span class="line">	server &#123;</span><br><span class="line">        listen       6602;</span><br><span class="line">        server_name  192.168.99.104; </span><br><span class="line">        location / &#123;  </span><br><span class="line">            proxy_pass   http://fn;</span><br><span class="line">            index  index.html index.htm;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">启动ff2节点</span></span><br><span class="line">docker run -it -d --name ff2 -v /home/ff2/nginx.conf:/etc/nginx/nginx.conf --net=host --privileged nginx</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置双机热备</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">进入ff1节点</span></span><br><span class="line">docker exec -it ff1 bash</span><br><span class="line"><span class="meta">#</span><span class="bash">更新软件包</span></span><br><span class="line">apt-get update</span><br><span class="line"><span class="meta">#</span><span class="bash">安装VIM</span></span><br><span class="line">apt-get install vim</span><br><span class="line"><span class="meta">#</span><span class="bash">安装Keepalived</span></span><br><span class="line">apt-get install keepalived</span><br><span class="line"><span class="meta">#</span><span class="bash">编辑Keepalived配置文件(如下)</span></span><br><span class="line">vim /etc/keepalived/keepalived.conf</span><br><span class="line"><span class="meta">#</span><span class="bash">启动Keepalived</span></span><br><span class="line">service keepalived start</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens33</span><br><span class="line">    virtual_router_id 52</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 123456</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.99.152</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">virtual_server 192.168.99.151 6701 &#123;</span><br><span class="line">    delay_loop 3</span><br><span class="line">    lb_algo rr</span><br><span class="line">    lb_kind NAT</span><br><span class="line">    persistence_timeout 50</span><br><span class="line">    protocol TCP</span><br><span class="line">    real_server 192.168.99.104 6601 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">进入ff1节点</span></span><br><span class="line">docker exec -it ff2 bash</span><br><span class="line"><span class="meta">#</span><span class="bash">更新软件包</span></span><br><span class="line">apt-get update</span><br><span class="line"><span class="meta">#</span><span class="bash">安装VIM</span></span><br><span class="line">apt-get install vim</span><br><span class="line"><span class="meta">#</span><span class="bash">安装Keepalived</span></span><br><span class="line">apt-get install keepalived</span><br><span class="line"><span class="meta">#</span><span class="bash">编辑Keepalived配置文件(如下)</span></span><br><span class="line">vim /etc/keepalived/keepalived.conf</span><br><span class="line"><span class="meta">#</span><span class="bash">启动Keepalived</span></span><br><span class="line">service keepalived start</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens33</span><br><span class="line">    virtual_router_id 52</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 123456</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.99.152</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">virtual_server 192.168.99.151 6701 &#123;</span><br><span class="line">    delay_loop 3</span><br><span class="line">    lb_algo rr</span><br><span class="line">    lb_kind NAT</span><br><span class="line">    persistence_timeout 50</span><br><span class="line">    protocol TCP</span><br><span class="line">    real_server 192.168.99.104 6602 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​</p>
</li>
</ol>

      
    </main>
    <footer class="post-footer">
      
    </footer>
  </article>
  
  <article class="index-post card" itemscope itemtype="http://schema.org/Article">
    <div class="post-block">
      <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/12/spring_security/2.SpringSecurityFormAuthentication/">
      <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
        <meta itemprop="name" content="龙门小左">
        <meta itemprop="description" content="">
        <meta itemprop="image" content="/images/avatar.png">
      </span>
      <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
        <meta itemprop="name" content="程序猿的日常">
      </span>
    </div>
    <header class="post-header">
      <h1 class="post-title" itemprop="name headline">
        <a class="post-title-link post-title-link-external" href="/2018/07/12/spring_security/2.SpringSecurityFormAuthentication/" itemprop="url">使用 Maven Module 搭建spring boot项目（整合Spring Security、Spring Social、spring OAuth）二</a>
      </h1>
      <div class="post-meta">
        
        <span class="post-date">
          <i class="far fa-calendar-plus"></i><span><time title="post-date" itemprop="dateCreated datePublished" datetime="2018-07-12T10:00:00+08:00">2018-07-12 10:00:00</time></span>
        </span>
        
        
        
      </div>
    </header>
    <main class="post-main" itemprop="articleBody">
      
      <h1 id="使用-Maven-Module-搭建spring-boot项目（整合Spring-Security、Spring-Social、spring-OAuth）二"><a href="#使用-Maven-Module-搭建spring-boot项目（整合Spring-Security、Spring-Social、spring-OAuth）二" class="headerlink" title="使用 Maven Module 搭建spring boot项目（整合Spring Security、Spring Social、spring OAuth）二"></a>使用 Maven Module 搭建spring boot项目（整合Spring Security、Spring Social、spring OAuth）二</h1><table>
<thead>
<tr>
<th>版本号</th>
<th>作者</th>
<th>日期</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>V0.1</td>
<td>huangz</td>
<td>2018-04-03</td>
<td>初稿</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="Spring-Security-开发基于表单的认证"><a href="#Spring-Security-开发基于表单的认证" class="headerlink" title="Spring Security 开发基于表单的认证"></a>Spring Security 开发基于表单的认证</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>​    在以上开发的RESTful服务中，都是一种暴露而不安全的服务，任何人都可以随意访问。需要对访问进行合理的权限分配，对用户的身份进行认证和授权，保证服务的安全性和合法性，spring security 框架就是基于此而诞生的。</p>
<p><strong>Spring Security 核心功能：</strong></p>
<ol>
<li>认证（你是谁）</li>
<li>授权（你能做什么）</li>
<li>攻击防护（防止伪造身份）</li>
</ol>
<h3 id="基本原理"><a href="#基本原理" class="headerlink" title="基本原理"></a>基本原理</h3><h4 id="开启Spring-Security"><a href="#开启Spring-Security" class="headerlink" title="开启Spring Security"></a>开启Spring Security</h4><p>​    在默认情况下，Spring Security 服务器中所有的服务都保护起来了，要访问某一个服务，都需要进行身份验证。</p>
<p>在<code>application.properties</code>中添加启动配置，默认开启<code>HttpBasic</code>方式进行验证</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># spring security 默认配置(默认为true)</span></span><br><span class="line"><span class="string">security.basic.enabled</span> <span class="string">=</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>若在未进行配置的情况下，用户名默认为<code>user</code>，并且登陆密码会在启动时临时生成，并在控制台输出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Using default security password: 99066b9e-054f-496f-9f29-4014eee36109</span><br></pre></td></tr></table></figure>
<h4 id="自定义安全验证"><a href="#自定义安全验证" class="headerlink" title="自定义安全验证"></a>自定义安全验证</h4><ol>
<li>目的：写出重用的模块，跟认证授权相应的代码都写在相应的项目中，并可以被其他模块引用</li>
<li>更改默认的验证方式，在浏览器项目中创建配置类，开启自定义配置</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * WebSecurityConfigurerAdapter: Spring Security 在web应用上配置适配器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BrowserSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Spring Security 默认配置的代码演示</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      <span class="comment">//最简单的配置</span></span><br><span class="line"><span class="comment">//http.httpBasic()//使用httpbasic验证，默认使用</span></span><br><span class="line">      http.formLogin()<span class="comment">//使用表单验证的意思</span></span><br><span class="line">            .and()<span class="comment">//</span></span><br><span class="line">            .authorizeRequests()<span class="comment">//对请求做授权</span></span><br><span class="line">            .anyRequest()<span class="comment">//任何请求</span></span><br><span class="line">            .authenticated();<span class="comment">//都需要身份验证</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>启动服务后，系统的认证方式从<code>HttpBasic</code>更改为<code>Form</code>方法</li>
</ol>
<h4 id="Security基本原理"><a href="#Security基本原理" class="headerlink" title="Security基本原理"></a>Security基本原理</h4><h5 id="核心类简单介绍"><a href="#核心类简单介绍" class="headerlink" title="核心类简单介绍"></a>核心类简单介绍</h5><p>​    Spring security 最核心的是一组过滤器链(一组Filter)，所有的功能都是建立在此基础上的，绿色中的过滤器是Spring security最核心的过滤器，作用是验证用户身份，每一种过滤器用来处理一种认证方式</p>
<p><img src="images/security-core-classes-introduction.png" alt=""></p>
<p><code>UsernamePasswordAuthenticationFilter</code> ：处理表单登陆验证</p>
<p><code>BasicAuthenticationFilter</code> ：处理<code>HttpBasic</code>登陆验证</p>
<p><code>FilterSecurityInterceptor</code> ：核心过滤链中最后一关，依据配置，判断当前请求能不能访问REST服务，如果不匹配，则抛出异常（根据不同原因）</p>
<p><code>ExceptionTranslationFilter</code> ：捕获<code>FilterSecurityInterceptor</code>抛出的异常并处理(例如引导用户到登陆页面)</p>
<p>​    <strong>通过配置可以选用绿色的过滤器，但非绿色的过滤器一定会在过滤器链上执行(<code>FilterSecurityInterceptor</code>不能关闭，<code>ExceptionTranslationFilter</code>一定在<code>FilterSecurityInterceptor</code>前)</strong></p>
<h5 id="内部流程解析"><a href="#内部流程解析" class="headerlink" title="内部流程解析"></a>内部流程解析</h5><ol>
<li>访问访问已经配置好受保护的REST服务: <code>&lt;http://localhost:8080/user&gt;</code></li>
<li>进入<code>FilterSecurityInterceptor</code></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FilterSecurityInterceptor</span></span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(FilterInvocation fi)</span></span>&#123;</span><br><span class="line">		InterceptorStatusToken token = <span class="keyword">super</span>.beforeInvocation(fi);<span class="comment">//验证，不符合抛出异常</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>抛出异常，被捕获</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExceptionTranslationFilter</span></span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest req, ServletResponse res, FilterChain chain)</span></span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//执行下一个过滤器，也就是FilterSecurityInterceptor</span></span><br><span class="line">    		chain.doFilter(request, response);</span><br><span class="line">    		<span class="keyword">this</span>.logger.debug(<span class="string">"Chain processed normally"</span>);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException var9) &#123;</span><br><span class="line">    		<span class="keyword">throw</span> var9;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception var10) &#123;</span><br><span class="line">            <span class="comment">//抛出异常，捕获</span></span><br><span class="line">    		Throwable[] causeChain = <span class="keyword">this</span>.throwableAnalyzer.determineCauseChain(var10);</span><br><span class="line">    		RuntimeException ase = (AuthenticationException)<span class="keyword">this</span>.throwableAnalyzer.getFirstThrowableOfType(AuthenticationException.class, causeChain);</span><br><span class="line">            <span class="keyword">if</span>(ase == <span class="keyword">null</span>) &#123;</span><br><span class="line">                ase = (AccessDeniedException)<span class="keyword">this</span>.throwableAnalyzer.getFirstThrowableOfType(AccessDeniedException.class, causeChain);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>.handleSpringSecurityException(request, response, chain, (RuntimeException)ase);<span class="comment">//处理异常，并且引导用户处理</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>引导用户登陆，用户登陆完毕</li>
<li>进入用户名密码校验过滤器</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UsernamePasswordAuthenticationFilter</span></span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Authentication <span class="title">attemptAuthentication</span><span class="params">(HttpServletRequest request, HttpServletResponse 		response)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">    	<span class="keyword">if</span>(<span class="keyword">this</span>.postOnly &amp;&amp; !request.getMethod().equals(<span class="string">"POST"</span>)) &#123;</span><br><span class="line">        	<span class="keyword">throw</span> <span class="keyword">new</span> AuthenticationServiceException(<span class="string">"Authentication method not supported: "</span> + 				request.getMethod());</span><br><span class="line">    	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        	String username = <span class="keyword">this</span>.obtainUsername(request);</span><br><span class="line">        	String password = <span class="keyword">this</span>.obtainPassword(request);</span><br><span class="line">        	<span class="keyword">if</span>(username == <span class="keyword">null</span>) &#123;</span><br><span class="line">            	username = <span class="string">""</span>;</span><br><span class="line">        	&#125;</span><br><span class="line">        	<span class="keyword">if</span>(password == <span class="keyword">null</span>) &#123;</span><br><span class="line">            	password = <span class="string">""</span>;</span><br><span class="line">        	&#125;</span><br><span class="line">        	username = username.trim();</span><br><span class="line">        	UsernamePasswordAuthenticationToken authRequest = <span class="keyword">new</span> UsernamePasswordAuthenticationToken(username, password);</span><br><span class="line">        	<span class="keyword">this</span>.setDetails(request, authRequest);</span><br><span class="line">        	<span class="keyword">return</span> <span class="keyword">this</span>.getAuthenticationManager().authenticate(authRequest);</span><br><span class="line">    	&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="6">
<li>进入<code>FilterSecurityInterceptor</code>，再次验证，通过验证，进入服务，服务返回数据</li>
</ol>
<h4 id="自定义认证逻辑"><a href="#自定义认证逻辑" class="headerlink" title="自定义认证逻辑"></a>自定义认证逻辑</h4><h5 id="Security处理用户信息校验逻辑"><a href="#Security处理用户信息校验逻辑" class="headerlink" title="Security处理用户信息校验逻辑"></a>Security处理用户信息校验逻辑</h5><p>Spring Security 提供两个接口<code>UserDetailService</code>与<code>UserDetail</code>，用于校验用户信息逻辑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.security.core.userdetails;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDetailsService</span> </span>&#123;</span><br><span class="line">    <span class="function">UserDetails <span class="title">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.security.core.userdetails;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.GrantedAuthority;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 封装了spring security 登陆所需要的所有信息</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDetails</span> <span class="keyword">extends</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    Collection&lt;? extends GrantedAuthority&gt; getAuthorities();<span class="comment">//权限信息</span></span><br><span class="line">    <span class="function">String <span class="title">getPassword</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">String <span class="title">getUsername</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 以下四个方法是可以实现自定义校验逻辑的</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isAccountNonExpired</span><span class="params">()</span></span>;<span class="comment">//账户没有过期返回true</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isAccountNonLocked</span><span class="params">()</span></span>;<span class="comment">//账户是不是被锁定了(冻结)</span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">isCredentialsNonExpired</span><span class="params">()</span></span>;<span class="comment">//密码是否过期</span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">isEnabled</span><span class="params">()</span></span>;<span class="comment">//账户是不是可用(是否逻辑删除)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="自定义处理用户信息校验逻辑"><a href="#自定义处理用户信息校验逻辑" class="headerlink" title="自定义处理用户信息校验逻辑"></a>自定义处理用户信息校验逻辑</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyUserDetailsService</span> <span class="keyword">implements</span> <span class="title">UserDetailsService</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  模拟注入Dao或Mapper</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">//@Autowired</span></span><br><span class="line">    <span class="comment">//private UserDao userDao;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 开发中，所有的动态数据都需要从数据库中或其他数据储存介质读取</span></span><br><span class="line"><span class="comment">     * 包括权限列表</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDetails <span class="title">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException </span>&#123;</span><br><span class="line">        <span class="comment">//模拟根据用户名使用Dao或Mapper寻找用户</span></span><br><span class="line">        logger.info(<span class="string">"登陆用户名： "</span> + username);</span><br><span class="line">        <span class="comment">//User:spring security框架提供的一个实现了UserDetails接口的实现类</span></span><br><span class="line">        <span class="comment">//三个参数:username,password,authorities：授权</span></span><br><span class="line">        <span class="comment">//分割String类型为授权集合</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> User(username,<span class="string">"123456"</span>, AuthorityUtils.commaSeparatedStringToAuthorityList(<span class="keyword">super</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上代码返回了一个User类，是Spring Security默认提供的一个UserDetails接口实现类，以上的构造器传入了3个参数，但是没有传入账号是否过期、是否被锁定，密码是否过期，是否可用(是否逻辑删除)等属性参数，这样默认都为true，账号可用。</p>
<p>若需要增加账号其他逻辑判断，则可以修改为</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> User(username,<span class="string">"123456"</span>,<span class="keyword">true</span>,<span class="keyword">true</span>,<span class="keyword">true</span>,<span class="keyword">true</span></span><br><span class="line">                AuthorityUtils.commaSeparatedStringToAuthorityList(<span class="string">"admin"</span>));</span><br></pre></td></tr></table></figure>
<h5 id="处理密码加解密"><a href="#处理密码加解密" class="headerlink" title="处理密码加解密"></a>处理密码加解密</h5><ol>
<li>Spring Security 提供密码加密的接口，并且提供一个常用的密码处理类<code>BCryptPasswordEncoder</code></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.security.crypto.password;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PasswordEncoder</span> </span>&#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* var1:原始密码</span></span><br><span class="line"><span class="comment">* return:返回加密后的密码</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">    <span class="function">String <span class="title">encode</span><span class="params">(CharSequence var1)</span></span>;</span><br><span class="line">    </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 用户输入的密码与数据库密码进行匹配</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(CharSequence var1, String var2)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>配置Spring Security提供的密码加密类</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BrowserSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 配置一个PasswordEncoder加密的实现类</span></span><br><span class="line"><span class="comment">    * 可以自定义加密类如使用MD5、SHA1等实现加密逻辑然后实现PasswordEncoder</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> PasswordEncoder <span class="title">passwordEncoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> BCryptPasswordEncoder();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>在后台出，从数据库中读取出的密码应是用户注册时已经通过加密添加入数据库中。在UserDetails返回后，spring security 会从前台传过来的密码进行加密后，才会跟我们生成的UserDetails中的密码进行比对。</li>
<li><code>BCryptPasswordEncoder</code>是Spring 提供的一个强大的密码加密工具类，同样的字符串进行加密，每次结果都会不一样，加密时，使用随机盐进行对取得得密码再次进行处理。安全性更强大。</li>
</ol>
<p>对于<code>BCryptPasswordEncoder</code>的强大，原理还不清楚，在网上查了些资料，如下：</p>
<blockquote>
<p>spring security中的BCryptPasswordEncoder方法采用SHA-256 +随机盐+密钥对密码进行加密。SHA系列是Hash算法，不是加密算法，使用加密算法意味着可以解密（这个与编码/解码一样），但是采用Hash处理，其过程是不可逆的。</p>
</blockquote>
<blockquote>
<p>加密(encode)：注册用户时，使用SHA-256+随机盐+密钥把用户输入的密码进行hash处理，得到密码的hash值，然后将其存入数据库中。</p>
</blockquote>
<blockquote>
<p>密码匹配(matches)：用户登录时，密码匹配阶段并没有进行密码解密（因为密码经过Hash处理，是不可逆的），而是使用相同的算法把用户输入的密码进行hash处理，得到密码的hash值，然后将其与从数据库中查询到的密码hash值进行比较。如果两者相同，说明用户输入的密码正确。</p>
</blockquote>
<blockquote>
<p>这正是为什么处理密码时要用hash算法，而不用加密算法。因为这样处理即使数据库泄漏，黑客也很难破解密码（破解密码只能用彩虹表）。</p>
</blockquote>
<h4 id="个性化认证流程"><a href="#个性化认证流程" class="headerlink" title="个性化认证流程"></a>个性化认证流程</h4><p>一定要注意spring boot默认资源位置，不然会出现404状态</p>
<p>Spring boot 默认将/**所有访问映射到以下目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">classpath:/static</span><br><span class="line">classpath:/public</span><br><span class="line">classpath:/resources</span><br><span class="line">classpath:/META-INF/resources/</span><br></pre></td></tr></table></figure>
<h5 id="自定义登陆页面"><a href="#自定义登陆页面" class="headerlink" title="自定义登陆页面"></a>自定义登陆页面</h5><h6 id="页面请求配置"><a href="#页面请求配置" class="headerlink" title="页面请求配置"></a>页面请求配置</h6><ol>
<li>修改配置</li>
</ol>
<p>在核心配置中添加<code>loginPage</code>配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BrowserSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">   	<span class="comment">//最简单的配置</span></span><br><span class="line">   	<span class="comment">//http.httpBasic()//使用httpbasic验证，默认使用</span></span><br><span class="line">   		http.formLogin()<span class="comment">//使用表单验证的意思</span></span><br><span class="line">         .loginPage(<span class="string">"/vic-login.html"</span>)</span><br><span class="line">         .and()<span class="comment">//</span></span><br><span class="line">         .authorizeRequests()<span class="comment">//对请求做授权</span></span><br><span class="line">         .anyRequest()<span class="comment">//任何请求</span></span><br><span class="line">         .authenticated();<span class="comment">//都需要身份验证</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>资源目录下添加相应的页面</li>
</ol>
<p>在资源目录下<code>resources/vic-login.html</code>增加相应页面</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">h2</span>&gt;</span>标准登录页面<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">h3</span>&gt;</span>表单登录<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"/authentication/form"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">table</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>用户名:<span class="tag">&lt;/<span class="name">td</span>&gt;</span> </span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"username"</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>密码:<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">name</span>=<span class="string">"password"</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line"></span><br><span class="line">         <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span> <span class="attr">colspan</span>=<span class="string">"2"</span>&gt;</span><span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"submit"</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">button</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ol start="3">
<li>启动服务</li>
</ol>
<p>页面错误，提示：ERR_TOO_MANY_REDIRECTS（重定向过多）</p>
<p>原因：需要验证登陆时，需要跳转到<code>vic-login.html</code>，但本身<code>vic-login.html</code>也需要授权(在前面配置中,对所有访问都实行了验证)，因此会陷入一个死循环</p>
<p>解决：增加配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">http.formLogin()<span class="comment">//使用表单验证的意思</span></span><br><span class="line">      .loginPage(<span class="string">"/vic-login.html"</span>)</span><br><span class="line">      .and()<span class="comment">//</span></span><br><span class="line">      .authorizeRequests()<span class="comment">//对请求做授权</span></span><br><span class="line">      .antMatchers(<span class="string">"/vic-login.html"</span>).permitAll()</span><br><span class="line">      .anyRequest()<span class="comment">//任何请求</span></span><br><span class="line">      .authenticated();<span class="comment">//都需要身份验证</span></span><br></pre></td></tr></table></figure>
<ol start="4">
<li>处理登陆请求</li>
</ol>
<p>在我们的页面中，表达提交的地址定位到<code>/authentication/form</code> ，但在Spring Security  <code>UsernamePasswordAuthenticationFilter.java</code>默认配置中处理的是<code>/login</code> 请求</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">UsernamePasswordAuthenticationFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(<span class="keyword">new</span> AntPathRequestMatcher(<span class="string">"/login"</span>, <span class="string">"POST"</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因此引入自定义配置的处理登陆请求的地址</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">http.formLogin()<span class="comment">//使用表单验证的意思</span></span><br><span class="line">         .loginPage(<span class="string">"/vic-login.html"</span>)<span class="comment">//自定义登陆页面</span></span><br><span class="line">         .loginProcessingUrl(<span class="string">"/authentication/form"</span>)<span class="comment">//登陆页面登陆跳转地址</span></span><br><span class="line">         .and()<span class="comment">//</span></span><br><span class="line">         .authorizeRequests()<span class="comment">//对请求做授权</span></span><br><span class="line">         .antMatchers(<span class="string">"/vic-login.html"</span>).permitAll()</span><br><span class="line">         .anyRequest()<span class="comment">//任何请求</span></span><br><span class="line">         .authenticated();<span class="comment">//都需要身份验证</span></span><br></pre></td></tr></table></figure>
<ol start="5">
<li>启动报错</li>
</ol>
<p>控制台输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">This application has no explicit mapping for /error, so you are seeing this as a fallback.</span><br><span class="line"></span><br><span class="line">Fri Oct 06 14:49:33 CST 2017</span><br><span class="line">There was an unexpected error (type=Forbidden, status=403).</span><br><span class="line">Could not verify the provided CSRF token because your session was not found.</span><br></pre></td></tr></table></figure>
<p>原因：spring security 默认情况下提供了一个叫跨站请求伪造的一个防护</p>
<p>解决：修改配置，暂时关闭请求</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">http.formLogin()<span class="comment">//使用表单验证的意思</span></span><br><span class="line">        .loginPage(<span class="string">"/vic-login.html"</span>)<span class="comment">//自定义登陆页面</span></span><br><span class="line">        .loginProcessingUrl(<span class="string">"/authentication/form"</span>)<span class="comment">//登陆页面登陆跳转地址</span></span><br><span class="line">        .and()<span class="comment">//</span></span><br><span class="line">        .authorizeRequests()<span class="comment">//对请求做授权</span></span><br><span class="line">        .antMatchers(<span class="string">"/vic-login.html"</span>).permitAll()</span><br><span class="line">        .anyRequest()<span class="comment">//任何请求</span></span><br><span class="line">        .authenticated()<span class="comment">//都需要身份验证</span></span><br><span class="line">        .and()</span><br><span class="line">        .csrf().disable();<span class="comment">//关闭跨站伪造服务</span></span><br></pre></td></tr></table></figure>
<hr>
<h6 id="服务请求配置"><a href="#服务请求配置" class="headerlink" title="服务请求配置"></a>服务请求配置</h6><p>​    虽然现在可以使用自定义的登陆页面，但是离我们的目标还是有点距离的。我们在页面上请求我们的RESTful服务请求，我们处理是返回一个自定义的html页面，这个是不合理的，RestFul服务应该返回的是状态码或者是json数据，但我们返回的是一个html，如果是html请求，那么我们应该返回是html，不是则返回json（理应想spring security的错误处理机制一样）。我们的目标是实现一个可重用的模块，可重用的目标是，有多个模块使用同一个模块，但是不可能所有的模块都使用这一个我们刚刚自定义的登陆页面。如果定义其他模块可以使用自己的页面，如果不配置就使用我们默认的配置页面</p>
<p><img src="images/handlerequest.png" alt=""></p>
<ol>
<li>创建处理服务</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BrowserSecurityController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 把当前请求缓存到session里</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">private</span> RequestCache requestCache = <span class="keyword">new</span> HttpSessionRequestCache();</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Spring security 提供的一个跳转工具</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">private</span> RedirectStrategy redirectStrategy = <span class="keyword">new</span> DefaultRedirectStrategy();</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> SecurityProperties securityProperties;</span><br><span class="line">   </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 当需要身份认证时，跳转到这里</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 包装后的错误信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">//@RequestMapping(SecurityConstants.DEFAULT_UNAUTHENTICATION_URL)</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/authentication/require"</span>)</span><br><span class="line"><span class="meta">@ResponseStatus</span>(code = HttpStatus.UNAUTHORIZED)<span class="comment">//返回状态码 401未授权</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> SimpleResponse <span class="title">requireAuthentication</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span><span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">   SavedRequest savedRequest = requestCache.getRequest(request, response);<span class="comment">//获取引发跳转的请求</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (savedRequest != <span class="keyword">null</span>) &#123;</span><br><span class="line">      String targetUrl = savedRequest.getRedirectUrl();</span><br><span class="line">      logger.info(<span class="string">"引发跳转的请求是:"</span> + targetUrl);</span><br><span class="line">      <span class="keyword">if</span> (StringUtils.endsWithIgnoreCase(targetUrl, <span class="string">".html"</span>)) &#123;<span class="comment">//判断跳转url是否以.html结尾</span></span><br><span class="line">         redirectStrategy.sendRedirect(request, response, securityProperties.getBrowser().getLoginPage());<span class="comment">//用户定义或系统默认</span></span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//如果不是html请求，那么返回一个自定义对象作为json数据返回</span></span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">new</span> SimpleResponse(<span class="string">"访问的服务需要身份认证，请引导用户到登录页"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>定义信息回显包装类</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回信息实体包装</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleResponse</span> </span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">SimpleResponse</span><span class="params">(Object content)</span></span>&#123; <span class="keyword">this</span>.content = content; &#125;</span><br><span class="line"><span class="comment">//定义object意味着我们可以返回任何对象</span></span><br><span class="line">   <span class="keyword">private</span> Object content;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> Object <span class="title">getContent</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> content; &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContent</span><span class="params">(Object content)</span> </span>&#123;<span class="keyword">this</span>.content = content; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>在项目中<code>application.properties</code>配置自定义的登陆页</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 配置自定义跳转登陆的页面</span><br><span class="line">vic.security.browser.loginPage = /vic-login.html</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>系统配置封装</li>
</ol>
<p>系统配置封装的目的是实现可配置化，自定义化。简单来说就是：配置覆盖系统默认</p>
<p>定义系统封装实体结构：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SecurityProperties                        # 系统总配置</span><br><span class="line">      | - - - BrowserProperties           # 浏览器相关配置</span><br><span class="line">      | - - - ValidateCodeProperties      # 验证码相关配置</span><br><span class="line">      | - - - OAuthProperties             # OAuth相关配置</span><br><span class="line">      | - - - SocialProperties            # 社交登陆相关配置</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>定义各个配置类</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BrowserProperties</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 默认值，用户没有配置就使用默认值</span></span><br><span class="line"><span class="comment">     * 若用户自定义配置则使用用户配置的值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String loginPage = <span class="string">"vic-login.html"</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getLoginPage</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> loginPage; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLoginPage</span><span class="params">(String loginPage)</span> </span>&#123;<span class="keyword">this</span>.loginPage = loginPage; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"vic.security"</span>)<span class="comment">//读取配置文件中vic.security的配置</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityProperties</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//browser读取vic.security.browser属性</span></span><br><span class="line">    <span class="keyword">private</span> BrowserProperties browser = <span class="keyword">new</span> BrowserProperties();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> BrowserProperties <span class="title">getBrowser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> browser;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBrowser</span><span class="params">(BrowserProperties browser)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.browser = browser;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties</span>(SecurityProperties.class)<span class="comment">//使自定义配置生效</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityCoreConfig</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>修改需要身份跳转的请求，并且对配置的请求权限进行放开</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">http.formLogin()<span class="comment">//使用表单验证的意思</span></span><br><span class="line">         <span class="comment">//.loginPage("/vic-login.html")//自定义登陆页面</span></span><br><span class="line">    	.loginPage(<span class="string">"/authentication/require"</span>)<span class="comment">//自定义登陆页面</span></span><br><span class="line">    	.and()</span><br><span class="line">			.authorizeRequests()</span><br><span class="line">			.antMatchers(<span class="string">"/authentication/require"</span>,</span><br><span class="line">					securityProperties.getBrowser().getLoginPage()).permitAll()</span><br></pre></td></tr></table></figure>
<ol start="6">
<li><p>总结</p>
<p><code>/authentication/require</code>的实现逻辑可以自定义配置，不同的系统根据不同的业务处理进行自定义</p>
</li>
</ol>
<h5 id="自定义登陆成功处理"><a href="#自定义登陆成功处理" class="headerlink" title="自定义登陆成功处理"></a>自定义登陆成功处理</h5><h6 id="Spring-Security默认的登陆成功处理器"><a href="#Spring-Security默认的登陆成功处理器" class="headerlink" title="Spring Security默认的登陆成功处理器"></a>Spring Security默认的登陆成功处理器</h6><p>​    Spring Security默认的处理登陆成功的机制是:登陆成功后，跳转到引发登陆的那个请求上（如：访问/user需要进行登陆，则跳到登陆页，当登陆成功后，再次跳转到/user）</p>
<p>Spring Security提供<code>AuthenticationSuccessHandler</code>接口供实现登陆成功跳转，默认使用其实现类<code>SavedRequestAwareAuthenticationSuccessHandler</code>： 跳转到之前缓存器的那个请求</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.security.web.authentication;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* authentication:封装了认证相关的信息</span></span><br><span class="line"><span class="comment">* 包括:认证请求的一些信息，session</span></span><br><span class="line"><span class="comment">* 认证通过后的UserDetails用户信息</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AuthenticationSuccessHandler</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onAuthenticationSuccess</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span> <span class="keyword">throws</span> IOException, ServletException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="自定义登陆成功处理器"><a href="#自定义登陆成功处理器" class="headerlink" title="自定义登陆成功处理器"></a>自定义登陆成功处理器</h6><ol>
<li>定义当前登陆类型，并加入<code>BrowserProperties</code>配置中，实现可配置化</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> LoginType &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 跳转</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    REDIRECT,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回json</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    JSON</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BrowserProperties</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 默认值，用户没有配置就使用默认值</span></span><br><span class="line"><span class="comment">     * 若用户自定义配置则使用用户配置的值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String loginPage = <span class="string">"/vic-login.html"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> LoginType loginType = LoginType.JSON; <span class="comment">//默认是json</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>定义处理器实现类</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VicAuthenticationSuccessHandler</span> <span class="keyword">extends</span> <span class="title">SavedRequestAwareAuthenticationSuccessHandler</span> </span>&#123;</span><br><span class="line">        <span class="comment">//implements AuthenticationSuccessHandler &#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * spring mvc在启动的时候，自动声明这个bean</span></span><br><span class="line"><span class="comment">     * 作用:把对象输出为json数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ObjectMapper objectMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SecurityProperties securityProperties;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAuthenticationSuccess</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"登录成功"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//这里可以增加实现逻辑，比如说从请求头中获取请求类型，根据请求类型去跳转，如果没有带指定的请求头，则按系统配置，实现参数覆盖自定义配置，自定义配置覆盖默认配置</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (LoginType.JSON.equals(securityProperties.getBrowser().getLoginType())) &#123;<span class="comment">//自定义输出</span></span><br><span class="line">            response.setContentType(<span class="string">"application/json;charset=UTF-8"</span>);</span><br><span class="line">            response.getWriter().write(objectMapper.writeValueAsString(authentication));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">super</span>.onAuthenticationSuccess(request, response, authentication);<span class="comment">//跳转到激发登陆请求的链接</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>加入配置中，使自定义的成功处理器生效</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BrowserSecurityConfig</span></span>&#123;</span><br><span class="line"><span class="comment">//注入自定义成功处理bean</span></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> AuthenticationSuccessHandler vicAuthenticationSuccessHandler;</span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">   <span class="comment">//最简单的配置</span></span><br><span class="line">   <span class="comment">//http.httpBasic()//使用httpbasic验证，默认使用</span></span><br><span class="line">   http.formLogin()<span class="comment">//使用表单验证的意思</span></span><br><span class="line">         <span class="comment">//.loginPage("/vic-login.html")//自定义登陆页面</span></span><br><span class="line">         .loginPage(<span class="string">"/authentication/require"</span>)<span class="comment">//自定义登陆页面跳转的controller</span></span><br><span class="line">         .loginProcessingUrl(<span class="string">"/authentication/form"</span>)<span class="comment">//登陆页面登陆跳转地址</span></span><br><span class="line">         .successHandler(vicAuthenticationSuccessHandler)<span class="comment">//使用自定义登陆跳转处理</span></span><br><span class="line">         ………</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>启动服务，获得返回信息</li>
</ol>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    authorities: [&#123;authority: "admin"&#125;],…&#125;,</span><br><span class="line">	authenticated:true,</span><br><span class="line">	authorities:[&#123;authority: "admin"&#125;],</span><br><span class="line">	0:&#123;authority: "admin"&#125;,</span><br><span class="line">	credentials:null,</span><br><span class="line">	details:&#123;remoteAddress: "0:0:0:0:0:0:0:1", sessionId: "9785C465BA32BB2D34BBC2FF872A878A"&#125;,</span><br><span class="line">	remoteAddress:"0:0:0:0:0:0:0:1",</span><br><span class="line">	sessionId:"9785C465BA32BB2D34BBC2FF872A878A",</span><br><span class="line">	name:"edpmaster@123.com",</span><br><span class="line">	principal:&#123;password: null, username: "edpmaster@123.com", authorities: [&#123;authority: "admin"&#125;],…&#125;,</span><br><span class="line">	accountNonExpired:true,</span><br><span class="line">	accountNonLocked:true,</span><br><span class="line">	authorities:[&#123;authority: "admin"&#125;],</span><br><span class="line">	credentialsNonExpired:true,</span><br><span class="line">	enabled:true,</span><br><span class="line">	password:null,</span><br><span class="line">	username:"edpmaster@123.com"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意：根据登陆方式的不同，Authentication里的信息也是不同的。他是一个接口，在实际当中，会根据登陆方式不同，会赋值不同的实现类</p>
<h5 id="自定义登陆失败处理器"><a href="#自定义登陆失败处理器" class="headerlink" title="自定义登陆失败处理器"></a>自定义登陆失败处理器</h5><h6 id="Spring-Security-默认的登陆失败处理"><a href="#Spring-Security-默认的登陆失败处理" class="headerlink" title="Spring Security 默认的登陆失败处理"></a>Spring Security 默认的登陆失败处理</h6><p>Spring Security提供<code>AuthenticationFailureHandler</code>接口供实现登陆失败处理，默认使用其实现类<code>SimpleUrlAuthenticationFailureHandler</code>： 用户不存在或密码错误问题。这种情况下能够实现从哪个登录页面过来的还是返回原登录页，并携带错误信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.security.web.authentication;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AuthenticationFailureHandler</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onAuthenticationFailure</span><span class="params">(HttpServletRequest var1, HttpServletResponse var2, AuthenticationException var3)</span> <span class="keyword">throws</span> IOException, ServletException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="自定义登陆失败处理"><a href="#自定义登陆失败处理" class="headerlink" title="自定义登陆失败处理"></a>自定义登陆失败处理</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VicAuthenticationFailureHandler</span> <span class="keyword">extends</span> <span class="title">SimpleUrlAuthenticationFailureHandler</span></span>&#123;</span><br><span class="line">                <span class="comment">//implements AuthenticationFailureHandler &#123;</span></span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ObjectMapper objectMapper;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SecurityProperties securityProperties;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> authenticationException 认证过程中产生的异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAuthenticationFailure</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span></span><br><span class="line"><span class="function"><span class="params">                                        AuthenticationException authenticationException)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"登录失败"</span>);</span><br><span class="line">        <span class="keyword">if</span> (LoginType.JSON.equals(securityProperties.getBrowser().getLoginType())) &#123;</span><br><span class="line">            response.setStatus(HttpStatus.INTERNAL_SERVER_ERROR.value());<span class="comment">// 500 服务器内部异常</span></span><br><span class="line">            response.setContentType(<span class="string">"application/json;charset=UTF-8"</span>);</span><br><span class="line">            response.getWriter().write(objectMapper.writeValueAsString(authenticationException));</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">super</span>.onAuthenticationFailure(request, response, authenticationException);<span class="comment">//spring boot 默认的处理方式</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="Spring-Security-认证流程源码解析"><a href="#Spring-Security-认证流程源码解析" class="headerlink" title="Spring Security 认证流程源码解析"></a>Spring Security 认证流程源码解析</h4><h5 id="认证流程说明（以用户名密码登陆为入口）"><a href="#认证流程说明（以用户名密码登陆为入口）" class="headerlink" title="认证流程说明（以用户名密码登陆为入口）"></a>认证流程说明（以用户名密码登陆为入口）</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- - 登陆请求 - (携带登陆信息) - &gt; UsernamePasswordAuthenticationFilter - (携带未认证的Authentication) - &gt; AuthenticationManager - - &gt; AuthenticationProvider - - &gt; UserDetailService - - &gt; UserDetails - - &gt; Authentication(已认证)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">登陆请求</span><br><span class="line">   | (携带登陆信息)</span><br><span class="line">UsernamePasswordAuthenticationFilter</span><br><span class="line">   | (携带未认证的Authentication)</span><br><span class="line">AuthenticationManager</span><br><span class="line">   |</span><br><span class="line">AuthenticationProvider</span><br><span class="line">   |</span><br><span class="line">UserDetailService</span><br><span class="line">   |</span><br><span class="line">UserDetails</span><br><span class="line">   |</span><br><span class="line">Authentication(已认证)</span><br></pre></td></tr></table></figure>
<h6 id="UsernamePasswordAuthenticationFilter源码流程解析"><a href="#UsernamePasswordAuthenticationFilter源码流程解析" class="headerlink" title="UsernamePasswordAuthenticationFilter源码流程解析"></a>UsernamePasswordAuthenticationFilter源码流程解析</h6><p><code>UsernamePasswordAuthenticationToken.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//构造函数</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">UsernamePasswordAuthenticationToken</span><span class="params">(Object principal, Object credentials)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>((Collection)<span class="keyword">null</span>); <span class="comment">//一组权限，当前没有进行身份验证，所以无权限</span></span><br><span class="line">    <span class="keyword">this</span>.principal = principal;<span class="comment">//用户名</span></span><br><span class="line">    <span class="keyword">this</span>.credentials = credentials;<span class="comment">//密码</span></span><br><span class="line">    <span class="keyword">this</span>.setAuthenticated(<span class="keyword">false</span>);<span class="comment">//当前存进去的信息是否经过身份验证</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p><code>UsernamePasswordAuthenticationFilter.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UsernamePasswordAuthenticationFilter</span></span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> Authentication <span class="title">attemptAuthentication</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">      HttpServletResponse response)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (postOnly &amp;&amp; !request.getMethod().equals(<span class="string">"POST"</span>)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> AuthenticationServiceException(</span><br><span class="line">            <span class="string">"Authentication method not supported: "</span> + request.getMethod());</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//获取用户密码</span></span><br><span class="line">   String username = obtainUsername(request);</span><br><span class="line">   String password = obtainPassword(request);</span><br><span class="line">   <span class="keyword">if</span> (username == <span class="keyword">null</span>) &#123;username = <span class="string">""</span>; &#125;</span><br><span class="line">   <span class="keyword">if</span> (password == <span class="keyword">null</span>) &#123;password = <span class="string">""</span>;&#125;</span><br><span class="line">   username = username.trim();</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* UsernamePasswordAuthenticationToken是Authentication接口的一个实现类</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">   UsernamePasswordAuthenticationToken authRequest = <span class="keyword">new</span> UsernamePasswordAuthenticationToken(</span><br><span class="line">         username, password);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Allow subclasses to set the "details" property</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* 将请求的一些信息，封装到上面的UsernamePasswordAuthenticationToken中</span></span><br><span class="line"><span class="comment">* 包括一些session信息，ip等</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">   setDetails(request, authRequest);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* this.getAuthenticationManager()返回一个AuthenticationManager对象</span></span><br><span class="line"><span class="comment">* 这个对象本身并不包含验证逻辑</span></span><br><span class="line"><span class="comment">* 作用：管理AuthenticationProvider</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">this</span>.getAuthenticationManager().authenticate(authRequest);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p><code>ProviderManager.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProviderManager</span> <span class="keyword">implements</span> <span class="title">AuthenticationManager</span>, <span class="title">MessageSourceAware</span>,</span></span><br><span class="line"><span class="class">      <span class="title">InitializingBean</span> </span>&#123;</span><br><span class="line">          </span><br><span class="line"><span class="function"><span class="keyword">public</span> Authentication <span class="title">authenticate</span><span class="params">(Authentication authentication)</span></span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">   <span class="comment">//获取Authentication的类型</span></span><br><span class="line">   Class&lt;? extends Authentication&gt; toTest = authentication.getClass();</span><br><span class="line">   AuthenticationException lastException = <span class="keyword">null</span>;</span><br><span class="line">   Authentication result = <span class="keyword">null</span>;</span><br><span class="line">   <span class="keyword">boolean</span> debug = logger.isDebugEnabled();</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* 不同的认证方式，它的认证逻辑是不一样的（如密码登陆需要验证密码，而微信登陆则不需要验证密码）</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">   <span class="keyword">for</span> (AuthenticationProvider provider : getProviders()) &#123;</span><br><span class="line">       <span class="comment">//每一种AuthenticaitonToken都有各自对应的AuthenticationProvider</span></span><br><span class="line">      <span class="keyword">if</span> (!provider.supports(toTest)) &#123;</span><br><span class="line">         <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (debug) &#123;</span><br><span class="line">         logger.debug(<span class="string">"Authentication attempt using "</span></span><br><span class="line">               + provider.getClass().getName());</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">	<span class="comment">//真正的校验逻辑</span></span><br><span class="line">         result = provider.authenticate(authentication);</span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</span><br><span class="line">            copyDetails(authentication, result);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (AccountStatusException e) &#123;</span><br><span class="line">         prepareException(e, authentication);</span><br><span class="line">         <span class="comment">// SEC-546: Avoid polling additional providers if auth failure is due to</span></span><br><span class="line">         <span class="comment">// invalid account status</span></span><br><span class="line">         <span class="keyword">throw</span> e;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (InternalAuthenticationServiceException e) &#123;</span><br><span class="line">         prepareException(e, authentication);</span><br><span class="line">         <span class="keyword">throw</span> e;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (AuthenticationException e) &#123;</span><br><span class="line">         lastException = e;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//循环结束</span></span><br><span class="line">   <span class="keyword">if</span> (result == <span class="keyword">null</span> &amp;&amp; parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">// Allow the parent to try.</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         result = parent.authenticate(authentication);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (ProviderNotFoundException e) &#123;</span><br><span class="line">         <span class="comment">// ignore as we will throw below if no other exception occurred prior to</span></span><br><span class="line">         <span class="comment">// calling parent and the parent</span></span><br><span class="line">         <span class="comment">// may throw ProviderNotFound even though a provider in the child already</span></span><br><span class="line">         <span class="comment">// handled the request</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (AuthenticationException e) &#123;</span><br><span class="line">         lastException = e;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (eraseCredentialsAfterAuthentication</span><br><span class="line">            &amp;&amp; (result <span class="keyword">instanceof</span> CredentialsContainer)) &#123;</span><br><span class="line">         <span class="comment">// Authentication is complete. Remove credentials and other secret data</span></span><br><span class="line">         <span class="comment">// from authentication</span></span><br><span class="line">         ((CredentialsContainer) result).eraseCredentials();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      eventPublisher.publishAuthenticationSuccess(result);</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Parent was null, or didn't authenticate (or throw an exception).</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (lastException == <span class="keyword">null</span>) &#123;</span><br><span class="line">      lastException = <span class="keyword">new</span> ProviderNotFoundException(messages.getMessage(</span><br><span class="line">            <span class="string">"ProviderManager.providerNotFound"</span>,</span><br><span class="line">            <span class="keyword">new</span> Object[] &#123; toTest.getName() &#125;,</span><br><span class="line">            <span class="string">"No AuthenticationProvider found for &#123;0&#125;"</span>));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   prepareException(lastException, authentication);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">throw</span> lastException;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p><code>AbstractUserDetailsAuthenticationProvider.java</code></p>
<p>result = provider.authenticate(authentication)的实现就是在此类中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractUserDetailsAuthenticationProvider</span> <span class="keyword">implements</span></span></span><br><span class="line"><span class="class">      <span class="title">AuthenticationProvider</span>, <span class="title">InitializingBean</span>, <span class="title">MessageSourceAware</span> </span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> Authentication <span class="title">authenticate</span><span class="params">(Authentication authentication)</span></span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">   Assert.isInstanceOf(UsernamePasswordAuthenticationToken.class, authentication,</span><br><span class="line">         messages.getMessage(</span><br><span class="line">               <span class="string">"AbstractUserDetailsAuthenticationProvider.onlySupports"</span>,</span><br><span class="line">               <span class="string">"Only UsernamePasswordAuthenticationToken is supported"</span>));</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Determine username</span></span><br><span class="line">   String username = (authentication.getPrincipal() == <span class="keyword">null</span>) ? <span class="string">"NONE_PROVIDED"</span></span><br><span class="line">         : authentication.getName();</span><br><span class="line"></span><br><span class="line">   <span class="keyword">boolean</span> cacheWasUsed = <span class="keyword">true</span>;</span><br><span class="line">   UserDetails user = <span class="keyword">this</span>.userCache.getUserFromCache(username);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (user == <span class="keyword">null</span>) &#123;</span><br><span class="line">      cacheWasUsed = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         user = retrieveUser(username,</span><br><span class="line">               (UsernamePasswordAuthenticationToken) authentication);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (UsernameNotFoundException notFound) &#123;</span><br><span class="line">         logger.debug(<span class="string">"User '"</span> + username + <span class="string">"' not found"</span>);</span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span> (hideUserNotFoundExceptions) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BadCredentialsException(messages.getMessage(</span><br><span class="line">                  <span class="string">"AbstractUserDetailsAuthenticationProvider.badCredentials"</span>,</span><br><span class="line">                  <span class="string">"Bad credentials"</span>));</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> notFound;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      Assert.notNull(user,</span><br><span class="line">            <span class="string">"retrieveUser returned null - a violation of the interface contract"</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      preAuthenticationChecks.check(user);</span><br><span class="line">      additionalAuthenticationChecks(user,</span><br><span class="line">            (UsernamePasswordAuthenticationToken) authentication);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (AuthenticationException exception) &#123;</span><br><span class="line">      <span class="keyword">if</span> (cacheWasUsed) &#123;</span><br><span class="line">         <span class="comment">// There was a problem, so try again after checking</span></span><br><span class="line">         <span class="comment">// we're using latest data (i.e. not from the cache)</span></span><br><span class="line">         cacheWasUsed = <span class="keyword">false</span>;</span><br><span class="line">         user = retrieveUser(username,</span><br><span class="line">               (UsernamePasswordAuthenticationToken) authentication);</span><br><span class="line">         preAuthenticationChecks.check(user);</span><br><span class="line">         additionalAuthenticationChecks(user,</span><br><span class="line">               (UsernamePasswordAuthenticationToken) authentication);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="keyword">throw</span> exception;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   postAuthenticationChecks.check(user);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (!cacheWasUsed) &#123;</span><br><span class="line">      <span class="keyword">this</span>.userCache.putUserInCache(user);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   Object principalToReturn = user;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (forcePrincipalAsString) &#123;</span><br><span class="line">      principalToReturn = user.getUsername();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> createSuccessAuthentication(principalToReturn, authentication, user);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="认证结果如何在多个请求之间共享"><a href="#认证结果如何在多个请求之间共享" class="headerlink" title="认证结果如何在多个请求之间共享"></a>认证结果如何在多个请求之间共享</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">登陆请求</span><br><span class="line">   | (携带登陆信息)</span><br><span class="line">UsernamePasswordAuthenticationFilter</span><br><span class="line">   | (携带未认证的Authentication)</span><br><span class="line">AuthenticationManager</span><br><span class="line">   |</span><br><span class="line">AuthenticationProvider</span><br><span class="line">   |</span><br><span class="line">UserDetailService</span><br><span class="line">   |</span><br><span class="line">UserDetails</span><br><span class="line">   |</span><br><span class="line">Authentication(已认证)</span><br><span class="line">   |</span><br><span class="line">SecurityContext</span><br><span class="line">   |</span><br><span class="line">SecurityContextHolder</span><br><span class="line">   |</span><br><span class="line">SecurityContextPersistenceFilter</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractAuthenticationProcessingFilter</span> <span class="keyword">extends</span> <span class="title">GenericFilterBean</span></span></span><br><span class="line"><span class="class">      <span class="keyword">implements</span> <span class="title">ApplicationEventPublisherAware</span>, <span class="title">MessageSourceAware</span> </span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest req, ServletResponse res, FilterChain chain)</span></span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">     … … …</span><br><span class="line">     successfulAuthentication(request, response, chain, authResult);</span><br><span class="line">&#125;</span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">successfulAuthentication</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">      HttpServletResponse response, FilterChain chain, Authentication authResult)</span></span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">… … …</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 将已经认证成功后的Authentication 放入 SecurityContext中，然后</span></span><br><span class="line"><span class="comment"> * 放进SecurityContextHolder</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">    SecurityContextHolder.getContext().setAuthentication(authResult);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="images/persistencefilter.png" alt=""></p>
<p><code>SecurityContextPersistenceFilter</code>过滤器的作用：</p>
<ol>
<li>当请求进来时，检查Session中是否有SecurityContext，如果有则取出放到当前线程中</li>
<li>当请求结束后，线程中有SecurityContext，则取出放进Session中</li>
</ol>
<h5 id="获取认证用户信息"><a href="#获取认证用户信息" class="headerlink" title="获取认证用户信息"></a>获取认证用户信息</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取当前用户信息，使用SecurityContextHolder</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/me"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getCurrentUser</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> SecurityContextHolder.getContext().getAuthentication();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取当前用户信息，使用Spring自动注入，</span></span><br><span class="line"><span class="comment">     * spring会在后台自动在SecurityContext中寻找相应的类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/me2"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getCurrentUsers</span><span class="params">(Authentication authentication)</span></span>&#123;</span><br><span class="line">       <span class="keyword">return</span> authentication;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="验证码功能"><a href="#验证码功能" class="headerlink" title="验证码功能"></a>验证码功能</h4><h5 id="实现思想"><a href="#实现思想" class="headerlink" title="实现思想"></a>实现思想</h5><p>​    校验实现思路：在<code>UsernamePasswordAuthenticationFilter</code>前，加入自定义的验证码过滤器，验证通过则进入<code>UsernamePasswordAuthenticationFilter</code>，验证不通过则抛出异常</p>
<ol>
<li>验证码参数可配置</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">请求级配置 （如服务中的参数）</span><br><span class="line">    | （覆盖）</span><br><span class="line">应用级配置 （在配置文件中定义）</span><br><span class="line">    | （覆盖）</span><br><span class="line"> 默认配置  （属性中的默认值）</span><br></pre></td></tr></table></figure>
<p>对于验证码，默认配置会存在默认值，当模块自定义时，配置会覆盖默认值（通过properties指定配置），当请求参数中存在指定参数，则会覆盖默认值或配置值</p>
<ol start="2">
<li>验证码拦截接口可配置</li>
</ol>
<p>系统提供默认的拦截URL，通过配置，用户也可以指定验证码接口拦截的URL</p>
<ol start="3">
<li>验证码生成逻辑可配置</li>
</ol>
<p>通过接口化，系统提供默认的验证码生成逻辑，用户自定义的生成逻辑，可覆盖系统的默认实现</p>
<ol start="4">
<li>基本类介绍</li>
</ol>
<p><strong>验证码生成器</strong></p>
<p><code>ValidateCodeGenerator</code> : 其作用是提供生成验证码接口</p>
<p>​    实现类 1) <code>ImageCodeGenerator</code> ： 图形验证码生成器，生成一个图形验证码</p>
<p>​    实现类 2) <code>SmsCodeGenerator</code> : 短信验证码生成器，生成一个短信验证码</p>
<p><strong>验证码处理器</strong></p>
<p><code>ValidateCodeProcessor</code> : 其作用是封装不同校验码的处理逻辑，提供<code>创建</code>和<code>验证</code>方法</p>
<p>​    实现类：<code>AbstractValidateCodeProcessor</code> : 此类为抽象类</p>
<p>​        作用是：1) 收集所有的验证码生成器</p>
<p>​                2) 创建验证码：包括生成验证码、保存验证码、发送验证码（可由子类自定义实现）</p>
<p>​            实现类 1)<code>ImageCodeProcessor</code>：覆盖父类中的发送验证码处理逻辑</p>
<p>​            实现类 2)<code>SmsCodeProcessor</code>：覆盖父类中的发送验证码处理逻辑</p>
<p><strong>验证码处理器寻找器</strong></p>
<p><code>ValidateCodeProcessorHolder</code> :其作用是</p>
<p>​    1) 收集所有<code>ValidateCodeProcessor</code> 的实现类</p>
<p>​    2) 根据请求类型，获取指定的<code>ValidateCodeProcessor</code> </p>
<p><strong>验证码存储器</strong></p>
<p><code>ValidateCodeRepository</code>：起作用是提供验证码保存、获取、删除</p>
<p><strong>验证码过滤器</strong></p>
<p><code>ValidateCodeFilter</code>： 用于在Spring Security 过滤器链中进行验证</p>
<p><strong>请求逻辑</strong></p>
<p><code>ValidateCodeProcessorHolder</code>通过请求中的TYPE(验证码类型)寻找相应类型的<code>ValidateCodeProcessor</code> 进行验证码的生成、保存和发送</p>
<h5 id="验证码接口定义"><a href="#验证码接口定义" class="headerlink" title="验证码接口定义"></a>验证码接口定义</h5><ol>
<li>验证码基类，所有验证码通用的属性</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 验证码属性，字符串验证码、过期时间</span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan 20180228</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ValidateCode</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String code;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> LocalDateTime expireTime;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ValidateCode</span><span class="params">(String code, <span class="keyword">int</span> expireIn)</span></span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.code = code;</span><br><span class="line">		<span class="keyword">this</span>.expireTime = LocalDateTime.now().plusSeconds(expireIn);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ValidateCode</span><span class="params">(String code, LocalDateTime expireTime)</span></span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.code = code;</span><br><span class="line">		<span class="keyword">this</span>.expireTime = expireTime;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isExpried</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> LocalDateTime.now().isAfter(expireTime);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> code;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCode</span><span class="params">(String code)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.code = code;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> LocalDateTime <span class="title">getExpireTime</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> expireTime;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setExpireTime</span><span class="params">(LocalDateTime expireTime)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.expireTime = expireTime;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>验证码异常类，存储验证码异常信息</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 验证码异常类</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan 20180228</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ValidateCodeException</span> <span class="keyword">extends</span> <span class="title">AuthenticationException</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">7285211528095468156L</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ValidateCodeException</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(msg);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>验证码生成器接口</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 验证码生成器接口</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan 20180301</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ValidateCodeGenerator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function">ValidateCode <span class="title">generate</span><span class="params">(ServletWebRequest request)</span></span>;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>验证码处理器接口</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 校验码处理器，封装不同校验码的处理逻辑</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan 20180301</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ValidateCodeProcessor</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 验证码放入session时的前缀</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	String SESSION_KEY_PREFIX = <span class="string">"SESSION_KEY_FOR_CODE_"</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 创建校验码</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> request 工具类，request or response 都可以放入此包装类</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">create</span><span class="params">(ServletWebRequest request)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 校验验证码</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> servletWebRequest 工具类，request or response 都可以放入此包装类</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">validate</span><span class="params">(ServletWebRequest servletWebRequest)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>验证码处理器寻找器定义</li>
</ol>
<p>主要用于寻找指定的验证码处理器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ValidateCodeProcessorHolder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> Map&lt;String, ValidateCodeProcessor&gt; validateCodeProcessors;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> ValidateCodeProcessor <span class="title">findValidateCodeProcessor</span><span class="params">(ValidateCodeType type)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> findValidateCodeProcessor(type.toString().toLowerCase());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> ValidateCodeProcessor <span class="title">findValidateCodeProcessor</span><span class="params">(String type)</span> </span>&#123;</span><br><span class="line">		String name = type.toLowerCase() + ValidateCodeProcessor.class.getSimpleName();</span><br><span class="line">		ValidateCodeProcessor processor = validateCodeProcessors.get(name);</span><br><span class="line">		<span class="keyword">if</span> (processor == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> ValidateCodeException(<span class="string">"验证码处理器"</span> + name + <span class="string">"不存在"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> processor;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="6">
<li>验证码类型定义，主要定义了短信验证码与图片验证码</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 验证码类型</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * String DEFAULT_PARAMETER_NAME_CODE_IMAGE = "imageCode";</span></span><br><span class="line"><span class="comment"> * 验证图片验证码时，http请求中默认的携带图片验证码信息的参数的名称</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * String DEFAULT_PARAMETER_NAME_CODE_SMS = "smsCode";</span></span><br><span class="line"><span class="comment"> * 验证短信验证码时，http请求中默认的携带短信验证码信息的参数的名称</span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan 20180308</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> ValidateCodeType &#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 短信验证码</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	SMS &#123;</span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> String <span class="title">getParamNameOnValidate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			<span class="keyword">return</span> SecurityConstants.DEFAULT_PARAMETER_NAME_CODE_SMS;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 图片验证码</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	IMAGE &#123;</span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> String <span class="title">getParamNameOnValidate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			<span class="keyword">return</span> SecurityConstants.DEFAULT_PARAMETER_NAME_CODE_IMAGE;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 校验时从请求中获取的参数的名字</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> String <span class="title">getParamNameOnValidate</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="7">
<li>定义验证码配置属性</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 验证码需要配置的基本属性</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan 20180308</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CodeProperties</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> length = <span class="number">4</span>;  <span class="comment">//验证码基本长度</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> expireIn = <span class="number">60</span>;<span class="comment">//验证码的过期时间/秒</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String url; <span class="comment">//拦截url可配置化</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getLength</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> length;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLength</span><span class="params">(<span class="keyword">int</span> lenght)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.length = lenght;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getExpireIn</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> expireIn;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setExpireIn</span><span class="params">(<span class="keyword">int</span> expireIn)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.expireIn = expireIn;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUrl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> url;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUrl</span><span class="params">(String url)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.url = url;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="8">
<li>定义配置属性，并加入<code>SecurityProperties</code>配置类中</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 所有验证码类型属性分类</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan 20180308</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ValidateCodeProperties</span> </span>&#123;</span><br><span class="line">	<span class="comment">//图形验证码属性</span></span><br><span class="line">    <span class="keyword">private</span> ImageCodeProperties image = <span class="keyword">new</span> ImageCodeProperties();</span><br><span class="line">    <span class="comment">//短信验证码属性</span></span><br><span class="line">    <span class="keyword">private</span> SmsCodeProperties sms = <span class="keyword">new</span> SmsCodeProperties();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ImageCodeProperties <span class="title">getImage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> image;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setImage</span><span class="params">(ImageCodeProperties image)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.image = image;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SmsCodeProperties <span class="title">getSms</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> sms;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSms</span><span class="params">(SmsCodeProperties sms)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.sms = sms;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="7">
<li>定义统一的验证码处理器，规范验证码处理的逻辑</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 使用模板方法进行抽取</span></span><br><span class="line"><span class="comment"> * 生成可重用的验证码操作逻辑</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan 20180228</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractValidateCodeProcessor</span>&lt;<span class="title">C</span> <span class="keyword">extends</span> <span class="title">ValidateCode</span>&gt; <span class="keyword">implements</span> <span class="title">ValidateCodeProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * spring中的依赖查找</span></span><br><span class="line"><span class="comment">	 * 所有验证码生成器</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> Map&lt;String, ValidateCodeGenerator&gt; validateCodeGenerators;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//验证码存储接口</span></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> ValidateCodeRepository validateCodeRepository;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 主干逻辑想通过，但处理不同</span></span><br><span class="line"><span class="comment">	 * 1.创建验证码</span></span><br><span class="line"><span class="comment">	 * 2.保存验证码</span></span><br><span class="line"><span class="comment">	 * 3.发送验证码</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">create</span><span class="params">(ServletWebRequest request)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		C validateCode = generate(request);</span><br><span class="line">		save(request, validateCode);</span><br><span class="line">		send(request, validateCode);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 生成校验码</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">private</span> C <span class="title">generate</span><span class="params">(ServletWebRequest request)</span> </span>&#123;</span><br><span class="line">		String type = getProcessorType(request);</span><br><span class="line">		ValidateCodeGenerator validateCodeGenerator = validateCodeGenerators.get(type + <span class="string">"ValidateCodeGenerator"</span>);</span><br><span class="line">		<span class="keyword">return</span> (C) validateCodeGenerator.generate(request);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 保存校验码</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> validateCode</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">(ServletWebRequest request, C validateCode)</span> </span>&#123;</span><br><span class="line">		ValidateCode code = <span class="keyword">new</span> ValidateCode(validateCode.getCode(),validateCode.getExpireTime());</span><br><span class="line">		<span class="comment">//sessionStrategy.setAttribute(request, SESSION_KEY_PREFIX + getProcessorType(request).toUpperCase(), code);</span></span><br><span class="line">		validateCodeRepository.save(request, code, getValidateCodeType(request));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 发送校验码，由子类实现</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> validateCode</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(ServletWebRequest request, C validateCode)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 根据请求的url获取校验码的类型</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> String <span class="title">getProcessorType</span><span class="params">(ServletWebRequest request)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> StringUtils.substringAfter(request.getRequest().getRequestURI(), <span class="string">"/code/"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">validate</span><span class="params">(ServletWebRequest request)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		ValidateCodeType processorType = getValidateCodeType(request);</span><br><span class="line"></span><br><span class="line">		C codeInSession = (C) validateCodeRepository.get(request, processorType);</span><br><span class="line"></span><br><span class="line">		String codeInRequest;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			codeInRequest = ServletRequestUtils.getStringParameter(request.getRequest(),</span><br><span class="line">					processorType.getParamNameOnValidate());</span><br><span class="line">		&#125; <span class="keyword">catch</span> (ServletRequestBindingException e) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> ValidateCodeException(<span class="string">"获取验证码的值失败"</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (StringUtils.isBlank(codeInRequest)) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> ValidateCodeException(processorType + <span class="string">"验证码的值不能为空"</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (codeInSession == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> ValidateCodeException(processorType + <span class="string">"验证码不存在"</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (codeInSession.isExpried()) &#123;</span><br><span class="line">			validateCodeRepository.remove(request, processorType);</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> ValidateCodeException(processorType + <span class="string">"验证码已过期"</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!StringUtils.equals(codeInSession.getCode(), codeInRequest)) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> ValidateCodeException(processorType + <span class="string">"验证码不匹配"</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		validateCodeRepository.remove(request, processorType);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 构建验证码放入session时的key</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> String <span class="title">getSessionKey</span><span class="params">(ServletWebRequest request)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> SESSION_KEY_PREFIX + getValidateCodeType(request).toString().toUpperCase();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 根据请求的url获取校验码的类型</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> ValidateCodeType <span class="title">getValidateCodeType</span><span class="params">(ServletWebRequest request)</span> </span>&#123;</span><br><span class="line">		String type = StringUtils.substringBefore(getClass().getSimpleName(), <span class="string">"CodeProcessor"</span>);</span><br><span class="line">		<span class="keyword">return</span> ValidateCodeType.valueOf(type.toUpperCase());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="8">
<li>定义统一的验证码存储器，用户根据不同的环境下，存储验证码</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 验证码存储接口</span></span><br><span class="line"><span class="comment"> * 提供给不同类型的自定义实现，浏览器项目可用session ， app项目可用redis数据库等进行验证码的保存</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan 20180305</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ValidateCodeRepository</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 保存验证码</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> request 请求</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> code 验证码实体</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> validateCodeType 验证码类型</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">save</span><span class="params">(ServletWebRequest request, ValidateCode code, ValidateCodeType validateCodeType)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 获取验证码</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> request 请求</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> validateCodeType 验证码类型</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function">ValidateCode <span class="title">get</span><span class="params">(ServletWebRequest request, ValidateCodeType validateCodeType)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 移除验证码</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> request 请求</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> codeType 验证码类型</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">remove</span><span class="params">(ServletWebRequest request, ValidateCodeType codeType)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="图形验证码"><a href="#图形验证码" class="headerlink" title="图形验证码"></a>图形验证码</h5><ol>
<li>定义图形验证码配置属性</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 图形验证码属性</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan 20180228</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageCodeProperties</span> <span class="keyword">extends</span> <span class="title">CodeProperties</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//验证码的默认长度与高度</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> width = <span class="number">67</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> height = <span class="number">23</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getWidth</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> width;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setWidth</span><span class="params">(<span class="keyword">int</span> width)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.width = width;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getHeight</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> height;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setHeight</span><span class="params">(<span class="keyword">int</span> height)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.height = height;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>定义图片验证码实体类</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 图片验证码</span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan 20180228</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageCode</span> <span class="keyword">extends</span> <span class="title">ValidateCode</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> BufferedImage image;</span><br><span class="line">   </span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">ImageCode</span><span class="params">(BufferedImage image, String code, <span class="keyword">int</span> expireIn)</span></span>&#123;</span><br><span class="line">      <span class="keyword">super</span>(code,expireIn);</span><br><span class="line">      <span class="keyword">this</span>.image = image;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">ImageCode</span><span class="params">(BufferedImage image, String code, LocalDateTime expireTime)</span></span>&#123;</span><br><span class="line">      <span class="keyword">super</span>(code,expireTime);</span><br><span class="line">      <span class="keyword">this</span>.image = image;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> BufferedImage <span class="title">getImage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> image;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setImage</span><span class="params">(BufferedImage image)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.image = image;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>定义图片验证码生成器</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 图片验证码生成器</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan 20180301</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageCodeGenerator</span> <span class="keyword">implements</span> <span class="title">ValidateCodeGenerator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> SecurityProperties securityProperties;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> ImageCode <span class="title">generate</span><span class="params">(ServletWebRequest request)</span> </span>&#123;</span><br><span class="line">         <span class="comment">//实现参数覆盖配置</span></span><br><span class="line">		<span class="keyword">int</span> width = ServletRequestUtils.getIntParameter(request.getRequest(), <span class="string">"width"</span>,</span><br><span class="line">				securityProperties.getCode().getImage().getWidth());</span><br><span class="line">		<span class="keyword">int</span> height = ServletRequestUtils.getIntParameter(request.getRequest(), <span class="string">"height"</span>,</span><br><span class="line">				securityProperties.getCode().getImage().getHeight());</span><br><span class="line">		BufferedImage image = <span class="keyword">new</span> BufferedImage(width, height, BufferedImage.TYPE_INT_RGB);</span><br><span class="line"></span><br><span class="line">		Graphics g = image.getGraphics();</span><br><span class="line"></span><br><span class="line">		Random random = <span class="keyword">new</span> Random();</span><br><span class="line"></span><br><span class="line">		g.setColor(getRandColor(<span class="number">200</span>, <span class="number">250</span>));</span><br><span class="line">		g.fillRect(<span class="number">0</span>, <span class="number">0</span>, width, height);</span><br><span class="line">		g.setFont(<span class="keyword">new</span> Font(<span class="string">"Times New Roman"</span>, Font.ITALIC, <span class="number">20</span>));</span><br><span class="line">		g.setColor(getRandColor(<span class="number">160</span>, <span class="number">200</span>));</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">155</span>; i++) &#123;</span><br><span class="line">			<span class="keyword">int</span> x = random.nextInt(width);</span><br><span class="line">			<span class="keyword">int</span> y = random.nextInt(height);</span><br><span class="line">			<span class="keyword">int</span> xl = random.nextInt(<span class="number">12</span>);</span><br><span class="line">			<span class="keyword">int</span> yl = random.nextInt(<span class="number">12</span>);</span><br><span class="line">			g.drawLine(x, y, x + xl, y + yl);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		String sRand = <span class="string">""</span>;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; securityProperties.getCode().getImage().getLength(); i++) &#123;</span><br><span class="line">			String rand = String.valueOf(random.nextInt(<span class="number">10</span>));</span><br><span class="line">			sRand += rand;</span><br><span class="line">			g.setColor(<span class="keyword">new</span> Color(<span class="number">20</span> + random.nextInt(<span class="number">110</span>), <span class="number">20</span> + random.nextInt(<span class="number">110</span>), <span class="number">20</span> + random.nextInt(<span class="number">110</span>)));</span><br><span class="line">			g.drawString(rand, <span class="number">13</span> * i + <span class="number">6</span>, <span class="number">16</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		g.dispose();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> ImageCode(image, sRand, securityProperties.getCode().getImage().getExpireIn());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 生成随机背景条纹</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> fc</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> bc</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> Color <span class="title">getRandColor</span><span class="params">(<span class="keyword">int</span> fc, <span class="keyword">int</span> bc)</span> </span>&#123;</span><br><span class="line">		Random random = <span class="keyword">new</span> Random();</span><br><span class="line">		<span class="keyword">if</span> (fc &gt; <span class="number">255</span>) &#123;</span><br><span class="line">			fc = <span class="number">255</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (bc &gt; <span class="number">255</span>) &#123;</span><br><span class="line">			bc = <span class="number">255</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">int</span> r = fc + random.nextInt(bc - fc);</span><br><span class="line">		<span class="keyword">int</span> g = fc + random.nextInt(bc - fc);</span><br><span class="line">		<span class="keyword">int</span> b = fc + random.nextInt(bc - fc);</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> Color(r, g, b);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> SecurityProperties <span class="title">getSecurityProperties</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> securityProperties;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSecurityProperties</span><span class="params">(SecurityProperties securityProperties)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.securityProperties = securityProperties;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>图片验证码处理器</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 图片验证码处理器</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan 20180301</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span>(<span class="string">"imageValidateCodeProcessor"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageCodeProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractValidateCodeProcessor</span>&lt;<span class="title">ImageCode</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 发送图形验证码，将其写到响应中</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(ServletWebRequest request, ImageCode imageCode)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		ImageIO.write(imageCode.getImage(), <span class="string">"JPEG"</span>, request.getResponse().getOutputStream());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="短信验证码"><a href="#短信验证码" class="headerlink" title="短信验证码"></a>短信验证码</h5><ol>
<li>定义短信验证码配置属性</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 短信验证码属性</span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan 20180301</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SmsCodeProperties</span> <span class="keyword">extends</span> <span class="title">CodeProperties</span></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>定义短信验证码实体类</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 短信验证码</span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan 20170308</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SmsCode</span> <span class="keyword">extends</span> <span class="title">ValidateCode</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SmsCode</span><span class="params">(String code, <span class="keyword">int</span> expireIn)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(code, expireIn);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SmsCode</span><span class="params">(String code, LocalDateTime expireTime)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(code, expireTime);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>定义短信验证码生成器</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 短信验证码生成器</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan 20180301</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SmsCodeGenerator</span> <span class="keyword">implements</span> <span class="title">ValidateCodeGenerator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> SecurityProperties securityProperties;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 短信验证码生成</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> request 请求</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> 验证码实现类</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> ValidateCode <span class="title">generate</span><span class="params">(ServletWebRequest request)</span> </span>&#123;</span><br><span class="line">		String code = RandomStringUtils.randomNumeric(securityProperties.getCode().getSms().getLength());</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> SmsCode(code, securityProperties.getCode().getSms().getExpireIn());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> SecurityProperties <span class="title">getSecurityProperties</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> securityProperties;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSecurityProperties</span><span class="params">(SecurityProperties securityProperties)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.securityProperties = securityProperties;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>短信验证码处理器</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 短信验证码处理器</span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan 20180301</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span>(<span class="string">"smsValidateCodeProcessor"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SmsCodeProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractValidateCodeProcessor</span>&lt;<span class="title">ValidateCode</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 短信验证码发送器</span></span><br><span class="line"><span class="comment">	 * 需要进行bean配置,默认使用核心包中的DefaultSmsCodeSender</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> SmsCodeSender smsCodeSender;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 发送处理逻辑不一样，需要重新实现</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(ServletWebRequest request, ValidateCode validateCode)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		String mobile = ServletRequestUtils.getRequiredStringParameter(request.getRequest(), SecurityConstants.DEFAULT_PARAMETER_NAME_MOBILE);</span><br><span class="line">		smsCodeSender.send(mobile, validateCode.getCode());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>定义短信发送商规范接口，并提供一个默认实现类</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 短信验证码发送者实现发送接口</span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan 20180301</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SmsCodeSender</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 短信验证码发送逻辑</span></span><br><span class="line"><span class="comment">	 * 需要开发者继承此接口，并实现业务处理逻辑</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> mobile 手机号</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> code 验证码</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">send</span><span class="params">(String mobile, String code)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 短信验证码发送者实现发送接口默认实现类</span></span><br><span class="line"><span class="comment"> * 自定义可以覆盖默认实现类</span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan 20180301</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultSmsCodeSender</span> <span class="keyword">implements</span> <span class="title">SmsCodeSender</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(String mobile, String code)</span> </span>&#123;</span><br><span class="line">		<span class="comment">//模拟实现</span></span><br><span class="line">		System.out.println(<span class="string">"向手机"</span>+mobile+<span class="string">"发送短信验证码"</span>+code);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="验证码实体类配置"><a href="#验证码实体类配置" class="headerlink" title="验证码实体类配置"></a>验证码实体类配置</h5><p>目的：提供默认的图片验证、短信验证码生成器等。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 验证码相关的扩展点配置。配置在这里的bean，业务系统都可以通过声明同类型或同名的bean来覆盖安全</span></span><br><span class="line"><span class="comment"> * 模块默认的配置。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan 20180308</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ValidateCodeBeanConfig</span> </span>&#123;</span><br><span class="line">   </span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> SecurityProperties securityProperties;</span><br><span class="line">   </span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 图片验证码图片生成器</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> ValidateCodeGenerator图片验证码生成器</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="meta">@ConditionalOnMissingBean</span>(name = <span class="string">"imageValidateCodeGenerator"</span>)</span><br><span class="line">   <span class="function"><span class="keyword">public</span> ValidateCodeGenerator <span class="title">imageValidateCodeGenerator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      ImageCodeGenerator codeGenerator = <span class="keyword">new</span> ImageCodeGenerator();</span><br><span class="line">      codeGenerator.setSecurityProperties(securityProperties);</span><br><span class="line">      <span class="keyword">return</span> codeGenerator;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 短信验证码生成器</span></span><br><span class="line"><span class="comment">    *  <span class="doctag">@return</span> ValidateCodeGenerator短信验证码生成器</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="meta">@ConditionalOnMissingBean</span>(name = <span class="string">"smsValidateCodeGenerator"</span>)</span><br><span class="line">   <span class="function"><span class="keyword">public</span> ValidateCodeGenerator <span class="title">smsValidateCodeGenerator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      SmsCodeGenerator codeGenerator = <span class="keyword">new</span> SmsCodeGenerator();</span><br><span class="line">      codeGenerator.setSecurityProperties(securityProperties);</span><br><span class="line">      <span class="keyword">return</span> codeGenerator;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 短信验证码发送器</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> SmsCodeSender 默认实现类</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="meta">@ConditionalOnMissingBean</span>(SmsCodeSender.class)</span><br><span class="line">   <span class="function"><span class="keyword">public</span> SmsCodeSender <span class="title">smsCodeSender</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> DefaultSmsCodeSender();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="验证码校验过滤器的生成"><a href="#验证码校验过滤器的生成" class="headerlink" title="验证码校验过滤器的生成"></a>验证码校验过滤器的生成</h5><p>生成过滤器，主要是为了加入Spring Security过滤器链中，并且在<code>UsernamePasswordAuthenticationFilter</code>之前</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 生成过滤器，负责对验证码进行校验</span></span><br><span class="line"><span class="comment"> * InitializingBean:初始化bean后完成一些指定的业务处理逻辑</span></span><br><span class="line"><span class="comment"> * OncePerRequestFilter:在spring中，filter都默认继承OncePerRequestFilter,确保在一次请求只通过一次filter，而不需要重复执行</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan 20180308</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span>(<span class="string">"validateCodeFilter"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ValidateCodeFilter</span> <span class="keyword">extends</span> <span class="title">OncePerRequestFilter</span> <span class="keyword">implements</span> <span class="title">InitializingBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 验证码校验失败处理器</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> AuthenticationFailureHandler authenticationFailureHandler;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 系统配置信息</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> SecurityProperties securityProperties;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 系统中的校验码处理器</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> ValidateCodeProcessorHolder validateCodeProcessorHolder;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 存放所有需要校验验证码的url</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">private</span> Map&lt;String, ValidateCodeType&gt; urlMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 验证请求url与配置的url是否匹配的工具类</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">private</span> AntPathMatcher pathMatcher = <span class="keyword">new</span> AntPathMatcher();</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 初始化要拦截的url配置信息</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">      <span class="keyword">super</span>.afterPropertiesSet();</span><br><span class="line"></span><br><span class="line">      <span class="comment">//从系统中读取信息，放入不同的类型</span></span><br><span class="line">      urlMap.put(SecurityConstants.DEFAULT_LOGIN_PROCESSING_URL_FORM, ValidateCodeType.IMAGE);</span><br><span class="line">      addUrlToMap(securityProperties.getCode().getImage().getUrl(), ValidateCodeType.IMAGE);</span><br><span class="line"></span><br><span class="line">      urlMap.put(SecurityConstants.DEFAULT_LOGIN_PROCESSING_URL_MOBILE, ValidateCodeType.SMS);</span><br><span class="line">      addUrlToMap(securityProperties.getCode().getSms().getUrl(), ValidateCodeType.SMS);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 从系统中配置的需要校验验证码的URL根据校验的类型放入map</span></span><br><span class="line"><span class="comment">    * </span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> urlString 配置的url字符串,每条url用,分割</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> type 验证码类型</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addUrlToMap</span><span class="params">(String urlString, ValidateCodeType type)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (StringUtils.isNotBlank(urlString)) &#123;</span><br><span class="line">         String[] urls = StringUtils.splitByWholeSeparatorPreserveAllTokens(urlString, <span class="string">","</span>);</span><br><span class="line">         <span class="keyword">for</span> (String url : urls) &#123;</span><br><span class="line">            urlMap.put(url, type);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doFilterInternal</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain)</span></span></span><br><span class="line"><span class="function">         <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">      ValidateCodeType type = getValidateCodeType(request);</span><br><span class="line">      <span class="keyword">if</span> (type != <span class="keyword">null</span>) &#123;</span><br><span class="line">         logger.info(<span class="string">"校验请求("</span> + request.getRequestURI() + <span class="string">")中的验证码,验证码类型"</span> + type);</span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">            validateCodeProcessorHolder.findValidateCodeProcessor(type)</span><br><span class="line">                  .validate(<span class="keyword">new</span> ServletWebRequest(request, response));</span><br><span class="line">            logger.info(<span class="string">"验证码校验通过"</span>);</span><br><span class="line">         &#125; <span class="keyword">catch</span> (ValidateCodeException exception) &#123;</span><br><span class="line">            authenticationFailureHandler.onAuthenticationFailure(request, response, exception);</span><br><span class="line">            <span class="keyword">return</span>;<span class="comment">//防止继续请求</span></span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      chain.doFilter(request, response);</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 获取校验码的类型，如果当前请求不需要校验，则返回null</span></span><br><span class="line"><span class="comment">    * </span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> ValidateCodeType <span class="title">getValidateCodeType</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">      ValidateCodeType result = <span class="keyword">null</span>;</span><br><span class="line">      <span class="keyword">if</span> (!StringUtils.equalsIgnoreCase(request.getMethod(), <span class="string">"get"</span>)) &#123;</span><br><span class="line">         Set&lt;String&gt; urls = urlMap.keySet();</span><br><span class="line">         <span class="keyword">for</span> (String url : urls) &#123;</span><br><span class="line">            <span class="keyword">if</span> (pathMatcher.match(url, request.getRequestURI())) &#123;</span><br><span class="line">               result = urlMap.get(url);</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="登陆页面改造"><a href="#登陆页面改造" class="headerlink" title="登陆页面改造"></a>登陆页面改造</h5><ol>
<li>图形验证码：<code>&lt;img src=&quot;/code/image?width=200&quot;&gt;</code></li>
<li>短信验证码：<code>&lt;a href=&quot;/code/sms?mobile=13012345678&quot;&gt;发送验证码&lt;/a&gt;</code></li>
</ol>
<h5 id="配置成为Spring-security-过滤器中的一员"><a href="#配置成为Spring-security-过滤器中的一员" class="headerlink" title="配置成为Spring security 过滤器中的一员"></a>配置成为Spring security 过滤器中的一员</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 校验码相关安全配置</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan 20180308</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span>(<span class="string">"validateCodeSecurityConfig"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ValidateCodeSecurityConfig</span> <span class="keyword">extends</span> <span class="title">SecurityConfigurerAdapter</span>&lt;<span class="title">DefaultSecurityFilterChain</span>, <span class="title">HttpSecurity</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> Filter validateCodeFilter;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 将自定义的验证码校验过滤器加入spring sucurity的过滤器链中</span></span><br><span class="line"><span class="comment">    * 为保证能在自定义的短信验证码登录AuthenticationFilter(自定义的像UsernamePasswordAuthentication类实现的功能)能比其他Authentication过滤器先在执行</span></span><br><span class="line"><span class="comment">    * 因此将自定义的过滤器加在spring security 过滤器链中的AbstractPreAuthenticatedProcessingFilter</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> http HttpSecurity</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      http.addFilterBefore(validateCodeFilter, AbstractPreAuthenticatedProcessingFilter.class);</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="开启服务"><a href="#开启服务" class="headerlink" title="开启服务"></a>开启服务</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 生成校验码的请求处理器</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan on 20180309</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ValidateCodeController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> ValidateCodeProcessorHolder validateCodeProcessorHolder;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 创建验证码，根据验证码类型不同，调用不同的 &#123;<span class="doctag">@link</span> ValidateCodeProcessor&#125;接口实现</span></span><br><span class="line"><span class="comment">    * </span></span><br><span class="line"><span class="comment">    * 默认的处理验证码的url前缀</span></span><br><span class="line"><span class="comment">    * String DEFAULT_VALIDATE_CODE_URL_PREFIX = "/code";</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> response</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> type</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@GetMapping</span>(SecurityConstants.DEFAULT_VALIDATE_CODE_URL_PREFIX + <span class="string">"/&#123;type&#125;"</span>)</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createCode</span><span class="params">(HttpServletRequest request, HttpServletResponse response, @PathVariable String type)</span></span></span><br><span class="line"><span class="function">         <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">       <span class="comment">//根据类型从验证码处理器中找到验证码生成器，并生成验证码</span></span><br><span class="line">      validateCodeProcessorHolder.findValidateCodeProcessor(type).create(<span class="keyword">new</span> ServletWebRequest(request, response));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="记住我功能"><a href="#记住我功能" class="headerlink" title="记住我功能"></a>记住我功能</h4><h5 id="记住我基本原理"><a href="#记住我基本原理" class="headerlink" title="记住我基本原理"></a>记住我基本原理</h5><p><img src="images/rememberme-1.png" alt=""></p>
<p><img src="images/rememberme-2.png" alt=""></p>
<p>当其他的的过滤器无法认证时（如<code>UsernamePasswordAuthenticationFilter</code>），<code>RememberMeAuthenticationFilter</code>会尝试进行验证</p>
<h5 id="功能实现"><a href="#功能实现" class="headerlink" title="功能实现"></a>功能实现</h5><ol>
<li>页面添加属性，属性名必须为<code>remember-me</code></li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"remember-me"</span> <span class="attr">type</span>=<span class="string">"checkbox"</span> <span class="attr">value</span>=<span class="string">"true"</span> /&gt;</span>记住我</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>配置<code>TokenRepository</code>相关配置</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BrowserSecurityBeanConfig</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> DataSource dataSource;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 配置是否开启remmemberMe功能</span></span><br><span class="line"><span class="comment">	 * 只有配置中存在turing.security.browser.remember-me" 并且值为true才会生效</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@ConditionalOnProperty</span>(prefix = <span class="string">"turing.security.browser"</span>, name = <span class="string">"remember-me"</span>, havingValue = <span class="string">"true"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> PersistentTokenRepository <span class="title">persistentTokenRepository</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		JdbcTokenRepositoryImpl tokenRepository = <span class="keyword">new</span> JdbcTokenRepositoryImpl();</span><br><span class="line">		tokenRepository.setDataSource(dataSource);</span><br><span class="line">        <span class="comment">//数据库不存在，则会创建，如果存在则会报错</span></span><br><span class="line">		tokenRepository.setCreateTableOnStartup(<span class="keyword">true</span>);<span class="comment">//启动的时候建表</span></span><br><span class="line">		<span class="keyword">return</span> tokenRepository;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//其他配置省略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>Security安全配置中实现配置，开启RememberMe功能，此特性为浏览器特性特有，因此配置在浏览器项目的核心配置中</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BrowserSecurityConfig</span>  <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> SecurityProperties securityProperties;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//配置RemmberMe所需要的数据操作仓库</span></span><br><span class="line">	<span class="meta">@Autowired</span>(required = <span class="keyword">false</span>)</span><br><span class="line">	<span class="keyword">private</span> PersistentTokenRepository persistentTokenRepository;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> UserDetailsService userDetailsService;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 配置浏览器特有的安全配置，并且读取全局配置，加入spring security安全配置中</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> http</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//是否开启remmemberMe功能</span></span><br><span class="line">		<span class="keyword">if</span> (persistentTokenRepository != <span class="keyword">null</span>)&#123;</span><br><span class="line">			http.rememberMe()</span><br><span class="line">					.tokenRepository(persistentTokenRepository)<span class="comment">//配置数据每个用户对应的token</span></span><br><span class="line">                .tokenValiditySeconds(securityProperties.getBrowser().getRememberMeSeconds())</span><br><span class="line">                <span class="comment">//在浏览器属性配置中增加rememberMe的过期时间</span></span><br><span class="line">					.userDetailsService(userDetailsService);<span class="comment">//拿到用户名后从该user找到用户</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//省略其他相关配置</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="RememberMe源码解析"><a href="#RememberMe源码解析" class="headerlink" title="RememberMe源码解析"></a>RememberMe源码解析</h5><h6 id="普通登陆处理"><a href="#普通登陆处理" class="headerlink" title="普通登陆处理"></a>普通登陆处理</h6><ol>
<li><code>AbstractAuthenticationProcessingFilter.java</code></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * spring提供的登陆验证处理器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractAuthenticationProcessingFilter</span> <span class="keyword">extends</span> <span class="title">GenericFilterBean</span></span></span><br><span class="line"><span class="class">      <span class="keyword">implements</span> <span class="title">ApplicationEventPublisherAware</span>, <span class="title">MessageSourceAware</span> </span>&#123;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 登陆成功</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">successfulAuthentication</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">      HttpServletResponse response, FilterChain chain, Authentication authResult)</span></span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">      logger.debug(<span class="string">"Authentication success. Updating SecurityContextHolder to contain: "</span></span><br><span class="line">            + authResult);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//将认证信息放入Context中</span></span><br><span class="line">   SecurityContextHolder.getContext().setAuthentication(authResult);</span><br><span class="line">   <span class="comment">//rememberMe处理</span></span><br><span class="line">   rememberMeServices.loginSuccess(request, response, authResult);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Fire event</span></span><br><span class="line">   <span class="keyword">if</span> (<span class="keyword">this</span>.eventPublisher != <span class="keyword">null</span>) &#123;</span><br><span class="line">      eventPublisher.publishEvent(<span class="keyword">new</span> InteractiveAuthenticationSuccessEvent(</span><br><span class="line">            authResult, <span class="keyword">this</span>.getClass()));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   successHandler.onAuthenticationSuccess(request, response, authResult);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li><code>AbstractRememberMeServices.java</code></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractRememberMeServices</span> <span class="keyword">implements</span> <span class="title">RememberMeServices</span>,</span></span><br><span class="line"><span class="class">      <span class="title">InitializingBean</span>, <span class="title">LogoutHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">loginSuccess</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">      HttpServletResponse response, Authentication successfulAuthentication)</span> </span>&#123;</span><br><span class="line">   <span class="comment">//是否开启RemmberMe，检查请求参数中是否带remember-me参数</span></span><br><span class="line">   <span class="keyword">if</span> (!rememberMeRequested(request, parameter)) &#123;</span><br><span class="line">      logger.debug(<span class="string">"Remember-me login not requested."</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   onLoginSuccess(request, response, successfulAuthentication);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li><code>PersistentTokenBasedRememberMeServices.java</code></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PersistentTokenBasedRememberMeServices</span> <span class="keyword">extends</span> <span class="title">AbstractRememberMeServices</span> </span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLoginSuccess</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">      HttpServletResponse response, Authentication successfulAuthentication)</span> </span>&#123;</span><br><span class="line">   String username = successfulAuthentication.getName();</span><br><span class="line"></span><br><span class="line">   logger.debug(<span class="string">"Creating new persistent login for user "</span> + username);</span><br><span class="line"></span><br><span class="line">   PersistentRememberMeToken persistentToken = <span class="keyword">new</span> PersistentRememberMeToken(</span><br><span class="line">         username, generateSeriesData(), generateTokenData(), <span class="keyword">new</span> Date());</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="comment">//写入token</span></span><br><span class="line">      tokenRepository.createNewToken(persistentToken);</span><br><span class="line">		<span class="comment">//写入浏览器</span></span><br><span class="line">      addCookie(persistentToken, request, response);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      logger.error(<span class="string">"Failed to save persistent token "</span>, e);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="普通访问处理"><a href="#普通访问处理" class="headerlink" title="普通访问处理"></a>普通访问处理</h6><ol>
<li><code>RememberMeAuthenticationFilter.java</code></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RememberMeAuthenticationFilter</span> <span class="keyword">extends</span> <span class="title">GenericFilterBean</span> <span class="keyword">implements</span></span></span><br><span class="line"><span class="class">      <span class="title">ApplicationEventPublisherAware</span> </span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest req, ServletResponse res, FilterChain chain)</span></span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">   HttpServletRequest request = (HttpServletRequest) req;</span><br><span class="line">   HttpServletResponse response = (HttpServletResponse) res;</span><br><span class="line"></span><br><span class="line"><span class="comment">//判断是否已经有认证过的信息</span></span><br><span class="line">   <span class="keyword">if</span> (SecurityContextHolder.getContext().getAuthentication() == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="comment">//如果前面的没验证，尝试使用rememberMe登陆</span></span><br><span class="line">      Authentication rememberMeAuth = rememberMeServices.autoLogin(request,</span><br><span class="line">            response);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (rememberMeAuth != <span class="keyword">null</span>) &#123;</span><br><span class="line">         <span class="comment">// Attempt authenticaton via AuthenticationManager</span></span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">            rememberMeAuth = authenticationManager.authenticate(rememberMeAuth);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Store to SecurityContextHolder</span></span><br><span class="line">            SecurityContextHolder.getContext().setAuthentication(rememberMeAuth);</span><br><span class="line"></span><br><span class="line">            onSuccessfulAuthentication(request, response, rememberMeAuth);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">               logger.debug(<span class="string">"SecurityContextHolder populated with remember-me token: '"</span></span><br><span class="line">                     + SecurityContextHolder.getContext().getAuthentication()</span><br><span class="line">                     + <span class="string">"'"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Fire event</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.eventPublisher != <span class="keyword">null</span>) &#123;</span><br><span class="line">               eventPublisher</span><br><span class="line">                     .publishEvent(<span class="keyword">new</span> InteractiveAuthenticationSuccessEvent(</span><br><span class="line">                           SecurityContextHolder.getContext()</span><br><span class="line">                                 .getAuthentication(), <span class="keyword">this</span>.getClass()));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (successHandler != <span class="keyword">null</span>) &#123;</span><br><span class="line">               successHandler.onAuthenticationSuccess(request, response,</span><br><span class="line">                     rememberMeAuth);</span><br><span class="line"></span><br><span class="line">               <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">catch</span> (AuthenticationException authenticationException) &#123;</span><br><span class="line">            <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">               logger.debug(</span><br><span class="line">                     <span class="string">"SecurityContextHolder not populated with remember-me token, as "</span></span><br><span class="line">                           + <span class="string">"AuthenticationManager rejected Authentication returned by RememberMeServices: '"</span></span><br><span class="line">                           + rememberMeAuth</span><br><span class="line">                           + <span class="string">"'; invalidating remember-me token"</span>,</span><br><span class="line">                     authenticationException);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            rememberMeServices.loginFail(request, response);</span><br><span class="line"></span><br><span class="line">            onUnsuccessfulAuthentication(request, response,</span><br><span class="line">                  authenticationException);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      chain.doFilter(request, response);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">         logger.debug(<span class="string">"SecurityContextHolder not populated with remember-me token, as it already contained: '"</span></span><br><span class="line">               + SecurityContextHolder.getContext().getAuthentication() + <span class="string">"'"</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      chain.doFilter(request, response);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li><code>AbstractRememberMeServices.java</code></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractRememberMeServices</span> <span class="keyword">implements</span> <span class="title">RememberMeServices</span>,</span></span><br><span class="line"><span class="class">      <span class="title">InitializingBean</span>, <span class="title">LogoutHandler</span> </span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Authentication <span class="title">autoLogin</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">      HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">   String rememberMeCookie = extractRememberMeCookie(request);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (rememberMeCookie == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   logger.debug(<span class="string">"Remember-me cookie detected"</span>);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (rememberMeCookie.length() == <span class="number">0</span>) &#123;</span><br><span class="line">      logger.debug(<span class="string">"Cookie was empty"</span>);</span><br><span class="line">      cancelCookie(request, response);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   UserDetails user = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      String[] cookieTokens = decodeCookie(rememberMeCookie);</span><br><span class="line">      user = processAutoLoginCookie(cookieTokens, request, response);</span><br><span class="line">      userDetailsChecker.check(user);</span><br><span class="line"></span><br><span class="line">      logger.debug(<span class="string">"Remember-me cookie accepted"</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> createSuccessfulAuthentication(request, user);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   cancelCookie(request, response);</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li><code>PersistentTokenBasedRememberMeServices.java</code></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PersistentTokenBasedRememberMeServices</span> <span class="keyword">extends</span> <span class="title">AbstractRememberMeServices</span> </span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">protected</span> UserDetails <span class="title">processAutoLoginCookie</span><span class="params">(String[] cookieTokens,</span></span></span><br><span class="line"><span class="function"><span class="params">      HttpServletRequest request, HttpServletResponse response)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (cookieTokens.length != <span class="number">2</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> InvalidCookieException(<span class="string">"Cookie token did not contain "</span> + <span class="number">2</span></span><br><span class="line">            + <span class="string">" tokens, but contained '"</span> + Arrays.asList(cookieTokens) + <span class="string">"'"</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">final</span> String presentedSeries = cookieTokens[<span class="number">0</span>];</span><br><span class="line">   <span class="keyword">final</span> String presentedToken = cookieTokens[<span class="number">1</span>];</span><br><span class="line">   </span><br><span class="line"><span class="comment">//数据库查询</span></span><br><span class="line">   PersistentRememberMeToken token = tokenRepository</span><br><span class="line">         .getTokenForSeries(presentedSeries);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (token == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">// No series match, so we can't authenticate using this cookie</span></span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> RememberMeAuthenticationException(</span><br><span class="line">            <span class="string">"No persistent token found for series id: "</span> + presentedSeries);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// We have a match for this user/series combination</span></span><br><span class="line">   <span class="keyword">if</span> (!presentedToken.equals(token.getTokenValue())) &#123;</span><br><span class="line">      <span class="comment">// Token doesn't match series value. Delete all logins for this user and throw</span></span><br><span class="line">      <span class="comment">// an exception to warn them.</span></span><br><span class="line">      tokenRepository.removeUserTokens(token.getUsername());</span><br><span class="line"></span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> CookieTheftException(</span><br><span class="line">            messages.getMessage(</span><br><span class="line">                  <span class="string">"PersistentTokenBasedRememberMeServices.cookieStolen"</span>,</span><br><span class="line">                  <span class="string">"Invalid remember-me token (Series/token) mismatch. Implies previous cookie theft attack."</span>));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (token.getDate().getTime() + getTokenValiditySeconds() * <span class="number">1000L</span> &lt; System</span><br><span class="line">         .currentTimeMillis()) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> RememberMeAuthenticationException(<span class="string">"Remember-me login has expired"</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Token also matches, so login is valid. Update the token value, keeping the</span></span><br><span class="line">   <span class="comment">// *same* series number.</span></span><br><span class="line">   <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">      logger.debug(<span class="string">"Refreshing persistent login token for user '"</span></span><br><span class="line">            + token.getUsername() + <span class="string">"', series '"</span> + token.getSeries() + <span class="string">"'"</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   PersistentRememberMeToken newToken = <span class="keyword">new</span> PersistentRememberMeToken(</span><br><span class="line">         token.getUsername(), token.getSeries(), generateTokenData(), <span class="keyword">new</span> Date());</span><br><span class="line"></span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      tokenRepository.updateToken(newToken.getSeries(), newToken.getTokenValue(),</span><br><span class="line">            newToken.getDate());</span><br><span class="line">      addCookie(newToken, request, response);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      logger.error(<span class="string">"Failed to update token: "</span>, e);</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> RememberMeAuthenticationException(</span><br><span class="line">            <span class="string">"Autologin failed due to data access problem"</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> getUserDetailsService().loadUserByUsername(token.getUsername());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="短信登陆"><a href="#短信登陆" class="headerlink" title="短信登陆"></a>短信登陆</h4><p>​    前面已经实现了短信验证码的校验，校验通过后，需要根据手机号实现登陆。用户名密码登陆是spring security的默认实现，整个流程都是固定在代码中，虽然提供了部分接口使得可以进行扩展，但核心的流程是无法更改的，需要实现自定义的身份验证逻辑。</p>
<h5 id="登陆实现原理"><a href="#登陆实现原理" class="headerlink" title="登陆实现原理"></a>登陆实现原理</h5><p>​    Spring security 中密码登陆请求处理如下，我们需要仿造这个流程，写一套短信验证码登陆校验。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">用户名密码登陆请求</span><br><span class="line">   | (携带登陆信息)</span><br><span class="line">UsernamePasswordAuthenticationFilter</span><br><span class="line">   | (携带未认证的UsernamePasswordAuthenticationToken)</span><br><span class="line">AuthenticationManager</span><br><span class="line">   |</span><br><span class="line">AuthenticationProvider（由DaoAuthenticationProvider实现）</span><br><span class="line">   |</span><br><span class="line">UserDetailService</span><br><span class="line">   |</span><br><span class="line">UserDetails</span><br><span class="line">   |</span><br><span class="line">Authentication(已认证)</span><br><span class="line">   |</span><br><span class="line">SecurityContext</span><br><span class="line">   |</span><br><span class="line">SecurityContextHolder</span><br><span class="line">   |</span><br><span class="line">SecurityContextPersistenceFilter</span><br></pre></td></tr></table></figure>
<p>自定义验证短信登陆流程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">手机登陆请求</span><br><span class="line">   | (携带登陆信息)</span><br><span class="line">SmsAuthenticationFilter</span><br><span class="line">   | (携带未认证的SmsAuthenticationToken)</span><br><span class="line">AuthenticationManager</span><br><span class="line">   |</span><br><span class="line">AuthenticationProvider（由SmsAuthenticationProvider实现）</span><br><span class="line">   |</span><br><span class="line">UserDetailService</span><br><span class="line">   |</span><br><span class="line">UserDetails</span><br><span class="line">   |</span><br><span class="line">Authentication(已认证)</span><br><span class="line">   |</span><br><span class="line">SecurityContext</span><br><span class="line">   |</span><br><span class="line">SecurityContextHolder</span><br><span class="line">   |</span><br><span class="line">SecurityContextPersistenceFilter</span><br></pre></td></tr></table></figure>
<p>总结：我们需要仿造一个<code>UsernamePasswordAuthenticationFilter</code>、<code>UsernamePasswordAuthenticationToken</code>、<code>DaoAuthenticationProvider</code>即可</p>
<h5 id="编码实现"><a href="#编码实现" class="headerlink" title="编码实现"></a>编码实现</h5><ol>
<li>定义Token</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 短信登录验证信息封装类</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan 20180308</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SmsCodeAuthenticationToken</span> <span class="keyword">extends</span> <span class="title">AbstractAuthenticationToken</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = SpringSecurityCoreVersion.SERIAL_VERSION_UID;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//初始化为手机号,验证完成为UserDetail</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Object principal;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 初始化传入手机，设置校验状态</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> mobile 手机号</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">SmsCodeAuthenticationToken</span><span class="params">(String mobile)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(<span class="keyword">null</span>);</span><br><span class="line">		<span class="keyword">this</span>.principal = mobile;</span><br><span class="line">		setAuthenticated(<span class="keyword">false</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 校验成功后的初始化Token信息</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> principal 用户信息</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> authorities 权限信息</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">SmsCodeAuthenticationToken</span><span class="params">(Object principal,</span></span></span><br><span class="line"><span class="function"><span class="params">			Collection&lt;? extends GrantedAuthority&gt; authorities)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(authorities);</span><br><span class="line">		<span class="keyword">this</span>.principal = principal;</span><br><span class="line">		<span class="keyword">super</span>.setAuthenticated(<span class="keyword">true</span>); <span class="comment">// must use super, as we override</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">getCredentials</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">getPrincipal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.principal;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAuthenticated</span><span class="params">(<span class="keyword">boolean</span> isAuthenticated)</span> <span class="keyword">throws</span> IllegalArgumentException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (isAuthenticated) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">					<span class="string">"Cannot set this token to trusted - use constructor which takes a GrantedAuthority list instead"</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">super</span>.setAuthenticated(<span class="keyword">false</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">eraseCredentials</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>.eraseCredentials();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>定义Provider，Provider需要加入到ProviderManager进行管理</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义Provider校验短信验证码验证</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan 20180228</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SmsCodeAuthenticationProvider</span> <span class="keyword">implements</span> <span class="title">AuthenticationProvider</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> UserDetailsService userDetailsService;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 验证逻辑</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Authentication <span class="title">authenticate</span><span class="params">(Authentication authentication)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line"></span><br><span class="line">		SmsCodeAuthenticationToken authenticationToken = (SmsCodeAuthenticationToken) authentication;</span><br><span class="line">		<span class="comment">//根据手机号获取用户信息</span></span><br><span class="line">		UserDetails user = userDetailsService.loadUserByUsername((String) authenticationToken.getPrincipal());</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (user == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> InternalAuthenticationServiceException(<span class="string">"无法获取用户信息"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		SmsCodeAuthenticationToken authenticationResult = <span class="keyword">new</span> SmsCodeAuthenticationToken(user, user.getAuthorities());</span><br><span class="line">		</span><br><span class="line">		authenticationResult.setDetails(authenticationToken.getDetails());</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> authenticationResult;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 声明当前Provider支持验证哪一个类型的Token</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Class&lt;?&gt; authentication)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> SmsCodeAuthenticationToken.class.isAssignableFrom(authentication);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> UserDetailsService <span class="title">getUserDetailsService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> userDetailsService;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserDetailsService</span><span class="params">(UserDetailsService userDetailsService)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.userDetailsService = userDetailsService;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>定义Filter</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义手机登陆过滤器</span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan 20180228</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SmsCodeAuthenticationFilter</span> <span class="keyword">extends</span> <span class="title">AbstractAuthenticationProcessingFilter</span> </span>&#123;</span><br><span class="line">    <span class="comment">//请求中手机好的参数名</span></span><br><span class="line">	<span class="keyword">private</span> String mobileParameter = SecurityConstants.DEFAULT_PARAMETER_NAME_MOBILE;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> postOnly = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 只拦截指定的请求</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">SmsCodeAuthenticationFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//手机登陆匹配哪个请求地址</span></span><br><span class="line">		<span class="keyword">super</span>(<span class="keyword">new</span> AntPathRequestMatcher(SecurityConstants.DEFAULT_LOGIN_PROCESSING_URL_MOBILE, <span class="string">"POST"</span>));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Authentication <span class="title">attemptAuthentication</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span></span><br><span class="line"><span class="function">			<span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (postOnly &amp;&amp; !request.getMethod().equals(<span class="string">"POST"</span>)) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> AuthenticationServiceException(<span class="string">"Authentication method not supported: "</span> + request.getMethod());</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		String mobile = obtainMobile(request);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (mobile == <span class="keyword">null</span>) &#123;</span><br><span class="line">			mobile = <span class="string">""</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		mobile = mobile.trim();</span><br><span class="line"></span><br><span class="line">		SmsCodeAuthenticationToken authRequest = <span class="keyword">new</span> SmsCodeAuthenticationToken(mobile);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Allow subclasses to set the "details" property</span></span><br><span class="line">		setDetails(request, authRequest);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.getAuthenticationManager().authenticate(authRequest);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 获取手机号</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> String <span class="title">obtainMobile</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> request.getParameter(mobileParameter);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setDetails</span><span class="params">(HttpServletRequest request, SmsCodeAuthenticationToken authRequest)</span> </span>&#123;</span><br><span class="line">		authRequest.setDetails(authenticationDetailsSource.buildDetails(request));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMobileParameter</span><span class="params">(String usernameParameter)</span> </span>&#123;</span><br><span class="line">		Assert.hasText(usernameParameter, <span class="string">"Username parameter must not be empty or null"</span>);</span><br><span class="line">		<span class="keyword">this</span>.mobileParameter = usernameParameter;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPostOnly</span><span class="params">(<span class="keyword">boolean</span> postOnly)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.postOnly = postOnly;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">final</span> String <span class="title">getMobileParameter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> mobileParameter;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>组合生成短信登陆配置</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义短信验证码身份验证配置</span></span><br><span class="line"><span class="comment"> * 合适浏览器、APP项目</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan 20180228</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SmsCodeAuthenticationSecurityConfig</span> <span class="keyword">extends</span> <span class="title">SecurityConfigurerAdapter</span>&lt;<span class="title">DefaultSecurityFilterChain</span>, <span class="title">HttpSecurity</span>&gt; </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> AuthenticationSuccessHandler turingAuthenticationSuccessHandler;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> AuthenticationFailureHandler turingAuthenticationFailureHandler;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> UserDetailsService userDetailsService;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//配置认证过滤器</span></span><br><span class="line">		SmsCodeAuthenticationFilter smsCodeAuthenticationFilter = <span class="keyword">new</span> SmsCodeAuthenticationFilter();</span><br><span class="line">		smsCodeAuthenticationFilter.setAuthenticationManager(http.getSharedObject(AuthenticationManager.class));</span><br><span class="line">		smsCodeAuthenticationFilter.setAuthenticationSuccessHandler(turingAuthenticationSuccessHandler);</span><br><span class="line">		smsCodeAuthenticationFilter.setAuthenticationFailureHandler(turingAuthenticationFailureHandler);</span><br><span class="line"></span><br><span class="line">		<span class="comment">//配置provider</span></span><br><span class="line">		SmsCodeAuthenticationProvider smsCodeAuthenticationProvider = <span class="keyword">new</span> SmsCodeAuthenticationProvider();</span><br><span class="line">		smsCodeAuthenticationProvider.setUserDetailsService(userDetailsService);</span><br><span class="line"></span><br><span class="line">		<span class="comment">//Token是不需要配置的</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">//加入到ProviderManager</span></span><br><span class="line">		http.authenticationProvider(smsCodeAuthenticationProvider)</span><br><span class="line">				<span class="comment">//过滤器加入安全链中,在UsernamePasswordAuthenticationFilter后中加入</span></span><br><span class="line">			.addFilterAfter(smsCodeAuthenticationFilter, UsernamePasswordAuthenticationFilter.class);</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>将配置应用在Spring Security核心配置中</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BrowserSecurityConfig</span>  <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="comment">//短信登录过滤器配置</span></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> SmsCodeAuthenticationSecurityConfig smsCodeAuthenticationSecurityConfig;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">       	http.apply(smsCodeAuthenticationSecurityConfig);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//...其他配置省略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </main>
    <footer class="post-footer">
      
    </footer>
  </article>
  
  <article class="index-post card" itemscope itemtype="http://schema.org/Article">
    <div class="post-block">
      <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/12/spring_security/3.SpringSecuritySocial/">
      <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
        <meta itemprop="name" content="龙门小左">
        <meta itemprop="description" content="">
        <meta itemprop="image" content="/images/avatar.png">
      </span>
      <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
        <meta itemprop="name" content="程序猿的日常">
      </span>
    </div>
    <header class="post-header">
      <h1 class="post-title" itemprop="name headline">
        <a class="post-title-link post-title-link-external" href="/2018/07/12/spring_security/3.SpringSecuritySocial/" itemprop="url">使用 Maven Module 搭建spring boot项目（整合Spring Security、Spring Social、spring OAuth）三</a>
      </h1>
      <div class="post-meta">
        
        <span class="post-date">
          <i class="far fa-calendar-plus"></i><span><time title="post-date" itemprop="dateCreated datePublished" datetime="2018-07-12T10:00:00+08:00">2018-07-12 10:00:00</time></span>
        </span>
        
        
        
      </div>
    </header>
    <main class="post-main" itemprop="articleBody">
      
      <h1 id="使用-Maven-Module-搭建spring-boot项目（整合Spring-Security、Spring-Social、spring-OAuth）三"><a href="#使用-Maven-Module-搭建spring-boot项目（整合Spring-Security、Spring-Social、spring-OAuth）三" class="headerlink" title="使用 Maven Module 搭建spring boot项目（整合Spring Security、Spring Social、spring OAuth）三"></a>使用 Maven Module 搭建spring boot项目（整合Spring Security、Spring Social、spring OAuth）三</h1><table>
<thead>
<tr>
<th>版本号</th>
<th>作者</th>
<th>日期</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>V0.1</td>
<td>huangz</td>
<td>2018-04-03</td>
<td>初稿</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="Spring-Social-开发第三方登陆"><a href="#Spring-Social-开发第三方登陆" class="headerlink" title="Spring Social 开发第三方登陆"></a>Spring Social 开发第三方登陆</h2><h3 id="OAuth-2-0-协议简介"><a href="#OAuth-2-0-协议简介" class="headerlink" title="OAuth 2.0 协议简介"></a>OAuth 2.0 协议简介</h3><h4 id="协议要解决的问题"><a href="#协议要解决的问题" class="headerlink" title="协议要解决的问题"></a>协议要解决的问题</h4><p>某平台（如优酷）可以使用第三方（微博）登陆进入系统，关于第三方应用授权会产生以下问题</p>
<ol>
<li>优酷应用可以访问用户在微博上的所有数据</li>
<li>用户只有修改密码才能收回授权</li>
<li>密码泄露的可能性大大提高</li>
</ol>
<h4 id="协议中的各种角色与运行流程"><a href="#协议中的各种角色与运行流程" class="headerlink" title="协议中的各种角色与运行流程"></a>协议中的各种角色与运行流程</h4><p>角色包括：资源所有者、客户端、服务提供商（认证服务器、资源服务器）</p>
<p><img src="images/oauth-1.png" alt=""></p>
<h4 id="协议中的授权模式"><a href="#协议中的授权模式" class="headerlink" title="协议中的授权模式"></a>协议中的授权模式</h4><ol>
<li>授权码模式（Authorization Code）</li>
</ol>
<p>授权码模式是目前最常使用的模式，以下是它的流程</p>
<p><img src="images/authorizationcode.png" alt=""></p>
<ol>
<li>密码模式（Resource Owner Password Credentials）</li>
<li>客户端模式（Client Credentials）</li>
<li>简化模式（Implicit）</li>
</ol>
<hr>
<h3 id="Spring-Social"><a href="#Spring-Social" class="headerlink" title="Spring Social"></a>Spring Social</h3><h4 id="基本原理"><a href="#基本原理" class="headerlink" title="基本原理"></a>基本原理</h4><h5 id="Spring-Social-基本流程"><a href="#Spring-Social-基本流程" class="headerlink" title="Spring Social 基本流程"></a>Spring Social 基本流程</h5><p><img src="images/social-1.png" alt=""></p>
<p>从第一步到第五步都是标准的OAuth协议流程，第六、七步是个性化流程</p>
<h5 id="Spring-Social-过滤器链"><a href="#Spring-Social-过滤器链" class="headerlink" title="Spring Social 过滤器链"></a>Spring Social 过滤器链</h5><p><code>SocialAuthenticationFilter</code>：处理社交登陆认证过滤器</p>
<p><img src="images/social-2.png" alt=""></p>
<h5 id="Spring-Social运行流程"><a href="#Spring-Social运行流程" class="headerlink" title="Spring Social运行流程"></a>Spring Social运行流程</h5><p><img src="images/social-process.png" alt=""></p>
<h5 id="Spring-Social-各种角色"><a href="#Spring-Social-各种角色" class="headerlink" title="Spring Social 各种角色"></a>Spring Social 各种角色</h5><ol>
<li>DBUserConnection ： 数据库</li>
<li>UserConnectionRepository（JdbcUserConnectionRepository）：用户信息连接仓库</li>
<li>Connection（OAuth2Connection）：由连接工厂创建</li>
<li>ConnectionFactory（OAuth2ConnectionFactory）：连接工厂</li>
</ol>
<p>组成：1）ServiceProvider 定义服务提供商</p>
<p>​        2）ApiAdapter ：用与匹配Api中返回的用户信息</p>
<ol>
<li>ServiceProvider（AbstractOAuth2ServiceProvider）：服务提供商</li>
</ol>
<p>组成：1）OAuth2Operations（OAuth2Template）：用于与服务提供商交互</p>
<p>​        2）Api（AbstractOAuth2ApiBingding）：定义服务提供商获取用户信息</p>
<p><img src="images/social-3.png" alt=""></p>
<h4 id="UsersConnectionRepository"><a href="#UsersConnectionRepository" class="headerlink" title="UsersConnectionRepository"></a>UsersConnectionRepository</h4><h5 id="数据库表"><a href="#数据库表" class="headerlink" title="数据库表"></a>数据库表</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> vic_UserConnection (userId <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    providerId <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    providerUserId <span class="built_in">varchar</span>(<span class="number">255</span>),</span><br><span class="line">    <span class="keyword">rank</span> <span class="built_in">int</span> <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    displayName <span class="built_in">varchar</span>(<span class="number">255</span>),</span><br><span class="line">    profileUrl <span class="built_in">varchar</span>(<span class="number">512</span>),</span><br><span class="line">    imageUrl <span class="built_in">varchar</span>(<span class="number">512</span>),</span><br><span class="line">    accessToken <span class="built_in">varchar</span>(<span class="number">512</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    secret <span class="built_in">varchar</span>(<span class="number">512</span>),</span><br><span class="line">    refreshToken <span class="built_in">varchar</span>(<span class="number">512</span>),</span><br><span class="line">    expireTime <span class="built_in">bigint</span>,</span><br><span class="line">    primary <span class="keyword">key</span> (userId, providerId, providerUserId));</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">unique</span> <span class="keyword">index</span> vic_UserConnectionRank <span class="keyword">on</span> vic_UserConnection(userId, providerId, <span class="keyword">rank</span>);</span><br></pre></td></tr></table></figure>
<h5 id="属性类创建"><a href="#属性类创建" class="headerlink" title="属性类创建"></a>属性类创建</h5><ol>
<li>Spring Social 提供的一个社交配置类</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">SocialProperties</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String appId;</span><br><span class="line">    <span class="keyword">private</span> String appSecret;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SocialProperties</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getAppId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.appId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAppId</span><span class="params">(String appId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.appId = appId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getAppSecret</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.appSecret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAppSecret</span><span class="params">(String appSecret)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.appSecret = appSecret;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>定义QQ和微信的属性类</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 配置QQ登陆属性</span></span><br><span class="line"><span class="comment"> * 父类中提供appId、appSecret;</span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan 20180302</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QQProperties</span> <span class="keyword">extends</span> <span class="title">SocialProperties</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> String providerId = <span class="string">"qq"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getProviderId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> providerId;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setProviderId</span><span class="params">(String providerId)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.providerId = providerId;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 微信属性</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan on 20280308</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WeixinProperties</span> <span class="keyword">extends</span> <span class="title">SocialProperties</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 第三方id，用来决定发起第三方登录的url，默认是 weixin。</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> String providerId = <span class="string">"weixin"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the providerId</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getProviderId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> providerId;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> providerId the providerId to set</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setProviderId</span><span class="params">(String providerId)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.providerId = providerId;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>建立社交配置类，并加入SecurityProperties核心属性配置中</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 社交登陆配置</span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan 20180302</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SocialProperties</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> QQProperties qq = <span class="keyword">new</span> QQProperties();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> WeixinProperties weixin = <span class="keyword">new</span> WeixinProperties();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//默认的处理社交登陆的URL</span></span><br><span class="line">	<span class="keyword">private</span> String filterProcessesUrl = <span class="string">"/auth"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> QQProperties <span class="title">getQq</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> qq;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setQq</span><span class="params">(QQProperties qq)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.qq = qq;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getFilterProcessesUrl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> filterProcessesUrl;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFilterProcessesUrl</span><span class="params">(String filterProcessesUrl)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.filterProcessesUrl = filterProcessesUrl;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> WeixinProperties <span class="title">getWeixin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> weixin;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setWeixin</span><span class="params">(WeixinProperties weixin)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.weixin = weixin;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>SecurityProperties.java</strong>中加入属性配置如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 社交登陆的相关配置,配置名:turing.security.social</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> SocialProperties social = <span class="keyword">new</span> SocialProperties();</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>社交用户信息回显</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 简单的社交用户信息,用户页面回显</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan on 20180308</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SocialUserInfo</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> String providerId;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> String providerUserId;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> String nickname;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> String headimg;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getProviderId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> providerId;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setProviderId</span><span class="params">(String providerId)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.providerId = providerId;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getProviderUserId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> providerUserId;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setProviderUserId</span><span class="params">(String providerUserId)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.providerUserId = providerUserId;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getNickname</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> nickname;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNickname</span><span class="params">(String nickname)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.nickname = nickname;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getHeadimg</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> headimg;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setHeadimg</span><span class="params">(String headimg)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.headimg = headimg;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="SocialUserDetailsService"><a href="#SocialUserDetailsService" class="headerlink" title="SocialUserDetailsService"></a>SocialUserDetailsService</h4><p>开启社交登陆，需要实现<code>SocialUserDetailsService</code>接口，开启社交用户匹配系统用户的查询</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义实现 spring security 验证逻辑</span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan on 2018/2/27.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ForecastUserDetailsServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserDetailsService</span>,<span class="title">SocialUserDetailsService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PasswordEncoder passwordEncoder;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * UserDetailsService接口实现方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDetails <span class="title">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException </span>&#123;</span><br><span class="line">        <span class="comment">//spring security框架提供的一个实现了UserDetails接口的实现类</span></span><br><span class="line">        <span class="comment">//dao查询username信息</span></span><br><span class="line">        SystemUser user = userMapper.findSystemUserByUsername(username);</span><br><span class="line">        <span class="keyword">if</span> (user == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="comment">//AbstractUserDetailsAuthenticationProvider把UsernameNotFoundException包装其他异常，因为AbstractUserDetailsAuthenticationProvider.hideUserNotFoundExceptions=true</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UsernameNotFoundException(<span class="string">"无法找到用户名为:"</span> + username + <span class="string">"的用户"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        user.setPassword(passwordEncoder.encode(user.getPassword()));</span><br><span class="line">        <span class="comment">//三个参数:username,password,authorities：授权</span></span><br><span class="line">        <span class="comment">//分割String类型为授权集合</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> User(username,user.getPassword(), AuthorityUtils.commaSeparatedStringToAuthorityList(<span class="keyword">super</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * SocialUserDetailsService接口实现方法</span></span><br><span class="line"><span class="comment">     * userId对应UsersConnectionRepository表中的UserId</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SocialUserDetails <span class="title">loadUserByUserId</span><span class="params">(String userId)</span> <span class="keyword">throws</span> UsernameNotFoundException </span>&#123;</span><br><span class="line">        SystemUser user = userMapper.findSystemUserByUsername(userId);</span><br><span class="line">        <span class="keyword">if</span> (user == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="comment">//AbstractUserDetailsAuthenticationProvider把UsernameNotFoundException包装其他异常，因为AbstractUserDetailsAuthenticationProvider.hideUserNotFoundExceptions=true</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UsernameNotFoundException(<span class="string">"无法找到用户名为:"</span> + userId + <span class="string">"的用户"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SocialUser(userId,user.getPassword(),AuthorityUtils.commaSeparatedStringToAuthorityList(<span class="keyword">super</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="QQ登陆"><a href="#QQ登陆" class="headerlink" title="QQ登陆"></a>QQ登陆</h4><h5 id="构造ServiceProvider"><a href="#构造ServiceProvider" class="headerlink" title="构造ServiceProvider"></a>构造ServiceProvider</h5><h6 id="API"><a href="#API" class="headerlink" title="API"></a>API</h6><ol>
<li>定义获取用户信息接口</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义QQ用户信息接口</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan 20180302</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">QQ</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="function">QQUserInfo <span class="title">getUserInfo</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>定义用户信息接口实现类，并继承 Api 接口的子类 AbstractOAuth2ApiBinding</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户获取QQ 用户信息</span></span><br><span class="line"><span class="comment"> * QQ API 实现类</span></span><br><span class="line"><span class="comment"> * 所有的API需要继承 AbstractOAuth2ApiBinding 提供access_token属性  RestTemplate用户发送HTTP请求</span></span><br><span class="line"><span class="comment"> * 多例对象，每个用户都拥有一个QQImpl实例</span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan 20180302</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QQImpl</span> <span class="keyword">extends</span> <span class="title">AbstractOAuth2ApiBinding</span> <span class="keyword">implements</span> <span class="title">QQ</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">	<span class="comment">//qq根据access_token(令牌)获取openId</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String URL_GET_OPENID = <span class="string">"https://graph.qq.com/oauth2.0/me?access_token=%s"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//获取用户信息</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String URL_GET_USERINFO = <span class="string">"https://graph.qq.com/user/get_user_info?oauth_consumer_key=%s&amp;openid=%s"</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> String appId;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> String openId;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line"></span><br><span class="line">	<span class="comment">//走完oAuth协议获取到的accessToken</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">QQImpl</span><span class="params">(String accessToken, String appId)</span> </span>&#123;</span><br><span class="line">		<span class="comment">//设置策略，发送请求时，token以参数形式在请求地址中</span></span><br><span class="line">		<span class="keyword">super</span>(accessToken, TokenStrategy.ACCESS_TOKEN_PARAMETER);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">this</span>.appId = appId;</span><br><span class="line">		</span><br><span class="line">		String url = String.format(URL_GET_OPENID, accessToken);</span><br><span class="line">		String result = getRestTemplate().getForObject(url, String.class);</span><br><span class="line">		</span><br><span class="line">		logger.info(result);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">this</span>.openId = StringUtils.substringBetween(result, <span class="string">"\"openid\":\""</span>, <span class="string">"\"&#125;"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> QQUserInfo <span class="title">getUserInfo</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">		String url = String.format(URL_GET_USERINFO, appId, openId);</span><br><span class="line">		String result = getRestTemplate().getForObject(url, String.class);</span><br><span class="line"></span><br><span class="line">		logger.info(result);</span><br><span class="line"></span><br><span class="line">		QQUserInfo userInfo = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			userInfo = objectMapper.readValue(result, QQUserInfo.class);</span><br><span class="line">			userInfo.setOpenId(openId);</span><br><span class="line">			<span class="keyword">return</span> userInfo;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"获取用户信息失败"</span>, e);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>定义QQ用户信息，从官网文档中获取返回的用户信息并创建对应实体类</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * QQ用户信息实体类</span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan 20180302</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QQUserInfo</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 	返回码</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> String ret;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 如果ret&lt;0，会有相应的错误信息提示，返回数据全部用UTF-8编码。</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> String msg;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> String openId;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 不知道什么东西，文档上没写，但是实际api返回里有。</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> String is_lost;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 省(直辖市)</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> String province;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 市(直辖市区)</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> String city;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 出生年月</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> String year;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 	用户在QQ空间的昵称。</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> String nickname;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 	大小为30×30像素的QQ空间头像URL。</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> String figureurl;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 	大小为50×50像素的QQ空间头像URL。</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> String figureurl_1;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 	大小为100×100像素的QQ空间头像URL。</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> String figureurl_2;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 	大小为40×40像素的QQ头像URL。</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> String figureurl_qq_1;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 	大小为100×100像素的QQ头像URL。需要注意，不是所有的用户都拥有QQ的100×100的头像，但40×40像素则是一定会有。</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> String figureurl_qq_2;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 	性别。 如果获取不到则默认返回”男”</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> String gender;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 	标识用户是否为黄钻用户（0：不是；1：是）。</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> String is_yellow_vip;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 	标识用户是否为黄钻用户（0：不是；1：是）</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> String vip;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 	黄钻等级</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> String yellow_vip_level;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 	黄钻等级</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> String level;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 标识是否为年费黄钻用户（0：不是； 1：是）</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> String is_yellow_year_vip;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="OAuth2Operations"><a href="#OAuth2Operations" class="headerlink" title="OAuth2Operations"></a>OAuth2Operations</h6><p><strong>OAuth2Template.java源码分析</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OAuth2Template</span> <span class="keyword">implements</span> <span class="title">OAuth2Operations</span> </span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> AccessGrant <span class="title">exchangeForAccess</span><span class="params">(String authorizationCode, String redirectUri, MultiValueMap&lt;String, String&gt; additionalParameters)</span> </span>&#123;</span><br><span class="line">    MultiValueMap&lt;String, String&gt; params = <span class="keyword">new</span> LinkedMultiValueMap();</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">this</span>.useParametersForClientAuthentication) &#123;</span><br><span class="line">        params.set(<span class="string">"client_id"</span>, <span class="keyword">this</span>.clientId);</span><br><span class="line">        params.set(<span class="string">"client_secret"</span>, <span class="keyword">this</span>.clientSecret);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    params.set(<span class="string">"code"</span>, authorizationCode);</span><br><span class="line">    params.set(<span class="string">"redirect_uri"</span>, redirectUri);</span><br><span class="line">    params.set(<span class="string">"grant_type"</span>, <span class="string">"authorization_code"</span>);</span><br><span class="line">    <span class="keyword">if</span>(additionalParameters != <span class="keyword">null</span>) &#123;</span><br><span class="line">        params.putAll(additionalParameters);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.postForAccessGrant(<span class="keyword">this</span>.accessTokenUrl, params);</span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 标准返回的是Map也就是json数据，但是各个服务提供商返回的不一定是标准格式，需要实现的服务商特殊格式处理</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> AccessGrant <span class="title">postForAccessGrant</span><span class="params">(String accessTokenUrl, MultiValueMap&lt;String, String&gt; parameters)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> </span><br><span class="line"><span class="comment">//希望返回的数据是json数据</span></span><br><span class="line"><span class="keyword">this</span>.extractAccessGrant((Map)<span class="keyword">this</span>.getRestTemplate().postForObject(accessTokenUrl, parameters, Map.class, <span class="keyword">new</span> Object[<span class="number">0</span>]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> RestTemplate <span class="title">createRestTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ClientHttpRequestFactory requestFactory = ClientHttpRequestFactorySelector.getRequestFactory();</span><br><span class="line">    RestTemplate restTemplate = <span class="keyword">new</span> RestTemplate(requestFactory);</span><br><span class="line">    List&lt;HttpMessageConverter&lt;?&gt;&gt; converters = <span class="keyword">new</span> ArrayList(<span class="number">2</span>);</span><br><span class="line">    converters.add(<span class="keyword">new</span> FormHttpMessageConverter());</span><br><span class="line">    converters.add(<span class="keyword">new</span> FormMapHttpMessageConverter());</span><br><span class="line">    converters.add(<span class="keyword">new</span> MappingJackson2HttpMessageConverter());</span><br><span class="line">    restTemplate.setMessageConverters(converters);</span><br><span class="line">    restTemplate.setErrorHandler(<span class="keyword">new</span> LoggingErrorHandler());</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">this</span>.useParametersForClientAuthentication) &#123;</span><br><span class="line">        List&lt;ClientHttpRequestInterceptor&gt; interceptors = restTemplate.getInterceptors();</span><br><span class="line">        <span class="keyword">if</span>(interceptors == <span class="keyword">null</span>) &#123;</span><br><span class="line">            interceptors = <span class="keyword">new</span> ArrayList();</span><br><span class="line">            restTemplate.setInterceptors((List)interceptors);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ((List)interceptors).add(<span class="keyword">new</span> PreemptiveBasicAuthClientHttpRequestInterceptor(<span class="keyword">this</span>.clientId, <span class="keyword">this</span>.clientSecret));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> restTemplate;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>OAuth2AuthenticationService.java 源码分析</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OAuth2AuthenticationService</span>&lt;<span class="title">S</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractSocialAuthenticationService</span>&lt;<span class="title">S</span>&gt; </span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> SocialAuthenticationToken <span class="title">getAuthToken</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> SocialAuthenticationRedirectException </span>&#123;</span><br><span class="line">    String code = request.getParameter(<span class="string">"code"</span>);</span><br><span class="line">    <span class="comment">//如果没有code，则是需要跳转到授权</span></span><br><span class="line">    <span class="keyword">if</span>(!StringUtils.hasText(code)) &#123;</span><br><span class="line">        OAuth2Parameters params = <span class="keyword">new</span> OAuth2Parameters();</span><br><span class="line">        params.setRedirectUri(<span class="keyword">this</span>.buildReturnToUrl(request));</span><br><span class="line">        <span class="keyword">this</span>.setScope(request, params);</span><br><span class="line">        params.add(<span class="string">"state"</span>, <span class="keyword">this</span>.generateState(<span class="keyword">this</span>.connectionFactory, request));</span><br><span class="line">        <span class="keyword">this</span>.addCustomParameters(params);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SocialAuthenticationRedirectException(<span class="keyword">this</span>.getConnectionFactory().getOAuthOperations().buildAuthenticateUrl(params));</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(StringUtils.hasText(code)) &#123;</span><br><span class="line">        <span class="comment">//获得了授权码</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String returnToUrl = <span class="keyword">this</span>.buildReturnToUrl(request);</span><br><span class="line">            <span class="comment">//获取accessToken，调用连接工厂创建操作，获得accesstoken</span></span><br><span class="line">            AccessGrant accessGrant = <span class="keyword">this</span>.getConnectionFactory().getOAuthOperations().exchangeForAccess(code, returnToUrl, (MultiValueMap)<span class="keyword">null</span>);</span><br><span class="line">            Connection&lt;S&gt; connection = <span class="keyword">this</span>.getConnectionFactory().createConnection(accessGrant);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SocialAuthenticationToken(connection, (Map)<span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RestClientException var7) &#123;</span><br><span class="line">            <span class="keyword">this</span>.logger.debug(<span class="string">"failed to exchange for access"</span>, var7);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果服务商没有按照指定的格式返回accesstoken数据，则可能会抛出如下异常：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">授权成功后，进到我们的服务器中错误</span><br><span class="line">org.springframework.web.client.RestClientException: Could not extract response: no suitable HttpMessageConverter found for response type [interface java.util.Map] and content type [text/html]</span><br></pre></td></tr></table></figure>
<p><strong>自定义继承OAuth2Template</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义配置Auth2Template实现</span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan 20180302</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QQOAuth2Template</span> <span class="keyword">extends</span> <span class="title">OAuth2Template</span> </span>&#123;</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">QQOAuth2Template</span><span class="params">(String clientId, String clientSecret, String authorizeUrl, String accessTokenUrl)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">super</span>(clientId, clientSecret, authorizeUrl, accessTokenUrl);</span><br><span class="line">      <span class="comment">//设置为true的时候才会在请求的时候带上client_id和client_secret</span></span><br><span class="line">      setUseParametersForClientAuthentication(<span class="keyword">true</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 针对QQ特殊的返回方式，需要覆盖父类的处理逻辑</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> accessTokenUrl</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> parameters</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> AccessGrant <span class="title">postForAccessGrant</span><span class="params">(String accessTokenUrl, MultiValueMap&lt;String, String&gt; parameters)</span> </span>&#123;</span><br><span class="line">      String responseStr = getRestTemplate().postForObject(accessTokenUrl, parameters, String.class);</span><br><span class="line">      </span><br><span class="line">      logger.info(<span class="string">"获取accessToke的响应："</span>+responseStr);</span><br><span class="line">      </span><br><span class="line">      String[] items = StringUtils.splitByWholeSeparatorPreserveAllTokens(responseStr, <span class="string">"&amp;"</span>);</span><br><span class="line">      </span><br><span class="line">      String accessToken = StringUtils.substringAfterLast(items[<span class="number">0</span>], <span class="string">"="</span>);</span><br><span class="line">      Long expiresIn = <span class="keyword">new</span> Long(StringUtils.substringAfterLast(items[<span class="number">1</span>], <span class="string">"="</span>));</span><br><span class="line">      String refreshToken = StringUtils.substringAfterLast(items[<span class="number">2</span>], <span class="string">"="</span>);</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> AccessGrant(accessToken, <span class="keyword">null</span>, refreshToken, expiresIn);</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> RestTemplate <span class="title">createRestTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      RestTemplate restTemplate = <span class="keyword">super</span>.createRestTemplate();</span><br><span class="line">      <span class="comment">//新增一个转换对象</span></span><br><span class="line">      restTemplate.getMessageConverters().add(<span class="keyword">new</span> StringHttpMessageConverter(Charset.forName(<span class="string">"UTF-8"</span>)));</span><br><span class="line">      <span class="keyword">return</span> restTemplate;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="ServiceProvider"><a href="#ServiceProvider" class="headerlink" title="ServiceProvider"></a>ServiceProvider</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * QQ Provider 需要实现 AbstractOAuth2ServiceProvider&lt;T&gt; T：传入QQ API类型</span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan 20180302</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QQServiceProvider</span> <span class="keyword">extends</span> <span class="title">AbstractOAuth2ServiceProvider</span>&lt;<span class="title">QQ</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> String appId;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//导向认证地址，获取授权码</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String URL_AUTHORIZE = <span class="string">"https://graph.qq.com/oauth2.0/authorize"</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//拿着授权码获取令牌申请地址</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String URL_ACCESS_TOKEN = <span class="string">"https://graph.qq.com/oauth2.0/token"</span>;</span><br><span class="line">   </span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">QQServiceProvider</span><span class="params">(String appId, String appSecret)</span> </span>&#123;</span><br><span class="line">      <span class="comment">//单例</span></span><br><span class="line">      <span class="keyword">super</span>(<span class="keyword">new</span> QQOAuth2Template(appId, appSecret, URL_AUTHORIZE, URL_ACCESS_TOKEN));</span><br><span class="line">      <span class="keyword">this</span>.appId = appId;</span><br><span class="line">      </span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> QQ <span class="title">getApi</span><span class="params">(String accessToken)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> QQImpl(accessToken, appId);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="构造ConnectionFactory"><a href="#构造ConnectionFactory" class="headerlink" title="构造ConnectionFactory"></a>构造ConnectionFactory</h5><h6 id="ApiAdapter"><a href="#ApiAdapter" class="headerlink" title="ApiAdapter"></a>ApiAdapter</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 构造Adapter</span></span><br><span class="line"><span class="comment"> * 需要实现ApiAdapter&lt;T&gt; T：指当前的适配器 是 适配哪个 API</span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan 20180302</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QQAdapter</span> <span class="keyword">implements</span> <span class="title">ApiAdapter</span>&lt;<span class="title">QQ</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//服务是否为可用</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">test</span><span class="params">(QQ api)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Connection数据 与 Api 数据 的适配</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> api</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> values 创建Connection所需要的数据项</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setConnectionValues</span><span class="params">(QQ api, ConnectionValues values)</span> </span>&#123;</span><br><span class="line">		QQUserInfo userInfo = api.getUserInfo();</span><br><span class="line">		</span><br><span class="line">		values.setDisplayName(userInfo.getNickname());</span><br><span class="line">		values.setImageUrl(userInfo.getFigureurl_qq_1());</span><br><span class="line">		values.setProfileUrl(<span class="keyword">null</span>);<span class="comment">//个人主页，QQ没有。微博就会有</span></span><br><span class="line">		values.setProviderUserId(userInfo.getOpenId());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> UserProfile <span class="title">fetchUserProfile</span><span class="params">(QQ api)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateStatus</span><span class="params">(QQ api, String message)</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="ConnectionFactory"><a href="#ConnectionFactory" class="headerlink" title="ConnectionFactory"></a>ConnectionFactory</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 构造ConnectionFactory</span></span><br><span class="line"><span class="comment"> * 继承&lt;T&gt; T：指当前的适配器 是 适配哪个 API</span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan 20180302</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QQConnectionFactory</span> <span class="keyword">extends</span> <span class="title">OAuth2ConnectionFactory</span>&lt;<span class="title">QQ</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">QQConnectionFactory</span><span class="params">(String providerId, String appId, String appSecret)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(providerId, <span class="keyword">new</span> QQServiceProvider(appId, appSecret), <span class="keyword">new</span> QQAdapter());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="生成QQ配置"><a href="#生成QQ配置" class="headerlink" title="生成QQ配置"></a>生成QQ配置</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * QQ配置</span></span><br><span class="line"><span class="comment"> * ConditionalOnProperty：当系统中存在指定的配置时，此配置才生效</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan 20180302</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty</span>(prefix = <span class="string">"victory.security.social.qq"</span>, name = <span class="string">"app-id"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QQAutoConfig</span> <span class="keyword">extends</span> <span class="title">SocialAutoConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> SecurityProperties securityProperties;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建连接工厂，使用自定义的连接工厂</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> ConnectionFactory&lt;?&gt; createConnectionFactory() &#123;</span><br><span class="line">		QQProperties qqConfig = securityProperties.getSocial().getQq();</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> QQConnectionFactory(qqConfig.getProviderId(), qqConfig.getAppId(), qqConfig.getAppSecret());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 为了解决生产多个连接工厂，覆盖父类的连接工厂创建</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> connectionFactoryLocator</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> UsersConnectionRepository <span class="title">getUsersConnectionRepository</span><span class="params">(ConnectionFactoryLocator connectionFactoryLocator)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理视图，后面会进行讲解</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">	<span class="meta">@Bean</span>(&#123;<span class="string">"connect/qqConnect"</span>, <span class="string">"connect/qqConnected"</span>&#125;)</span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean</span>(name = <span class="string">"qqConnectedView"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> View <span class="title">qqConnectedView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> AbstractConnectView();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="微信登陆"><a href="#微信登陆" class="headerlink" title="微信登陆"></a>微信登陆</h4><h5 id="构造ServiceProvider-1"><a href="#构造ServiceProvider-1" class="headerlink" title="构造ServiceProvider"></a>构造ServiceProvider</h5><h6 id="API-1"><a href="#API-1" class="headerlink" title="API"></a>API</h6><ol>
<li>定义微信API接口</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 微信API调用接口</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan 20180302</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Weixin</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function">WeixinUserInfo <span class="title">getUserInfo</span><span class="params">(String openId)</span></span>;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>定义微信用户信息类，从微信官网文档中获取返回的用户信息，构造出用户实体类</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 微信用户信息</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan on 20180303</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WeixinUserInfo</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 普通用户的标识，对当前开发者帐号唯一</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> String openid;	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 普通用户昵称</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> String nickname;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 语言</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> String language;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 普通用户性别，1为男性，2为女性</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> String sex;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 普通用户个人资料填写的省份</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> String province;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 普通用户个人资料填写的城市</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> String city;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 国家，如中国为CN</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> String country;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 用户头像，最后一个数值代表正方形头像大小（有0、46、64、96、132数值可选，0代表640*640正方形头像），用户没有头像时该项为空</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> String headimgurl;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 用户特权信息，json数组，如微信沃卡用户为（chinaunicom）</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> String[] privilege;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 用户统一标识。针对一个微信开放平台帐号下的应用，同一用户的unionid是唯一的。</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> String unionid;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>定义微信用户信息接口实现类，并继承 Api 接口的子类 AbstractOAuth2ApiBinding</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Weixin API调用模板， scope为Request的Spring bean, 根据当前用户的accessToken创建。</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan 20180303</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WeixinImpl</span> <span class="keyword">extends</span> <span class="title">AbstractOAuth2ApiBinding</span> <span class="keyword">implements</span> <span class="title">Weixin</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 获取用户信息的url</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String URL_GET_USER_INFO = <span class="string">"https://api.weixin.qq.com/sns/userinfo?openid="</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> accessToken</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">WeixinImpl</span><span class="params">(String accessToken)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(accessToken, TokenStrategy.ACCESS_TOKEN_PARAMETER);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 默认注册的StringHttpMessageConverter字符集为ISO-8859-1，而微信返回的是UTF-8的，所以覆盖了原来的方法。</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">protected</span> List&lt;HttpMessageConverter&lt;?&gt;&gt; getMessageConverters() &#123;</span><br><span class="line">		List&lt;HttpMessageConverter&lt;?&gt;&gt; messageConverters = <span class="keyword">super</span>.getMessageConverters();</span><br><span class="line">		messageConverters.remove(<span class="number">0</span>);</span><br><span class="line">		messageConverters.add(<span class="keyword">new</span> StringHttpMessageConverter(Charset.forName(<span class="string">"UTF-8"</span>)));</span><br><span class="line">		<span class="keyword">return</span> messageConverters;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 获取微信用户信息。</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> WeixinUserInfo <span class="title">getUserInfo</span><span class="params">(String openId)</span> </span>&#123;</span><br><span class="line">		String url = URL_GET_USER_INFO + openId;</span><br><span class="line">		String response = getRestTemplate().getForObject(url, String.class);</span><br><span class="line">		<span class="keyword">if</span>(StringUtils.contains(response, <span class="string">"errcode"</span>)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		WeixinUserInfo profile = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			profile = objectMapper.readValue(response,WeixinUserInfo.class);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> profile;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="OAuth2Operations-1"><a href="#OAuth2Operations-1" class="headerlink" title="OAuth2Operations"></a>OAuth2Operations</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 完成微信的OAuth2认证流程的模板类。国内厂商实现的OAuth2每个都不同, spring默认提供的OAuth2Template适应不了，只能针对每个厂商自己微调。</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan on 20180308</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WeixinOAuth2Template</span> <span class="keyword">extends</span> <span class="title">OAuth2Template</span> </span>&#123;</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">private</span> String clientId;</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">private</span> String clientSecret;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> String accessTokenUrl;</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String REFRESH_TOKEN_URL = <span class="string">"https://api.weixin.qq.com/sns/oauth2/refresh_token"</span>;</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">WeixinOAuth2Template</span><span class="params">(String clientId, String clientSecret, String authorizeUrl, String accessTokenUrl)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">super</span>(clientId, clientSecret, authorizeUrl, accessTokenUrl);</span><br><span class="line">      setUseParametersForClientAuthentication(<span class="keyword">true</span>);</span><br><span class="line">      <span class="keyword">this</span>.clientId = clientId;</span><br><span class="line">      <span class="keyword">this</span>.clientSecret = clientSecret;</span><br><span class="line">      <span class="keyword">this</span>.accessTokenUrl = accessTokenUrl;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   <span class="comment">/* (non-Javadoc)</span></span><br><span class="line"><span class="comment">    * @see org.springframework.social.oauth2.OAuth2Template#exchangeForAccess(java.lang.String, java.lang.String, org.springframework.util.MultiValueMap)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> AccessGrant <span class="title">exchangeForAccess</span><span class="params">(String authorizationCode, String redirectUri,</span></span></span><br><span class="line"><span class="function"><span class="params">                                         MultiValueMap&lt;String, String&gt; parameters)</span> </span>&#123;</span><br><span class="line">      </span><br><span class="line">      StringBuilder accessTokenRequestUrl = <span class="keyword">new</span> StringBuilder(accessTokenUrl);</span><br><span class="line">      </span><br><span class="line">      accessTokenRequestUrl.append(<span class="string">"?appid="</span>+clientId);</span><br><span class="line">      accessTokenRequestUrl.append(<span class="string">"&amp;secret="</span>+clientSecret);</span><br><span class="line">      accessTokenRequestUrl.append(<span class="string">"&amp;code="</span>+authorizationCode);</span><br><span class="line">      accessTokenRequestUrl.append(<span class="string">"&amp;grant_type=authorization_code"</span>);</span><br><span class="line">      accessTokenRequestUrl.append(<span class="string">"&amp;redirect_uri="</span>+redirectUri);</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">return</span> getAccessToken(accessTokenRequestUrl);</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   <span class="function"><span class="keyword">public</span> AccessGrant <span class="title">refreshAccess</span><span class="params">(String refreshToken, MultiValueMap&lt;String, String&gt; additionalParameters)</span> </span>&#123;</span><br><span class="line">      </span><br><span class="line">      StringBuilder refreshTokenUrl = <span class="keyword">new</span> StringBuilder(REFRESH_TOKEN_URL);</span><br><span class="line">      </span><br><span class="line">      refreshTokenUrl.append(<span class="string">"?appid="</span>+clientId);</span><br><span class="line">      refreshTokenUrl.append(<span class="string">"&amp;grant_type=refresh_token"</span>);</span><br><span class="line">      refreshTokenUrl.append(<span class="string">"&amp;refresh_token="</span>+refreshToken);</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">return</span> getAccessToken(refreshTokenUrl);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">   <span class="function"><span class="keyword">private</span> AccessGrant <span class="title">getAccessToken</span><span class="params">(StringBuilder accessTokenRequestUrl)</span> </span>&#123;</span><br><span class="line">      </span><br><span class="line">      logger.info(<span class="string">"获取access_token, 请求URL: "</span>+accessTokenRequestUrl.toString());</span><br><span class="line">      </span><br><span class="line">      String response = getRestTemplate().getForObject(accessTokenRequestUrl.toString(), String.class);</span><br><span class="line">      </span><br><span class="line">      logger.info(<span class="string">"获取access_token, 响应内容: "</span>+response);</span><br><span class="line">      </span><br><span class="line">      Map&lt;String, Object&gt; result = <span class="keyword">null</span>;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         result = <span class="keyword">new</span> ObjectMapper().readValue(response, Map.class);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">         e.printStackTrace();</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">//返回错误码时直接返回空</span></span><br><span class="line">      <span class="keyword">if</span>(StringUtils.isNotBlank(MapUtils.getString(result, <span class="string">"errcode"</span>)))&#123;</span><br><span class="line">         String errcode = MapUtils.getString(result, <span class="string">"errcode"</span>);</span><br><span class="line">         String errmsg = MapUtils.getString(result, <span class="string">"errmsg"</span>);</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"获取access token失败, errcode:"</span>+errcode+<span class="string">", errmsg:"</span>+errmsg);</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      WeixinAccessGrant accessToken = <span class="keyword">new</span> WeixinAccessGrant(</span><br><span class="line">            MapUtils.getString(result, <span class="string">"access_token"</span>),</span><br><span class="line">            MapUtils.getString(result, <span class="string">"scope"</span>),</span><br><span class="line">            MapUtils.getString(result, <span class="string">"refresh_token"</span>),</span><br><span class="line">            MapUtils.getLong(result, <span class="string">"expires_in"</span>));</span><br><span class="line">      </span><br><span class="line">      accessToken.setOpenId(MapUtils.getString(result, <span class="string">"openid"</span>));</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">return</span> accessToken;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 构建获取授权码的请求。也就是引导用户跳转到微信的地址。</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">buildAuthenticateUrl</span><span class="params">(OAuth2Parameters parameters)</span> </span>&#123;</span><br><span class="line">      String url = <span class="keyword">super</span>.buildAuthenticateUrl(parameters);</span><br><span class="line">      url = url + <span class="string">"&amp;appid="</span>+clientId+<span class="string">"&amp;scope=snsapi_login"</span>;</span><br><span class="line">      <span class="keyword">return</span> url;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">buildAuthorizeUrl</span><span class="params">(OAuth2Parameters parameters)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> buildAuthenticateUrl(parameters);</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 微信返回的contentType是html/text，添加相应的HttpMessageConverter来处理。</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> RestTemplate <span class="title">createRestTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      RestTemplate restTemplate = <span class="keyword">super</span>.createRestTemplate();</span><br><span class="line">      restTemplate.getMessageConverters().add(<span class="keyword">new</span> StringHttpMessageConverter(Charset.forName(<span class="string">"UTF-8"</span>)));</span><br><span class="line">      <span class="keyword">return</span> restTemplate;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="AccessGrant"><a href="#AccessGrant" class="headerlink" title="AccessGrant"></a>AccessGrant</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 完成微信的OAuth2认证流程的模板类。国内厂商实现的OAuth2每个都不同, spring默认提供的OAuth2Template适应不了，只能针对每个厂商自己微调。</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan on 20180308</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WeixinOAuth2Template</span> <span class="keyword">extends</span> <span class="title">OAuth2Template</span> </span>&#123;</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">private</span> String clientId;</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">private</span> String clientSecret;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> String accessTokenUrl;</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String REFRESH_TOKEN_URL = <span class="string">"https://api.weixin.qq.com/sns/oauth2/refresh_token"</span>;</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">WeixinOAuth2Template</span><span class="params">(String clientId, String clientSecret, String authorizeUrl, String accessTokenUrl)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">super</span>(clientId, clientSecret, authorizeUrl, accessTokenUrl);</span><br><span class="line">      setUseParametersForClientAuthentication(<span class="keyword">true</span>);</span><br><span class="line">      <span class="keyword">this</span>.clientId = clientId;</span><br><span class="line">      <span class="keyword">this</span>.clientSecret = clientSecret;</span><br><span class="line">      <span class="keyword">this</span>.accessTokenUrl = accessTokenUrl;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   <span class="comment">/* (non-Javadoc)</span></span><br><span class="line"><span class="comment">    * @see org.springframework.social.oauth2.OAuth2Template#exchangeForAccess(java.lang.String, java.lang.String, org.springframework.util.MultiValueMap)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> AccessGrant <span class="title">exchangeForAccess</span><span class="params">(String authorizationCode, String redirectUri,</span></span></span><br><span class="line"><span class="function"><span class="params">                                         MultiValueMap&lt;String, String&gt; parameters)</span> </span>&#123;</span><br><span class="line">      </span><br><span class="line">      StringBuilder accessTokenRequestUrl = <span class="keyword">new</span> StringBuilder(accessTokenUrl);</span><br><span class="line">      </span><br><span class="line">      accessTokenRequestUrl.append(<span class="string">"?appid="</span>+clientId);</span><br><span class="line">      accessTokenRequestUrl.append(<span class="string">"&amp;secret="</span>+clientSecret);</span><br><span class="line">      accessTokenRequestUrl.append(<span class="string">"&amp;code="</span>+authorizationCode);</span><br><span class="line">      accessTokenRequestUrl.append(<span class="string">"&amp;grant_type=authorization_code"</span>);</span><br><span class="line">      accessTokenRequestUrl.append(<span class="string">"&amp;redirect_uri="</span>+redirectUri);</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">return</span> getAccessToken(accessTokenRequestUrl);</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   <span class="function"><span class="keyword">public</span> AccessGrant <span class="title">refreshAccess</span><span class="params">(String refreshToken, MultiValueMap&lt;String, String&gt; additionalParameters)</span> </span>&#123;</span><br><span class="line">      </span><br><span class="line">      StringBuilder refreshTokenUrl = <span class="keyword">new</span> StringBuilder(REFRESH_TOKEN_URL);</span><br><span class="line">      </span><br><span class="line">      refreshTokenUrl.append(<span class="string">"?appid="</span>+clientId);</span><br><span class="line">      refreshTokenUrl.append(<span class="string">"&amp;grant_type=refresh_token"</span>);</span><br><span class="line">      refreshTokenUrl.append(<span class="string">"&amp;refresh_token="</span>+refreshToken);</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">return</span> getAccessToken(refreshTokenUrl);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">   <span class="function"><span class="keyword">private</span> AccessGrant <span class="title">getAccessToken</span><span class="params">(StringBuilder accessTokenRequestUrl)</span> </span>&#123;</span><br><span class="line">      </span><br><span class="line">      logger.info(<span class="string">"获取access_token, 请求URL: "</span>+accessTokenRequestUrl.toString());</span><br><span class="line">      </span><br><span class="line">      String response = getRestTemplate().getForObject(accessTokenRequestUrl.toString(), String.class);</span><br><span class="line">      </span><br><span class="line">      logger.info(<span class="string">"获取access_token, 响应内容: "</span>+response);</span><br><span class="line">      </span><br><span class="line">      Map&lt;String, Object&gt; result = <span class="keyword">null</span>;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         result = <span class="keyword">new</span> ObjectMapper().readValue(response, Map.class);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">         e.printStackTrace();</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">//返回错误码时直接返回空</span></span><br><span class="line">      <span class="keyword">if</span>(StringUtils.isNotBlank(MapUtils.getString(result, <span class="string">"errcode"</span>)))&#123;</span><br><span class="line">         String errcode = MapUtils.getString(result, <span class="string">"errcode"</span>);</span><br><span class="line">         String errmsg = MapUtils.getString(result, <span class="string">"errmsg"</span>);</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"获取access token失败, errcode:"</span>+errcode+<span class="string">", errmsg:"</span>+errmsg);</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      WeixinAccessGrant accessToken = <span class="keyword">new</span> WeixinAccessGrant(</span><br><span class="line">            MapUtils.getString(result, <span class="string">"access_token"</span>),</span><br><span class="line">            MapUtils.getString(result, <span class="string">"scope"</span>),</span><br><span class="line">            MapUtils.getString(result, <span class="string">"refresh_token"</span>),</span><br><span class="line">            MapUtils.getLong(result, <span class="string">"expires_in"</span>));</span><br><span class="line">      </span><br><span class="line">      accessToken.setOpenId(MapUtils.getString(result, <span class="string">"openid"</span>));</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">return</span> accessToken;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 构建获取授权码的请求。也就是引导用户跳转到微信的地址。</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">buildAuthenticateUrl</span><span class="params">(OAuth2Parameters parameters)</span> </span>&#123;</span><br><span class="line">      String url = <span class="keyword">super</span>.buildAuthenticateUrl(parameters);</span><br><span class="line">      url = url + <span class="string">"&amp;appid="</span>+clientId+<span class="string">"&amp;scope=snsapi_login"</span>;</span><br><span class="line">      <span class="keyword">return</span> url;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">buildAuthorizeUrl</span><span class="params">(OAuth2Parameters parameters)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> buildAuthenticateUrl(parameters);</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 微信返回的contentType是html/text，添加相应的HttpMessageConverter来处理。</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> RestTemplate <span class="title">createRestTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      RestTemplate restTemplate = <span class="keyword">super</span>.createRestTemplate();</span><br><span class="line">      restTemplate.getMessageConverters().add(<span class="keyword">new</span> StringHttpMessageConverter(Charset.forName(<span class="string">"UTF-8"</span>)));</span><br><span class="line">      <span class="keyword">return</span> restTemplate;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="ServiceProvider-1"><a href="#ServiceProvider-1" class="headerlink" title="ServiceProvider"></a>ServiceProvider</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 微信的OAuth2流程处理器的提供器，供spring social的connect体系调用</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan 20180303</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WeixinServiceProvider</span> <span class="keyword">extends</span> <span class="title">AbstractOAuth2ServiceProvider</span>&lt;<span class="title">Weixin</span>&gt; </span>&#123;</span><br><span class="line">   </span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 微信获取授权码的url</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String URL_AUTHORIZE = <span class="string">"https://open.weixin.qq.com/connect/qrconnect"</span>;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 微信获取accessToken的url</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String URL_ACCESS_TOKEN = <span class="string">"https://api.weixin.qq.com/sns/oauth2/access_token"</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> appId</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> appSecret</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">WeixinServiceProvider</span><span class="params">(String appId, String appSecret)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">super</span>(<span class="keyword">new</span> WeixinOAuth2Template(appId, appSecret,URL_AUTHORIZE,URL_ACCESS_TOKEN));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> Weixin <span class="title">getApi</span><span class="params">(String accessToken)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> WeixinImpl(accessToken);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="构造ConnectionFactory-1"><a href="#构造ConnectionFactory-1" class="headerlink" title="构造ConnectionFactory"></a>构造ConnectionFactory</h5><h6 id="ApiAdapter-1"><a href="#ApiAdapter-1" class="headerlink" title="ApiAdapter"></a>ApiAdapter</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 微信 api适配器，将微信 api的数据模型转为spring social的标准模型。</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan on 20180308</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WeixinAdapter</span> <span class="keyword">implements</span> <span class="title">ApiAdapter</span>&lt;<span class="title">Weixin</span>&gt; </span>&#123;</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">private</span> String openId;</span><br><span class="line">   </span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">WeixinAdapter</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">   </span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">WeixinAdapter</span><span class="params">(String openId)</span></span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.openId = openId;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> api</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">test</span><span class="params">(Weixin api)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> api</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> values</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setConnectionValues</span><span class="params">(Weixin api, ConnectionValues values)</span> </span>&#123;</span><br><span class="line">      WeixinUserInfo profile = api.getUserInfo(openId);</span><br><span class="line">      values.setProviderUserId(profile.getOpenid());</span><br><span class="line">      values.setDisplayName(profile.getNickname());</span><br><span class="line">      values.setImageUrl(profile.getHeadimgurl());</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> api</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> UserProfile <span class="title">fetchUserProfile</span><span class="params">(Weixin api)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> api</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateStatus</span><span class="params">(Weixin api, String message)</span> </span>&#123;</span><br><span class="line">      <span class="comment">//do nothing</span></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="ConnectionFactory-1"><a href="#ConnectionFactory-1" class="headerlink" title="ConnectionFactory"></a>ConnectionFactory</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 微信连接工厂</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan on 20180308</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WeixinConnectionFactory</span> <span class="keyword">extends</span> <span class="title">OAuth2ConnectionFactory</span>&lt;<span class="title">Weixin</span>&gt; </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> appId</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> appSecret</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">WeixinConnectionFactory</span><span class="params">(String providerId, String appId, String appSecret)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(providerId, <span class="keyword">new</span> WeixinServiceProvider(appId, appSecret), <span class="keyword">new</span> WeixinAdapter());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 由于微信的openId是和accessToken一起返回的，所以在这里直接根据accessToken设置providerUserId即可，不用像QQ那样通过QQAdapter来获取</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> String <span class="title">extractProviderUserId</span><span class="params">(AccessGrant accessGrant)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(accessGrant <span class="keyword">instanceof</span> WeixinAccessGrant) &#123;</span><br><span class="line">			<span class="keyword">return</span> ((WeixinAccessGrant)accessGrant).getOpenId();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/* (non-Javadoc)</span></span><br><span class="line"><span class="comment">	 * @see org.springframework.social.connect.support.OAuth2ConnectionFactory#createConnection(org.springframework.social.oauth2.AccessGrant)</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Connection&lt;Weixin&gt; <span class="title">createConnection</span><span class="params">(AccessGrant accessGrant)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> OAuth2Connection&lt;Weixin&gt;(getProviderId(), extractProviderUserId(accessGrant), accessGrant.getAccessToken(),</span><br><span class="line">				accessGrant.getRefreshToken(), accessGrant.getExpireTime(), getOAuth2ServiceProvider(), getApiAdapter(extractProviderUserId(accessGrant)));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* (non-Javadoc)</span></span><br><span class="line"><span class="comment">	 * @see org.springframework.social.connect.support.OAuth2ConnectionFactory#createConnection(org.springframework.social.connect.ConnectionData)</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Connection&lt;Weixin&gt; <span class="title">createConnection</span><span class="params">(ConnectionData data)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> OAuth2Connection&lt;Weixin&gt;(data, getOAuth2ServiceProvider(), getApiAdapter(data.getProviderUserId()));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> ApiAdapter&lt;Weixin&gt; <span class="title">getApiAdapter</span><span class="params">(String providerUserId)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> WeixinAdapter(providerUserId);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> OAuth2ServiceProvider&lt;Weixin&gt; <span class="title">getOAuth2ServiceProvider</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> (OAuth2ServiceProvider&lt;Weixin&gt;) getServiceProvider();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="生成微信配置"><a href="#生成微信配置" class="headerlink" title="生成微信配置"></a>生成微信配置</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 微信登录配置</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan on 20180308</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty</span>(prefix = <span class="string">"victorys.security.social.weixin"</span>, name = <span class="string">"app-id"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WeixinAutoConfiguration</span> <span class="keyword">extends</span> <span class="title">SocialAutoConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> SecurityProperties securityProperties;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 获取微信配置，生成微信的连接工厂</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * @see</span></span><br><span class="line"><span class="comment">	 * org.springframework.boot.autoconfigure.social.SocialAutoConfigurerAdapter</span></span><br><span class="line"><span class="comment">	 * #createConnectionFactory()</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> ConnectionFactory&lt;?&gt; createConnectionFactory() &#123;</span><br><span class="line">		WeixinProperties weixinConfig = securityProperties.getSocial().getWeixin();</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> WeixinConnectionFactory(weixinConfig.getProviderId(), weixinConfig.getAppId(),</span><br><span class="line">				weixinConfig.getAppSecret());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> UsersConnectionRepository <span class="title">getUsersConnectionRepository</span><span class="params">(ConnectionFactoryLocator connectionFactoryLocator)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span>(&#123;<span class="string">"connect/weixinConnect"</span>, <span class="string">"connect/weixinConnected"</span>&#125;)</span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean</span>(name = <span class="string">"weixinConnectedView"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> View <span class="title">weixinConnectedView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> AbstractConnectView();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="社交总配置"><a href="#社交总配置" class="headerlink" title="社交总配置"></a>社交总配置</h4><ol>
<li>配置SpringSocialConfigurer，实现对SocialAuthenticationFilter的配置</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义配置SocialConfigurer,覆盖其默认拍配置</span></span><br><span class="line"><span class="comment"> * 作用：SocialAuthenticationFilter初始化完成后，重新设置它的某些属性</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan 20180302</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractSpringSocialConfigurer</span> <span class="keyword">extends</span> <span class="title">SpringSocialConfigurer</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> String filterProcessesUrl;<span class="comment">//实现可配置的社交登陆拦截url</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//实现可扩展化Filter类</span></span><br><span class="line">	<span class="keyword">private</span> SocialAuthenticationFilterPostProcessor socialAuthenticationFilterPostProcessor;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">AbstractSpringSocialConfigurer</span><span class="params">(String filterProcessesUrl)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.filterProcessesUrl = filterProcessesUrl;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> &lt;T&gt; <span class="function">T <span class="title">postProcess</span><span class="params">(T object)</span> </span>&#123;</span><br><span class="line">		SocialAuthenticationFilter filter = (SocialAuthenticationFilter) <span class="keyword">super</span>.postProcess(object);</span><br><span class="line">		<span class="comment">//设置社交登陆拦截的url</span></span><br><span class="line">		filter.setFilterProcessesUrl(filterProcessesUrl);</span><br><span class="line">		<span class="keyword">if</span> (socialAuthenticationFilterPostProcessor != <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="comment">//为SocialAuthenticationFilter增加额外的属性</span></span><br><span class="line">			<span class="comment">//在不同的项目下会有不同的实现</span></span><br><span class="line">			socialAuthenticationFilterPostProcessor.process(filter);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> (T) filter;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> SocialAuthenticationFilterPostProcessor <span class="title">getSocialAuthenticationFilterPostProcessor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> socialAuthenticationFilterPostProcessor;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSocialAuthenticationFilterPostProcessor</span><span class="params">(SocialAuthenticationFilterPostProcessor socialAuthenticationFilterPostProcessor)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.socialAuthenticationFilterPostProcessor = socialAuthenticationFilterPostProcessor;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getFilterProcessesUrl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> filterProcessesUrl;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFilterProcessesUrl</span><span class="params">(String filterProcessesUrl)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.filterProcessesUrl = filterProcessesUrl;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>SocialAuthenticationFilterPostProcessor社交验证过滤器后置处理器接口定义</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 定义后处理器接口，处理不同模式下授权后返回的信息</span></span><br><span class="line"><span class="comment"> * 如果不进行配置，则不修改SocialAuthenticationFilter里的任何属性值</span></span><br><span class="line"><span class="comment"> * 默认不进行设置，即没有实现类</span></span><br><span class="line"><span class="comment"> * 根据不同的环境，可以自定义接口的实现，对SocialAuthenticationFilter进行属性扩展</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 在前后端分离的项目中，一般都需要返回不一样的社交登陆验证信息，比如说给Filter设置登陆成功处理器</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan 20180305</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SocialAuthenticationFilterPostProcessor</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">process</span><span class="params">(SocialAuthenticationFilter socialAuthenticationFilter)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>总配置</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 配置社交登陆配置</span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan 20180302</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableSocial</span><span class="comment">//开启社交项目的支持</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SocialConfig</span> <span class="keyword">extends</span> <span class="title">SocialConfigurerAdapter</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> DataSource dataSource;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> SecurityProperties securityProperties;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//开启社交用户自动注册</span></span><br><span class="line">	<span class="meta">@Autowired</span>(required = <span class="keyword">false</span>)</span><br><span class="line">	<span class="keyword">private</span> ConnectionSignUp connectionSignUp;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//是否有后置处理器去增强过滤器的配置</span></span><br><span class="line">	<span class="meta">@Autowired</span>(required = <span class="keyword">false</span>)</span><br><span class="line">	<span class="keyword">private</span> SocialAuthenticationFilterPostProcessor socialAuthenticationFilterPostProcessor;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//配置UsersConnectionRepository</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> UsersConnectionRepository <span class="title">getUsersConnectionRepository</span><span class="params">(ConnectionFactoryLocator connectionFactoryLocator)</span> </span>&#123;</span><br><span class="line">		JdbcUsersConnectionRepository repository = <span class="keyword">new</span> JdbcUsersConnectionRepository(dataSource, connectionFactoryLocator, Encryptors.noOpText());</span><br><span class="line">		repository.setTablePrefix(<span class="string">"vic_"</span>);<span class="comment">//加入表前缀</span></span><br><span class="line">		<span class="keyword">if</span>(connectionSignUp != <span class="keyword">null</span>) &#123;</span><br><span class="line">			repository.setConnectionSignUp(connectionSignUp);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> repository;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 全局配置SocailConfig</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Bean</span>(name = SecurityConstants.DEFAULT_SPRING_SOCIAL_CONFIGURER_BEAN_NAME)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> SpringSocialConfigurer <span class="title">socialSecurityConfig</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		String filterProcessesUrl = securityProperties.getSocial().getFilterProcessesUrl();</span><br><span class="line">		AbstractSpringSocialConfigurer configurer = <span class="keyword">new</span> AbstractSpringSocialConfigurer(filterProcessesUrl);</span><br><span class="line">		<span class="comment">//设置注册地址</span></span><br><span class="line">		configurer.signupUrl(securityProperties.getBrowser().getSignUpUrl());</span><br><span class="line">		<span class="comment">//设置后置处理器，对过滤器进行增强改造</span></span><br><span class="line">		configurer.setSocialAuthenticationFilterPostProcessor(socialAuthenticationFilterPostProcessor);</span><br><span class="line">		<span class="keyword">return</span> configurer;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * spring social 提供的工具类，可以获取获取到的第三方用户信息</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> connectionFactoryLocator spring boot 已经有此类的实现</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> ProviderSignInUtils</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> ProviderSignInUtils <span class="title">providerSignInUtils</span><span class="params">(ConnectionFactoryLocator connectionFactoryLocator)</span> </span>&#123;</span><br><span class="line">		UsersConnectionRepository usersConnectionRepository = getUsersConnectionRepository(connectionFactoryLocator);</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> ProviderSignInUtils(connectionFactoryLocator,usersConnectionRepository);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 配置默认的社交绑定状态信息输出器</span></span><br><span class="line"><span class="comment">	 * 可扩展</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean</span>(AbstractConnectionViewProcessor.class)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> AbstractConnectionViewProcessor <span class="title">connectionViewProcessor</span><span class="params">(ObjectMapper objectMapper)</span></span>&#123;</span><br><span class="line">		DefaultConnectionViewProcessor processor = <span class="keyword">new</span> DefaultConnectionViewProcessor(objectMapper);</span><br><span class="line">		<span class="keyword">return</span> processor;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Spring-Social额外配置"><a href="#Spring-Social额外配置" class="headerlink" title="Spring Social额外配置"></a>Spring Social额外配置</h4><h5 id="社交注册"><a href="#社交注册" class="headerlink" title="社交注册"></a>社交注册</h5><p>​    当以上流程就是走完整个OAuth协议的流程，拿到了服务提供商的用户信息，但是成功后却引发了另外一个跳转：/signup。</p>
<h6 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h6><p><strong>SocialAuthenticationProvider 源码跟踪</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.social.security;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SocialAuthenticationProvider</span> <span class="keyword">implements</span> <span class="title">AuthenticationProvider</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Class&lt;? extends Object&gt; authentication)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> SocialAuthenticationToken.class.isAssignableFrom(authentication);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Authentication <span class="title">authenticate</span><span class="params">(Authentication authentication)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">        Assert.isInstanceOf(SocialAuthenticationToken.class, authentication, <span class="string">"unsupported authentication type"</span>);</span><br><span class="line">        Assert.isTrue(!authentication.isAuthenticated(), <span class="string">"already authenticated"</span>);</span><br><span class="line">        SocialAuthenticationToken authToken = (SocialAuthenticationToken)authentication;</span><br><span class="line">        String providerId = authToken.getProviderId();</span><br><span class="line">        <span class="comment">//获得Connection</span></span><br><span class="line">        Connection&lt;?&gt; connection = authToken.getConnection();</span><br><span class="line">		<span class="comment">//在系统用户中不存在对应第三方用户的记录</span></span><br><span class="line">        String userId = <span class="keyword">this</span>.toUserId(connection);</span><br><span class="line">        <span class="keyword">if</span>(userId == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="comment">//扔出这个异常，会跳转到注册</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BadCredentialsException(<span class="string">"Unknown access token"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            UserDetails userDetails = <span class="keyword">this</span>.userDetailsService.loadUserByUserId(userId);</span><br><span class="line">            <span class="keyword">if</span>(userDetails == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> UsernameNotFoundException(<span class="string">"Unknown connected account id"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> SocialAuthenticationToken(connection, userDetails, authToken.getProviderAccountData(), <span class="keyword">this</span>.getAuthorities(providerId, userDetails));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//根据Connection获取系统用户的信息</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">toUserId</span><span class="params">(Connection&lt;?&gt; connection)</span> </span>&#123;</span><br><span class="line">        List&lt;String&gt; userIds = <span class="keyword">this</span>.usersConnectionRepository.findUserIdsWithConnection(connection);</span><br><span class="line">        <span class="keyword">return</span> userIds.size() == <span class="number">1</span>?(String)userIds.iterator().next():<span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>SocialAuthenticationFilter源码跟踪</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SocialAuthenticationFilter</span> <span class="keyword">extends</span> <span class="title">AbstractAuthenticationProcessingFilter</span></span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">private</span> Authentication <span class="title">doAuthentication</span><span class="params">(SocialAuthenticationService&lt;?&gt; authService, HttpServletRequest request, SocialAuthenticationToken token)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(!authService.getConnectionCardinality().isAuthenticatePossible()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            token.setDetails(<span class="keyword">this</span>.authenticationDetailsSource.buildDetails(request));</span><br><span class="line">            Authentication success = <span class="keyword">this</span>.getAuthenticationManager().authenticate(token);</span><br><span class="line">            Assert.isInstanceOf(SocialUserDetails.class, success.getPrincipal(), <span class="string">"unexpected principle type"</span>);</span><br><span class="line">            <span class="keyword">this</span>.updateConnections(authService, token, success);</span><br><span class="line">            <span class="keyword">return</span> success;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (BadCredentialsException var5) &#123;</span><br><span class="line">	<span class="comment">//捕获到该异常就会进行跳转到默认的注册页或者自定义的注册页</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.signupUrl != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.sessionStrategy.setAttribute(<span class="keyword">new</span> ServletWebRequest(request), ProviderSignInAttempt.SESSION_ATTRIBUTE, <span class="keyword">new</span> ProviderSignInAttempt(token.getConnection()));</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SocialAuthenticationRedirectException(<span class="keyword">this</span>.buildSignupUrl(request));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> var5;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h6><ol>
<li>开启指定的注册页面</li>
</ol>
<p>1）新增一个注册页面，并且将注册页面url实现可配置化，并且通知SocialConfiguer注册页，并放开注册页的访问权限。</p>
<p>在以上<code>SocialConfig.java</code>代码展示中已经配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//设置注册地址</span></span><br><span class="line">configurer.signupUrl(securityProperties.getBrowser().getSignUpUrl())</span><br></pre></td></tr></table></figure>
<p>2）社交用户信息的传递</p>
<p>当我们在授权获取用户信息后，跳到了注册页上，那么怎么将第三方用户信息传递到注册页面上，注册后，怎么告诉social，刚注册的用户怎么关联上授权用户的信息；Spring 提供了工具类，解决问题：①注册时拿到spring social 信息；②注册完成如何传递用户id给spring social</p>
<p><code>SocialConfig.java</code>中的配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * spring social 提供的工具类，可以获取获取到的第三方用户信息</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> connectionFactoryLocator spring boot 已经有此类的实现</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> ProviderSignInUtils</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> ProviderSignInUtils <span class="title">providerSignInUtils</span><span class="params">(ConnectionFactoryLocator connectionFactoryLocator)</span> </span>&#123;</span><br><span class="line">		UsersConnectionRepository usersConnectionRepository = getUsersConnectionRepository(connectionFactoryLocator);</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> ProviderSignInUtils(connectionFactoryLocator,usersConnectionRepository);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p><code>ProviderSignInUtils</code>工具类需要在有session的环境下才能使用，否则无效</p>
<p>3）构建获取社交用户信息的服务</p>
<p><code>BrowserSecurityController.java</code>中新增服务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> ProviderSignInUtils providerSignInUtils;</span><br><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/social/user"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> SocialUserInfo <span class="title">getSocialUserInfo</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">   SocialUserInfo userInfo = <span class="keyword">new</span> SocialUserInfo();</span><br><span class="line">   Connection&lt;?&gt; connection = providerSignInUtils.getConnectionFromSession(<span class="keyword">new</span> ServletWebRequest(request));</span><br><span class="line">   userInfo.setProviderId(connection.getKey().getProviderId());</span><br><span class="line">   userInfo.setProviderUserId(connection.getKey().getProviderUserId());<span class="comment">//openid</span></span><br><span class="line">   userInfo.setNickname(connection.getDisplayName());</span><br><span class="line">   userInfo.setHeadimg(connection.getImageUrl());</span><br><span class="line">   <span class="keyword">return</span> userInfo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>4）Connection信息的存储</p>
<p>查看<code>SocialAuthenticationFilter</code>中源码，中当需要跳转注册页面时，执行下代码，将Connection放入session中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.sessionStrategy.setAttribute(<span class="keyword">new</span> ServletWebRequest(request), ProviderSignInAttempt.SESSION_ATTRIBUTE, <span class="keyword">new</span> ProviderSignInAttempt(token.getConnection()));</span><br></pre></td></tr></table></figure>
<p>5）创建注册服务</p>
<p><code>UserController.java</code>中注册服务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> ProviderSignInUtils providerSignInUtils;</span><br><span class="line"></span><br><span class="line"><span class="meta">@PostMapping</span>(<span class="string">"/regist"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">regist</span><span class="params">(User user, HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">   <span class="comment">//实现注册业务，注册成功后返回用户唯一标签</span></span><br><span class="line">    <span class="comment">//实现逻辑.........</span></span><br><span class="line">   <span class="comment">//不管是注册用户还是绑定用户，都会拿到一个用户唯一标识。</span></span><br><span class="line">   String userId = user.getUsername();</span><br><span class="line">    </span><br><span class="line">   <span class="comment">//工具类实现注册关联</span></span><br><span class="line">   providerSignInUtils.doPostSignUp(userId, <span class="keyword">new</span> ServletWebRequest(request));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>开启关联注册</li>
</ol>
<p>当用户使用第三方登陆时，授权获取信息成功后，不是跳转的注册页面，而是进入系统。开启默认注册</p>
<p>1）源码分析</p>
<p><code>SocialAuthenticationProvider.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SocialAuthenticationProvider</span> <span class="keyword">implements</span> <span class="title">AuthenticationProvider</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Authentication <span class="title">authenticate</span><span class="params">(Authentication authentication)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">        String userId = <span class="keyword">this</span>.toUserId(connection);</span><br><span class="line">  	&#125;</span><br><span class="line">    </span><br><span class="line">	<span class="function"><span class="keyword">protected</span> String <span class="title">toUserId</span><span class="params">(Connection&lt;?&gt; connection)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//查看是否有系统关联的用户存在</span></span><br><span class="line">    List&lt;String&gt; userIds =  <span class="keyword">this</span>.usersConnectionRepository.findUserIdsWithConnection(connection);</span><br><span class="line">    <span class="keyword">return</span> userIds.size() == <span class="number">1</span>?(String)userIds.iterator().next():<span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>JdbcUsersConnectionRepository.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JdbcUsersConnectionRepository</span> <span class="keyword">implements</span> <span class="title">UsersConnectionRepository</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ConnectionSignUp connectionSignUp;<span class="comment">//对象存在时，开启默认创建用户</span></span><br><span class="line">    </span><br><span class="line">	<span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">findUserIdsWithConnection</span><span class="params">(Connection&lt;?&gt; connection)</span> </span>&#123;</span><br><span class="line">    	ConnectionKey key = connection.getKey();</span><br><span class="line">    	List&lt;String&gt; localUserIds = <span class="keyword">this</span>.jdbcTemplate.queryForList(<span class="string">"select userId from "</span> + <span class="keyword">this</span>.tablePrefix + <span class="string">"UserConnection where providerId = ? and providerUserId = ?"</span>, String.class, <span class="keyword">new</span> Object[]&#123;key.getProviderId(), key.getProviderUserId()&#125;);</span><br><span class="line">    	<span class="comment">//如果没有查到对象，并且connectionSignUp对象存在</span></span><br><span class="line">		<span class="keyword">if</span>(localUserIds.size() == <span class="number">0</span> &amp;&amp; <span class="keyword">this</span>.connectionSignUp != <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="comment">//执行方法，返回新用户的Id</span></span><br><span class="line">        	String newUserId = <span class="keyword">this</span>.connectionSignUp.execute(connection);</span><br><span class="line">        	<span class="keyword">if</span>(newUserId != <span class="keyword">null</span>) &#123;</span><br><span class="line">            	<span class="keyword">this</span>.createConnectionRepository(newUserId).addConnection(connection);</span><br><span class="line">            	<span class="keyword">return</span> Arrays.asList(<span class="keyword">new</span> String[]&#123;newUserId&#125;);</span><br><span class="line">        	&#125;</span><br><span class="line">    	&#125;</span><br><span class="line"></span><br><span class="line">    	<span class="keyword">return</span> localUserIds;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2） 自定义ConnectionSignUp</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义社交登陆，开启默认注册</span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan 20180303</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoConnectionSignUp</span> <span class="keyword">implements</span> <span class="title">ConnectionSignUp</span> </span>&#123;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">execute</span><span class="params">(Connection&lt;?&gt; connection)</span> </span>&#123;</span><br><span class="line">      <span class="comment">//根据业务创建逻辑,实现注册</span></span><br><span class="line">      <span class="comment">//根据社交用户信息默认创建用户并返回用户唯一标识</span></span><br><span class="line">      <span class="keyword">return</span> connection.getDisplayName();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>SocialConfig.java</code>中加入<code>UserUsersConnectionRepository</code>配置中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//注入</span></span><br><span class="line">	<span class="meta">@Autowired</span>(required = <span class="keyword">false</span>)</span><br><span class="line">	<span class="keyword">private</span> ConnectionSignUp connectionSignUp;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> UsersConnectionRepository <span class="title">getUsersConnectionRepository</span><span class="params">(ConnectionFactoryLocator connectionFactoryLocator)</span> </span>&#123;</span><br><span class="line">		JdbcUsersConnectionRepository repository = <span class="keyword">new</span> JdbcUsersConnectionRepository(dataSource, connectionFactoryLocator, Encryptors.noOpText());</span><br><span class="line">		repository.setTablePrefix(<span class="string">"vic_"</span>);<span class="comment">//加入表前缀</span></span><br><span class="line">		<span class="keyword">if</span>(connectionSignUp != <span class="keyword">null</span>) &#123;</span><br><span class="line">			repository.setConnectionSignUp(connectionSignUp);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> repository;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h6 id="BUG"><a href="#BUG" class="headerlink" title="BUG"></a>BUG</h6><ol>
<li>问题：</li>
</ol>
<p>这里我遇到了一个问题：</p>
<p>SocialAuthenticationProvider中使用的是InMemoryUsersConnectionRepository导致无法通过验证，每次都要重新注册，但是我们明明已经配置好JdbcUsersConnectionRepository为默认的操作数据库Connection，很奇怪的是我们在注册时候调用ProviderSignInUtils的自动注册方法，确是使用JdbcUsersConnectionRepository</p>
<p><strong>SocialAuthenticationProvider中的UsersConnectionRepository为InMemoryUsersConnectionRepository</strong></p>
<p><strong>ProviderSignInUtils中的UsersConnectionRepository为JdbcUsersConnectionRepository</strong></p>
<ol start="2">
<li>源码分析：</li>
</ol>
<p><code>SocialConfiguration.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SocialConfiguration</span> </span>&#123;</span><br><span class="line">   <span class="comment">//会在set方法中注入所有的socialConfigurers ， QQAutoConfig等都实现了此接口</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;SocialConfigurer&gt; socialConfigurers;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UsersConnectionRepository <span class="title">usersConnectionRepository</span><span class="params">(ConnectionFactoryLocator connectionFactoryLocator)</span> </span>&#123;</span><br><span class="line">        UsersConnectionRepository usersConnectionRepository = <span class="keyword">null</span>;</span><br><span class="line">        Iterator i$ = <span class="keyword">this</span>.socialConfigurers.iterator();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//找到多个接口的实现进行遍历</span></span><br><span class="line">        <span class="keyword">while</span>(i$.hasNext()) &#123;</span><br><span class="line">            SocialConfigurer socialConfigurer = (SocialConfigurer)i$.next();</span><br><span class="line">            <span class="comment">//调用方法获取UsersConnectionRepository</span></span><br><span class="line">            UsersConnectionRepository ucrCandidate = socialConfigurer.getUsersConnectionRepository(connectionFactoryLocator);</span><br><span class="line">            <span class="keyword">if</span>(ucrCandidate != <span class="keyword">null</span>) &#123;</span><br><span class="line">                usersConnectionRepository = ucrCandidate;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Assert.notNull(usersConnectionRepository, <span class="string">"One configuration class must implement getUsersConnectionRepository from SocialConfigurer."</span>);</span><br><span class="line">        <span class="keyword">return</span> usersConnectionRepository;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>socialConfigurer.getUsersConnectionRepository(connectionFactoryLocator);</code></p>
<p>如果子类没有覆盖方法，则会默认调用父类的获取UsersConnectionRepository方法，返回的就是InMemoryUsersConnectionRepository</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">SocialConfigurerAdapter</span> <span class="keyword">implements</span> <span class="title">SocialConfigurer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UsersConnectionRepository <span class="title">getUsersConnectionRepository</span><span class="params">(ConnectionFactoryLocator connectionFactoryLocator)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> InMemoryUsersConnectionRepository(connectionFactoryLocator);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>分析：</li>
</ol>
<p>因为初始化顺序的问题，<code>SocialConfiguration</code>中有多个，例如<code>QQAutoConfig</code>，在遍历寻找UserConnectionRepository中</p>
<p><code>socialConfigurer.getUsersConnectionRepository(connectionFactoryLocator);</code>,则调用父类返回默认的<code>InMemoryUsersConnectionRepository</code></p>
<ol start="4">
<li>解决：</li>
</ol>
<p>在自定义<code>SocialConfiguration</code>实现类中，覆盖其父类的<code>getUsersConnectionRepository</code>方法，返回<code>null</code>则可以解决这个问题，返回<code>null</code>时则会继续遍历下一个，直达在总配置<code>SocialConfig</code>返回我们覆盖的获得该类的方法</p>
<p>修改配置，微信配置也如此</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QQAutoConfig</span> <span class="keyword">extends</span> <span class="title">SocialAutoConfigurerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 为了解决生产多个连接工厂，覆盖父类的连接工厂创建</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> connectionFactoryLocator</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> UsersConnectionRepository <span class="title">getUsersConnectionRepository</span><span class="params">(ConnectionFactoryLocator connectionFactoryLocator)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="社交账号的绑定与解绑"><a href="#社交账号的绑定与解绑" class="headerlink" title="社交账号的绑定与解绑"></a>社交账号的绑定与解绑</h5><p>系统当前用户需要绑定第三方账号或系统当前用户解绑第三方账号</p>
<p>绑定的流程跟社交登陆的流程是大同小异的；解绑实现逻辑比较简单，是从数据库中删除当前账户与第三方账户的记录</p>
<h6 id="绑定信息"><a href="#绑定信息" class="headerlink" title="绑定信息"></a>绑定信息</h6><p>Spring Security默认提供当前账户绑定信息的服务,服务的请求地址为<code>/conncet</code>,访问的方式的<code>POST</code></p>
<p><code>ConnectController.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(&#123;<span class="string">"/connect"</span>&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConnectController</span> <span class="keyword">implements</span> <span class="title">InitializingBean</span> </span>&#123;</span><br><span class="line"><span class="meta">@RequestMapping</span>(</span><br><span class="line">    method = &#123;RequestMethod.GET&#125;</span><br><span class="line">)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">connectionStatus</span><span class="params">(NativeWebRequest request, Model model)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.setNoCache(request);</span><br><span class="line">    <span class="keyword">this</span>.processFlash(request, model);</span><br><span class="line">	<span class="comment">//当前用户所有的绑定信息</span></span><br><span class="line">    Map&lt;String, List&lt;Connection&lt;?&gt;&gt;&gt; connections = <span class="keyword">this</span>.connectionRepository.findAllConnections();</span><br><span class="line">	<span class="comment">//获得所有的第三方支持</span></span><br><span class="line">    model.addAttribute(<span class="string">"providerIds"</span>, <span class="keyword">this</span>.connectionFactoryLocator.registeredProviderIds());</span><br><span class="line"><span class="comment">//将用户信息放进model</span></span><br><span class="line">    model.addAttribute(<span class="string">"connectionMap"</span>, connections);</span><br><span class="line">	<span class="comment">//返回视图名字:/connect/status</span></span><br><span class="line">	<span class="comment">//spring默认没有提供这个视图，需要进行自定义</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.connectView();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>方法中获取了当前账户所有的,并且已经在系统中配置了的第三方应用的绑定信息,并且存入Model中.</p>
<p><strong>自定义回显视图<code>connect/status</code></strong></p>
<ol>
<li>定义可扩展输出借口</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 为扩展提供spring 社交绑定状态信息返回提供接口</span></span><br><span class="line"><span class="comment"> * 各个模块可实现该接口逻辑进行状态信息的输出</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan on 20180308</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AbstractConnectionViewProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 实现社交绑定状态信息（内容自定义）的输出</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> model spring social 在ConnectController内存将此属性填充,含有属性:providerIds、connectionMap等，我们只需要用就可以了</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request 请求体</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response 响应体</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">outputModel</span><span class="params">(Map&lt;String, Object&gt; model, HttpServletRequest request,HttpServletResponse response)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>实现视图定义</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 社交账号绑定状态视图</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan on 20180308</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span>(<span class="string">"connect/status"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractConnectionStatusView</span> <span class="keyword">extends</span> <span class="title">AbstractView</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> AbstractConnectionViewProcessor abstractConnectionViewProcessor;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">renderMergedOutputModel</span><span class="params">(Map&lt;String, Object&gt; model, HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">			HttpServletResponse response)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		abstractConnectionViewProcessor.outputModel(model,request,response);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>定义<code>AbstractConnectionViewProcessor</code>借口默认实现类</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 默认提供的输出社交绑定信息的实现类</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan on 20180308</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultConnectionViewProcessor</span> <span class="keyword">implements</span> <span class="title">AbstractConnectionViewProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ObjectMapper objectMapper;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DefaultConnectionViewProcessor</span><span class="params">(ObjectMapper objectMapper)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.objectMapper = objectMapper;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">outputModel</span><span class="params">(Map&lt;String, Object&gt; model, HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Map&lt;String, List&lt;Connection&lt;?&gt;&gt;&gt; connections = (Map&lt;String, List&lt;Connection&lt;?&gt;&gt;&gt;) model.get(<span class="string">"connectionMap"</span>);</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Boolean&gt; result = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (String key : connections.keySet()) &#123;</span><br><span class="line">            result.put(key, CollectionUtils.isNotEmpty(connections.get(key)));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        response.setContentType(<span class="string">"application/json;charset=UTF-8"</span>);</span><br><span class="line">        response.getWriter().write(objectMapper.writeValueAsString(result));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>配置输出接口</li>
</ol>
<p>在社交总配置<code>SocialConfig.java</code>代码中,已经贴出了相关配置:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 配置默认的社交绑定状态信息输出器</span></span><br><span class="line"><span class="comment"> * 可扩展</span></span><br><span class="line"><span class="comment"> * 子模块为定义,则使用默认提供的输出类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean</span>(AbstractConnectionViewProcessor.class)</span><br><span class="line"><span class="function"><span class="keyword">public</span> AbstractConnectionViewProcessor <span class="title">connectionViewProcessor</span><span class="params">(ObjectMapper objectMapper)</span></span>&#123;</span><br><span class="line">	DefaultConnectionViewProcessor processor = <span class="keyword">new</span> DefaultConnectionViewProcessor(objectMapper);</span><br><span class="line">	<span class="keyword">return</span> processor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="绑定与解绑"><a href="#绑定与解绑" class="headerlink" title="绑定与解绑"></a>绑定与解绑</h6><p><strong>绑定与解绑的实现</strong></p>
<p>Spring Social已经实现了绑定与解绑的逻辑,提供了<code>/connect/providerId</code>服务,根据请求方法的不同,执行不同的业务处理,POST方式进行绑定,DELETE方式进行解绑,与绑定信息的获取同属与同一个类中,<code>providerId</code>代表系统已经配置好的服务提供商的id</p>
<ol>
<li>源码分析</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(&#123;<span class="string">"/connect"</span>&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConnectController</span> <span class="keyword">implements</span> <span class="title">InitializingBean</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping</span>(</span><br><span class="line">        value = &#123;<span class="string">"/&#123;providerId&#125;"</span>&#125;,</span><br><span class="line">        method = &#123;RequestMethod.POST&#125;</span><br><span class="line">    )</span><br><span class="line">    <span class="comment">//跳转到授权</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedirectView <span class="title">connect</span><span class="params">(@PathVariable String providerId, NativeWebRequest request)</span> </span>&#123;</span><br><span class="line">        ConnectionFactory&lt;?&gt; connectionFactory = <span class="keyword">this</span>.connectionFactoryLocator.getConnectionFactory(providerId);</span><br><span class="line">        MultiValueMap&lt;String, String&gt; parameters = <span class="keyword">new</span> LinkedMultiValueMap();</span><br><span class="line">        <span class="keyword">this</span>.preConnect(connectionFactory, parameters, request);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> RedirectView(<span class="keyword">this</span>.connectSupport.buildOAuthUrl(connectionFactory, request, parameters));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var6) &#123;</span><br><span class="line">            <span class="keyword">this</span>.sessionStrategy.setAttribute(request, <span class="string">"social_provider_error"</span>, var6);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.connectionStatusRedirect(providerId, request);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获得授权码,根据授权码获取token,用户信息,最后返回一个Connection</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(</span><br><span class="line">        value = &#123;<span class="string">"/&#123;providerId&#125;"</span>&#125;,</span><br><span class="line">        method = &#123;RequestMethod.GET&#125;,</span><br><span class="line">        params = &#123;<span class="string">"code"</span>&#125;</span><br><span class="line">    )</span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedirectView <span class="title">oauth2Callback</span><span class="params">(@PathVariable String providerId, NativeWebRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            OAuth2ConnectionFactory&lt;?&gt; connectionFactory = (OAuth2ConnectionFactory)<span class="keyword">this</span>.connectionFactoryLocator.getConnectionFactory(providerId);</span><br><span class="line">            Connection&lt;?&gt; connection = <span class="keyword">this</span>.connectSupport.completeConnection(connectionFactory, request);</span><br><span class="line">            <span class="keyword">this</span>.addConnection(connection, connectionFactory, request);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var5) &#123;</span><br><span class="line">            <span class="keyword">this</span>.sessionStrategy.setAttribute(request, <span class="string">"social_provider_error"</span>, var5);</span><br><span class="line">            logger.warn(<span class="string">"Exception while handling OAuth2 callback ("</span> + var5.getMessage() + <span class="string">"). Redirecting to "</span> + providerId + <span class="string">" connection status page."</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.connectionStatusRedirect(providerId, request);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@RequestMapping</span>(</span><br><span class="line">        value = &#123;<span class="string">"/&#123;providerId&#125;"</span>&#125;,</span><br><span class="line">        method = &#123;RequestMethod.DELETE&#125;</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//解绑业务,进行数据库记录的解绑</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedirectView <span class="title">removeConnections</span><span class="params">(@PathVariable String providerId, NativeWebRequest request)</span> </span>&#123;</span><br><span class="line">        ConnectionFactory&lt;?&gt; connectionFactory = <span class="keyword">this</span>.connectionFactoryLocator.getConnectionFactory(providerId);</span><br><span class="line">        <span class="keyword">this</span>.preDisconnect(connectionFactory, request);</span><br><span class="line">        <span class="keyword">this</span>.connectionRepository.removeConnections(providerId);</span><br><span class="line">        <span class="keyword">this</span>.postDisconnect(connectionFactory, request);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.connectionStatusRedirect(providerId, request);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>绑定与解绑返回的视图</strong></p>
<p>从上面列中源码中绑定的两个方法,则是走OAuth协议,与之前的实现QQ,微信登录流程是一样的,绑定成功与解绑成功后会跳转指定的视图</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">connectView</span><span class="params">(String providerId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.getViewPath() + providerId + <span class="string">"Connect"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">connectedView</span><span class="params">(String providerId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.getViewPath() + providerId + <span class="string">"Connected"</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>而且,sping social并未提供该视图,因此需要自定义</p>
<ol>
<li>定义绑定与解绑视图处理器接口</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 抽象的绑定成功与解绑成功信息回显处理器</span></span><br><span class="line"><span class="comment"> * 实现可扩展接口</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan 20180322</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AbstractBindingProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 实现社交绑定与解绑的信息输出</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> model 包含解绑和绑定成功后的一些信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request 请求体</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response 响应体</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">outputModel</span><span class="params">(Map&lt;String, Object&gt; model, HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>定义默认的视图处理器实现类</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 默认的绑定与解绑处理器实现类</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan 20180322</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultBindingProcessor</span> <span class="keyword">implements</span> <span class="title">AbstractBindingProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">outputModel</span><span class="params">(Map&lt;String, Object&gt; model, HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">        response.setContentType(<span class="string">"text/html;charset=UTF-8"</span>);</span><br><span class="line">        <span class="keyword">if</span> (model.get(<span class="string">"connections"</span>) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            response.getWriter().write(<span class="string">"&lt;h3&gt;解绑成功&lt;/h3&gt;"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            response.getWriter().write(<span class="string">"&lt;h3&gt;绑定成功&lt;/h3&gt;"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>定义绑定与解绑视图</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * spring security 处理第三方登陆解绑与绑定返回结果视图</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan on 20180308</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractConnectBindingView</span> <span class="keyword">extends</span> <span class="title">AbstractView</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> AbstractBindingProcessor abstractBindingProcessor;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">AbstractConnectBindingView</span><span class="params">(AbstractBindingProcessor abstractBindingProcessor)</span></span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.abstractBindingProcessor = abstractBindingProcessor;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">renderMergedOutputModel</span><span class="params">(Map&lt;String, Object&gt; model, HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">			HttpServletResponse response)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">		abstractBindingProcessor.outputModel(model,request,response);</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>视图的配置</li>
</ol>
<p><code>QQAutoConfig.java</code>中增加配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span>(&#123;<span class="string">"connect/qqConnect"</span>, <span class="string">"connect/qqConnected"</span>&#125;)</span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean</span>(name = <span class="string">"qqBindingView"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> View <span class="title">qqBindingView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> AbstractConnectBindingView(<span class="keyword">new</span> DefaultBindingProcessor());</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p><code>WeixinAutoConfiguration.java</code>中增加配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span>(&#123;<span class="string">"connect/weixinConnect"</span>, <span class="string">"connect/weixinConnected"</span>&#125;)</span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean</span>(name = <span class="string">"weixinBindingView"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> View <span class="title">weixinBindingView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> AbstractConnectBindingView(<span class="keyword">new</span> DefaultBindingProcessor());</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

      
    </main>
    <footer class="post-footer">
      
    </footer>
  </article>
  
  <article class="index-post card" itemscope itemtype="http://schema.org/Article">
    <div class="post-block">
      <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/12/spring_security/5.SpringSecurityAuthorizationControllerAndIntegrateThymeleaf/">
      <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
        <meta itemprop="name" content="龙门小左">
        <meta itemprop="description" content="">
        <meta itemprop="image" content="/images/avatar.png">
      </span>
      <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
        <meta itemprop="name" content="程序猿的日常">
      </span>
    </div>
    <header class="post-header">
      <h1 class="post-title" itemprop="name headline">
        <a class="post-title-link post-title-link-external" href="/2018/07/12/spring_security/5.SpringSecurityAuthorizationControllerAndIntegrateThymeleaf/" itemprop="url">使用 Maven Module 搭建spring boot项目（整合Spring Security、Spring Social、spring OAuth）五</a>
      </h1>
      <div class="post-meta">
        
        <span class="post-date">
          <i class="far fa-calendar-plus"></i><span><time title="post-date" itemprop="dateCreated datePublished" datetime="2018-07-12T10:00:00+08:00">2018-07-12 10:00:00</time></span>
        </span>
        
        
        
      </div>
    </header>
    <main class="post-main" itemprop="articleBody">
      
      <h1 id="Spring-Security-权限控制及整合Thymeleaf引擎模板"><a href="#Spring-Security-权限控制及整合Thymeleaf引擎模板" class="headerlink" title="Spring Security 权限控制及整合Thymeleaf引擎模板"></a>Spring Security 权限控制及整合Thymeleaf引擎模板</h1><table>
<thead>
<tr>
<th>版本号</th>
<th>作者</th>
<th>日期</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>V0.1</td>
<td>huangz</td>
<td>2018-04-03</td>
<td>初稿</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="Spring-Security-权限控制"><a href="#Spring-Security-权限控制" class="headerlink" title="Spring Security 权限控制"></a>Spring Security 权限控制</h2><h3 id="Spring-Security-对权限的定义"><a href="#Spring-Security-对权限的定义" class="headerlink" title="Spring Security 对权限的定义"></a>Spring Security 对权限的定义</h3><p><img src="images/authorize-01.png" alt=""></p>
<p><img src="images/authorize-02.png" alt=""></p>
<p>对权限的控制，可以通过简单的权限规则、复杂的权限规则进行自定义的配置</p>
<h4 id="简单规则（权限规则基本不变）"><a href="#简单规则（权限规则基本不变）" class="headerlink" title="简单规则（权限规则基本不变）"></a>简单规则（权限规则基本不变）</h4><p><img src="images/authorize-03.png" alt=""></p>
<h4 id="区分是否登陆"><a href="#区分是否登陆" class="headerlink" title="区分是否登陆"></a>区分是否登陆</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">.authorizeRequests()<span class="comment">//对请求做授权</span></span><br><span class="line">.antMatchers(SecurityConstants.DEFAULT_UNAUTHENTICATION_URL,</span><br><span class="line">      SecurityConstants.DEFAULT_LOGIN_PROCESSING_URL_MOBILE,</span><br><span class="line">      securityProperties.getBrowser().getLoginPage(),</span><br><span class="line">      SecurityConstants.DEFAULT_VALIDATE_CODE_URL_PREFIX+<span class="string">"/*"</span>,</span><br><span class="line">      securityProperties.getBrowser().getSignUpUrl(),</span><br><span class="line">      <span class="string">"/user/regist"</span>,</span><br><span class="line">      <span class="string">"/session/invalid"</span>,</span><br><span class="line">      securityProperties.getBrowser().getSignOutUrl()</span><br><span class="line">   ).permitAll() <span class="comment">//不用登陆就可以访问</span></span><br><span class="line">.anyRequest()<span class="comment">//任何请求</span></span><br><span class="line">.authenticated()<span class="comment">//都需要身份验证  //需要登陆才能访问</span></span><br></pre></td></tr></table></figure>
<h4 id="区分简单角色"><a href="#区分简单角色" class="headerlink" title="区分简单角色"></a>区分简单角色</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">.authorizeRequests()<span class="comment">//对请求做授权</span></span><br><span class="line">.antMatchers(SecurityConstants.DEFAULT_UNAUTHENTICATION_URL,</span><br><span class="line">      SecurityConstants.DEFAULT_LOGIN_PROCESSING_URL_MOBILE,</span><br><span class="line">      securityProperties.getBrowser().getLoginPage(),</span><br><span class="line">      SecurityConstants.DEFAULT_VALIDATE_CODE_URL_PREFIX+<span class="string">"/*"</span>,</span><br><span class="line">      securityProperties.getBrowser().getSignUpUrl(),</span><br><span class="line">      <span class="string">"/user/regist"</span>,</span><br><span class="line">      <span class="string">"/session/invalid"</span>,</span><br><span class="line">      securityProperties.getBrowser().getSignOutUrl()</span><br><span class="line">   ).permitAll()</span><br><span class="line">.antMatchers(<span class="string">"/roles/*"</span>).hasRole(<span class="string">"ADMIN"</span>)<span class="comment">//有什么角色才能访问</span></span><br><span class="line">.anyRequest()<span class="comment">//任何请求</span></span><br><span class="line">.authenticated()<span class="comment">//都需要身份验证</span></span><br></pre></td></tr></table></figure>
<h4 id="Spring-Security-中用户的权限设置"><a href="#Spring-Security-中用户的权限设置" class="headerlink" title="Spring Security 中用户的权限设置"></a>Spring Security 中用户的权限设置</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyUserDetailsService</span> <span class="keyword">implements</span> <span class="title">UserDetailsService</span>,<span class="title">SocialUserDetailsService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SocialUserDetails <span class="title">loadUserByUserId</span><span class="params">(String userId)</span> <span class="keyword">throws</span> UsernameNotFoundException </span>&#123;</span><br><span class="line">        String password = passwordEncoder.encode(<span class="string">"123456"</span>);<span class="comment">//此时应该是用户登记密码时的流程</span></span><br><span class="line">        logger.info(<span class="string">"数据库密码是: "</span> + password);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SocialUser(userId,password,</span><br><span class="line">                <span class="keyword">true</span>,<span class="keyword">true</span>,<span class="keyword">true</span>,<span class="keyword">true</span>,</span><br><span class="line">                AuthorityUtils.commaSeparatedStringToAuthorityList(<span class="keyword">super</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在生成<code>UserDetails</code> 和<code>SocialUserDetail</code> 接口实现类时，构造函数中都需要传入权限集合</p>
<p><code>Collection&lt;?extends GrantedAuthority&gt; authorities</code>类型的参数</p>
<p>上面代码中，通过<code>AuthorityUtils</code>工具类将字符串切割成权限集合</p>
<p><strong>在权限配置中，<code>antMatchers(&quot;/roles/*&quot;).hasRole(&quot;ADMIN&quot;),hasRole所对应的角色字符串为：ROLE_ADMIN</code></strong></p>
<p>(下文会解析为什么是有这样的命名规范)</p>
<p>在restful服务中，一个url通常对应不同httpmethod的请求，针对不同请求可以进行权限配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.antMatchers(HttpMethod.GET,<span class="string">"/roles/*"</span>).hasRole(<span class="string">"ADMIN"</span>) <span class="comment">//针对URL的get请求作权限</span></span><br></pre></td></tr></table></figure>
<h3 id="Spring-Security-授权源码分析"><a href="#Spring-Security-授权源码分析" class="headerlink" title="Spring Security 授权源码分析"></a>Spring Security 授权源码分析</h3><h4 id="流程分析"><a href="#流程分析" class="headerlink" title="流程分析"></a>流程分析</h4><p><img src="images/authorize-resource-analysis-01.png" alt=""></p>
<p><code>FilterSecurityInterceptor</code>与<code>ExceptionTranslationFilter</code>是授权相关的类。</p>
<p><code>FilterSecurityInterceptor</code>根据未能授权原因抛出异常给<code>ExceptionTranslationFilter</code>处理。 </p>
<p><code>AnonymousAuthenticationFilter</code>：（匿名认证过滤器）处于所有验证过滤器链中的最后一个</p>
<h4 id="授权分析"><a href="#授权分析" class="headerlink" title="授权分析"></a>授权分析</h4><p><img src="images/authorize-analysis-02.png" alt=""></p>
<p><code>AccessDecisionManager</code>(访问决定管理者)管理着一组Voter</p>
<p><code>AccessDecisionVoter</code>(投票者)。</p>
<p>投票逻辑：</p>
<ol>
<li><code>AffirmativeBased</code>(所有投票者中有一个过则通过，是spring 的默认实现)</li>
<li><code>ConsensusBased</code>(否定票与赞成票，多者胜出)</li>
<li><code>UnanimousBased</code>(只要有一个投票者不过则不过)</li>
</ol>
<p>SecurityConfig：配置信息</p>
<p>Authentication：验证信息，含用户权限信息</p>
<h4 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h4><p>1) <code>AnonymousAuthenticationFilter.java</code> 匿名认证过滤器，当其他认证都不通过，最后尝试此过滤器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnonymousAuthenticationFilter</span></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest req, ServletResponse res, FilterChain chain)</span></span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">   <span class="comment">//判断在前面的认证过程中是否已经创建了Authentication</span></span><br><span class="line">   <span class="keyword">if</span> (SecurityContextHolder.getContext().getAuthentication() == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">//创建出一个匿名Authentication</span></span><br><span class="line">SecurityContextHolder.getContext().setAuthentication(</span><br><span class="line">            createAuthentication((HttpServletRequest) req));</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">         logger.debug(<span class="string">"SecurityContextHolder not populated with anonymous token, as it already contained: '"</span></span><br><span class="line">               + SecurityContextHolder.getContext().getAuthentication() + <span class="string">"'"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   chain.doFilter(req, res);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Authentication <span class="title">createAuthentication</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">   AnonymousAuthenticationToken auth = <span class="keyword">new</span> AnonymousAuthenticationToken(key,</span><br><span class="line">         principal, authorities);</span><br><span class="line">   auth.setDetails(authenticationDetailsSource.buildDetails(request));</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> auth;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">AnonymousAuthenticationFilter</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">this</span>(key, <span class="string">"anonymousUser"</span>, AuthorityUtils.createAuthorityList(<span class="string">"ROLE_ANONYMOUS"</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2) <code>FilterSecurityInterceptor.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FilterSecurityInterceptor</span> <span class="keyword">extends</span> <span class="title">AbstractSecurityInterceptor</span> <span class="keyword">implements</span></span></span><br><span class="line"><span class="class">      <span class="title">Filter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> FilterInvocationSecurityMetadataSource securityMetadataSource;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">boolean</span> observeOncePerRequest = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response,</span></span></span><br><span class="line"><span class="function"><span class="params">         FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">      FilterInvocation fi = <span class="keyword">new</span> FilterInvocation(request, response, chain);</span><br><span class="line">      invoke(fi);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(FilterInvocation fi)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> ((fi.getRequest() != <span class="keyword">null</span>)</span><br><span class="line">            &amp;&amp; (fi.getRequest().getAttribute(FILTER_APPLIED) != <span class="keyword">null</span>)</span><br><span class="line">            &amp;&amp; observeOncePerRequest) &#123;</span><br><span class="line">         <span class="comment">// filter already applied to this request and user wants us to observe</span></span><br><span class="line">         <span class="comment">// once-per-request handling, so don't re-do security checking</span></span><br><span class="line">         fi.getChain().doFilter(fi.getRequest(), fi.getResponse());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="comment">// first time this request being called, so perform security checking</span></span><br><span class="line">         <span class="keyword">if</span> (fi.getRequest() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            fi.getRequest().setAttribute(FILTER_APPLIED, Boolean.TRUE);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="comment">//权限认证在这里面完成，如果这里抛出异常会给ExceptionTranslationFilter处理</span></span><br><span class="line">         InterceptorStatusToken token = <span class="keyword">super</span>.beforeInvocation(fi);</span><br><span class="line"></span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//服务器中的服务</span></span><br><span class="line">            fi.getChain().doFilter(fi.getRequest(), fi.getResponse());</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">super</span>.finallyInvocation(token);</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="keyword">super</span>.afterInvocation(token, <span class="keyword">null</span>);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3) <code>AbstractSecurityInterceptor.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractSecurityInterceptor</span></span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">protected</span> InterceptorStatusToken <span class="title">beforeInvocation</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">   Assert.notNull(object, <span class="string">"Object was null"</span>);</span><br><span class="line">   <span class="keyword">final</span> <span class="keyword">boolean</span> debug = logger.isDebugEnabled();</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (!getSecureObjectClass().isAssignableFrom(object.getClass())) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">            <span class="string">"Security invocation attempted for object "</span></span><br><span class="line">                  + object.getClass().getName()</span><br><span class="line">                  + <span class="string">" but AbstractSecurityInterceptor only configured to support secure objects of type: "</span></span><br><span class="line">                  + getSecureObjectClass());</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//从配置信息中获取信息，需要的权限，封装成ConfigAttribute</span></span><br><span class="line">   Collection&lt;ConfigAttribute&gt; attributes = <span class="keyword">this</span>.obtainSecurityMetadataSource()</span><br><span class="line">         .getAttributes(object);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (attributes == <span class="keyword">null</span> || attributes.isEmpty()) &#123;</span><br><span class="line">      <span class="keyword">if</span> (rejectPublicInvocations) &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">               <span class="string">"Secure object invocation "</span></span><br><span class="line">                     + object</span><br><span class="line">                     + <span class="string">" was denied as public invocations are not allowed via this interceptor. "</span></span><br><span class="line">                     + <span class="string">"This indicates a configuration error because the "</span></span><br><span class="line">                     + <span class="string">"rejectPublicInvocations property is set to 'true'"</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (debug) &#123;</span><br><span class="line">         logger.debug(<span class="string">"Public object - authentication not attempted"</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      publishEvent(<span class="keyword">new</span> PublicInvocationEvent(object));</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>; <span class="comment">// no further work post-invocation</span></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (debug) &#123;</span><br><span class="line">      logger.debug(<span class="string">"Secure object: "</span> + object + <span class="string">"; Attributes: "</span> + attributes);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (SecurityContextHolder.getContext().getAuthentication() == <span class="keyword">null</span>) &#123;</span><br><span class="line">      credentialsNotFound(messages.getMessage(</span><br><span class="line">            <span class="string">"AbstractSecurityInterceptor.authenticationNotFound"</span>,</span><br><span class="line">            <span class="string">"An Authentication object was not found in the SecurityContext"</span>),</span><br><span class="line">            object, attributes);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//获取当前的Authentication</span></span><br><span class="line">   Authentication authenticated = authenticateIfRequired();</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Attempt authorization</span></span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//获得Authentication、当前请求信息和ConfigAttribute后，进行投票</span></span><br><span class="line">      <span class="keyword">this</span>.accessDecisionManager.decide(authenticated, object, attributes);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (AccessDeniedException accessDeniedException) &#123;</span><br><span class="line">      publishEvent(<span class="keyword">new</span> AuthorizationFailureEvent(object, attributes, authenticated,</span><br><span class="line">            accessDeniedException));</span><br><span class="line"></span><br><span class="line">      <span class="keyword">throw</span> accessDeniedException;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (debug) &#123;</span><br><span class="line">      logger.debug(<span class="string">"Authorization successful"</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (publishAuthorizationSuccess) &#123;</span><br><span class="line">      publishEvent(<span class="keyword">new</span> AuthorizedEvent(object, attributes, authenticated));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Attempt to run as a different user</span></span><br><span class="line">   Authentication runAs = <span class="keyword">this</span>.runAsManager.buildRunAs(authenticated, object,</span><br><span class="line">         attributes);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (runAs == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (debug) &#123;</span><br><span class="line">         logger.debug(<span class="string">"RunAsManager did not change Authentication object"</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// no further work post-invocation</span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> InterceptorStatusToken(SecurityContextHolder.getContext(), <span class="keyword">false</span>,</span><br><span class="line">            attributes, object);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (debug) &#123;</span><br><span class="line">         logger.debug(<span class="string">"Switching to RunAs Authentication: "</span> + runAs);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      SecurityContext origCtx = SecurityContextHolder.getContext();</span><br><span class="line">      SecurityContextHolder.setContext(SecurityContextHolder.createEmptyContext());</span><br><span class="line">      SecurityContextHolder.getContext().setAuthentication(runAs);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// need to revert to token.Authenticated post-invocation</span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> InterceptorStatusToken(origCtx, <span class="keyword">true</span>, attributes, object);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>4) <code>AffirmativeBased.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AffirmativeBased</span> <span class="keyword">extends</span> <span class="title">AbstractAccessDecisionManager</span> </span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">decide</span><span class="params">(Authentication authentication, Object object,</span></span></span><br><span class="line"><span class="function"><span class="params">      Collection&lt;ConfigAttribute&gt; configAttributes)</span> <span class="keyword">throws</span> AccessDeniedException </span>&#123;</span><br><span class="line">   <span class="keyword">int</span> deny = <span class="number">0</span>;</span><br><span class="line">   <span class="comment">//所有的投票者投票</span></span><br><span class="line">   <span class="keyword">for</span> (AccessDecisionVoter voter : getDecisionVoters()) &#123;</span><br><span class="line"><span class="comment">//投票后返回投票结果</span></span><br><span class="line">      <span class="keyword">int</span> result = voter.vote(authentication, object, configAttributes);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">         logger.debug(<span class="string">"Voter: "</span> + voter + <span class="string">", returned: "</span> + result);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">switch</span> (result) &#123;</span><br><span class="line"><span class="comment">//有一个投票者则通过</span></span><br><span class="line">      <span class="keyword">case</span> AccessDecisionVoter.ACCESS_GRANTED:</span><br><span class="line">         <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> AccessDecisionVoter.ACCESS_DENIED:</span><br><span class="line">         deny++;</span><br><span class="line"></span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (deny &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> AccessDeniedException(messages.getMessage(</span><br><span class="line">            <span class="string">"AbstractAccessDecisionManager.accessDenied"</span>, <span class="string">"Access is denied"</span>));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// To get this far, every AccessDecisionVoter abstained</span></span><br><span class="line">   checkAllowIfAllAbstainDecisions();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="分析hasRole角色配置"><a href="#分析hasRole角色配置" class="headerlink" title="分析hasRole角色配置"></a>分析hasRole角色配置</h4><p>前面配置提到 :</p>
<p><code>antMatchers(&quot;/roles/*&quot;).hasRole(&quot;ADMIN&quot;),hasRole所对应的角色字符串为：ROLE_ADMIN</code></p>
<p><code>ExpressionUrlAuthorizationConfigurer.java</code>源码跟踪</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ExpressionUrlAuthorizationConfigurer</span></span>&#123;</span><br><span class="line"><span class="keyword">public</span> ExpressionUrlAuthorizationConfigurer&lt;H&gt;.<span class="function">ExpressionInterceptUrlRegistry <span class="title">hasRole</span><span class="params">(String role)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.access(ExpressionUrlAuthorizationConfigurer.hasRole(role));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">hasRole</span><span class="params">(String role)</span> </span>&#123;</span><br><span class="line">    Assert.notNull(role, <span class="string">"role cannot be null"</span>);</span><br><span class="line">    <span class="keyword">if</span>(role.startsWith(<span class="string">"ROLE_"</span>)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"role should not start with 'ROLE_' since it is automatically inserted. Got '"</span> + role + <span class="string">"'"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">//最终返回sping security 需要判断的一个完整的表达式</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"hasRole('ROLE_"</span> + role + <span class="string">"')"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因此在<code>hasRole</code>中只需要配置角色名称<code>ADMIN</code>，而配置用户角色权限的时候，需要配置<code>ROLE_ADMIN</code></p>
<h3 id="Spring-Security-权限表达式"><a href="#Spring-Security-权限表达式" class="headerlink" title="Spring Security 权限表达式"></a>Spring Security 权限表达式</h3><p><img src="images/authorize-express-01.png" alt=""></p>
<p>在spring security中，每个权限表达式都对应一个方法，这个方法跟在<code>antMatchers(&quot;/roles/*&quot;)</code>，</p>
<p>不支持<code>.antMatchers(&quot;/roles/*&quot;).hasRole(&quot;ADMIN&quot;)</code>多个并列调用。</p>
<p>但是可以使用另外一个提供的方法处理并列逻辑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">antMatchers(<span class="string">"/roles/*"</span>)</span><br><span class="line">.access(<span class="string">"hasRole('ADMIN') and hasIpAddress('192.168.1.235')"</span>)</span><br></pre></td></tr></table></figure>
<h3 id="复杂规则权限开发"><a href="#复杂规则权限开发" class="headerlink" title="复杂规则权限开发"></a>复杂规则权限开发</h3><h4 id="RBAC模型"><a href="#RBAC模型" class="headerlink" title="RBAC模型"></a>RBAC模型</h4><p><img src="images/rbac.png" alt=""></p>
<h4 id="开发自定义的权限模块"><a href="#开发自定义的权限模块" class="headerlink" title="开发自定义的权限模块"></a>开发自定义的权限模块</h4><p>新建一个子模块项目，命名为<code>chu-authorize</code></p>
<p><code>pom.xml</code> 文件定义</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>vic-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>vic.tjs.security<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>chu-authorize<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.servlet-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.security<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-security-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>RbacService</code> 定义</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.Authentication;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * RBAC接口</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RbacService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 权限认证</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> request 请求</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> authentication 认证信息</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">boolean</span> <span class="title">hasPermission</span><span class="params">(HttpServletRequest request, Authentication authentication)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> vic.tjs.authorize.rbac; </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * RBAC接口实现类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span>(<span class="string">"rbacService"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RbacServiceImpl</span> <span class="keyword">implements</span> <span class="title">RbacService</span> </span>&#123;</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">private</span> AntPathMatcher antPathMatcher = <span class="keyword">new</span> AntPathMatcher();</span><br><span class="line"></span><br><span class="line">   <span class="comment">//实现处理逻辑</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasPermission</span><span class="params">(HttpServletRequest request, Authentication authentication)</span> </span>&#123;</span><br><span class="line">      Object principal = authentication.getPrincipal();</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">boolean</span> hasPermission = <span class="keyword">false</span>;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span> (principal <span class="keyword">instanceof</span> UserDetails) &#123;</span><br><span class="line">         </span><br><span class="line">         String username = ((UserDetails)principal).getUsername();</span><br><span class="line">         <span class="comment">//读取模拟用户所拥有权限的所有URL</span></span><br><span class="line">         Set&lt;String&gt; urls = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">         <span class="keyword">for</span> (String url : urls) &#123;</span><br><span class="line">            <span class="keyword">if</span>(antPathMatcher.match(url, request.getRequestURI()))&#123;</span><br><span class="line">               hasPermission = <span class="keyword">true</span>;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         </span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> hasPermission;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="使用自定义认证"><a href="#使用自定义认证" class="headerlink" title="使用自定义认证"></a>使用自定义认证</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">config.anyRequest().access(<span class="string">"@rbacService.hasPermission(request,authentication)"</span>);</span><br></pre></td></tr></table></figure>
<h2 id="Spring-Security-整合-Thymeleaf-引擎模板"><a href="#Spring-Security-整合-Thymeleaf-引擎模板" class="headerlink" title="Spring Security 整合 Thymeleaf 引擎模板"></a>Spring Security 整合 Thymeleaf 引擎模板</h2><blockquote>
<p>参考<a href="https://www.thymeleaf.org/doc/articles/springsecurity.html" target="_blank" rel="noopener">Thymeleaf官方整合Security文档</a></p>
</blockquote>
<h3 id="目的："><a href="#目的：" class="headerlink" title="目的："></a>目的：</h3><p>更方便的在thymeleaf中使用security安全表达式</p>
<h3 id="jar包"><a href="#jar包" class="headerlink" title="jar包"></a>jar包</h3><p>引用 Spring security 和 Thymeleaf 整合包</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.thymeleaf.extras<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>thymeleaf-extras-springsecurity4<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="引入测试权限"><a href="#引入测试权限" class="headerlink" title="引入测试权限"></a>引入测试权限</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">config.antMatchers(<span class="string">"/thymeleaf/admins/**"</span>).hasAnyRole(<span class="string">"ADMIN"</span>)</span><br><span class="line">				.antMatchers(<span class="string">"/thymeleaf/users/**"</span>).hasAnyRole(<span class="string">"USER"</span>)</span><br></pre></td></tr></table></figure>
<h3 id="页面引用"><a href="#页面引用" class="headerlink" title="页面引用"></a>页面引用</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/1999/xhtml"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">xmlns:th</span>=<span class="string">"http://www.thymeleaf.org"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">xmlns:sec</span>=<span class="string">"http://www.thymeleaf.org/thymeleaf-extras-springsecurity4"</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">span</span> <span class="attr">sec:authorize</span>=<span class="string">"isAuthenticated()"</span>&gt;</span></span><br><span class="line">                | Logged user: <span class="tag">&lt;<span class="name">span</span> <span class="attr">sec:authentication</span>=<span class="string">"name"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span> |</span><br><span class="line">                Roles: <span class="tag">&lt;<span class="name">span</span> <span class="attr">sec:authentication</span>=<span class="string">"principal.authorities"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span> |</span><br><span class="line">                <span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">"@&#123;/logout&#125;"</span>&gt;</span>登出<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>标签解释</strong><br><code>sec:authorize</code> : 基于表达式的计算结果，条件性的渲染内容，接受spring security 权限表达式（本文上部分已列出常用的表达式），若权限认证成功，则标签执行（理解为：显示），否则不执行（理解为：不显示）</p>
<p><code>sec:authentication</code> :渲染认证对象的属性， 获取Authentication对象中的信息，并执行输出</p>
<p>备注： 待时间充足，将更深入的了解整合的其他功能</p>

      
    </main>
    <footer class="post-footer">
      
    </footer>
  </article>
  
  <article class="index-post card" itemscope itemtype="http://schema.org/Article">
    <div class="post-block">
      <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/12/spring_security/1.SpringSecurityRESTful/">
      <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
        <meta itemprop="name" content="龙门小左">
        <meta itemprop="description" content="">
        <meta itemprop="image" content="/images/avatar.png">
      </span>
      <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
        <meta itemprop="name" content="程序猿的日常">
      </span>
    </div>
    <header class="post-header">
      <h1 class="post-title" itemprop="name headline">
        <a class="post-title-link post-title-link-external" href="/2018/07/12/spring_security/1.SpringSecurityRESTful/" itemprop="url">使用 Maven Module 搭建spring boot项目（整合Spring Security、Spring Social、spring OAuth）一</a>
      </h1>
      <div class="post-meta">
        
        <span class="post-date">
          <i class="far fa-calendar-plus"></i><span><time title="post-date" itemprop="dateCreated datePublished" datetime="2018-07-12T10:00:00+08:00">2018-07-12 10:00:00</time></span>
        </span>
        
        
        
      </div>
    </header>
    <main class="post-main" itemprop="articleBody">
      
      <h1 id="使用-Maven-Module-搭建spring-boot项目（整合Spring-Security、Spring-Social、spring-OAuth）一"><a href="#使用-Maven-Module-搭建spring-boot项目（整合Spring-Security、Spring-Social、spring-OAuth）一" class="headerlink" title="使用 Maven Module 搭建spring boot项目（整合Spring Security、Spring Social、spring OAuth）一"></a>使用 Maven Module 搭建spring boot项目（整合Spring Security、Spring Social、spring OAuth）一</h1><table>
<thead>
<tr>
<th>版本号</th>
<th>作者</th>
<th>日期</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>V0.1</td>
<td>huangz</td>
<td>2018-04-03</td>
<td>初稿</td>
</tr>
<tr>
<td>V0.2</td>
<td>huangz</td>
<td>2018-04-18</td>
<td>引入lombok</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><h3 id="项目环境、组件及目标"><a href="#项目环境、组件及目标" class="headerlink" title="项目环境、组件及目标"></a>项目环境、组件及目标</h3><ol>
<li><p>开发环境</p>
<p>Jdk1.8、Idea、Mysql、maven module</p>
</li>
<li><p>使用框架组件</p>
<p>spring boot 、spring security、spring social、spring oauth</p>
</li>
<li><p>搭建项目目标</p>
<p>深入理解spring security原理、功能及代码</p>
<p>基于spring security及相关框架独立开发认证授权相关功能</p>
<p>掌握抽象和封装的常见技巧，可以编写可重用的模块供他人使用</p>
<p>​</p>
</li>
</ol>
<h3 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h3><h4 id="Spring-Security"><a href="#Spring-Security" class="headerlink" title="Spring Security"></a>Spring Security</h4><p>​    Spring Security是一个能够为基于Spring的企业应用系统提供声明式的安全访问控制解决方案的安全框架。它提供了一组可以在Spring应用上下文中配置的Bean，充分利用了Spring IoC，DI（控制反转Inversion of Control ,DI:Dependency Injection 依赖注入）和AOP（面向切面编程）功能，为应用系统提供声明式的安全访问控制功能，减少了为企业系统安全控制编写大量重复代码的工作。</p>
<h4 id="Spring-IO-platform"><a href="#Spring-IO-platform" class="headerlink" title="Spring IO platform"></a>Spring IO platform</h4><p>​    Spring IO是构建现代应用程序的一个有凝聚力的版本化平台。这是一个模块化的企业级分布，提供了一组策略依赖关系，同时让开发人员完全控制只部署他们所需的部分。</p>
<p>   <strong>主要解决问题：</strong></p>
<p>​    在使用Spring的时候，经常会使用到第三方库，一般大家都是根据经验挑选一个版本号或挑选最新的，随意性较大，其实这是有问题的，除非做过完整的测试，保证集成该版本的依赖不会出现问题，且后续集成其它第三方库的时候也不会出现问题，否则风险较大，且后续扩展会越来越困难，因为随着业务复杂度的增加，集成的第三方组件会越来会多，依赖之间的关联也会也来越复杂。</p>
<p>   <strong>优点：</strong><br>       Spring IO平台提供了各种Spring项目及其依赖项的版本。通过指定的配置添加到您的构建脚本中，您就可以声明您的依赖关系，而无需担心版本号，保证最大限度的扩展，而且该版本的依赖是经过测试的，可以完美的与其它组件结合使用。</p>
<h3 id="项目架构"><a href="#项目架构" class="headerlink" title="项目架构"></a>项目架构</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">airports</span><br><span class="line">    | - - airport-core   &lt; - - | </span><br><span class="line">            | - - pom.xml      |</span><br><span class="line">    | - - airport-browser  - - |(依赖)   &lt;-| </span><br><span class="line">            | - - pom.xml      |           |</span><br><span class="line">    | - - airport-app      - - |         &lt;-|</span><br><span class="line">            | - - pom.xml                  |(选择性依赖) </span><br><span class="line">    | - - traffic-forecast   - - - - - - - |</span><br><span class="line">            | - - pom.xml</span><br><span class="line">    | - - pom.xml</span><br></pre></td></tr></table></figure>
<p><strong>airports:</strong> 项目父模块，只负责管理其下的子项目，只有一个pom文件，并且pom文件中打包方式为</p>
<p><code>&lt;packaging&gt;pom&lt;/packaging&gt;</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">modules</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>airportsCore<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>airportsBrowser<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>airportsApp<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>trafficForecast<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">modules</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">com.chuIllusion.version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">com.chuIllusion.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.reporting.outputEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.spring.platform<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>platform-bom<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>Brussels-SR4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>Dalston.SR2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">source</span>&gt;</span>$&#123;java.version&#125;<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">target</span>&gt;</span>$&#123;java.version&#125;<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">encoding</span>&gt;</span>$&#123;project.build.sourceEncoding&#125;<span class="tag">&lt;/<span class="name">encoding</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>airport-core:</strong> 核心业务逻辑，提供核心通用功能</p>
<p><code>pom.xml</code></p>
<p>引入核心包，包括jdbc、aop及一些基本工具类，并且引入核心组件：spring security、spring oauth、spring social</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-lang<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-beanutils<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-beanutils<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- spring security/social/oauth --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 引用spring security、spring oauth核心 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-oauth2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- spring social --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 提供Java 配置 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.social<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-social-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 提供社交连接框架和OAuth 客户端支持 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.social<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-social-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 提供社交安全支持 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.social<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-social-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 管理web应用程序的连接 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.social<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-social-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>airport-browser:</strong> 浏览器相关业务，依赖核心项目，拓展浏览器项目特有的功能</p>
<p><code>pom.xml</code></p>
<p>引入核心模块的支持，并拓展浏览器特有的支持，如session</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.chuIllusion<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>airports.core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;com.chuIllusion.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.session<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-session<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- ============================== Thymeleaf模板引擎 ================================= --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>airport-app:</strong> App或前后端分离项目中相关业务，依赖核心项目，拓展了前后端分离项目的功能</p>
<p><code>pom.xml</code></p>
<p>引入核心模块的支持，并拓展App或前后端分离项目特有的支持，如使用redis代替session存储</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.turingdi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>airports.core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>traffic-forecast:</strong>  项目程序，根据项目情况，选择性依赖浏览器模块或App模块</p>
<p><code>pom.xml</code></p>
<p>根据需求，引用浏览器核心支持或App核心支持,并且引用编译插件的支持</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--&lt;dependency&gt;--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--&lt;groupId&gt;com.chuIllusion&lt;/groupId&gt;--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--&lt;artifactId&gt;airports.browser&lt;/artifactId&gt;--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--&lt;version&gt;$&#123;com.turingdi.version&#125;&lt;/version&gt;--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--&lt;/dependency&gt;--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.chuIllusion<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>airports.app<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;com.chuIllusion.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 引入测试框架 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.3.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                        <span class="comment">&lt;!-- 重新打包现有的JAR和WAR存档，以便可以使用java -jar从命令行执行它们。 --&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>repackage<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>trafficForecast<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>注意</strong></p>
<ol>
<li><p>spring boot 包扫描机制</p>
<p>​    在项目程序启动前，一定要保证spring boot 启动类一定是在所有依赖项目中父级包，启动类扫描同级包和下级包的所有类才能生效，否则如果其他项目中有使用配置的类（相对于启动类是在启动类的上一级）则无法生效，建议将使用同一命名，以下是我这几个项目包的结构，每个模块中的代码都对应在其标准包下</p>
<p>​    在核心包中：com.chuillusion.core，在浏览器包中：com.chuillusion.browser，在App包中：com.chuillusion.app，在项目程序中：com.chuIllusion.trafiicforecast，启动类在<em>com.chuIllusion</em>包中创建</p>
</li>
<li><p>依赖配置</p>
<p>​    在项目中引入jdbc的依赖需要配置数据源、session的依赖需要配置session类型，否则系统启动会报错，根据系统报错信息，查找原因，排查原因，则很快可以解决问题</p>
</li>
<li><p>启动类</p>
<p>maven 默认 编译成jar包，使用java -jar运行命令即可将项目运行</p>
<p>但是在项目中我们需要war包，则要继承<code>SpringBootServletInitializer</code>并且实现其<code>config</code>方法，否则会报错误（无法找到入口）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TrafficForecastEntryApplication</span> <span class="keyword">extends</span> <span class="title">SpringBootServletInitializer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TrafficForecastEntryApplication</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> SpringApplicationBuilder <span class="title">configure</span><span class="params">(SpringApplicationBuilder application)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> application.sources(<span class="keyword">new</span> Class[]&#123;TrafficForecastEntryApplication.class&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(TrafficForecastEntryApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="RESTFUL-API"><a href="#RESTFUL-API" class="headerlink" title="RESTFUL API"></a>RESTFUL API</h2><h3 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h3><p>​    <strong>Representational State Transfer</strong>，简称<strong>REST</strong>，一种软件架构风格、设计风格，而不是标准，只是提供了一组设计原则和约束条件。它主要用于客户端和服务器交互类的软件。基于这个风格设计的软件可以更简洁，更有层次，更易于实现缓存等机制。</p>
<p><strong>特点：</strong></p>
<ol>
<li><p>用URL描述资源</p>
</li>
<li><p>使用HTTP方法描述行为，使用HTTP状态码表示不同的结果</p>
<p>HTTP METHOD：GET(从服务器取出资源（一项或多项）)、POST(在服务器新建一个资源)、PUT(在服务器更新资源)、DELETE(从服务器删除资源)</p>
<p>HTTP STATUS CODE：200（请求成功）、401（未授权）、404（未找到资源）、500（服务器内部错误）</p>
</li>
<li><p>使用JSON交互数据</p>
</li>
<li><p>RESTful只是一种风格，并不是强制的标准</p>
</li>
</ol>
<p><strong>例子：</strong></p>
<table>
<thead>
<tr>
<th>URL</th>
<th>METHOD</th>
<th>DESRCIBE</th>
</tr>
</thead>
<tbody>
<tr>
<td>/product</td>
<td>GET</td>
<td>列出所有商品</td>
</tr>
<tr>
<td>/product?limit=10</td>
<td>GET</td>
<td>返回指定数量的商品</td>
</tr>
<tr>
<td>/product?limit=10&amp;type=1</td>
<td>GET</td>
<td>返回指定类型和数量的商品</td>
</tr>
<tr>
<td>/product/id</td>
<td>GET</td>
<td>获取指定的商品</td>
</tr>
<tr>
<td>/product/id/image</td>
<td>GET</td>
<td>获取指定商品的所有图片</td>
</tr>
<tr>
<td>/product/id/image/id</td>
<td>GET</td>
<td>获取指定商品的指定图片</td>
</tr>
<tr>
<td>/product</td>
<td>POST</td>
<td>新建商品</td>
</tr>
<tr>
<td>/product/id</td>
<td>PUT</td>
<td>更新指定的商品信息</td>
</tr>
<tr>
<td>/prodect/id</td>
<td>DELETE</td>
<td>删除指定的商品</td>
</tr>
</tbody>
</table>
<p><strong>成熟度模型</strong></p>
<p><img src="images/restfulmaturitymodel.png" alt=""></p>
<h3 id="Spring-Boot-中-RESTful-API-开发"><a href="#Spring-Boot-中-RESTful-API-开发" class="headerlink" title="Spring Boot 中 RESTful API 开发"></a>Spring Boot 中 RESTful API 开发</h3><p>​    spring boot 对 RESTful API 提供了多个开发注解，在以下将会慢慢介绍</p>
<ol>
<li><p>@RestController : 标明此controller提供RESTful API</p>
<p>@RestController注解相当于@ResponseBody ＋ @Controller合在一起的作用。</p>
</li>
<li><p>@RequestMapping及其变体。映射HTTP请求URL到JAVA方法上</p>
</li>
<li><p>@RequestParam 映射请求参数到JAVA方法的参数</p>
</li>
</ol>
<h4 id="测试框架引入"><a href="#测试框架引入" class="headerlink" title="测试框架引入"></a>测试框架引入</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="测试用例创建"><a href="#测试用例创建" class="headerlink" title="测试用例创建"></a>测试用例创建</h4><p>建立测试用例的目的，是为了确保我们的服务能按照我们指定的方式去运行，并且获取预期的效果</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//如何运行测试用例</span></span><br><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</span><br><span class="line"><span class="comment">//标记此类为测试类</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserControllerTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">//web环境 启动的时候spring 已经创建了，直接注入就好了</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> WebApplicationContext webApplicationContext;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//伪造一个mvc的环境</span></span><br><span class="line">    <span class="keyword">private</span> MockMvc mockMvc;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mockMvc = MockMvcBuilders.webAppContextSetup(webApplicationContext).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//查询用例</span></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">whenQuerySuccess</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="comment">//模拟请求</span></span><br><span class="line">        mockMvc.perform(</span><br><span class="line">                MockMvcRequestBuilders.get(<span class="string">"/user"</span>)<span class="comment">//模拟发出get请求</span></span><br><span class="line">                .contentType(MediaType.APPLICATION_JSON_UTF8))<span class="comment">//设置请求的contentType</span></span><br><span class="line">                .andExpect(MockMvcResultMatchers.status().isOk())<span class="comment">//执行之后，期望的返回结果是返回状态码是200</span></span><br><span class="line">                <span class="comment">//返回一个集合，包含三个元素，jsonPath解析返回的内容，并对json进行判断 $.length()集合的长度</span></span><br><span class="line">                .andExpect(MockMvcResultMatchers.jsonPath(<span class="string">"$.length()"</span>).value(<span class="number">3</span>));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>启动测试用例</strong></p>
<p>Error：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Error:java.lang.IllegalStateException: Unable to find a @SpringBootConfiguration, you need to use @ContextConfiguration or @SpringBootTest(classes=...) with your test</span><br></pre></td></tr></table></figure>
<p>Cause：测试用例位置必须在Spring boot 启动类同名子包下，才能扫描打</p>
<p>Solve：</p>
<ol>
<li><p>更为测试类位置为Spring boot 启动类同名子包下</p>
</li>
<li><p>添加指定启动类位置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Error：</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>java.lang.AssertionError: Status<br>Expected :200<br>Actual  :404<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Cause and Solve：未建立对应的服务，应建立相应的服务</span><br><span class="line"></span><br><span class="line">**服务的创建**</span><br><span class="line"></span><br><span class="line">```java</span><br><span class="line">@RestController</span><br><span class="line">public class UserController &#123;</span><br><span class="line">    @RequestMapping(value = &quot;/user&quot;,method = RequestMethod.GET)</span><br><span class="line">    public List&lt;User&gt; query()&#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Error：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Description</span><br><span class="line">java.lang.AssertionError: No value at JSON path &quot;$.length()&quot;, exception: json can not be null or empty</span><br></pre></td></tr></table></figure>
<p>Cause：服务中的返回值为null，而测试对返回值的期待是返回数据的长度为3</p>
<p>Solve：使服务中返回指定的数据长度</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/user"</span>,method = RequestMethod.GET)</span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">query</span><span class="params">()</span></span>&#123;</span><br><span class="line">    List&lt;User&gt; users = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    users.add(<span class="keyword">new</span> User());</span><br><span class="line">    users.add(<span class="keyword">new</span> User());</span><br><span class="line">    users.add(<span class="keyword">new</span> User());</span><br><span class="line">    <span class="keyword">return</span> users;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="RequestParam注解的使用"><a href="#RequestParam注解的使用" class="headerlink" title="@RequestParam注解的使用"></a><code>@RequestParam</code>注解的使用</h5><p>在测试用例上添加参数传递</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mockMvc.perform(</span><br><span class="line">        MockMvcRequestBuilders.get(<span class="string">"/user"</span>)<span class="comment">//模拟发出get请求</span></span><br><span class="line">        .contentType(MediaType.APPLICATION_JSON_UTF8)<span class="comment">//设置请求的contentType</span></span><br><span class="line">        .param(<span class="string">"username"</span>,<span class="string">"victorys"</span>))<span class="comment">//设置参数</span></span><br></pre></td></tr></table></figure>
<p>在服务中接受参数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">query</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        @RequestParam(name=<span class="string">"username"</span>,//请求中属性名</span></span></span><br><span class="line"><span class="function"><span class="params">	required = <span class="keyword">true</span>,//属性必须，否则报错</span></span></span><br><span class="line"><span class="function"><span class="params">	defaultValue = <span class="string">"jojo"</span>)</span> <span class="comment">//没有则设置默认值</span></span></span><br><span class="line"><span class="function">                String username)</span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<h4 id="查询用例"><a href="#查询用例" class="headerlink" title="查询用例"></a>查询用例</h4><p><strong>掌握</strong></p>
<ol>
<li><p>@PathVariable 映射URL片段到java方法的参数</p>
</li>
<li><p>在url声明中使用正则表达式</p>
</li>
<li><p>@JsonView控制json输出内容</p>
<p>jsonview使用步骤：1）使用接口声明视图；2）在值对象的get方法上指定视图；3）在controller方法上指定视图</p>
</li>
</ol>
<h5 id="UserControllerTest-java"><a href="#UserControllerTest-java" class="headerlink" title="UserControllerTest.java"></a>UserControllerTest.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 使用RESTful API 查询用户详情</span></span><br><span class="line"><span class="comment"> * /user/1 代表资源</span></span><br><span class="line"><span class="comment"> * get请求代表操作</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">whenGetInfoSuccess</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    String result = mockMvc.perform(MockMvcRequestBuilders.get(<span class="string">"/user/1"</span>)<span class="comment">//获取用户为1的信息</span></span><br><span class="line">            .contentType(MediaType.APPLICATION_JSON_UTF8))</span><br><span class="line">            .andExpect(MockMvcResultMatchers.status().isOk())<span class="comment">//用状态码判断是成功还是失败，成功就是200</span></span><br><span class="line">            .andExpect(MockMvcResultMatchers.jsonPath(<span class="string">"$.username"</span>).value(<span class="string">"tom"</span>))<span class="comment">//期望值</span></span><br><span class="line">            .andReturn().getResponse().getContentAsString();<span class="comment">//获得返回结果，并以字符串形式输出</span></span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br><span class="line">**</span><br><span class="line"> * 测试使用正则表达式接受资源的服务</span><br><span class="line"> * <span class="meta">@throws</span> Exception</span><br><span class="line"> */</span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">whenGetInfoFail</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    mockMvc.perform(MockMvcRequestBuilders.get(<span class="string">"/user/a"</span>)</span><br><span class="line">            .contentType(MediaType.APPLICATION_JSON_UTF8))</span><br><span class="line">            .andExpect(MockMvcResultMatchers.status().is4xxClientError());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="UserController-java"><a href="#UserController-java" class="headerlink" title="UserController.java"></a>UserController.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/user"</span>,method = RequestMethod.GET)</span><br><span class="line">    <span class="meta">@JsonView</span>(User.UserSimpleView.class)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">query</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            @RequestParam(name=<span class="string">"username"</span>,required = <span class="keyword">true</span>,defaultValue = <span class="string">"jojo"</span>)</span></span></span><br><span class="line"><span class="function">                    String username,</span></span><br><span class="line"><span class="function">            <span class="comment">//spring提供的一个分页信息存储对象</span></span></span><br><span class="line"><span class="function">            @<span class="title">PageableDefault</span><span class="params">(page = <span class="number">2</span>, size = <span class="number">17</span>, sort = <span class="string">"username,asc"</span>)</span> Pageable pageable)</span>&#123;</span><br><span class="line">        List&lt;User&gt; users = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        users.add(<span class="keyword">new</span> User());</span><br><span class="line">        users.add(<span class="keyword">new</span> User());</span><br><span class="line">        users.add(<span class="keyword">new</span> User());</span><br><span class="line">        <span class="keyword">return</span> users;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@PathVariable</span>:将请求资源中的片段，映射到请求服务方法中的参数中</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@JsonView</span>:使用场景：List&lt;User&gt; query()方法中返回的用户信息没有包含密码信息</span></span><br><span class="line"><span class="comment">     *                      User getInfo()方法返回的用户信息有密码信息</span></span><br><span class="line"><span class="comment">     *                      1.在 User 类中 使用接口定义视图</span></span><br><span class="line"><span class="comment">     *                         public interface UserSimpleView &#123;&#125;; //简单视图</span></span><br><span class="line"><span class="comment">     *                         public interface UserDetailView extends UserSimpleView &#123;&#125;;//包含简单视图内容和扩展视图内容</span></span><br><span class="line"><span class="comment">     *                      2.在 User 类中值对象get方法中指定视图，UserDetailView可以显示所有UserSimpleView视图的显示内容</span></span><br><span class="line"><span class="comment">     *                         <span class="doctag">@JsonView</span>(UserSimpleView.class)</span></span><br><span class="line"><span class="comment">     *                         public String getUsername() &#123; return username;&#125;</span></span><br><span class="line"><span class="comment">     *                         <span class="doctag">@JsonView</span>(UserDetailView.class)</span></span><br><span class="line"><span class="comment">                               public String getPassword() &#123; return password;&#125;</span></span><br><span class="line"><span class="comment">                           3.在controller中指定视图</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">//@GetMapping("/&#123;id:\\d+&#125;")</span></span><br><span class="line">    <span class="meta">@JsonView</span>(User.UserDetailView.class)</span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/user/&#123;id:\\d+&#125;"</span>,method = RequestMethod.GET)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">getInfo</span><span class="params">(@PathVariable(name = <span class="string">"id"</span>)</span> String id) </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"进入getInfo服务"</span>);</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.setUsername(<span class="string">"tom"</span>);</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="User-java"><a href="#User-java" class="headerlink" title="User.java"></a>User.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserSimpleView</span> </span>&#123;&#125;;</span><br><span class="line">   <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDetailView</span> <span class="keyword">extends</span> <span class="title">UserSimpleView</span> </span>&#123;&#125;;</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">private</span> String id;</span><br><span class="line">   </span><br><span class="line">   <span class="comment">//@MyConstraint(message = "这是一个测试")</span></span><br><span class="line">   <span class="comment">//@ApiModelProperty(value = "用户名")</span></span><br><span class="line">   <span class="keyword">private</span> String username;</span><br><span class="line">   </span><br><span class="line">   <span class="meta">@NotBlank</span>(message = <span class="string">"密码不能为空"</span>)</span><br><span class="line">   <span class="keyword">private</span> String password;</span><br><span class="line">   </span><br><span class="line">   <span class="meta">@Past</span>(message = <span class="string">"生日必须是过去的时间"</span>)</span><br><span class="line">   <span class="keyword">private</span> Date birthday;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@JsonView</span>(UserSimpleView.class)</span><br><span class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">getUsername</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> username;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUsername</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.username = username;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@JsonView</span>(UserDetailView.class)</span><br><span class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">getPassword</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> password;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPassword</span><span class="params">(String password)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.password = password;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@JsonView</span>(UserSimpleView.class)</span><br><span class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> id;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.id = id;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   <span class="meta">@JsonView</span>(UserSimpleView.class)</span><br><span class="line">   <span class="function"><span class="keyword">public</span> Date <span class="title">getBirthday</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> birthday;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBirthday</span><span class="params">(Date birthday)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.birthday = birthday;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>代码重构</strong></p>
<p>使用RequestMapping变体简化代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line"><span class="meta">@GetMapping</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">query</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">    </span><br><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/&#123;id:\\d+&#125;"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">getInfo</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="创建用例"><a href="#创建用例" class="headerlink" title="创建用例"></a>创建用例</h4><ol>
<li>@RequestBody映射请求体到java方法的参数</li>
<li>日期类型参数的处理</li>
<li>@Valid注解和BindingResult验证请求参数的合法性并处理校验结果</li>
</ol>
<h5 id="UserControllerTest-java-1"><a href="#UserControllerTest-java-1" class="headerlink" title="UserControllerTest.java"></a>UserControllerTest.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 使用RESTful API 创建一个用户</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">whenCreateSuccess</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Date date = <span class="keyword">new</span> Date();</span><br><span class="line">    System.out.println(date.getTime());</span><br><span class="line">    String content = <span class="string">"&#123;\"username\":\"tom\",\"password\":null,\"birthday\":"</span>+date.getTime()+<span class="string">"&#125;"</span>;</span><br><span class="line">    String reuslt = mockMvc.perform(MockMvcRequestBuilders.post(<span class="string">"/user"</span>).contentType(MediaType.APPLICATION_JSON_UTF8)</span><br><span class="line">            .content(content))</span><br><span class="line">            .andExpect(MockMvcResultMatchers.status().isOk())</span><br><span class="line">            .andExpect(MockMvcResultMatchers.jsonPath(<span class="string">"$.id"</span>).value(<span class="string">"1"</span>))</span><br><span class="line">            .andReturn().getResponse().getContentAsString();</span><br><span class="line"></span><br><span class="line">    System.out.println(reuslt);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="UserController-java-1"><a href="#UserController-java-1" class="headerlink" title="UserController.java"></a>UserController.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 通过post请求创建用户</span></span><br><span class="line"><span class="comment"> * @ RequestBody:若请求数据是以json字符串格式数据传输，参数无法封装到方法中的参数</span></span><br><span class="line"><span class="comment"> *                  使用requestBody可以解析json格式为方法体中的参数赋值</span></span><br><span class="line"><span class="comment"> * @ Valid 验证、校验参数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> errors 校验错误信息存储器，与<span class="doctag">@Valid</span>注解成对出现</span></span><br><span class="line"><span class="comment"> *               若校验不接收错误信息，则不会进入方法体，并且返回错误到请求处</span></span><br><span class="line"><span class="comment"> *               若已接受错误信息，则进入方法体，完成方法体内容</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping</span></span><br><span class="line"><span class="comment">//@ApiOperation(value = "创建用户")</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">create</span><span class="params">(@Valid @RequestBody User user,BindingResult errors)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(errors.hasErrors())&#123;<span class="comment">//是否有错误校验信息</span></span><br><span class="line">        <span class="comment">//流化并且打印错误信息</span></span><br><span class="line">        errors.getAllErrors().stream().forEach(error -&gt; System.out.println(error.getDefaultMessage()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    System.out.println(user.getId());</span><br><span class="line">    System.out.println(user.getUsername());</span><br><span class="line">    System.out.println(user.getPassword());</span><br><span class="line">    System.out.println(user.getBirthday());</span><br><span class="line"></span><br><span class="line">    user.setId(<span class="string">"1"</span>);</span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="User-java-1"><a href="#User-java-1" class="headerlink" title="User.java"></a>User.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@NotBlank</span>(message = <span class="string">"密码不能为空"</span>)</span><br><span class="line"><span class="keyword">private</span> String password;</span><br></pre></td></tr></table></figure>
<h4 id="修改与删除用例"><a href="#修改与删除用例" class="headerlink" title="修改与删除用例"></a>修改与删除用例</h4><h5 id="UserControllerTest-java-2"><a href="#UserControllerTest-java-2" class="headerlink" title="UserControllerTest.java"></a>UserControllerTest.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试更新请求</span></span><br><span class="line"><span class="comment"> * 请求方式put请求</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">whenUpdateSuccess</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Date date = <span class="keyword">new</span> Date(LocalDateTime.now().plusYears(<span class="number">1</span>).atZone(ZoneId.systemDefault()).toInstant().toEpochMilli());</span><br><span class="line">    System.out.println(date.getTime());</span><br><span class="line">    String content = <span class="string">"&#123;\"id\":\"1\", \"username\":\"tom\",\"password\":null,\"birthday\":"</span>+date.getTime()+<span class="string">"&#125;"</span>;</span><br><span class="line">    String reuslt = mockMvc.perform(MockMvcRequestBuilders.put(<span class="string">"/user/1"</span>).contentType(MediaType.APPLICATION_JSON_UTF8)</span><br><span class="line">            .content(content))</span><br><span class="line">            .andExpect(MockMvcResultMatchers.status().isOk())</span><br><span class="line">            .andExpect(MockMvcResultMatchers.jsonPath(<span class="string">"$.id"</span>).value(<span class="string">"1"</span>))</span><br><span class="line">            .andReturn().getResponse().getContentAsString();</span><br><span class="line"></span><br><span class="line">    System.out.println(reuslt);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 请求方式Delete</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">whenDeleteSuccess</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    mockMvc.perform(MockMvcRequestBuilders.delete(<span class="string">"/user/1"</span>)</span><br><span class="line">            .contentType(MediaType.APPLICATION_JSON_UTF8))</span><br><span class="line">            .andExpect(MockMvcResultMatchers.status().isOk());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="UserConroller-java"><a href="#UserConroller-java" class="headerlink" title="UserConroller.java"></a>UserConroller.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PutMapping</span>(<span class="string">"/&#123;id:\\d+&#125;"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">update</span><span class="params">(@Valid @RequestBody User user, BindingResult errors)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (errors.hasErrors())&#123;</span><br><span class="line">        errors.getAllErrors().stream().forEach(error -&gt; &#123;</span><br><span class="line">            FieldError fieldError = (FieldError)error;</span><br><span class="line">            String message = fieldError.getField() + <span class="string">" "</span> + fieldError.getDefaultMessage();</span><br><span class="line">            System.out.println(message);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    System.out.println(user.getId());</span><br><span class="line">    System.out.println(user.getUsername());</span><br><span class="line">    System.out.println(user.getPassword());</span><br><span class="line">    System.out.println(user.getBirthday());</span><br><span class="line"></span><br><span class="line">    user.setId(<span class="string">"1"</span>);</span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Delete请求</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@DeleteMapping</span>(<span class="string">"/&#123;id:\\d+&#125;"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">(@PathVariable String id)</span> </span>&#123;</span><br><span class="line">    System.out.println(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="User-java-2"><a href="#User-java-2" class="headerlink" title="User.java"></a>User.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@NotBlank</span>(message = <span class="string">"密码不能为空"</span>)</span><br><span class="line"><span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Past</span>(message = <span class="string">"生日必须是过去的时间"</span>)</span><br><span class="line"><span class="keyword">private</span> Date birthday;</span><br></pre></td></tr></table></figure>
<h4 id="定义校验器"><a href="#定义校验器" class="headerlink" title="定义校验器"></a>定义校验器</h4><h5 id="校验器接口定义"><a href="#校验器接口定义" class="headerlink" title="校验器接口定义"></a>校验器接口定义</h5><p><strong>MyConstrain.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义校验注解</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  自定义校验器要声明以下必须的三个方法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Target</span>(&#123;ElementType.METHOD, ElementType.FIELD&#125;)<span class="comment">//使用在方法和字段上</span></span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)<span class="comment">//运行时注解</span></span><br><span class="line"><span class="meta">@Constraint</span>(validatedBy = MyConstraintValidator.class)<span class="comment">//表名此注解用于校验  validatedBy:当前注解，用哪一个类去校验</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> MyConstraint &#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 错误信息</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function">String <span class="title">message</span><span class="params">()</span></span>;</span><br><span class="line">   Class&lt;?&gt;[] groups() <span class="keyword">default</span> &#123; &#125;;</span><br><span class="line">   Class&lt;? extends Payload&gt;[] payload() <span class="keyword">default</span> &#123; &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="定义校验器校验实现类"><a href="#定义校验器校验实现类" class="headerlink" title="定义校验器校验实现类"></a>定义校验器校验实现类</h5><p><strong>MyConstraintValidator.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ConstraintValidator&lt;A,B&gt;</span></span><br><span class="line"><span class="comment"> *     A：使用哪个注解</span></span><br><span class="line"><span class="comment"> *    B：验证类型。如String，那么注解就只有String类型上起作用</span></span><br><span class="line"><span class="comment"> * 在类结构上，不需要声明为spring管理的类</span></span><br><span class="line"><span class="comment"> *        原因:spring扫描到 ConstraintValidator 接口， 自动将其实现类为自己管理的bean</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyConstraintValidator</span> <span class="keyword">implements</span> <span class="title">ConstraintValidator</span>&lt;<span class="title">MyConstraint</span>, <span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 在校验器中，可以注入spring容器中的任何Bean</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> HelloService helloService;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 校验器初始化工作</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> constraintAnnotation</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(MyConstraint constraintAnnotation)</span> </span>&#123;</span><br><span class="line">      System.out.println(<span class="string">"my validator init"</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 真正的校验逻辑</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> value 需要校验的值</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> context 验证器上下文</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isValid</span><span class="params">(Object value, ConstraintValidatorContext context)</span> </span>&#123;</span><br><span class="line">      helloService.greeting(<span class="string">"tom"</span>);<span class="comment">//模拟校验逻辑</span></span><br><span class="line">      System.out.println(value);</span><br><span class="line">      <span class="comment">//return false; //失败</span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">true</span>; <span class="comment">//校验成功</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="服务器异常处理"><a href="#服务器异常处理" class="headerlink" title="服务器异常处理"></a>服务器异常处理</h4><h5 id="Spring-Boot-的错误处理机制"><a href="#Spring-Boot-的错误处理机制" class="headerlink" title="Spring Boot 的错误处理机制"></a>Spring Boot 的错误处理机制</h5><ol>
<li>在浏览器中输入不存在的资源地址，spring boot跳转到指定的页面，显示如下信息</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Whitelabel Error Page</span><br><span class="line">This application has no explicit mapping for /error, so you are seeing this as a fallback.</span><br><span class="line">Tue Oct 03 18:46:23 CST 2017</span><br><span class="line">There was an unexpected error (type=Not Found, status=404).</span><br><span class="line">No message available</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>在模拟非浏览器请求，spring boot返回json数据</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;timestamp&quot;: 1507028069711,</span><br><span class="line">    &quot;status&quot;: 404,</span><br><span class="line">    &quot;error&quot;: &quot;Not Found&quot;,</span><br><span class="line">    &quot;message&quot;: &quot;No message available&quot;,</span><br><span class="line">    &quot;path&quot;: &quot;/xxx&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Spring-Boot错误处理机制源码分析"><a href="#Spring-Boot错误处理机制源码分析" class="headerlink" title="Spring Boot错误处理机制源码分析"></a>Spring Boot错误处理机制源码分析</h5><ol>
<li><p>浏览器发出的请求</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Request Headers：</span><br><span class="line">Accept:text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br></pre></td></tr></table></figure>
</li>
<li><p>非浏览器请求</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Request Headers:</span><br><span class="line">Accept:*/*</span><br></pre></td></tr></table></figure>
</li>
<li><p>源码分析</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span> <span class="comment">//本身就是一个控制器</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(&#123;<span class="string">"$&#123;server.error.path:$&#123;error.path:/error&#125;&#125;"</span>&#125;)<span class="comment">//处理error请求</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BasicErrorController</span> <span class="keyword">extends</span> <span class="title">AbstractErrorController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* 以下两个方法：</span></span><br><span class="line"><span class="comment">* 根据请求信息不同，返回结果不同</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(produces = &#123;<span class="string">"text/html"</span>&#125;)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ModelAndView <span class="title">errorHtml</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">    HttpStatus status = <span class="keyword">this</span>.getStatus(request);</span><br><span class="line">    Map&lt;String, Object&gt; model = Collections.unmodifiableMap(<span class="keyword">this</span>.getErrorAttributes(request, <span class="keyword">this</span>.isIncludeStackTrace(request, MediaType.TEXT_HTML)));<span class="comment">//返回一个HTML</span></span><br><span class="line">    response.setStatus(status.value());</span><br><span class="line">    ModelAndView modelAndView = <span class="keyword">this</span>.resolveErrorView(request, response, status, model);</span><br><span class="line">    <span class="keyword">return</span> modelAndView == <span class="keyword">null</span>?<span class="keyword">new</span> ModelAndView(<span class="string">"error"</span>, model):modelAndView;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//返回map转为json数据</span></span><br><span class="line"><span class="meta">@RequestMapping</span></span><br><span class="line"><span class="meta">@ResponseBody</span>  <span class="comment">//将map集合输出为json数据</span></span><br><span class="line"><span class="keyword">public</span> ResponseEntity&lt;Map&lt;String, Object&gt;&gt; error(HttpServletRequest request) &#123;</span><br><span class="line">    Map&lt;String, Object&gt; body = <span class="keyword">this</span>.getErrorAttributes(request, <span class="keyword">this</span>.isIncludeStackTrace(request, MediaType.ALL));</span><br><span class="line">    HttpStatus status = <span class="keyword">this</span>.getStatus(request);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ResponseEntity(body, status);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h5 id="自定义错误处理机制"><a href="#自定义错误处理机制" class="headerlink" title="自定义错误处理机制"></a>自定义错误处理机制</h5><p>​    默认情况下，spring boot默认的处理机制已经是可以满足我们一般的开发目标，若有特定需求，可以自定义处理方案</p>
<p><strong>定义浏览器返回的错误处理资源</strong></p>
<p>​    在资源目录下，创建<code>resources/error</code>目录，根据状态码命名错误页面，自定义错误页面的内容</p>
<p><strong>定义非浏览器（APP）返回的错误处理</strong></p>
<ol>
<li>自定义异常类<code>UserNotExistException.java</code></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义异常</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserNotExistException</span> <span class="keyword">extends</span> <span class="title">RuntimeException</span> </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">6112780192479692859L</span>;</span><br><span class="line">   <span class="keyword">private</span> String id;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">UserNotExistException</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">super</span>(<span class="string">"user not exist"</span>);</span><br><span class="line">      <span class="keyword">this</span>.id = id;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">getId</span><span class="params">()</span> </span>&#123;<span class="keyword">return</span> id; &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(String id)</span> </span>&#123;<span class="keyword">this</span>.id = id;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>增加服务</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/&#123;id:\\d+&#125;"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">getInfo</span><span class="params">(@PathVariable(name = <span class="string">"id"</span>)</span> String id) </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UserNotExistException(<span class="string">"1"</span>);<span class="comment">//测试异常处理</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>使用postman发送请求，返回json信息</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;timestamp&quot;: 1507034846064,</span><br><span class="line">    &quot;status&quot;: 500,</span><br><span class="line">    &quot;error&quot;: &quot;Internal Server Error&quot;,</span><br><span class="line">    &quot;exception&quot;: &quot;vic.tjs.Exception.UserNotExistException&quot;,</span><br><span class="line">    &quot;message&quot;: &quot;user not exist&quot;,</span><br><span class="line">    &quot;path&quot;: &quot;/user/1&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>创建异常处理控制器</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ControllerAdvice</span>：处理其他控制器抛出的异常，不处理http请求，只负责处理控制器抛出的异常</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ExceptionHandler</span>：当任何一个控制器，抛出指定的异常，都会执行该注解下的方法进行处理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ControllerExceptionHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@ExceptionHandler</span>(UserNotExistException.class)</span><br><span class="line">   <span class="meta">@ResponseBody</span> <span class="comment">//返回的map集合转成json</span></span><br><span class="line">   <span class="meta">@ResponseStatus</span>(HttpStatus.INTERNAL_SERVER_ERROR)<span class="comment">//返回的htto状态码</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">handleUserNotExistException</span><span class="params">(UserNotExistException ex)</span> </span>&#123;</span><br><span class="line">      Map&lt;String, Object&gt; result = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">      result.put(<span class="string">"id"</span>, ex.getId());</span><br><span class="line">      result.put(<span class="string">"message"</span>, ex.getMessage());</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>使用postman发送请求，返回json信息</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;id&quot;: &quot;1&quot;,</span><br><span class="line">    &quot;message&quot;: &quot;user not exist&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="RESTful-API的拦截（Filter、Interceptor与Aspect）"><a href="#RESTful-API的拦截（Filter、Interceptor与Aspect）" class="headerlink" title="RESTful API的拦截（Filter、Interceptor与Aspect）"></a>RESTful API的拦截（Filter、Interceptor与Aspect）</h4><h5 id="Filter过滤器：记录所有服务的处理时间"><a href="#Filter过滤器：记录所有服务的处理时间" class="headerlink" title="Filter过滤器：记录所有服务的处理时间"></a>Filter过滤器：记录所有服务的处理时间</h5><h6 id="组件自定义配置"><a href="#组件自定义配置" class="headerlink" title="组件自定义配置"></a>组件自定义配置</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义过滤器，拦截所有服务，并且计算服务时长</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span> <span class="comment">//声明为spring管理的组件才能识别此类为过滤器</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TimeFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span></span></span><br><span class="line"><span class="function">         <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">      System.out.println(<span class="string">"time filter start"</span>);</span><br><span class="line">      <span class="keyword">long</span> start = <span class="keyword">new</span> Date().getTime();</span><br><span class="line">      chain.doFilter(request, response); <span class="comment">//整个服务方法就在过滤器中执行</span></span><br><span class="line">      System.out.println(<span class="string">"time filter 耗时:"</span>+ (<span class="keyword">new</span> Date().getTime() - start));</span><br><span class="line">      System.out.println(<span class="string">"time filter finish"</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>访问服务，console输出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">time filter start</span><br><span class="line">进入getInfo服务</span><br><span class="line">time filter 耗时:240</span><br><span class="line">time filter finish</span><br><span class="line">time filter start</span><br><span class="line">time filter 耗时:10</span><br><span class="line">time filter finish</span><br></pre></td></tr></table></figure>
<h6 id="Spring-boot-声明配置"><a href="#Spring-boot-声明配置" class="headerlink" title="Spring boot 声明配置"></a>Spring boot 声明配置</h6><p>取消组件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//@Component //声明为spring管理的组件才能识别此类为过滤器</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TimeFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>配置类配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 配置类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfig</span></span>&#123;</span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> FilterRegistrationBean <span class="title">timeFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      FilterRegistrationBean registrationBean = <span class="keyword">new</span> FilterRegistrationBean();</span><br><span class="line">      TimeFilter timeFilter = <span class="keyword">new</span> TimeFilter();</span><br><span class="line">      registrationBean.setFilter(timeFilter); </span><br><span class="line">      List&lt;String&gt; urls = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">      urls.add(<span class="string">"/*"</span>);</span><br><span class="line">      registrationBean.setUrlPatterns(urls); </span><br><span class="line">      <span class="keyword">return</span> registrationBean; </span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="Filter-应用缺点"><a href="#Filter-应用缺点" class="headerlink" title="Filter 应用缺点"></a>Filter 应用缺点</h6><p>​    由于<code>Filter</code>是在<code>J2EE</code>规范定义的，未知<code>sping</code>相关的任何东西，只能获取<code>request</code>和<code>response</code>请求，无法获取请求的<code>controller</code>信息和哪个方法处理请求的</p>
<h5 id="Interceptor-拦截器"><a href="#Interceptor-拦截器" class="headerlink" title="Interceptor 拦截器"></a>Interceptor 拦截器</h5><h6 id="声明拦截器"><a href="#声明拦截器" class="headerlink" title="声明拦截器"></a>声明拦截器</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 服务时间记录拦截器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TimeInterceptor</span> <span class="keyword">implements</span> <span class="title">HandlerInterceptor</span> </span>&#123;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 服务方法执行前 调用</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> handler 服务控制器</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span></span></span><br><span class="line"><span class="function">         <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      System.out.println(<span class="string">"preHandle"</span>);</span><br><span class="line">      <span class="comment">//获得服务的控制器的信息</span></span><br><span class="line">    System.out.println(((HandlerMethod)handler).getBean().getClass().getName());</span><br><span class="line">      System.out.println(((HandlerMethod)handler).getMethod().getName());</span><br><span class="line">      request.setAttribute(<span class="string">"startTime"</span>, <span class="keyword">new</span> Date().getTime());</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">true</span>; <span class="comment">//是否放行</span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 服务方法执行完后 调用</span></span><br><span class="line"><span class="comment">    * 若服务方法抛出异常，则此方法不会被调用</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> handler</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> modelAndView</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler,</span></span></span><br><span class="line"><span class="function"><span class="params">         ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      System.out.println(<span class="string">"postHandle"</span>);</span><br><span class="line">      Long start = (Long) request.getAttribute(<span class="string">"startTime"</span>);</span><br><span class="line">      System.out.println(<span class="string">"time interceptor 耗时:"</span>+ (<span class="keyword">new</span> Date().getTime() - start));</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 不管服务方法是正常完成还是抛出异常，此方法都会调用</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> handler</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> exception</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception exception)</span></span></span><br><span class="line"><span class="function">         <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      System.out.println(<span class="string">"afterCompletion"</span>);</span><br><span class="line">      Long start = (Long) request.getAttribute(<span class="string">"startTime"</span>);</span><br><span class="line">      System.out.println(<span class="string">"time interceptor 耗时:"</span>+ (<span class="keyword">new</span> Date().getTime() - start));</span><br><span class="line">      System.out.println(<span class="string">"exception is "</span>+ exception);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="配置拦截器"><a href="#配置拦截器" class="headerlink" title="配置拦截器"></a>配置拦截器</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 配置类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfig</span> <span class="keyword">extends</span> <span class="title">WebMvcConfigurerAdapter</span> </span>&#123;</span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> TimeInterceptor timeInterceptor; <span class="comment">//注入拦截器</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> </span>&#123;</span><br><span class="line">      registry.addInterceptor(timeInterceptor);</span><br><span class="line">   &#125;</span><br><span class="line">……</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="正常运行控制台信息"><a href="#正常运行控制台信息" class="headerlink" title="正常运行控制台信息"></a>正常运行控制台信息</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">time filter start                                -- doFilter</span><br><span class="line">preHandle                                        -- preHandle</span><br><span class="line">vic.tjs.web.controller.UserController            -- preHandle</span><br><span class="line">query                                            -- preHandle</span><br><span class="line">postHandle                                       -- postHandle</span><br><span class="line">time interceptor 耗时:167                        -- postHandle</span><br><span class="line">afterCompletion                                  -- afterCompletion</span><br><span class="line">time interceptor 耗时:167</span><br><span class="line">exception is null</span><br><span class="line">time filter 耗时:170                             -- doFilter</span><br><span class="line">time filter finish</span><br></pre></td></tr></table></figure>
<h6 id="抛出异常控制台信息"><a href="#抛出异常控制台信息" class="headerlink" title="抛出异常控制台信息"></a>抛出异常控制台信息</h6><p>设置异常点</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/&#123;id:\\d+&#125;"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">getInfo</span><span class="params">(@PathVariable(name = <span class="string">"id"</span>)</span> String id) </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UserNotExistException(<span class="string">"1"</span>);<span class="comment">//测试异常处理</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>异常输出</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">time filter start</span><br><span class="line">preHandle</span><br><span class="line">vic.tjs.web.controller.UserController</span><br><span class="line">getInfo</span><br><span class="line">                                               -- 没有执行postHandle</span><br><span class="line">afterCompletion</span><br><span class="line">time interceptor 耗时:30</span><br><span class="line">exception is null                   </span><br><span class="line">time filter 耗时:40</span><br><span class="line">time filter finish</span><br></pre></td></tr></table></figure>
<p>疑问？exception为null？</p>
<p>解释：exception为空是因为之前配置中把异常处理了，自定义的异常控制处理器 比 拦截器中的afterCompletion 先执行，把异常处理完后才调用拦截器，因此不会获得异常信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ControllerExceptionHandler</span> </span>&#123;</span><br><span class="line">   <span class="meta">@ExceptionHandler</span>(UserNotExistException.class)</span><br><span class="line">   <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">handleUserNotExistException</span><span class="params">(UserNotExistException ex)</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>解决：</p>
<ol>
<li>改造异常抛出点</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">getInfo</span><span class="params">(@PathVariable(name = <span class="string">"id"</span>)</span> String id) </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"user not exist"</span>); &#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>抛出异常</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">time filter start</span><br><span class="line">preHandle</span><br><span class="line">vic.tjs.web.controller.UserController</span><br><span class="line">getInfo</span><br><span class="line">afterCompletion</span><br><span class="line">time interceptor 耗时:0</span><br><span class="line">exception is java.lang.RuntimeException: user not exist</span><br><span class="line">………</span><br><span class="line">//拦截器会拦截所有的控制器</span><br><span class="line">//以下的spring 异常处理控制器也被拦截了</span><br><span class="line">preHandle</span><br><span class="line">org.springframework.boot.autoconfigure.web.BasicErrorController</span><br><span class="line">error</span><br><span class="line">postHandle</span><br><span class="line">time interceptor 耗时:0</span><br><span class="line">afterCompletion</span><br><span class="line">time interceptor 耗时:0</span><br><span class="line">exception is null</span><br></pre></td></tr></table></figure>
<h6 id="拦截器局限性"><a href="#拦截器局限性" class="headerlink" title="拦截器局限性"></a>拦截器局限性</h6><p>​    拦截器<code>Object handle</code>中的能获取请求的控制器的信息，但无法获取请求的参数的值</p>
<p><strong>DispatcherServlet.java分发请求源码分析</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DispatcherServlet</span> <span class="keyword">extends</span> <span class="title">FrameworkServlet</span> </span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doService</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.doDispatch(request, response);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doDispatch</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span>&#123;</span><br><span class="line">   <span class="comment">//此方法是调用拦截器中的preHandle</span></span><br><span class="line"><span class="keyword">if</span>(!mappedHandler.applyPreHandle(processedRequest, response)) &#123;</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line"><span class="comment">//此处真正的调用控制器，方法参数的拼装在此处进行，所以拦截器无法获取参数信息</span></span><br><span class="line">      mv = ha.handle(processedRequest, response, mappedHandler.getHandler());</span><br><span class="line">      <span class="keyword">if</span>(asyncManager.isConcurrentHandlingStarted()) &#123;</span><br><span class="line">         <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Aspect-AOP-切片"><a href="#Aspect-AOP-切片" class="headerlink" title="Aspect (AOP) 切片"></a>Aspect (AOP) 切片</h5><p><img src="images/aop.png" alt="aop"></p>
<h6 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h6><p>在<code>pom.xml</code>中添加aop支持</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h6 id="声明切片"><a href="#声明切片" class="headerlink" title="声明切片"></a>声明切片</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span>  <span class="comment">//定义一个切片类</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TimeAspect</span> </span>&#123;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Around：什么时候执行</span></span><br><span class="line"><span class="comment">    * execution：在哪些符合条件的方法上执行</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> pjp 当前被拦截的方法信息对象</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Around</span>(<span class="string">"execution(* vic.tjs.web.controller.UserController.*(..))"</span>)</span><br><span class="line">   <span class="function"><span class="keyword">public</span> Object <span class="title">handleControllerMethod</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">      System.out.println(<span class="string">"time aspect start"</span>);</span><br><span class="line">      <span class="comment">//获取被拦截的控制器的参数		</span></span><br><span class="line">      Object[] args = pjp.getArgs();</span><br><span class="line">      <span class="keyword">for</span> (Object arg : args) &#123;</span><br><span class="line">         System.out.println(<span class="string">"arg is "</span>+arg);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">long</span> start = <span class="keyword">new</span> Date().getTime();</span><br><span class="line">      Object object = pjp.proceed(); <span class="comment">//很像Filter中的doFilter，得到的结果就是控制器的返回值</span></span><br><span class="line">      System.out.println(<span class="string">"time aspect 耗时:"</span>+ (<span class="keyword">new</span> Date().getTime() - start));</span><br><span class="line">      System.out.println(<span class="string">"time aspect end"</span>);</span><br><span class="line">      <span class="keyword">return</span> object;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>控制台输出</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">time filter start <span class="comment">#过滤器</span></span><br><span class="line">preHandle <span class="comment"># 拦截器</span></span><br><span class="line">vic.tjs.web.controller.UserController$<span class="variable">$EnhancerBySpringCGLIB</span>$<span class="variable">$678cdc94</span> <span class="comment">#拦截器</span></span><br><span class="line">getInfo <span class="comment">#拦截器</span></span><br><span class="line">time aspect start <span class="comment"># 切片</span></span><br><span class="line">arg is 1 <span class="comment">#切片</span></span><br><span class="line">进入getInfo服务 <span class="comment">#服务</span></span><br><span class="line">time aspect 耗时:3 <span class="comment">#切片</span></span><br><span class="line">time aspect end <span class="comment"># 切片</span></span><br><span class="line">postHandle	<span class="comment"># 拦截器</span></span><br><span class="line">time interceptor 耗时:83 <span class="comment"># 拦截器</span></span><br><span class="line">afterCompletion <span class="comment">#拦截器</span></span><br><span class="line">time interceptor 耗时:83</span><br><span class="line">exception is null</span><br><span class="line">time filter 耗时:93 <span class="comment">#过滤器</span></span><br><span class="line">time filter finish <span class="comment">#过滤器</span></span><br></pre></td></tr></table></figure>
<h6 id="切片局限性"><a href="#切片局限性" class="headerlink" title="切片局限性"></a>切片局限性</h6><p>​    切片不能像Filter和Interceptor能获取http请求与响应</p>
<h5 id="总结-amp-amp-执行顺序"><a href="#总结-amp-amp-执行顺序" class="headerlink" title="总结 &amp;&amp; 执行顺序"></a>总结 &amp;&amp; 执行顺序</h5><p>​    总结：这三种拦截方式各有各好处，应根据需求选取其中一种</p>
<p>​    执行顺序：</p>
<p><img src="images/executionsequence.png" alt=""></p>
<h4 id="使用RESTful方式处理文件服务"><a href="#使用RESTful方式处理文件服务" class="headerlink" title="使用RESTful方式处理文件服务"></a>使用RESTful方式处理文件服务</h4><h5 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h5><ol>
<li>添加常用io包</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>创建测试类，模拟上传文件</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 模拟客户端实现文件上传</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">whenUploadSuccess</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    String result = mockMvc.perform(MockMvcRequestBuilders.fileUpload(<span class="string">"/file"</span>)</span><br><span class="line">            .file(<span class="keyword">new</span> MockMultipartFile(<span class="string">"file"</span>, <span class="string">"test.txt"</span>, <span class="string">"multipart/form-data"</span>, <span class="string">"hello upload"</span>.getBytes(<span class="string">"UTF-8"</span>))))</span><br><span class="line">            .andExpect(MockMvcResultMatchers.status().isOk())</span><br><span class="line">            .andReturn().getResponse().getContentAsString();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>创建服务</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 文件上传处理控制器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/file"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FileController</span> </span>&#123;</span><br><span class="line"><span class="comment">//上传到本地</span></span><br><span class="line">   <span class="keyword">private</span> String folder = <span class="string">"D:\\idea_location\\vicsecuritydemo\\src\\main\\java\\vic\\tjs\\web\\controller"</span></span><br><span class="line">   <span class="meta">@PostMapping</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> FileInfo <span class="title">upload</span><span class="params">(MultipartFile file)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      <span class="comment">//上传文件的信息</span></span><br><span class="line">      System.out.println(file.getName());</span><br><span class="line">      System.out.println(file.getOriginalFilename());</span><br><span class="line">      System.out.println(file.getSize());</span><br><span class="line">      File localFile = <span class="keyword">new</span> File(folder, <span class="keyword">new</span> Date().getTime() + <span class="string">".txt"</span>);</span><br><span class="line">      file.transferTo(localFile);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> FileInfo(localFile.getAbsolutePath());</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注：这里的<code>FileInfo</code>只是一个自定义的简单实体类，用来记录文件位置</p>
<h5 id="文件下载"><a href="#文件下载" class="headerlink" title="文件下载"></a>文件下载</h5><ol>
<li>创建服务</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/&#123;id&#125;"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">download</span><span class="params">(@PathVariable String id, HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * jdk 7 语法，将流声明在try()中，调用完后可以自动关闭对应的流，简化开发</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">try</span> (InputStream inputStream = <span class="keyword">new</span> FileInputStream(<span class="keyword">new</span> File(folder, id + <span class="string">".txt"</span>));</span><br><span class="line">         OutputStream outputStream = response.getOutputStream();) &#123;</span><br><span class="line">      response.setContentType(<span class="string">"application/x-download"</span>);</span><br><span class="line">      response.addHeader(<span class="string">"Content-Disposition"</span>, <span class="string">"attachment;filename=test.txt"</span>);</span><br><span class="line">      IOUtils.copy(inputStream, outputStream);</span><br><span class="line">      outputStream.flush();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="异步处理RESTful服务"><a href="#异步处理RESTful服务" class="headerlink" title="异步处理RESTful服务"></a>异步处理RESTful服务</h4><p><img src="images/asynhandlerestful.png" alt=""></p>
<h5 id="使用Callable异步处理RESTful服务"><a href="#使用Callable异步处理RESTful服务" class="headerlink" title="使用Callable异步处理RESTful服务"></a>使用Callable异步处理RESTful服务</h5><p>副线程由主线程唤起</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncController</span> </span>&#123;</span><br><span class="line"><span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/order"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Callable&lt;String&gt; <span class="title">order</span><span class="params">()</span></span>&#123;</span><br><span class="line">   logger.info(<span class="string">"主线程开始"</span>);</span><br><span class="line">		Callable&lt;String&gt; result = <span class="keyword">new</span> Callable&lt;String&gt;() &#123;</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">				logger.info(<span class="string">"副线程开始"</span>);</span><br><span class="line">				Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">				logger.info(<span class="string">"副线程返回"</span>);</span><br><span class="line">				<span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;;</span><br><span class="line">		logger.info(<span class="string">"执行其他事情 模拟  1 "</span>);</span><br><span class="line">		<span class="comment">//Thread.sleep(1000);</span></span><br><span class="line">		logger.info(<span class="string">"执行其他事情 模拟  2 "</span>);</span><br><span class="line">		<span class="comment">//Thread.sleep(1000);</span></span><br><span class="line">		logger.info(<span class="string">"主线程结束"</span>);</span><br><span class="line">		<span class="comment">//Thread.sleep(1000);</span></span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>补充：Callable与Runnable区别</p>
<ol>
<li>Callable中的call方法有返回值，而Runnable中的run方法无返回值；</li>
<li>Callable接口的call()方法允许抛出异常；而Runnable接口的run()方法的异常只能在内部消化，不能继续上抛；</li>
</ol>
<p>测试：开两个浏览器客户端同时发起请求，得到的结果是：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">2018-03-16 20:45:06.860  INFO 8276 --- [p-nio-80-exec-1] vic.tjs.web.async.AsyncController        : 主线程开始</span><br><span class="line">2018-03-16 20:45:06.860  INFO 8276 --- [p-nio-80-exec-1] vic.tjs.web.async.AsyncController        : 执行其他事情 模拟  1 </span><br><span class="line">2018-03-16 20:45:06.860  INFO 8276 --- [p-nio-80-exec-1] vic.tjs.web.async.AsyncController        : 执行其他事情 模拟  2 </span><br><span class="line">2018-03-16 20:45:06.860  INFO 8276 --- [p-nio-80-exec-1] vic.tjs.web.async.AsyncController        : 主线程结束</span><br><span class="line">2018-03-16 20:45:06.860  INFO 8276 --- [      MvcAsync4] vic.tjs.web.async.AsyncController        : 副线程开始</span><br><span class="line">2018-03-16 20:45:07.848  INFO 8276 --- [p-nio-80-exec-2] vic.tjs.web.async.AsyncController        : 主线程开始</span><br><span class="line">2018-03-16 20:45:07.848  INFO 8276 --- [p-nio-80-exec-2] vic.tjs.web.async.AsyncController        : 执行其他事情 模拟  1 </span><br><span class="line">2018-03-16 20:45:07.848  INFO 8276 --- [p-nio-80-exec-2] vic.tjs.web.async.AsyncController        : 执行其他事情 模拟  2 </span><br><span class="line">2018-03-16 20:45:07.848  INFO 8276 --- [p-nio-80-exec-2] vic.tjs.web.async.AsyncController        : 主线程结束</span><br><span class="line">2018-03-16 20:45:07.850  INFO 8276 --- [      MvcAsync5] vic.tjs.web.async.AsyncController        : 副线程开始</span><br><span class="line">2018-03-16 20:45:11.860  INFO 8276 --- [      MvcAsync4] vic.tjs.web.async.AsyncController        : 副线程返回</span><br><span class="line">2018-03-16 20:45:12.852  INFO 8276 --- [      MvcAsync5] vic.tjs.web.async.AsyncController        : 副线程返回</span><br></pre></td></tr></table></figure>
<p>疑问：副线程的执行都是在return时返回结果？测试一下将服务中的的返回结果改为<code>return null;</code>得到如下结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">2018-03-16 20:51:01.144  INFO 7668 --- [p-nio-80-exec-2] vic.tjs.web.async.AsyncController        : 主线程开始</span><br><span class="line">2018-03-16 20:51:01.144  INFO 7668 --- [p-nio-80-exec-2] vic.tjs.web.async.AsyncController        : 执行其他事情 模拟  1 </span><br><span class="line">2018-03-16 20:51:01.144  INFO 7668 --- [p-nio-80-exec-2] vic.tjs.web.async.AsyncController        : 执行其他事情 模拟  2 </span><br><span class="line">2018-03-16 20:51:01.144  INFO 7668 --- [p-nio-80-exec-2] vic.tjs.web.async.AsyncController        : 主线程结束</span><br></pre></td></tr></table></figure>
<p>从上面的结果，可以清楚的看到，Callable线程就是在return时启动执行的。<strong>也就是说，主线程并未结束，而是唤起了副线程，并且副线程执行返回的结果还是交给主线程，并由主线程将结果返回</strong>.</p>
<h5 id="使用DefferredResult异步处理RESTful服务"><a href="#使用DefferredResult异步处理RESTful服务" class="headerlink" title="使用DefferredResult异步处理RESTful服务"></a>使用DefferredResult异步处理RESTful服务</h5><p><img src="images/defferredresult.png" alt=""></p>
<ol>
<li>模拟下单队列</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 模拟下单队列</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MockQueue</span> </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> String placeOrder;</span><br><span class="line">   <span class="keyword">private</span> String completeOrder;</span><br><span class="line">   <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">getPlaceOrder</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> placeOrder; &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPlaceOrder</span><span class="params">(String placeOrder)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">         logger.info(<span class="string">"接到下单请求, "</span> + placeOrder);</span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">         &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">this</span>.completeOrder = placeOrder;</span><br><span class="line">         logger.info(<span class="string">"下单请求处理完毕,"</span> + placeOrder);</span><br><span class="line">      &#125;).start();</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">getCompleteOrder</span><span class="params">()</span> </span>&#123;<span class="keyword">return</span> completeOrder; &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCompleteOrder</span><span class="params">(String completeOrder)</span> </span>&#123;<span class="keyword">this</span>.completeOrder = completeOrder; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>在线程间传递DefferredResult</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DeferredResultHolder</span> </span>&#123;</span><br><span class="line"><span class="comment">//key:订单号,value:订单处理结果</span></span><br><span class="line">   <span class="keyword">private</span> Map&lt;String, DeferredResult&lt;String&gt;&gt; map = <span class="keyword">new</span> HashMap&lt;String, DeferredResult&lt;String&gt;&gt;();</span><br><span class="line">   <span class="keyword">public</span> Map&lt;String, DeferredResult&lt;String&gt;&gt; getMap() &#123;</span><br><span class="line">      <span class="keyword">return</span> map;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMap</span><span class="params">(Map&lt;String, DeferredResult&lt;String&gt;&gt; map)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.map = map;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>生成服务</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncController</span> </span>&#123;</span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> MockQueue mockQueue;</span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> DeferredResultHolder deferredResultHolder;</span><br><span class="line">    </span><br><span class="line">   <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line">   </span><br><span class="line">   <span class="meta">@RequestMapping</span>(<span class="string">"/order"</span>)</span><br><span class="line">   <span class="function"><span class="keyword">public</span> DeferredResult&lt;String&gt; <span class="title">order</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      logger.info(<span class="string">"主线程开始"</span>);</span><br><span class="line">      <span class="comment">//随机生成订单号</span></span><br><span class="line">      String orderNumber = RandomStringUtils.randomNumeric(<span class="number">8</span>);</span><br><span class="line">      mockQueue.setPlaceOrder(orderNumber);<span class="comment">//设置订单号</span></span><br><span class="line"></span><br><span class="line">      DeferredResult&lt;String&gt; result = <span class="keyword">new</span> DeferredResult&lt;&gt;();</span><br><span class="line">      deferredResultHolder.getMap().put(orderNumber, result);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>设置监听器</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 监听下单，返回Result</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QueueListener</span> <span class="keyword">implements</span> <span class="title">ApplicationListener</span>&lt;<span class="title">ContextRefreshedEvent</span>&gt; </span>&#123;</span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> MockQueue mockQueue;</span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> DeferredResultHolder deferredResultHolder;</span><br><span class="line">   <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(ContextRefreshedEvent event)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">         <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isNotBlank(mockQueue.getCompleteOrder())) &#123;</span><br><span class="line">               </span><br><span class="line">               String orderNumber = mockQueue.getCompleteOrder();</span><br><span class="line">               logger.info(<span class="string">"返回订单处理结果:"</span>+orderNumber);</span><br><span class="line">               deferredResultHolder.getMap().get(orderNumber).setResult(<span class="string">"place order success"</span>);<span class="comment">//当DeferredResult.setResult被执行，就意味着异步执行完毕需要向浏览器返回向信息</span></span><br><span class="line">               mockQueue.setCompleteOrder(<span class="keyword">null</span>);</span><br><span class="line">               </span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                  Thread.sleep(<span class="number">100</span>);</span><br><span class="line">               &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                  e.printStackTrace();</span><br><span class="line">               &#125;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;).start();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>调用服务，后台输出信息</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">2017-10-04 14:00:44.512  INFO 6976 --- [nio-8080-exec-1] vic.tjs.web.async.AsyncController        : 主线程开始</span><br><span class="line">2017-10-04 14:00:44.516  INFO 6976 --- [      Thread-10] vic.tjs.web.async.MockQueue              : 接到下单请求, 75192809</span><br><span class="line">2017-10-04 14:00:45.517  INFO 6976 --- [      Thread-10] vic.tjs.web.async.MockQueue              : 下单请求处理完毕,75192809</span><br><span class="line">2017-10-04 14:00:45.597  INFO 6976 --- [       Thread-7] vic.tjs.web.async.QueueListener          : 返回订单处理结果:75192809</span><br></pre></td></tr></table></figure>
<ol start="6">
<li>页面输出信息</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">place order success</span><br></pre></td></tr></table></figure>
<h5 id="异步服务的相关配置"><a href="#异步服务的相关配置" class="headerlink" title="异步服务的相关配置"></a>异步服务的相关配置</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfig</span> <span class="keyword">extends</span> <span class="title">WebMvcConfigurerAdapter</span> </span>&#123;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 配置异步支持</span></span><br><span class="line"><span class="comment">    * 需要支持异步的拦截器都需要配在这里，支持异步的拦截器和addInterceptors不一样</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> configurer</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configureAsyncSupport</span><span class="params">(AsyncSupportConfigurer configurer)</span> </span>&#123;</span><br><span class="line">      <span class="comment">//super.configureAsyncSupport(configurer);</span></span><br><span class="line">      configurer.registerCallableInterceptors(...); <span class="comment">//支持Callable的拦截器</span></span><br><span class="line">      configurer.registerDeferredResultInterceptors(..);<span class="comment">//支持DeferredResult的拦截器</span></span><br><span class="line">      configurer.setDefaultTimeout(..);<span class="comment">//异步请求的默认超时时间</span></span><br><span class="line">      configurer.setTaskExecutor(..);<span class="comment">//设置可重用的线程池</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Swagger自动生成文档"><a href="#Swagger自动生成文档" class="headerlink" title="Swagger自动生成文档"></a>Swagger自动生成文档</h4><p>​    目前很多项目都是前后端分离，并且前后端开发并行工作，后端人员手动编写文档，效率低而且难度大，并且在修改代码的同时，也需要修改文档。使用文档自动生成可以解决以上这些缺点，并且很好的使前端开发人员容易的调用所有的RESTful服务</p>
<ol>
<li><code>pom.xml</code>中添加依赖</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 核心包：扫描文档，生成数据 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 生成格式化界面 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span></span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>启动器中开启注解</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> springfox.documentation.swagger2.annotations.EnableSwagger2;</span><br><span class="line"><span class="meta">@EnableSwagger</span>2</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StartApplication</span></span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>访问文档地址<code>/swagger-ui.html</code></li>
<li>页面效果</li>
</ol>
<p><img src="images/swagger-1.png" alt=""></p>
<p><img src="images/swagger-2.png" alt=""></p>
<ol start="5">
<li>自定义文档显示</li>
</ol>
<p><code>@ApiOperation</code>注解声明在方法中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation</span>(value = <span class="string">"创建用户"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">create</span><span class="params">(@Valid @RequestBody User user,BindingResult errors)</span></span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p><img src="images/apioperation.png" alt=""></p>
<p><code>@ApiParam</code>注解声明在方法参数中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">(@ApiParam(value = <span class="string">"用户id"</span>)</span> @PathVariable String id)</span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p><img src="images/apiparam.png" alt=""></p>
<p><code>@ApiModelProperty</code>注解声明在对象属性中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">	<span class="meta">@ApiModelProperty</span>(value = <span class="string">"用户名"</span>)</span><br><span class="line">	<span class="keyword">private</span> String username;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="images/apimodelproperty.png" alt=""></p>
<h4 id="WireMock"><a href="#WireMock" class="headerlink" title="WireMock"></a>WireMock</h4><p>​    一般开发项目都会分模块进行，比如都会把前端和后端分开，在前端和后端里面也通常是分模块开发的。当开发进度不一致时，可以对依赖接口构建Mock Service，模拟不同输入/数据/场景，这样不至于影响本模块的开发进度。</p>
<ol>
<li>进入WireMock官网，进行服务器下载</li>
</ol>
<p><code>http://wiremock.org/docs/running-standalone/</code></p>
<ol start="2">
<li><p>将下载后的<code>wiremock-standalone-2.14.0.jar</code>运行，可以参考官方文档进行参数设置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">该文件目录下执行命令: java -jar wiremock-standalone-2.8.0.jar  - -port 8020</span><br><span class="line"># 其他参数 - - verbose 开启日志</span><br></pre></td></tr></table></figure>
</li>
<li><p>项目中使用</p>
</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.tomakehurst<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>wiremock<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">!—</span> <span class="attr">wiremock</span>需要依赖<span class="attr">http</span>工具类 <span class="attr">--</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.httpcomponents<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>httpmime<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ol start="4">
<li>搭建服务</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * WireMock 服务器搭建</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MockServer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 使用静态引入WireMock，直接调用方法</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">      configureFor(<span class="number">8020</span>);</span><br><span class="line">      removeAllMappings();</span><br><span class="line"></span><br><span class="line">      mock(<span class="string">"/order/1"</span>, <span class="string">"01"</span>);</span><br><span class="line">      mock(<span class="string">"/order/2"</span>, <span class="string">"02"</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">mock</span><span class="params">(String url, String file)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">      ClassPathResource resource = <span class="keyword">new</span> ClassPathResource(<span class="string">"vic/response/"</span> + file + <span class="string">".txt"</span>);</span><br><span class="line">      String content = StringUtils.join(FileUtils.readLines(resource.getFile(), <span class="string">"UTF-8"</span>).toArray(), <span class="string">"\n"</span>);</span><br><span class="line">      stubFor(get(urlPathEqualTo(url)).willReturn(aResponse().withBody(content).withStatus(<span class="number">200</span>)));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>资源创建</li>
</ol>
<p>在资源目录下创建文件:vic/response/01.txt</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">"id"</span>:<span class="number">1</span>,</span><br><span class="line">   <span class="attr">"type"</span>:<span class="string">"C"</span></span><br><span class="line">   <span class="string">"data"</span> : &#123;</span><br><span class="line">        <span class="attr">"name"</span> : <span class="string">"victorys"</span>,</span><br><span class="line">        <span class="attr">"age"</span> : <span class="number">22</span>,</span><br><span class="line">        <span class="attr">"sex"</span> : <span class="number">0</span></span><br><span class="line">        <span class="string">"interest"</span> : &#123;</span><br><span class="line">            <span class="attr">"0"</span> : <span class="string">"basketball"</span>,</span><br><span class="line">            <span class="attr">"1"</span> : <span class="string">"swingming"</span></span><br><span class="line">        &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过访问/order/1或得返回结果</p>
<h3 id="Slf4j"><a href="#Slf4j" class="headerlink" title="@Slf4j"></a>@Slf4j</h3><h4 id="slf4j"><a href="#slf4j" class="headerlink" title="slf4j"></a>slf4j</h4><p>对于一个maven项目。首先要在pom.xml中加入以下依赖项：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-log4j12<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.17<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ol>
<li>slf4j就是众多接口的集合，它不负责具体的日志实现，只在编译时负责寻找合适的日志系统进行绑定。具体有哪些接口，全部都定义在slf4j-api中。</li>
<li>slf4j-log4j12是链接slf4j-api和log4j中间的适配器。它实现了slf4j-apiz中StaticLoggerBinder接口，从而使得在编译时绑定的是slf4j-log4j12的getSingleton()方法</li>
<li>log4j是具体的日志系统。通过slf4j-log4j12初始化Log4j，达到最终日志的输出。</li>
<li>lombok：一个插件，封装了log的get和set，可以直接使用log来输出日志信息。</li>
</ol>
<h4 id="slf4j-1"><a href="#slf4j-1" class="headerlink" title="@slf4j"></a>@slf4j</h4><p>如果不想每次都写<code>private  final Logger logger = LoggerFactory.getLogger(XXX.class);</code> 可以用注解<code>@Slf4j</code></p>
<p>引入依赖，使用方式如上场景举例中代码示例</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.16.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="解决IDEA使用-Slf4j注入后找不到变量log"><a href="#解决IDEA使用-Slf4j注入后找不到变量log" class="headerlink" title="解决IDEA使用@Slf4j注入后找不到变量log"></a>解决IDEA使用@Slf4j注入后找不到变量log</h4><p>方式一：</p>
<p>idea中File –&gt; settings –&gt; Plugins –&gt; 点击”Browse repositories” –&gt; 搜索lombok –&gt; Install Lombok Plugins</p>
<p>若插件安装失败，则可以进行以下安装方式</p>
<p>方式二：</p>
<p>去idea官网下载插件 <a href="http://plugins.jetbrains.com/plugin/6317-lombok-plugin" target="_blank" rel="noopener">Lombok Plugin</a> ，到下载区，选择合适的版本下载，我的idea版本为2017.1.4，因此选择插件的版本号为<code>0.16-2017.1.4</code> 下载到文件为<code>lombok-plugin-0.16.zip</code></p>
<p>注：idea任何插件的版本都需要跟idea版本对应，否则会提示安装失败(本人踩过的坑)</p>
<p>安装步骤：解压下载到的zip文件，拷贝解压文件到idea安装目录下的<code>plugins</code>文件下，打开idea中的 plugins &gt; 选择 install plugin from disk &gt; 选择刚刚拷贝进去的文件夹中的jar，即可进行安装，安装完成后需要进行重启。</p>
<h3 id="Lombox"><a href="#Lombox" class="headerlink" title="Lombox"></a>Lombox</h3><h4 id="简介："><a href="#简介：" class="headerlink" title="简介："></a>简介：</h4><p><a href="https://projectlombok.org/" target="_blank" rel="noopener">Lombok</a>项目是一个java库，可以自动插入到您的编辑器和构建工具中，让您的java变得更加精彩。切勿再次写入另一个getter或equals方法。提前访问未来的Java功能<code>val</code>，等等。</p>
<p>除了官方介绍中，并不多相关文章，特意挑了<a href="https://blog.csdn.net/l_blackeagle/article/details/62041873" target="_blank" rel="noopener">一篇文章中相关内容</a></p>
<blockquote>
<p>lombok 提供了简单的注解的形式来帮助我们简化消除一些必须有但显得很臃肿的 java 代码。特别是相对于 POJO。<br>简单来说，比如我们新建了一个类，然后在其中写了几个字段，然后通常情况下我们需要手动去建立getter和setter方法啊，构造函数啊之类的，lombok的作用就是为了省去我们手动创建这些代码的麻烦，它能够在我们编译源码的时候自动帮我们生成这些方法。</p>
<p>lombok能够达到的效果就是在源码中不需要写一些通用的方法，但是在编译生成的字节码文件中会帮我们生成这些方法，这就是lombok的神奇作用。</p>
<p>虽然有人可能会说IDE里面都自带自动生成这些方法的功能，但是使用lombok会使你的代码看起来更加简洁，写起来也更加方便。</p>
</blockquote>
<h4 id="常用的注解"><a href="#常用的注解" class="headerlink" title="常用的注解"></a>常用的注解</h4><p>@slf4j、@Setter、@Getter、@NoArgsConstructor(注解在类上：为类提供一个无参的构造方法)、@AllArgsConstructor(注解在类上；为类提供一个全参的构造方法)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@NoArgsConstructor</span> <span class="comment">//注解在类上：为类提供一个无参的构造方法</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span><span class="comment">//注解在类上；为类提供一个全参的构造方法</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="comment">//@Getter @Setter 注解在属性上；为属性提供 setting 方法 getting方法</span></span><br><span class="line">    <span class="meta">@Setter</span> <span class="meta">@Getter</span> <span class="keyword">private</span> <span class="keyword">int</span> pid;</span><br><span class="line">    <span class="meta">@Setter</span> <span class="meta">@Getter</span> <span class="keyword">private</span> String pname;</span><br><span class="line">    <span class="meta">@Setter</span> <span class="meta">@Getter</span> <span class="keyword">private</span> <span class="keyword">int</span> sage;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </main>
    <footer class="post-footer">
      
    </footer>
  </article>
  
  <article class="index-post card" itemscope itemtype="http://schema.org/Article">
    <div class="post-block">
      <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/12/spring_security/4.SpringSecuritySession/">
      <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
        <meta itemprop="name" content="龙门小左">
        <meta itemprop="description" content="">
        <meta itemprop="image" content="/images/avatar.png">
      </span>
      <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
        <meta itemprop="name" content="程序猿的日常">
      </span>
    </div>
    <header class="post-header">
      <h1 class="post-title" itemprop="name headline">
        <a class="post-title-link post-title-link-external" href="/2018/07/12/spring_security/4.SpringSecuritySession/" itemprop="url">使用 Maven Module 搭建spring boot项目（整合Spring Security、Spring Social、spring OAuth）四</a>
      </h1>
      <div class="post-meta">
        
        <span class="post-date">
          <i class="far fa-calendar-plus"></i><span><time title="post-date" itemprop="dateCreated datePublished" datetime="2018-07-12T10:00:00+08:00">2018-07-12 10:00:00</time></span>
        </span>
        
        
        
      </div>
    </header>
    <main class="post-main" itemprop="articleBody">
      
      <h1 id="使用-Maven-Module-搭建spring-boot项目（整合Spring-Security、Spring-Social、spring-OAuth）四"><a href="#使用-Maven-Module-搭建spring-boot项目（整合Spring-Security、Spring-Social、spring-OAuth）四" class="headerlink" title="使用 Maven Module 搭建spring boot项目（整合Spring Security、Spring Social、spring OAuth）四"></a>使用 Maven Module 搭建spring boot项目（整合Spring Security、Spring Social、spring OAuth）四</h1><table>
<thead>
<tr>
<th>版本号</th>
<th>作者</th>
<th>日期</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>V0.1</td>
<td>huangz</td>
<td>2018-04-03</td>
<td>初稿</td>
</tr>
<tr>
<td>V0.2</td>
<td>huangz</td>
<td>2018-04-20</td>
<td>新增并发流程说明</td>
</tr>
<tr>
<td>V0.3</td>
<td>huangz</td>
<td>2018-04-25</td>
<td>解决session并发登录退出失效问题</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="Spring-boot-中应用-Spring-Session"><a href="#Spring-boot-中应用-Spring-Session" class="headerlink" title="Spring boot 中应用 Spring Session"></a>Spring boot 中应用 Spring Session</h2><p>spring session 只对浏览器环境下才生效,因此在浏览器项目中加入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.session<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-session<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="单机Session管理"><a href="#单机Session管理" class="headerlink" title="单机Session管理"></a>单机Session管理</h3><h4 id="Session-超时和并发处理"><a href="#Session-超时和并发处理" class="headerlink" title="Session 超时和并发处理"></a>Session 超时和并发处理</h4><h5 id="spring-session-配置"><a href="#spring-session-配置" class="headerlink" title="spring session 配置"></a>spring session 配置</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># session 默认30分钟超时</span><br><span class="line">server.session.timeout = 600</span><br></pre></td></tr></table></figure>
<p>若配置session超时时间少于1分钟,则会设置为1分钟,也就是60秒</p>
<p>设置超时时间源码分析:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.boot.context.embedded.tomcat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TomcatEmbeddedServletContainerFactory</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//配置session</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">configureSession</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//获得session的超时时间</span></span><br><span class="line">        <span class="keyword">long</span> sessionTimeout = <span class="keyword">this</span>.getSessionTimeoutInMinutes();</span><br><span class="line">        context.setSessionTimeout((<span class="keyword">int</span>)sessionTimeout);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.isPersistSession()) &#123;</span><br><span class="line">            Manager manager = context.getManager();</span><br><span class="line">            <span class="keyword">if</span> (manager == <span class="keyword">null</span>) &#123;</span><br><span class="line">                manager = <span class="keyword">new</span> StandardManager();</span><br><span class="line">                context.setManager((Manager)manager);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">this</span>.configurePersistSession((Manager)manager);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            context.addLifecycleListener(<span class="keyword">new</span> TomcatEmbeddedServletContainerFactory.DisablePersistSessionListener(<span class="keyword">null</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//获得session超时时间</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">long</span> <span class="title">getSessionTimeoutInMinutes</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> sessionTimeout = (<span class="keyword">long</span>)<span class="keyword">this</span>.getSessionTimeout();</span><br><span class="line">        <span class="keyword">if</span> (sessionTimeout &gt; <span class="number">0L</span>) &#123;</span><br><span class="line">            <span class="comment">//将秒数转化为分数,如果小与1则按1分钟算</span></span><br><span class="line">            sessionTimeout = Math.max(TimeUnit.SECONDS.toMinutes(sessionTimeout), <span class="number">1L</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> sessionTimeout;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Spring-Security-对-Session-过期处理"><a href="#Spring-Security-对-Session-过期处理" class="headerlink" title="Spring Security 对 Session 过期处理"></a>Spring Security 对 Session 过期处理</h5><p>spring-security-web包中提供了spring security 对session的管理，提供两个过滤器<code>ConcurrentSessionFilter</code>与<code>SessionManagementFilter</code></p>
<p>spring security对session过期的处理可以是</p>
<ol>
<li>配置session失效的处理url(注意要放开URL的权限)</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http.sessionManagement()</span><br><span class="line">    .invalidSessionUrl(URL)<span class="comment">//配置session失效跳转的url</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>配置seesion失效策略处理器(设置了处理器则配置失效的url就会失效)</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http.sessionManagement()</span><br><span class="line">    .invalidSessionUrl(URL)<span class="comment">//配置session失效跳转的url</span></span><br><span class="line">    .invalidSessionStrategy(invalidSessionStrategy)<span class="comment">//session过期处理器,invalidSessionUrl就会失效</span></span><br></pre></td></tr></table></figure>
<h5 id="Spring-Security-对-Session-并发处理"><a href="#Spring-Security-对-Session-并发处理" class="headerlink" title="Spring Security 对 Session 并发处理"></a>Spring Security 对 Session 并发处理</h5><p>控制用户在系统中只能有一个或指定个数的session</p>
<h6 id="并发处理的策略"><a href="#并发处理的策略" class="headerlink" title="并发处理的策略"></a>并发处理的策略</h6><ol>
<li>踢掉策略</li>
</ol>
<p>后登录的session会使前一个登录的session失效掉,通过以下配置实现,并且可配置因并发失效处理的URL</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//开启session管理功能</span></span><br><span class="line">		http.sessionManagement().maximumSessions(number)</span><br><span class="line">         	.expiredUrl(URL) <span class="comment">//处理返回给失效session的url</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>禁止策略</li>
</ol>
<p>禁止后登录的session登录进入,当前正在系统的session继续使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">http.sessionManagement().maximumSessions(number)</span><br><span class="line">         	.expiredUrl(URL) <span class="comment">//处理返回给失效session的url</span></span><br><span class="line">         	.maxSessionsPreventsLogin(<span class="keyword">true</span>) <span class="comment">//默认为false,不阻止登录</span></span><br><span class="line">         	<span class="comment">//.expiredSessionStrategy() 设置并发策略,则会让expiredUrl配置失效</span></span><br></pre></td></tr></table></figure>
<h5 id="实现Session过期与并发处理"><a href="#实现Session过期与并发处理" class="headerlink" title="实现Session过期与并发处理"></a>实现Session过期与并发处理</h5><p>1.定义自定义session属性配置,并将其加入<code>BrowserProperties</code>中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * session的配置</span><br><span class="line"> * created by chuIllusions_tan 20180322</span><br><span class="line"> */</span><br><span class="line">public class SessionProperties &#123;</span><br><span class="line">	</span><br><span class="line">	/**</span><br><span class="line">	 * 同一个用户在系统中的最大session数，默认1</span><br><span class="line">	 */</span><br><span class="line">	private int maximumSessions = 1;</span><br><span class="line">	/**</span><br><span class="line">	 * 达到最大session时是否阻止新的登录请求，默认为false，不阻止，新的登录会将老的登录失效掉</span><br><span class="line">	 */</span><br><span class="line">	private boolean maxSessionsPreventsLogin;</span><br><span class="line">	/**</span><br><span class="line">	 * session失效时跳转的地址</span><br><span class="line">	 */</span><br><span class="line">	private String sessionInvalidUrl = SecurityConstants.DEFAULT_SESSION_INVALID_URL;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BrowserProperties</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> SessionProperties session = <span class="keyword">new</span> SessionProperties();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>使用模板方法定义策略抽象类,抽取相同的处理逻辑</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用于处理session失效策略（踢掉策略 与 禁止登陆策略）</span></span><br><span class="line"><span class="comment"> * session失效包括两种情况：session 超时、session并发</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan 20180304</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractSessionStrategy</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 跳转的url</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> String destinationUrl;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 重定向策略</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> RedirectStrategy redirectStrategy = <span class="keyword">new</span> DefaultRedirectStrategy();</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 跳转前是否创建新的session</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> createNewSession = <span class="keyword">true</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> SecurityProperties securityPropertie;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> securityPropertie</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">AbstractSessionStrategy</span><span class="params">(SecurityProperties securityPropertie)</span> </span>&#123;</span><br><span class="line">		String invalidSessionUrl = securityPropertie.getBrowser().getSession().getSessionInvalidUrl();</span><br><span class="line">		Assert.isTrue(UrlUtils.isValidRedirectUrl(invalidSessionUrl), <span class="string">"url must start with '/' or with 'http(s)'"</span>);</span><br><span class="line">		<span class="comment">//Assert.isTrue(StringUtils.endsWithIgnoreCase(invalidSessionUrl, ".html"), "url must end with '.html'");</span></span><br><span class="line">		<span class="keyword">this</span>.destinationUrl = invalidSessionUrl;</span><br><span class="line">		<span class="keyword">this</span>.securityPropertie = securityPropertie;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onSessionInvalid</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (createNewSession) &#123;</span><br><span class="line">			request.getSession();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		String sourceUrl = request.getRequestURI();</span><br><span class="line">		String targetUrl;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (StringUtils.endsWithIgnoreCase(sourceUrl, <span class="string">".html"</span>)) &#123;</span><br><span class="line">			targetUrl = destinationUrl+<span class="string">".html"</span>;</span><br><span class="line">			logger.info(<span class="string">"session失效,跳转到"</span>+targetUrl);</span><br><span class="line">			redirectStrategy.sendRedirect(request, response, targetUrl);</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			Object result = buildResponseContent(request);</span><br><span class="line">			response.setStatus(HttpStatus.UNAUTHORIZED.value());</span><br><span class="line">			response.setContentType(<span class="string">"application/json;charset=UTF-8"</span>);</span><br><span class="line">			response.getWriter().write(objectMapper.writeValueAsString(result));</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> Object <span class="title">buildResponseContent</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">		String message = <span class="string">"session已失效"</span>;</span><br><span class="line">		<span class="keyword">if</span>(isConcurrency())&#123;</span><br><span class="line">			message = message + <span class="string">"，有可能是并发登录导致的"</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> SimpleResponse(message);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * session失效是否是并发导致的</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isConcurrency</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCreateNewSession</span><span class="params">(<span class="keyword">boolean</span> createNewSession)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.createNewSession = createNewSession;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>定义session失效策略,需要实现InvalidSessionStrategy接口</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 默认的session失效处理策略</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan on 20180308</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractInvalidSessionStrategy</span> <span class="keyword">extends</span> <span class="title">AbstractSessionStrategy</span> <span class="keyword">implements</span> <span class="title">InvalidSessionStrategy</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">AbstractInvalidSessionStrategy</span><span class="params">(SecurityProperties securityProperties)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(securityProperties);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onInvalidSessionDetected</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span></span><br><span class="line"><span class="function">			<span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">		onSessionInvalid(request, response);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>定义session并发策略</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 并发登录导致session失效时，默认的处理策略</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan on 20180308</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractExpiredSessionStrategy</span> <span class="keyword">extends</span> <span class="title">AbstractSessionStrategy</span> <span class="keyword">implements</span> <span class="title">SessionInformationExpiredStrategy</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">AbstractExpiredSessionStrategy</span><span class="params">(SecurityProperties securityPropertie)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(securityPropertie);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onExpiredSessionDetected</span><span class="params">(SessionInformationExpiredEvent event)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">		onSessionInvalid(event.getRequest(), event.getResponse());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 覆盖父类,证明其是并发登录的</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isConcurrency</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>策略bean的配置</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * session管理策略相关的扩展点配置。配置在这里的bean，业务系统都可以通过声明同类型或同名的bean来覆盖安全</span></span><br><span class="line"><span class="comment"> * 模块默认的配置。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan 20180308</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SessionStrategyBeanConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SecurityProperties securityProperties;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * session失效时的处理策略配置</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span>(InvalidSessionStrategy.class)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> InvalidSessionStrategy <span class="title">invalidSessionStrategy</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AbstractInvalidSessionStrategy(securityProperties);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 并发登录导致前一个session失效时的处理策略配置</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span>(SessionInformationExpiredStrategy.class)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> SessionInformationExpiredStrategy <span class="title">sessionInformationExpiredStrategy</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AbstractExpiredSessionStrategy(securityProperties);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="6">
<li>生成session配置</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 浏览器项目的安全配置</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan 20180227</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BrowserSecurityConfig</span>  <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line">	<span class="comment">//session失效策略</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> InvalidSessionStrategy invalidSessionStrategy;</span><br><span class="line">	<span class="comment">//session并发策略</span></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> SessionInformationExpiredStrategy sessionInformationExpiredStrategy;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 配置浏览器特有的安全配置，并且读取全局配置，加入spring security安全配置中</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> http</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//开启session管理功能</span></span><br><span class="line">		http.sessionManagement()</span><br><span class="line">				.invalidSessionStrategy(invalidSessionStrategy)<span class="comment">//session过期处理器</span></span><br><span class="line">				.maximumSessions(securityProperties.getBrowser().getSession().getMaximumSessions())<span class="comment">//用户最大session数</span></span><br><span class="line">				.maxSessionsPreventsLogin(securityProperties.getBrowser().getSession().isMaxSessionsPreventsLogin())<span class="comment">//是否阻止并发登录</span></span><br><span class="line">				.expiredSessionStrategy(sessionInformationExpiredStrategy);<span class="comment">//session并发处理器</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="流程整体描述"><a href="#流程整体描述" class="headerlink" title="流程整体描述"></a>流程整体描述</h5><p>​    <strong>session过期</strong></p>
<p>​    当ssesion过期时，自动进入自定义的session过去策略器。</p>
<p>​    <strong>session并发</strong></p>
<ol>
<li>当<code>maxSessionsPreventsLogin</code>配置为true时，即阻止并发登录，正在登录的用户正常使用，后登录的用户无法登入系统。当后登录用户发起登录请求时，通过过滤器的检验，发现已经出现了session并发，后登陆的用户会进入我们自定义的登录失败处理器中，并且<code>AuthenticationException</code>的实现类为<code>SessionAuthenticationException</code></li>
<li>当<code>maxSessionsPreventsLogin</code>配置为false时(默认)，不阻止并发登录，后登陆的用户B登入系统，但前面已经登录的用户A已经是失效状态。当用户A再发起请求时，则会进入自定义的session并发处理策略器中。</li>
</ol>
<h3 id="集群-Session-管理"><a href="#集群-Session-管理" class="headerlink" title="集群 Session 管理"></a>集群 Session 管理</h3><p><img src="images/session-jiqun.png" alt=""></p>
<h4 id="Spring-session对session存储方式的支持"><a href="#Spring-session对session存储方式的支持" class="headerlink" title="Spring session对session存储方式的支持"></a>Spring session对session存储方式的支持</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.boot.autoconfigure.session;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> StoreType &#123;</span><br><span class="line">	<span class="comment">//redis //存放在非关系型数据库</span></span><br><span class="line">    REDIS,</span><br><span class="line">	<span class="comment">//mongo</span></span><br><span class="line">    MONGO,</span><br><span class="line">	<span class="comment">//jdbc 存放在数据库中</span></span><br><span class="line">    JDBC,</span><br><span class="line">	<span class="comment">//跟redis类似</span></span><br><span class="line">    HAZELCAST,</span><br><span class="line">	<span class="comment">//放在本机内存</span></span><br><span class="line">    HASH_MAP,</span><br><span class="line">	<span class="comment">//使用默认session</span></span><br><span class="line">    NONE;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">StoreType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>使用Redis的原因:</strong></p>
<p>​    Session需要频繁访问，如果放在数据库中，会造成很大的压力；另外session会有一个时效性，超时时间，还要在数据库中进行清除。</p>
<p>​    Redis 特点就是对数据的存储会有一个过期的时间</p>
<h4 id="开启支持"><a href="#开启支持" class="headerlink" title="开启支持"></a>开启支持</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="comment">#使用了session管理</span></span><br><span class="line"><span class="attr">  session:</span></span><br><span class="line"><span class="attr">    store-type:</span> <span class="string">redis</span></span><br></pre></td></tr></table></figure>
<p><strong>注意</strong></p>
<p>此前我将生产的图片也存放在seesion中了,Image并未实现序列化借口,存放在redis中都数据需要被序列化,否则可能会抛出以下异常</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nested exception is java.lang.IllegalArgumentException: DefaultSerializer requires a Serializable payload but received an object of type [vic.security.core.validate.code.image.ImageCode]</span><br></pre></td></tr></table></figure>
<h2 id="Spring-Security-退出登录"><a href="#Spring-Security-退出登录" class="headerlink" title="Spring Security 退出登录"></a>Spring Security 退出登录</h2><p>Spring Security 默认的退出登录有指定的服务<code>/logout</code></p>
<h3 id="退出处理逻辑"><a href="#退出处理逻辑" class="headerlink" title="退出处理逻辑"></a>退出处理逻辑</h3><p>spring security 退出处理逻辑:</p>
<ol>
<li>使当前session失效</li>
<li>清除与当前用户相关的remember-me记录</li>
<li>清空当前的SecurityContext</li>
<li>重定向到登录页</li>
</ol>
<h3 id="相关配置"><a href="#相关配置" class="headerlink" title="相关配置"></a>相关配置</h3><p>spring security 提供类似于<code>AuthenticationSuccessHandler</code>登录成功处理器的<code>LogoutSuccessHandler</code>退出成功处理器</p>
<h4 id="自定义LogoutSuccessHandler"><a href="#自定义LogoutSuccessHandler" class="headerlink" title="自定义LogoutSuccessHandler"></a>自定义LogoutSuccessHandler</h4><ol>
<li>定义默认实现的退出成功处理器</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 默认的退出成功处理器，如果设置了turing.security.browser.signOutUrl，则跳到配置的地址上，</span></span><br><span class="line"><span class="comment"> * 如果没配置，则返回json格式的响应。</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan on 20180308</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractLogoutSuccessHandler</span> <span class="keyword">implements</span> <span class="title">LogoutSuccessHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String signOutSuccessUrl;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> ObjectMapper objectMapper;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">AbstractLogoutSuccessHandler</span><span class="params">(String signOutSuccessUrl)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.signOutSuccessUrl = signOutSuccessUrl;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLogoutSuccess</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span></span></span><br><span class="line"><span class="function">			<span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line"></span><br><span class="line">		logger.info(<span class="string">"退出成功"</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (StringUtils.isBlank(signOutSuccessUrl)) &#123;</span><br><span class="line">			response.setContentType(<span class="string">"application/json;charset=UTF-8"</span>);</span><br><span class="line">			response.setStatus(HttpStatus.OK.value());</span><br><span class="line">			response.getWriter().write(objectMapper.writeValueAsString(<span class="keyword">new</span> SimpleResponse(<span class="string">"退出成功"</span>)));</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			response.sendRedirect(signOutSuccessUrl);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setObjectMapper</span><span class="params">(ObjectMapper objectMapper)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.objectMapper = objectMapper;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li><code>AuthenticationHandlerBeanConfig.java</code>中添加可配置Bean</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 退出登录时跳转的策略</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean</span>(LogoutSuccessHandler.class)</span><br><span class="line"><span class="function"><span class="keyword">public</span> LogoutSuccessHandler <span class="title">logoutSuccessHandler</span><span class="params">()</span></span>&#123;</span><br><span class="line">	AbstractLogoutSuccessHandler abstractLogoutSuccessHandler= <span class="keyword">new</span> AbstractLogoutSuccessHandler(securityProperties.getBrowser().getSignOutUrl());</span><br><span class="line">	abstractLogoutSuccessHandler.setObjectMapper(objectMapper);</span><br><span class="line">	<span class="keyword">return</span> abstractLogoutSuccessHandler;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="加入总配置"><a href="#加入总配置" class="headerlink" title="加入总配置"></a>加入总配置</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 浏览器项目的安全配置</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * created by chuIllusions_tan 20180227</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BrowserSecurityConfig</span>  <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> LogoutSuccessHandler logoutSuccessHandler;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 配置浏览器特有的安全配置，并且读取全局配置，加入spring security安全配置中</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> http</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//退出登录管理</span></span><br><span class="line">		http.logout()</span><br><span class="line">				.logoutUrl(<span class="string">"/signOut"</span>)<span class="comment">//配置请求退出处理的URL,覆盖默认</span></span><br><span class="line">            	<span class="comment">//.logoutSuccessUrl("")</span></span><br><span class="line">				.logoutSuccessHandler(logoutSuccessHandler)<span class="comment">//配置了handler会使这条配置失效.logoutSuccessUrl("")</span></span><br><span class="line">				.deleteCookies(<span class="string">"JSESSIONID"</span>);<span class="comment">//其他操作</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Spring-Security-集合-Session-并发登录退出问题"><a href="#Spring-Security-集合-Session-并发登录退出问题" class="headerlink" title="Spring Security 集合 Session 并发登录退出问题"></a>Spring Security 集合 Session 并发登录退出问题</h2><h3 id="问题抛出"><a href="#问题抛出" class="headerlink" title="问题抛出"></a>问题抛出</h3><p>​    当请求退出登录时，成功退出跳转到登录页面，再次进行登录，无法进行登录，提示用户已经登录，存在session并发问题（理想状态下，退出成功之后，再次登录，不存在并发问题，进入系统）</p>
<h3 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h3><p>查看源码进行分析：</p>
<p><code>LogoutFilter.java</code>检验退出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogoutFilter</span> <span class="keyword">extends</span> <span class="title">GenericFilterBean</span> </span>&#123;</span><br><span class="line">    <span class="comment">//退出登录后进行拦截处理</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest req, ServletResponse res, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        HttpServletRequest request = (HttpServletRequest)req;</span><br><span class="line">        HttpServletResponse response = (HttpServletResponse)res;</span><br><span class="line">        <span class="comment">//判断请求是否是需要退出登录</span></span><br><span class="line">        <span class="comment">//请求是退出登录则进入逻辑处理</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.requiresLogout(request, response)) &#123;</span><br><span class="line">            Authentication auth = SecurityContextHolder.getContext().getAuthentication();</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.logger.isDebugEnabled()) &#123;</span><br><span class="line">                <span class="keyword">this</span>.logger.debug(<span class="string">"Logging out user '"</span> + auth + <span class="string">"' and transferring to logout destination"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">			<span class="comment">//处理退出</span></span><br><span class="line">            <span class="keyword">this</span>.handler.logout(request, response, auth);</span><br><span class="line">            <span class="comment">//退出成功</span></span><br><span class="line">            <span class="keyword">this</span>.logoutSuccessHandler.onLogoutSuccess(request, response, auth);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            chain.doFilter(request, response);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>SecurityContextLogoutHandler.java</code>  处理退出逻辑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityContextLogoutHandler</span> <span class="keyword">implements</span> <span class="title">LogoutHandler</span> </span>&#123;</span><br><span class="line">	<span class="comment">//处理退出</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">logout</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span> </span>&#123;</span><br><span class="line">        Assert.notNull(request, <span class="string">"HttpServletRequest required"</span>);</span><br><span class="line">        <span class="comment">//销毁session</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.invalidateHttpSession) &#123;</span><br><span class="line">            HttpSession session = request.getSession(<span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (session != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">this</span>.logger.debug(<span class="string">"Invalidating session: "</span> + session.getId());</span><br><span class="line">                session.invalidate();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">//销毁认证信息</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.clearAuthentication) &#123;</span><br><span class="line">            SecurityContext context = SecurityContextHolder.getContext();</span><br><span class="line">            context.setAuthentication((Authentication)<span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">//清空Context</span></span><br><span class="line">        SecurityContextHolder.clearContext();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>ConcurrentSessionControlAuthenticationStrategy.java</code>验证session并发</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcurrentSessionControlAuthenticationStrategy</span> <span class="keyword">implements</span> <span class="title">MessageSourceAware</span>, <span class="title">SessionAuthenticationStrategy</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAuthentication</span><span class="params">(Authentication authentication, HttpServletRequest request, HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//问题关键就在于这一行</span></span><br><span class="line">        <span class="comment">//拿到当前存档的所有该用户的登录信息</span></span><br><span class="line">        List&lt;SessionInformation&gt; sessions = <span class="keyword">this</span>.sessionRegistry.getAllSessions(authentication.getPrincipal(), <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">int</span> sessionCount = sessions.size();</span><br><span class="line">        <span class="keyword">int</span> allowedSessions = <span class="keyword">this</span>.getMaximumSessionsForThisUser(authentication);</span><br><span class="line">        <span class="comment">//判断是否session数超过了限制数</span></span><br><span class="line">        <span class="keyword">if</span> (sessionCount &gt;= allowedSessions) &#123;</span><br><span class="line">            <span class="keyword">if</span> (allowedSessions != -<span class="number">1</span>) &#123;</span><br><span class="line">               </span><br><span class="line">                <span class="keyword">if</span> (sessionCount == allowedSessions) &#123;</span><br><span class="line">                    HttpSession session = request.getSession(<span class="keyword">false</span>);</span><br><span class="line">                    <span class="keyword">if</span> (session != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        Iterator var8 = sessions.iterator();</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">while</span>(var8.hasNext()) &#123;</span><br><span class="line">                            SessionInformation si = (SessionInformation)var8.next();</span><br><span class="line">                            <span class="keyword">if</span> (si.getSessionId().equals(session.getId())) &#123;</span><br><span class="line">                                <span class="keyword">return</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">				<span class="comment">//超过则扔出异常</span></span><br><span class="line">                <span class="keyword">this</span>.allowableSessionsExceeded(sessions, allowedSessions, <span class="keyword">this</span>.sessionRegistry);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>SessionRegistryImpl.java</code> 用户对应的session信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SessionRegistryImpl</span> <span class="keyword">implements</span> <span class="title">SessionRegistry</span>,</span></span><br><span class="line"><span class="class">		<span class="title">ApplicationListener</span>&lt;<span class="title">SessionDestroyedEvent</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">final</span> Log logger = LogFactory.getLog(SessionRegistryImpl.class);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** &lt;principal:Object,SessionIdSet&gt; */</span></span><br><span class="line">    <span class="comment">//存放一个用户对应多个session</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;Object, Set&lt;String&gt;&gt; principals = <span class="keyword">new</span> ConcurrentHashMap&lt;Object, Set&lt;String&gt;&gt;();</span><br><span class="line">	<span class="comment">/** &lt;sessionId:Object,SessionInformation&gt; */</span></span><br><span class="line">    <span class="comment">//存放session对应的用户信息        </span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, SessionInformation&gt; sessionIds = <span class="keyword">new</span> ConcurrentHashMap&lt;String, SessionInformation&gt;();</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> List&lt;Object&gt; <span class="title">getAllPrincipals</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> ArrayList&lt;Object&gt;(principals.keySet());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//根据用户，获取用户的所有session</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> List&lt;SessionInformation&gt; <span class="title">getAllSessions</span><span class="params">(Object principal,</span></span></span><br><span class="line"><span class="function"><span class="params">			<span class="keyword">boolean</span> includeExpiredSessions)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">final</span> Set&lt;String&gt; sessionsUsedByPrincipal = principals.get(principal);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (sessionsUsedByPrincipal == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		List&lt;SessionInformation&gt; list = <span class="keyword">new</span> ArrayList&lt;SessionInformation&gt;(</span><br><span class="line">				sessionsUsedByPrincipal.size());</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (String sessionId : sessionsUsedByPrincipal) &#123;</span><br><span class="line">			SessionInformation sessionInformation = getSessionInformation(sessionId);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (sessionInformation == <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (includeExpiredSessions || !sessionInformation.isExpired()) &#123;</span><br><span class="line">				list.add(sessionInformation);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> list;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//重要</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(SessionDestroyedEvent event)</span> </span>&#123;</span><br><span class="line">		String sessionId = event.getId();</span><br><span class="line">		removeSessionInformation(sessionId);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​    通过源码分析，根于找到了。当用户退出登录的时候，session进行了销毁，但是SessionRegistryImpl中维护的session对应的用户信息以及用户所对应的所有session并未清除，也就是说当退出的时候没有清除SessionRegistryImpl中principals、sessionIds两个集合的对应内容。</p>
<p>​    问题的根源就是没有进行退出时的数据清除。再看SessionRegistryImpl中实现了<code>ApplicationListener&lt;SessionDestroyedEvent&gt;</code>接口，并覆盖了方法，如下实现，但是经过断点测试，发现并未进入，说明监听失效。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//重要</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(SessionDestroyedEvent event)</span> </span>&#123;</span><br><span class="line">		String sessionId = event.getId();</span><br><span class="line">        <span class="comment">//进行两个集合的清除</span></span><br><span class="line">		removeSessionInformation(sessionId);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h3 id="问题解决"><a href="#问题解决" class="headerlink" title="问题解决"></a>问题解决</h3><p>​    细心发现<code>SessionRegistryImpl</code>类注释中有下面这一段解析：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Default implementation of</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> org.springframework.security.core.session.SessionRegistry SessionRegistry&#125; which</span></span><br><span class="line"><span class="comment"> * listens for &#123;<span class="doctag">@link</span> org.springframework.security.core.session.SessionDestroyedEvent</span></span><br><span class="line"><span class="comment"> * SessionDestroyedEvent&#125;s published in the Spring application context.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * For this class to function correctly in a web application, it is important that you</span></span><br><span class="line"><span class="comment"> * register an &lt;a href="&#123;<span class="doctag">@docRoot</span>&#125;/org/springframework/security/web/session/HttpSessionEventPublisher.html"&gt;HttpSessionEventPublisher&lt;/a&gt;</span></span><br><span class="line"><span class="comment"> * in the &lt;tt&gt;web.xml&lt;/tt&gt; file so that this class is notified of sessions that expire.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Ben Alex</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Luke Taylor</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SessionRegistryImpl</span> <span class="keyword">implements</span> <span class="title">SessionRegistry</span>,</span></span><br><span class="line"><span class="class">		<span class="title">ApplicationListener</span>&lt;<span class="title">SessionDestroyedEvent</span>&gt; </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>​    说为了让<code>SessionDestroyedEvent</code>功能在环境中正确利用，需要注册一个<code>HttpSessionEventPublisher</code>以便这个类能够通知seesion事件</p>
<p>添加该类的默认实现，问题即可解决：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 配置session 监听接口</span></span><br><span class="line"><span class="comment">	 * 目前作用 用于监听session失效进入session并发处理</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> HttpSessionEventPublisher <span class="title">sessionEventPubulisher</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span>  <span class="keyword">new</span> HttpSessionEventPublisher();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </main>
    <footer class="post-footer">
      
    </footer>
  </article>
  
  <article class="index-post card" itemscope itemtype="http://schema.org/Article">
    <div class="post-block">
      <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/26/docker/docker_dbe_/">
      <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
        <meta itemprop="name" content="龙门小左">
        <meta itemprop="description" content="">
        <meta itemprop="image" content="/images/avatar.png">
      </span>
      <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
        <meta itemprop="name" content="程序猿的日常">
      </span>
    </div>
    <header class="post-header">
      <h1 class="post-title" itemprop="name headline">
        <a class="post-title-link post-title-link-external" href="/2018/06/26/docker/docker_dbe_/" itemprop="url">docker  一台虚拟机安装部署分布式web 前后端分离集群</a>
      </h1>
      <div class="post-meta">
        
        <span class="post-date">
          <i class="far fa-calendar-plus"></i><span><time title="post-date" itemprop="dateCreated datePublished" datetime="2018-06-26T10:00:00+08:00">2018-06-26 10:00:00</time></span>
        </span>
        
        
        
      </div>
    </header>
    <main class="post-main" itemprop="articleBody">
      
      <h1 id="docker-安装部署分布式web-前后端分离集群"><a href="#docker-安装部署分布式web-前后端分离集群" class="headerlink" title="docker  安装部署分布式web 前后端分离集群"></a>docker  安装部署分布式web 前后端分离集群</h1><table>
<thead>
<tr>
<th style="text-align:center">版本</th>
<th style="text-align:center">作者</th>
<th style="text-align:center">内容</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">2018.06.29</td>
<td style="text-align:center">huangzuo</td>
<td style="text-align:center">首次发布</td>
</tr>
</tbody>
</table>
<h3 id="学习内容简介"><a href="#学习内容简介" class="headerlink" title="学习内容简介"></a>学习内容简介</h3><p>   相关课程指令脚本可以在百度云下载<br><a href="https://pan.baidu.com/s/15aVny_MRi0AQBQJE7myUOg" target="_blank" rel="noopener">https://pan.baidu.com/s/15aVny_MRi0AQBQJE7myUOg</a> 密码：j413</p>
<pre><code>本章节主要大概介绍如何使用docker虚拟机，部署分布式web 前后端分离集群，包过
1、人人网开源前后端分离项目
2、配置docker加载器
3、安装mysql pxc集群
4、安装redis 集群
5、部署后端的项目
6、安装ngxin 集群
7、前端项目部署与负载均衡
8、多台虚拟机安装docker sware 集群
9、界面安装
</code></pre><h3 id="人人网开源前后端分离项目"><a href="#人人网开源前后端分离项目" class="headerlink" title="人人网开源前后端分离项目"></a>人人网开源前后端分离项目</h3><p>地址: <a href="http://www.renren.io/,项目renren-fast" target="_blank" rel="noopener">http://www.renren.io/,项目renren-fast</a> </p>
<p>功能:<br><img src="images/renren.jpg" alt=""></p>
<h3 id="配置docker加载器"><a href="#配置docker加载器" class="headerlink" title="配置docker加载器"></a>配置docker加载器</h3><p>由于docker仓库在国外，需要配置国内远程镜像加速下载速度<br>访问地址:<a href="https://www.daocloud.io/" target="_blank" rel="noopener">https://www.daocloud.io/</a> 注册账号<br>执行对应的语句<br><img src="images/docker1.jpg" alt=""></p>
<h3 id="几个重要的docker指令"><a href="#几个重要的docker指令" class="headerlink" title="几个重要的docker指令"></a>几个重要的docker指令</h3><h4 id="查看容器运行日志"><a href="#查看容器运行日志" class="headerlink" title="查看容器运行日志"></a>查看容器运行日志</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker logs -f -t --tail 10 h1</span><br><span class="line"></span><br><span class="line">docker logs h1</span><br></pre></td></tr></table></figure>
<p>h1:容器名称</p>
<p>10:最近10行</p>
<h4 id="进入容器"><a href="#进入容器" class="headerlink" title="进入容器"></a>进入容器</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it h1 bash</span><br></pre></td></tr></table></figure>
<h3 id="mysql-pxc集群安装"><a href="#mysql-pxc集群安装" class="headerlink" title="mysql pxc集群安装"></a>mysql pxc集群安装</h3><h4 id="下载pxc"><a href="#下载pxc" class="headerlink" title="下载pxc"></a>下载pxc</h4><p>访问网站<a href="https://hub.docker.com/r/percona/percona-xtradb-cluster/" target="_blank" rel="noopener">https://hub.docker.com/r/percona/percona-xtradb-cluster/</a> 里面有关percona/percona-xtradb-cluster集群安装相关描述<br>xshell 执行下面代码，下载镜像<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull percona/percona-xtradb-cluster</span><br></pre></td></tr></table></figure></p>
<p>修改容器名称，删除原来的容器</p>
<p>修改<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker tag docker.io/percona-xtradb-cluster pxc</span><br></pre></td></tr></table></figure></p>
<p>删除<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rm docker.io/percona-xtradb-cluster</span><br></pre></td></tr></table></figure></p>
<h4 id="安装mysql集群"><a href="#安装mysql集群" class="headerlink" title="安装mysql集群"></a>安装mysql集群</h4><p>在一台服务器安装5个pxc容器，即5台数据库，修改其中一台数据库的信息，其他四台也会同步修改</p>
<h5 id="设置网段"><a href="#设置网段" class="headerlink" title="设置网段"></a>设置网段</h5><p>处于安全考虑，需要给PXC集群实例创建docker内部网络<br>创建<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network create net1</span><br></pre></td></tr></table></figure></p>
<p>查看<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network inspect net1</span><br></pre></td></tr></table></figure></p>
<p>删除<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network rm net1</span><br></pre></td></tr></table></figure></p>
<p>默认的网段是172.17.0.0 ，可以设置自己的网段<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network create --subnet=172.18.0.0/24 net1</span><br></pre></td></tr></table></figure></p>
<h5 id="创建docker卷"><a href="#创建docker卷" class="headerlink" title="创建docker卷"></a>创建docker卷</h5><p>容器是一个独立的空间，可编辑、删除等操作，为了保存容器的数据，需要把数据的路径映射到宿主机目录下。即把容器中的数据保存在宿主机中，就算容器被删数据还是保留下来</p>
<p>创建docker卷语句<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker volume create v1</span><br></pre></td></tr></table></figure></p>
<p>查看docker卷，可知道在宿主机的目录<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker volume inspect v1</span><br></pre></td></tr></table></figure></p>
<p><img src="images/docker2.jpg" alt=""><br>删除docker卷<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker volume rm v1</span><br></pre></td></tr></table></figure></p>
<h5 id="创建pxc容器集群"><a href="#创建pxc容器集群" class="headerlink" title="创建pxc容器集群"></a>创建pxc容器集群</h5><p>创建pxc容器集群：第一个pxc容器和其他容器不一样</p>
<h6 id="创建第一个pxc容器"><a href="#创建第一个pxc容器" class="headerlink" title="创建第一个pxc容器"></a>创建第一个pxc容器</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 3307:3306 -e MYSQL_ROOT_PASSWORD=root -e CLUSTER_NAME=PXC -e XTRABACKUP_PASSWORD=root -v v1:/var/lib/mysql -v backup:/data --privileged --name=node1 --net=net1 --ip 172.18.0.2 pxc</span><br></pre></td></tr></table></figure>
<p>3307:3306:3307是宿主机端口，3306为容器mysql端口，为了在外面能访问到容器mysql，需要把端口映射到宿主机上</p>
<p>1、MYSQL_ROOT_PASSWORD=root：设置mysql 的root账户密码</p>
<p>2、CLUSTER_NAME=PXC:集群名称</p>
<p>3、XTRABACKUP_PASSWORD=root:mysql 之间通讯的密码</p>
<p>4、-v v1:/var/lib/mysql -v backup:/data :v1是docker卷,映射宿主机docker卷和容器的目录，每一个容器一个docker卷</p>
<p>5、–privileged:赋予容器修改宿主机目录文件的权限</p>
<p>6、–name=node1:容器名称</p>
<p>7、–net=net1 –ip 172.18.0.2:网络ip地址</p>
<p>8、pxc:镜像名称</p>
<h6 id="创建其他pxc容器"><a href="#创建其他pxc容器" class="headerlink" title="创建其他pxc容器"></a>创建其他pxc容器</h6><p>创建其他容器和第一个容器有所不同，主要添加CLUSTER_JOIN=node1 ，意思是和node1（第一个容器）容器同步数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 3308:3306 -e MYSQL_ROOT_PASSWORD=root -e CLUSTER_NAME=PXC -e XTRABACKUP_PASSWORD=root  -e  CLUSTER_JOIN=node1 -v v2:/var/lib/mysql -v backup:/data --privileged --name=node2 --net=net1 --ip 172.18.0.3 pxc</span><br><span class="line"></span><br><span class="line">docker run -d -p 3309:3306 -e MYSQL_ROOT_PASSWORD=root -e CLUSTER_NAME=PXC -e XTRABACKUP_PASSWORD=root  -e  CLUSTER_JOIN=node1 -v v3:/var/lib/mysql -v backup:/data --privileged --name=node3 --net=net1 --ip 172.18.0.4 pxc</span><br><span class="line"></span><br><span class="line">docker run -d -p 3310:3306 -e MYSQL_ROOT_PASSWORD=root -e CLUSTER_NAME=PXC -e XTRABACKUP_PASSWORD=root  -e  CLUSTER_JOIN=node1 -v v4:/var/lib/mysql -v backup:/data --privileged --name=node4 --net=net1 --ip 172.18.0.5 pxc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker run -d -p 3311:3306 -e MYSQL_ROOT_PASSWORD=root -e CLUSTER_NAME=PXC -e XTRABACKUP_PASSWORD=root  -e  CLUSTER_JOIN=node1 -v v5:/var/lib/mysql -v backup:/data --privileged --name=node5 --net=net1 --ip 172.18.0.6 pxc</span><br></pre></td></tr></table></figure>
<p>注意事项<br>1、3308:3306:3308宿主机的端口不能相同，每台映射到宿主机的端口都不一样</p>
<p>2、 CLUSTER_JOIN=node1:添加关联第一台容器</p>
<p>3、 -v v2:/var/lib/mysql：v2是docker卷,每台容器docker卷都不一样</p>
<p>4、–name=node2:每台容器名称都不一样</p>
<p>5、–net=net1 –ip 172.18.0.3:每台容器ip地址不一样</p>
<h5 id="测试集群"><a href="#测试集群" class="headerlink" title="测试集群"></a>测试集群</h5><p>pxc集群安装完，使用navicat连接数据库测试，注意连接对应的映射宿主机端口号，只要修改其中一台数据库的数据，其他数据库也会同步发生变化<br><img src="images/docker4.jpg" alt=""></p>
<h3 id="数据库负载均衡"><a href="#数据库负载均衡" class="headerlink" title="数据库负载均衡"></a>数据库负载均衡</h3><h4 id="负载均衡的必要性"><a href="#负载均衡的必要性" class="headerlink" title="负载均衡的必要性"></a>负载均衡的必要性</h4><p>pxc集群有多台数据库，如何能做到用户均匀访问不同数据库，提高网站访问并发量和性能、高可用？？</p>
<p><img src="images/docker5.jpg" alt=""></p>
<h4 id="Haproxy中间件做负载均衡"><a href="#Haproxy中间件做负载均衡" class="headerlink" title="Haproxy中间件做负载均衡"></a>Haproxy中间件做负载均衡</h4><p>haproxy 只做转发，均匀转发访问到不同数据库</p>
<p><img src="images/docker6.jpg" alt=""></p>
<h4 id="中间件比较"><a href="#中间件比较" class="headerlink" title="中间件比较"></a>中间件比较</h4><p><img src="images/docker7.jpg" alt=""></p>
<h4 id="docker安装Haproxy镜像"><a href="#docker安装Haproxy镜像" class="headerlink" title="docker安装Haproxy镜像"></a>docker安装Haproxy镜像</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull haproxy</span><br></pre></td></tr></table></figure>
<h4 id="设置Haproxy配置文件"><a href="#设置Haproxy配置文件" class="headerlink" title="设置Haproxy配置文件"></a>设置Haproxy配置文件</h4><p>在宿主机上创建Haproxy 配置文件，haproxy.cfg文件在百度云相关指令上</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">touch /home/soft/haproxy.cfg</span><br></pre></td></tr></table></figure>
<p>通过映射方式到haproxy容器目录中，haproxy.cfg详情需要参考网站<a href="https://zhangge.net/5125.html" target="_blank" rel="noopener">https://zhangge.net/5125.html</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">global</span><br><span class="line">	<span class="comment">#工作目录</span></span><br><span class="line">	chroot /usr/<span class="built_in">local</span>/etc/haproxy</span><br><span class="line">	<span class="comment">#日志文件，使用rsyslog服务中local5日志设备（/var/log/local5），等级info</span></span><br><span class="line">	<span class="built_in">log</span> 127.0.0.1 local5 info</span><br><span class="line">	<span class="comment">#守护进程运行</span></span><br><span class="line">	daemon</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">	<span class="built_in">log</span>	global</span><br><span class="line">	mode	http</span><br><span class="line">	<span class="comment">#日志格式</span></span><br><span class="line">	option	httplog</span><br><span class="line">	<span class="comment">#日志中不记录负载均衡的心跳检测记录</span></span><br><span class="line">	option	dontlognull</span><br><span class="line">    <span class="comment">#连接超时（毫秒）</span></span><br><span class="line">	timeout connect 5000</span><br><span class="line">    <span class="comment">#客户端超时（毫秒）</span></span><br><span class="line">	timeout client  50000</span><br><span class="line">	<span class="comment">#服务器超时（毫秒）</span></span><br><span class="line">    timeout server  50000</span><br><span class="line"></span><br><span class="line"><span class="comment">#监控界面	</span></span><br><span class="line">listen  admin_stats</span><br><span class="line">	<span class="comment">#监控界面的访问的IP和端口</span></span><br><span class="line">	<span class="built_in">bind</span>  0.0.0.0:8888</span><br><span class="line">	<span class="comment">#访问协议</span></span><br><span class="line">    mode        http</span><br><span class="line">	<span class="comment">#URI相对地址</span></span><br><span class="line">    stats uri   /dbs</span><br><span class="line">	<span class="comment">#统计报告格式</span></span><br><span class="line">    stats realm     Global\ statistics</span><br><span class="line">	<span class="comment">#登陆帐户信息</span></span><br><span class="line">    stats auth  admin:admin</span><br><span class="line"><span class="comment">#数据库负载均衡</span></span><br><span class="line">listen  proxy-mysql</span><br><span class="line">	<span class="comment">#访问的IP和端口</span></span><br><span class="line">	<span class="built_in">bind</span>  0.0.0.0:3306  </span><br><span class="line">    <span class="comment">#网络协议</span></span><br><span class="line">	mode  tcp</span><br><span class="line">	<span class="comment">#负载均衡算法（轮询算法）</span></span><br><span class="line">	<span class="comment">#轮询算法：roundrobin</span></span><br><span class="line">	<span class="comment">#权重算法：static-rr</span></span><br><span class="line">	<span class="comment">#最少连接算法：leastconn</span></span><br><span class="line">	<span class="comment">#请求源IP算法：source </span></span><br><span class="line">    balance  roundrobin</span><br><span class="line">	<span class="comment">#日志格式</span></span><br><span class="line">    option  tcplog</span><br><span class="line">	<span class="comment">#在MySQL中创建一个没有权限的haproxy用户，密码为空。Haproxy使用这个账户对MySQL数据库心跳检测</span></span><br><span class="line">    option  mysql-check user haproxy</span><br><span class="line">    server  MySQL_1 172.18.0.2:3306 check weight 1 maxconn 2000  </span><br><span class="line">    server  MySQL_2 172.18.0.3:3306 check weight 1 maxconn 2000  </span><br><span class="line">	server  MySQL_3 172.18.0.4:3306 check weight 1 maxconn 2000 </span><br><span class="line">	server  MySQL_4 172.18.0.5:3306 check weight 1 maxconn 2000</span><br><span class="line">	server  MySQL_5 172.18.0.6:3306 check weight 1 maxconn 2000</span><br><span class="line">	<span class="comment">#使用keepalive检测死链</span></span><br><span class="line">    option  tcpka</span><br></pre></td></tr></table></figure></p>
<p>主要是关注下面和数据库有关的配置<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">listen  proxy-mysql</span><br><span class="line">	<span class="comment">#访问的IP和端口</span></span><br><span class="line">	<span class="built_in">bind</span>  0.0.0.0:3306  </span><br><span class="line">    <span class="comment">#网络协议</span></span><br><span class="line">	mode  tcp</span><br><span class="line">	<span class="comment">#负载均衡算法（轮询算法）</span></span><br><span class="line">	<span class="comment">#轮询算法：roundrobin</span></span><br><span class="line">	<span class="comment">#权重算法：static-rr</span></span><br><span class="line">	<span class="comment">#最少连接算法：leastconn</span></span><br><span class="line">	<span class="comment">#请求源IP算法：source </span></span><br><span class="line">    balance  roundrobin</span><br><span class="line">	<span class="comment">#日志格式</span></span><br><span class="line">    option  tcplog</span><br><span class="line">	<span class="comment">#在MySQL中创建一个没有权限的haproxy用户，密码为空。Haproxy使用这个账户对MySQL数据库心跳检测</span></span><br><span class="line">    option  mysql-check user haproxy</span><br><span class="line">    server  MySQL_1 172.18.0.2:3306 check weight 1 maxconn 2000  </span><br><span class="line">    server  MySQL_2 172.18.0.3:3306 check weight 1 maxconn 2000  </span><br><span class="line">	server  MySQL_3 172.18.0.4:3306 check weight 1 maxconn 2000 </span><br><span class="line">	server  MySQL_4 172.18.0.5:3306 check weight 1 maxconn 2000</span><br><span class="line">	server  MySQL_5 172.18.0.6:3306 check weight 1 maxconn 2000</span><br><span class="line">	<span class="comment">#使用keepalive检测死链</span></span><br></pre></td></tr></table></figure></p>
<p>bind  0.0.0.0:3306:表示所有的ip地址都能访问数据库的3306端口</p>
<p>balance  roundrobin:负载均衡分发的请求算法</p>
<p>option  mysql-check user haproxy:需要检测haproxy 和数据库直接的连接，在MySQL中创建一个没有权限的haproxy用户，密码为空。Haproxy使用这个账户对MySQL数据库心跳检测</p>
<p>server  MySQL_1 172.18.0.2:3306 check weight 1 maxconn 2000  :MySQL数据库心跳检测</p>
<h4 id="创建mysql没有权限的haproxy用户，密码为空"><a href="#创建mysql没有权限的haproxy用户，密码为空" class="headerlink" title="创建mysql没有权限的haproxy用户，密码为空"></a>创建mysql没有权限的haproxy用户，密码为空</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create user <span class="string">'haproxy'</span>@<span class="string">'%'</span> IDENTIFIED BY <span class="string">''</span>;</span><br></pre></td></tr></table></figure>
<h4 id="创建Haproxy容器"><a href="#创建Haproxy容器" class="headerlink" title="创建Haproxy容器"></a>创建Haproxy容器</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建第1个Haproxy负载均衡服务器</span></span><br><span class="line">docker run -it -d -p 4001:8888 -p 4002:3306 -v /home/soft/haproxy:/usr/<span class="built_in">local</span>/etc/haproxy --name h1 --privileged --net=net1 --ip 172.18.0.7 haproxy</span><br><span class="line"><span class="comment">#进入h1容器，启动Haproxy</span></span><br><span class="line">docker <span class="built_in">exec</span> -it h1 bash</span><br><span class="line">haproxy -f /usr/<span class="built_in">local</span>/etc/haproxy/haproxy.cfg</span><br><span class="line"><span class="comment">#创建第2个Haproxy负载均衡服务器</span></span><br><span class="line">docker run -it -d -p 4003:8888 -p 4004:3306 -v /home/soft/haproxy:/usr/<span class="built_in">local</span>/etc/haproxy --name h2 --privileged --net=net1 --ip 172.18.0.8 haproxy</span><br><span class="line"><span class="comment">#进入h2容器，启动Haproxy</span></span><br><span class="line">docker <span class="built_in">exec</span> -it h2 bash</span><br><span class="line">haproxy -f /usr/<span class="built_in">local</span>/etc/haproxy/haproxy.cfg</span><br></pre></td></tr></table></figure>
<p>访问haproxy 第一个容器页面，账户密码在haproxy.cfg里面-登陆帐户信息<br>stats auth  admin:admin，我设置了admin/admin<br><a href="http://192.168.157.129:4001/dbs" target="_blank" rel="noopener">http://192.168.157.129:4001/dbs</a></p>
<p><img src="images/docker8.jpg" alt=""></p>
<p>在 navicat新建数据库连接h1， 端口号是上面对应的宿主机端口(h1是4002)和ip地址，账号密码是数据库账号密码，新增数据可以看到在node1到node5都有了数据，说明配置成功</p>
<p><img src="images/docker9.jpg" alt=""></p>
<h4 id="Haproxy高可用，创建多个haproxy"><a href="#Haproxy高可用，创建多个haproxy" class="headerlink" title="Haproxy高可用，创建多个haproxy"></a>Haproxy高可用，创建多个haproxy</h4><p>  单节点的haproxy没有高可用性能，单个haproxy挂了，整个服务就挂了<br>  <img src="images/docker10.jpg" alt=""><br>  多节点haproxy安装需要用到Keepalived，多节点会争抢虚拟ip，抢到的节点作为主节点运行，其他节点作为备份，节点之间发送心跳检测，当主节点挂了，其他备份节点会争抢成为主节点，实现高可用<br>    <img src="images/docker11.jpg" alt=""><br>  多节点haproxy方案<br>    <img src="images/docker12.jpg" alt=""></p>
<h4 id="Haproxy容器内安装Keepalived，设置虚拟IP"><a href="#Haproxy容器内安装Keepalived，设置虚拟IP" class="headerlink" title="Haproxy容器内安装Keepalived，设置虚拟IP"></a>Haproxy容器内安装Keepalived，设置虚拟IP</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#进入h1容器</span></span><br><span class="line">docker <span class="built_in">exec</span> -it h1 bash</span><br><span class="line"><span class="comment">#更新软件包</span></span><br><span class="line">apt-get update</span><br><span class="line"><span class="comment">#安装VIM</span></span><br><span class="line">apt-get install vim</span><br><span class="line"><span class="comment">#安装Keepalived</span></span><br><span class="line">apt-get install keepalived</span><br><span class="line"><span class="comment">#编辑Keepalived配置文件（参考下方配置文件）</span></span><br><span class="line">vim /etc/keepalived/keepalived.conf</span><br><span class="line"><span class="comment">#启动Keepalived</span></span><br><span class="line">service keepalived start</span><br><span class="line"><span class="comment">#宿主机执行ping命令</span></span><br><span class="line">ping 172.18.0.201</span><br></pre></td></tr></table></figure>
<p>keepalived.conf 配置文件 争抢虚拟IP<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">vrrp_instance  VI_1 &#123;</span><br><span class="line">    state  MASTER</span><br><span class="line">    interface  eth0</span><br><span class="line">    virtual_router_id  51</span><br><span class="line">    priority  100</span><br><span class="line">    advert_int  1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type  PASS</span><br><span class="line">        auth_pass  123456</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        172.18.0.201</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>配置文件解析<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">VI_1:配置信息的名字，可以修改</span><br><span class="line"></span><br><span class="line">state  MASTER:Keepalived节点身份信息-MASTER主服务（可以多个），BACKUP备服务器（可以多个），节点启动时主服务抢占虚拟IP,备用服务器不会抢占IP</span><br><span class="line"></span><br><span class="line">interface  eth0:网卡设置，定义的虚拟IP要设置在那个网卡里面，eth0是docker虚拟机的网卡，宿主机能访问，局域网不能访问，局域网要想访问，需要在宿主机上把eth0网卡映射到局域网上某个虚拟ip上，所以宿主机也需要安装keepalived</span><br><span class="line"></span><br><span class="line">virtual_router_id  51:给Keepalived集群组起ID-虚拟路由标识，MASTER和BACKUPB的虚拟路由标识必须一致，标识可以是2~255</span><br><span class="line"></span><br><span class="line">priority  100:权重，值越大争抢到虚拟IP几率越大</span><br><span class="line"></span><br><span class="line">advert_int  1:心跳检测，MASTER和BACKUPB节点之间同步检测时间间隔，单位秒，1每一秒检测一次，主备之间必须一致</span><br><span class="line"></span><br><span class="line">authentication &#123; auth_type  PASS  auth_pass  123456 &#125;:心跳检测需要开放的账户密码</span><br><span class="line"></span><br><span class="line">virtual_ipaddress &#123;  172.18.0.201 &#125;:eth0定义的虚拟IP,可以设置多个虚拟IP地址，每行一个，只在docker内部能看得见</span><br></pre></td></tr></table></figure></p>
<p><font color="#660000">注意问题:</font><br><br>1、在执行apt-get update，发现docker 机无法解析dns，需要修改/etc/resolv.conf的nameserver 值为主机的值</p>
<p> <img src="images/docker13.jpg" alt=""></p>
<p> 主机DNS值<br> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmcli dev show | grep IP4.DNS</span><br></pre></td></tr></table></figure></p>
<p> 发现在ubuntu不能使用命令vi ，前提是要apt-get update，直接使用touch，echo</p>
<p> 备份<br> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv resolv.conf resolv.conf-bak</span><br></pre></td></tr></table></figure></p>
<p>  创建<br> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">touch resolv.conf</span><br></pre></td></tr></table></figure></p>
<p> 添加数据<br>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> nameserver 192.168.157.2 &gt; resolv.conf</span><br><span class="line"><span class="built_in">echo</span> options ndots:0 &gt;&gt;resolv.conf</span><br></pre></td></tr></table></figure></p>
<p> 2、apt-get镜像在国外，下载速度比较慢，添加阿里云镜像，修改vim /etc/apt/sources.list 文件，如果不能使用vim，可以先使用echo &gt;&gt; sources.list<br> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial main restricted universe multiverse</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial-security main restricted universe multiverse</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial-updates main restricted universe multiverse</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial-proposed main restricted universe multiverse</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial-backports main restricted universe multiverse</span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ xenial main restricted universe multiverse</span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ xenial-security main restricted universe multiverse</span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ xenial-updates main restricted universe multiverse</span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ xenial-proposed main restricted universe multiverse</span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ xenial-backports main restricted universe multiverse</span><br></pre></td></tr></table></figure></p>
<h4 id="宿主机安装Keepalived"><a href="#宿主机安装Keepalived" class="headerlink" title="宿主机安装Keepalived"></a>宿主机安装Keepalived</h4><p>安装Keepalived<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#宿主机执行安装Keepalived</span></span><br><span class="line">yum -y install keepalived</span><br><span class="line"><span class="comment">#修改Keepalived配置文件</span></span><br><span class="line">vi /etc/keepalived/keepalived.conf</span><br><span class="line"><span class="comment">#启动Keepalived</span></span><br><span class="line">service keepalived start</span><br></pre></td></tr></table></figure></p>
<p>Keepalived配置文件如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens33</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">       	192.168.157.135</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">virtual_server 192.168.157.135 8888 &#123;</span><br><span class="line">    delay_loop 3</span><br><span class="line">    lb_algo rr </span><br><span class="line">    lb_kind NAT</span><br><span class="line">    persistence_timeout 50</span><br><span class="line">    protocol TCP</span><br><span class="line"></span><br><span class="line">    real_server 172.18.0.201 8888 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">virtual_server 192.168.157.135 3306 &#123;</span><br><span class="line">    delay_loop 3</span><br><span class="line">    lb_algo rr </span><br><span class="line">    lb_kind NAT</span><br><span class="line">    persistence_timeout 50</span><br><span class="line">    protocol TCP</span><br><span class="line"></span><br><span class="line">    real_server 172.18.0.201 3306 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>配置文件解析<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">192.168.157.135：宿主机局域网的IP地址</span><br><span class="line"></span><br><span class="line">8888:对应容器Haproxy服务端口</span><br><span class="line"></span><br><span class="line">3306:对应容器Haproxy数据库端口</span><br><span class="line"></span><br><span class="line">172.18.0.201:keepalived争抢的IP地址</span><br></pre></td></tr></table></figure></p>
<h4 id="检测Keepalived高可用"><a href="#检测Keepalived高可用" class="headerlink" title="检测Keepalived高可用"></a>检测Keepalived高可用</h4><p>1、访问 Haproxy服务，ip地址是192.168.157.135，端口号上面设置8888<br> <img src="images/docker14.jpg" alt=""></p>
<p>2、使用navicat 登录 ，ip地址是192.168.157.135，端口号3306，账号密码自己设置的数据库账户密码<br> <img src="images/docker15.jpg" alt=""><br> <img src="images/docker16.jpg" alt=""></p>
<p>3、暂停其中的一个haproxy容器，查看是否还能使用</p>
<p>暂停容器<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pause h1</span><br></pre></td></tr></table></figure></p>
<p>运行暂停的容器<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker unpause h1</span><br></pre></td></tr></table></figure></p>
<p>可见集群还是能使用</p>
<h3 id="暂停-pxc集群方法"><a href="#暂停-pxc集群方法" class="headerlink" title="暂停 pxc集群方法"></a>暂停 pxc集群方法</h3><p>当要关闭Linux虚拟机，pxc如何关闭并如何保存，这些是有顺序的。最好是直接挂起虚拟机，而不是直接关闭虚拟机。挂起虚拟机，重新开启虚拟机，容器会直接恢复启动，但docker虚拟机得不到网络。从挂起状态恢复运行状态，为内部进程虚拟机分配网络，宿主机需要修改下面配置<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/sysctl.conf</span><br><span class="line"><span class="comment">#文件中添加 net.ipv4.ip_forward=1 这个配置</span></span><br><span class="line">systemctl restart network</span><br></pre></td></tr></table></figure></p>
<h3 id="数据库备份"><a href="#数据库备份" class="headerlink" title="数据库备份"></a>数据库备份</h3><p>1、冷备份-暂停数据库运行<br> <img src="images/docker17.jpg" alt=""></p>
<p>2、热备份-数据库运行中<br><img src="images/docker18.jpg" alt=""></p>
<p>IVM :linux 自带的备份方式，分区里面的数据，可以备份多种数据库，备份要加锁，只读，不能写</p>
<p>XtraBackup :能读能写<br><img src="images/docker20.jpg" alt=""></p>
<p>热备份数据</p>
<p><img src="images/docker19.jpg" alt=""><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#宿主机</span></span><br><span class="line"></span><br><span class="line">docker <span class="built_in">exec</span> -it node1 bash</span><br><span class="line"><span class="comment">#更新软件包</span></span><br><span class="line">apt-get update</span><br><span class="line"><span class="comment">#安装热备工具</span></span><br><span class="line">apt-get install percona-xtrabackup-24</span><br><span class="line"><span class="comment">#全量热备到backup</span></span><br><span class="line">innobackupex --user=root --password=root /data/backup/full</span><br></pre></td></tr></table></figure></p>
<h3 id="数据库还原-只有冷还原"><a href="#数据库还原-只有冷还原" class="headerlink" title="数据库还原-只有冷还原"></a>数据库还原-只有冷还原</h3><p><img src="images/docker21.jpg" alt=""><br>冷还原数据 停止其余4个节点，并删除节点</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker stop node2</span><br><span class="line">docker stop node3</span><br><span class="line">docker stop node4</span><br><span class="line">docker stop node5</span><br><span class="line">docker rm node2</span><br><span class="line">docker rm node3</span><br><span class="line">docker rm node4</span><br><span class="line">docker rm node5</span><br></pre></td></tr></table></figure>
<p>node1容器中删除MySQL的数据<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#删除数据</span></span><br><span class="line">rm -rf /var/lib/mysql/*</span><br><span class="line"><span class="comment">#清空事务</span></span><br><span class="line">innobackupex --user=root --password=abc123456 --apply-back /data/backup/full/2018-04-15_05-09-07/</span><br><span class="line"><span class="comment">#还原数据</span></span><br><span class="line">innobackupex --user=root --password=abc123456 --copy-back  /data/backup/full/2018-04-15_05-09-07/</span><br></pre></td></tr></table></figure></p>
<p>重新创建其余4个节点，组件PXC集群</p>
<h3 id="安装redis-集群"><a href="#安装redis-集群" class="headerlink" title="安装redis 集群"></a>安装redis 集群</h3><h4 id="高速缓存结束"><a href="#高速缓存结束" class="headerlink" title="高速缓存结束"></a>高速缓存结束</h4><p><img src="images/redis1.jpg" alt=""></p>
<h4 id="redis介绍"><a href="#redis介绍" class="headerlink" title="redis介绍"></a>redis介绍</h4><p><img src="images/redis2.jpg" alt=""></p>
<h4 id="redis集群介绍"><a href="#redis集群介绍" class="headerlink" title="redis集群介绍"></a>redis集群介绍</h4><p>主要使用RedisCluster方案<br><img src="images/redis3.jpg" alt=""></p>
<h4 id="RedisCluster方案介绍"><a href="#RedisCluster方案介绍" class="headerlink" title="RedisCluster方案介绍"></a>RedisCluster方案介绍</h4><p><img src="images/redis4.jpg" alt=""><br>主从同步</p>
<p><img src="images/redis5.jpg" alt=""></p>
<p>RedisCluster集群的高可用<br><img src="images/redis6.jpg" alt=""></p>
<h4 id="安装redis镜像，配置RedisCluster集群"><a href="#安装redis镜像，配置RedisCluster集群" class="headerlink" title="安装redis镜像，配置RedisCluster集群"></a>安装redis镜像，配置RedisCluster集群</h4><h5 id="安装Redis镜像"><a href="#安装Redis镜像" class="headerlink" title="安装Redis镜像"></a>安装Redis镜像</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull yyyyttttwwww/redis</span><br></pre></td></tr></table></figure>
<h5 id="创建net2网段"><a href="#创建net2网段" class="headerlink" title="创建net2网段"></a>创建net2网段</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network create --subnet=172.19.0.0/16 net2</span><br></pre></td></tr></table></figure>
<h5 id="创建6节点Redis容器"><a href="#创建6节点Redis容器" class="headerlink" title="创建6节点Redis容器"></a>创建6节点Redis容器</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker run -it -d --name r1 -p 5001:6379 --net=net2 --ip 172.19.0.2 redis bash</span><br><span class="line">docker run -it -d --name r2 -p 5002:6379 --net=net2 --ip 172.19.0.3 redis bash</span><br><span class="line">docker run -it -d --name r3 -p 5003:6379 --net=net2 --ip 172.19.0.4 redis bash</span><br><span class="line">docker run -it -d --name r4 -p 5004:6379 --net=net2 --ip 172.19.0.5 redis bash</span><br><span class="line">docker run -it -d --name r5 -p 5005:6379 --net=net2 --ip 172.19.0.6 redis bash</span><br><span class="line">docker run -it -d --name r6 -p 5006:6379 --net=net2 --ip 172.19.0.7 redis bash</span><br></pre></td></tr></table></figure>
<h5 id="启动6节点Redis服务器"><a href="#启动6节点Redis服务器" class="headerlink" title="启动6节点Redis服务器"></a>启动6节点Redis服务器</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#进入r1节点</span></span><br><span class="line">docker <span class="built_in">exec</span> -it r1 bash</span><br><span class="line">vi /usr/redis/redis.conf</span><br><span class="line"><span class="built_in">cd</span> /usr/redis/src</span><br><span class="line">./redis-server ../redis.conf</span><br><span class="line"><span class="comment">#进入r2节点</span></span><br><span class="line">docker <span class="built_in">exec</span> -it r2 bash</span><br><span class="line">vi /usr/redis/redis.conf</span><br><span class="line"><span class="built_in">cd</span> /usr/redis/src</span><br><span class="line">./redis-server ../redis.conf</span><br><span class="line"><span class="comment">#进入r3节点</span></span><br><span class="line">docker <span class="built_in">exec</span> -it r3 bash</span><br><span class="line">vi /usr/redis/redis.conf</span><br><span class="line"><span class="built_in">cd</span> /usr/redis/src</span><br><span class="line">./redis-server ../redis.conf</span><br><span class="line"><span class="comment">#进入r4节点</span></span><br><span class="line">docker <span class="built_in">exec</span> -it r4 bash</span><br><span class="line">vi /usr/redis/redis.conf</span><br><span class="line"><span class="built_in">cd</span> /usr/redis/src</span><br><span class="line">./redis-server ../redis.conf</span><br><span class="line"><span class="comment">#进入r5节点</span></span><br><span class="line">docker <span class="built_in">exec</span> -it r5 bash</span><br><span class="line">vi /usr/redis/redis.conf</span><br><span class="line"><span class="built_in">cd</span> /usr/redis/src</span><br><span class="line">./redis-server ../redis.conf</span><br><span class="line"><span class="comment">#进入r6节点</span></span><br><span class="line">docker <span class="built_in">exec</span> -it r6 bash</span><br><span class="line">vi /usr/redis/redis.conf</span><br><span class="line"><span class="built_in">cd</span> /usr/redis/src</span><br><span class="line">./redis-server ../redis.conf</span><br></pre></td></tr></table></figure>
<p>redis.conf配置文件修改的地方<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">daemonize yes</span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file nodes.conf</span><br><span class="line">cluster-node-timeout 15000</span><br><span class="line"><span class="built_in">bind</span> 0.0.0.0  <span class="comment">#设置其他IP地址能访问，Cluster集群中的redis需要互相访问</span></span><br><span class="line">appendonly yes</span><br></pre></td></tr></table></figure></p>
<p><img src="images/redis8.jpg" alt=""></p>
<h5 id="创建Cluster集群"><a href="#创建Cluster集群" class="headerlink" title="创建Cluster集群"></a>创建Cluster集群</h5><p>cluster是ruby写的，需要安装ruby环境，但上面方式安装的redis已经集成了，不再需要安装<br><img src="images/redis7.jpg" alt=""><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在r1节点上执行下面的指令</span></span><br><span class="line"><span class="built_in">cd</span> /usr/redis/src</span><br><span class="line">mkdir -p ../cluster</span><br><span class="line">cp redis-trib.rb ../cluster/</span><br><span class="line"><span class="built_in">cd</span> ../cluster</span><br><span class="line"><span class="comment">#创建Cluster集群</span></span><br><span class="line">./redis-trib.rb create --replicas 1 172.19.0.2:6379 172.19.0.3:6379 172.19.0.4:6379 172.19.0.5:6379 172.19.0.6:6379 172.19.0.7:6379</span><br></pre></td></tr></table></figure></p>
<h5 id="重启redis"><a href="#重启redis" class="headerlink" title="重启redis"></a>重启redis</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ps -ef|grep redis <span class="comment">#查看进程</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">kill</span> -9 进程id  <span class="comment">#杀死进程</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> /usr/redis/src</span><br><span class="line"></span><br><span class="line">./redis-server ../redis.conf</span><br></pre></td></tr></table></figure>
<h3 id="部署后端的项目"><a href="#部署后端的项目" class="headerlink" title="部署后端的项目"></a>部署后端的项目</h3><h4 id="修改数据源配置"><a href="#修改数据源配置" class="headerlink" title="修改数据源配置"></a>修改数据源配置</h4><p>application_dev.yml</p>
<h4 id="修改redis配置"><a href="#修改redis配置" class="headerlink" title="修改redis配置"></a>修改redis配置</h4><p>application.yml<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#host: localhost</span></span><br><span class="line">  <span class="comment">#port: 6379</span></span><br><span class="line">  <span class="comment">#password:    # 密码（默认为空）</span></span><br><span class="line">  timeout: 6000ms  <span class="comment"># 连接超时时长（毫秒）</span></span><br><span class="line">  cluster:</span><br><span class="line">    nodes:</span><br><span class="line">    - 172.19.0.2:6379</span><br><span class="line">    - 172.19.0.3:6379</span><br><span class="line">    - 172.19.0.4:6379</span><br><span class="line">    - 172.19.0.5:6379</span><br><span class="line">    - 172.19.0.6:6379</span><br><span class="line">    - 172.19.0.7:6379</span><br><span class="line">  jedis:</span><br></pre></td></tr></table></figure></p>
<h4 id="进入人人开源后端项目，执行打包（修改配置文件，更改端口，打包三次生成三个JAR文件）"><a href="#进入人人开源后端项目，执行打包（修改配置文件，更改端口，打包三次生成三个JAR文件）" class="headerlink" title="进入人人开源后端项目，执行打包（修改配置文件，更改端口，打包三次生成三个JAR文件）"></a>进入人人开源后端项目，执行打包（修改配置文件，更改端口，打包三次生成三个JAR文件）</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn clean install -Dmaven.test.skip=<span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h4 id="安装Java镜像"><a href="#安装Java镜像" class="headerlink" title="安装Java镜像"></a>安装Java镜像</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull java</span><br></pre></td></tr></table></figure>
<h4 id="创建3节点Java容器"><a href="#创建3节点Java容器" class="headerlink" title="创建3节点Java容器"></a>创建3节点Java容器</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建数据卷，上传JAR文件</span></span><br><span class="line">docker volume create j1</span><br><span class="line"><span class="comment">#启动容器</span></span><br><span class="line">docker run -it -d --name j1 -v j1:/home/soft --net=host java</span><br><span class="line"><span class="comment">#进入j1容器</span></span><br><span class="line">docker <span class="built_in">exec</span> -it j1 bash</span><br><span class="line"><span class="comment">#启动Java项目</span></span><br><span class="line">nohup java -jar /home/soft/renren-fast.jar</span><br><span class="line"><span class="comment">#查看日志</span></span><br><span class="line">tail -fn 50 nohup.out</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建数据卷，上传JAR文件</span></span><br><span class="line">docker volume create j2</span><br><span class="line"><span class="comment">#启动容器</span></span><br><span class="line">docker run -it -d --name j2 -v j2:/home/soft --net=host java</span><br><span class="line"><span class="comment">#进入j1容器</span></span><br><span class="line">docker <span class="built_in">exec</span> -it j2 bash</span><br><span class="line"><span class="comment">#启动Java项目</span></span><br><span class="line">nohup java -jar /home/soft/renren-fast.jar</span><br><span class="line"><span class="comment">#查看日志</span></span><br><span class="line">tail -fn 50 nohup.out</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建数据卷，上传JAR文件</span></span><br><span class="line">docker volume create j3</span><br><span class="line"><span class="comment">#启动容器</span></span><br><span class="line">docker run -it -d --name j3 -v j3:/home/soft --net=host java</span><br><span class="line"><span class="comment">#进入j1容器</span></span><br><span class="line">docker <span class="built_in">exec</span> -it j3 bash</span><br><span class="line"><span class="comment">#启动Java项目</span></span><br><span class="line">nohup java -jar /home/soft/renren-fast.jar</span><br><span class="line"><span class="comment">#查看日志</span></span><br><span class="line">tail -fn 50 nohup.out</span><br></pre></td></tr></table></figure>
<h4 id="访问网站"><a href="#访问网站" class="headerlink" title="访问网站"></a>访问网站</h4><p><a href="http://192.168.157.129:6001/renren-fast/swagger/index.html" target="_blank" rel="noopener">http://192.168.157.129:6001/renren-fast/swagger/index.html</a><br><img src="images/renren1.jpg" alt=""></p>
<h3 id="nginx-负载均衡"><a href="#nginx-负载均衡" class="headerlink" title="nginx 负载均衡"></a>nginx 负载均衡</h3><h4 id="安装Nginx镜像"><a href="#安装Nginx镜像" class="headerlink" title="安装Nginx镜像"></a>安装Nginx镜像</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull nginx</span><br></pre></td></tr></table></figure>
<h4 id="创建Nginx容器，配置负载均衡"><a href="#创建Nginx容器，配置负载均衡" class="headerlink" title="创建Nginx容器，配置负载均衡"></a>创建Nginx容器，配置负载均衡</h4><p><img src="images/renren3.jpg" alt=""></p>
<h5 id="宿主机上-home-n1-nginx-conf配置文件内容如下："><a href="#宿主机上-home-n1-nginx-conf配置文件内容如下：" class="headerlink" title="宿主机上/home/n1/nginx.conf配置文件内容如下："></a>宿主机上/home/n1/nginx.conf配置文件内容如下：</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">user  nginx;</span><br><span class="line">worker_processes  1;</span><br><span class="line">error_log  /var/<span class="built_in">log</span>/nginx/error.log warn;</span><br><span class="line">pid        /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       /etc/nginx/mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format  main  <span class="string">'$remote_addr - $remote_user [$time_local] "$request" '</span></span><br><span class="line">                      <span class="string">'$status $body_bytes_sent "$http_referer" '</span></span><br><span class="line">                      <span class="string">'"$http_user_agent" "$http_x_forwarded_for"'</span>;</span><br><span class="line"></span><br><span class="line">    access_log  /var/<span class="built_in">log</span>/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    <span class="comment">#tcp_nopush     on;</span></span><br><span class="line"></span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#gzip  on;</span></span><br><span class="line">	</span><br><span class="line">	proxy_redirect          off;</span><br><span class="line">	proxy_set_header        Host <span class="variable">$host</span>;</span><br><span class="line">	proxy_set_header        X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">	proxy_set_header        X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">	client_max_body_size    10m;</span><br><span class="line">	client_body_buffer_size   128k;</span><br><span class="line">	proxy_connect_timeout   5s;</span><br><span class="line">	proxy_send_timeout      5s;</span><br><span class="line">	proxy_read_timeout      5s;</span><br><span class="line">	proxy_buffer_size        4k;</span><br><span class="line">	proxy_buffers           4 32k;</span><br><span class="line">	proxy_busy_buffers_size  64k;</span><br><span class="line">	proxy_temp_file_write_size 64k;</span><br><span class="line">	</span><br><span class="line">	upstream tomcat &#123;</span><br><span class="line">		server 192.168.99.104:6001;</span><br><span class="line">		server 192.168.99.104:6002;</span><br><span class="line">		server 192.168.99.104:6003;</span><br><span class="line">	&#125;</span><br><span class="line">	server &#123;</span><br><span class="line">        listen       6101;</span><br><span class="line">        server_name  192.168.99.104; </span><br><span class="line">        location / &#123;  </span><br><span class="line">            proxy_pass   http://tomcat;</span><br><span class="line">            index  index.html index.htm;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="创建第1个Nginx节点"><a href="#创建第1个Nginx节点" class="headerlink" title="创建第1个Nginx节点"></a>创建第1个Nginx节点</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it -d --name n1 -v /home/n1/nginx.conf:/etc/nginx/nginx.conf --net=host --privileged nginx</span><br></pre></td></tr></table></figure>
<h5 id="宿主机上-home-n2-nginx-conf配置文件内容如下："><a href="#宿主机上-home-n2-nginx-conf配置文件内容如下：" class="headerlink" title="宿主机上/home/n2/nginx.conf配置文件内容如下："></a>宿主机上/home/n2/nginx.conf配置文件内容如下：</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">user  nginx;</span><br><span class="line">worker_processes  1;</span><br><span class="line">error_log  /var/<span class="built_in">log</span>/nginx/error.log warn;</span><br><span class="line">pid        /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       /etc/nginx/mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format  main  <span class="string">'$remote_addr - $remote_user [$time_local] "$request" '</span></span><br><span class="line">                      <span class="string">'$status $body_bytes_sent "$http_referer" '</span></span><br><span class="line">                      <span class="string">'"$http_user_agent" "$http_x_forwarded_for"'</span>;</span><br><span class="line"></span><br><span class="line">    access_log  /var/<span class="built_in">log</span>/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    <span class="comment">#tcp_nopush     on;</span></span><br><span class="line"></span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#gzip  on;</span></span><br><span class="line">	</span><br><span class="line">	proxy_redirect          off;</span><br><span class="line">	proxy_set_header        Host <span class="variable">$host</span>;</span><br><span class="line">	proxy_set_header        X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">	proxy_set_header        X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">	client_max_body_size    10m;</span><br><span class="line">	client_body_buffer_size   128k;</span><br><span class="line">	proxy_connect_timeout   5s;</span><br><span class="line">	proxy_send_timeout      5s;</span><br><span class="line">	proxy_read_timeout      5s;</span><br><span class="line">	proxy_buffer_size        4k;</span><br><span class="line">	proxy_buffers           4 32k;</span><br><span class="line">	proxy_busy_buffers_size  64k;</span><br><span class="line">	proxy_temp_file_write_size 64k;</span><br><span class="line">	</span><br><span class="line">	upstream tomcat &#123;</span><br><span class="line">		server 192.168.99.104:6001;</span><br><span class="line">		server 192.168.99.104:6002;</span><br><span class="line">		server 192.168.99.104:6003;</span><br><span class="line">	&#125;</span><br><span class="line">	server &#123;</span><br><span class="line">        listen       6102;</span><br><span class="line">        server_name  192.168.99.104; </span><br><span class="line">        location / &#123;  </span><br><span class="line">            proxy_pass   http://tomcat;</span><br><span class="line">            index  index.html index.htm;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="创建第2个Nginx节点"><a href="#创建第2个Nginx节点" class="headerlink" title="创建第2个Nginx节点"></a>创建第2个Nginx节点</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it -d --name n2 -v /home/n2/nginx.conf:/etc/nginx/nginx.conf --net=host --privileged nginx</span><br></pre></td></tr></table></figure>
<h3 id="后端项目双机热备负载均衡"><a href="#后端项目双机热备负载均衡" class="headerlink" title="后端项目双机热备负载均衡"></a>后端项目双机热备负载均衡</h3><p><img src="images/renren2.jpg" alt=""></p>
<h4 id="在Nginx容器安装Keepalived"><a href="#在Nginx容器安装Keepalived" class="headerlink" title="在Nginx容器安装Keepalived"></a>在Nginx容器安装Keepalived</h4><h5 id="n1节点keepalived"><a href="#n1节点keepalived" class="headerlink" title="n1节点keepalived"></a>n1节点keepalived</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#进入n1节点</span></span><br><span class="line">docker <span class="built_in">exec</span> -it n1 bash</span><br><span class="line"><span class="comment">#更新软件包</span></span><br><span class="line">apt-get update</span><br><span class="line"><span class="comment">#安装VIM</span></span><br><span class="line">apt-get install vim</span><br><span class="line"><span class="comment">#安装Keepalived</span></span><br><span class="line">apt-get install keepalived</span><br><span class="line"><span class="comment">#编辑Keepalived配置文件(如下)</span></span><br><span class="line">vim /etc/keepalived/keepalived.conf</span><br><span class="line"><span class="comment">#启动Keepalived</span></span><br><span class="line">service keepalived start</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens33</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 123456</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.99.151</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">virtual_server 192.168.99.151 6201 &#123;</span><br><span class="line">    delay_loop 3</span><br><span class="line">    lb_algo rr</span><br><span class="line">    lb_kind NAT</span><br><span class="line">    persistence_timeout 50</span><br><span class="line">    protocol TCP</span><br><span class="line">    real_server 192.168.99.104 6101 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="n2节点keepalived"><a href="#n2节点keepalived" class="headerlink" title="n2节点keepalived"></a>n2节点keepalived</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#进入n2节点</span></span><br><span class="line">docker <span class="built_in">exec</span> -it n2 bash</span><br><span class="line"><span class="comment">#更新软件包</span></span><br><span class="line">apt-get update</span><br><span class="line"><span class="comment">#安装VIM</span></span><br><span class="line">apt-get install vim</span><br><span class="line"><span class="comment">#安装Keepalived</span></span><br><span class="line">apt-get install keepalived</span><br><span class="line"><span class="comment">#编辑Keepalived配置文件(如下)</span></span><br><span class="line">vim /etc/keepalived/keepalived.conf</span><br><span class="line"><span class="comment">#启动Keepalived</span></span><br><span class="line">service keepalived start</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens33</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 123456</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.99.151</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">virtual_server 192.168.99.151 6201 &#123;</span><br><span class="line">    delay_loop 3</span><br><span class="line">    lb_algo rr</span><br><span class="line">    lb_kind NAT</span><br><span class="line">    persistence_timeout 50</span><br><span class="line">    protocol TCP</span><br><span class="line">    real_server 192.168.99.104 6102 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="前端项目部署与负载均衡"><a href="#前端项目部署与负载均衡" class="headerlink" title="前端项目部署与负载均衡"></a>前端项目部署与负载均衡</h3><p><img src="images/docker22.jpg" alt=""></p>
<h4 id="设置前端连接后端的ip地址"><a href="#设置前端连接后端的ip地址" class="headerlink" title="设置前端连接后端的ip地址"></a>设置前端连接后端的ip地址</h4><p>比如<a href="http://192.168.157.129:6101/renren-fast" target="_blank" rel="noopener">http://192.168.157.129:6101/renren-fast</a><br><img src="images/renren4.jpg" alt=""></p>
<h4 id="打包部署前端项目"><a href="#打包部署前端项目" class="headerlink" title="打包部署前端项目"></a>打包部署前端项目</h4><h4 id="使用淘宝镜像-加速下载速度"><a href="#使用淘宝镜像-加速下载速度" class="headerlink" title="使用淘宝镜像,加速下载速度"></a>使用淘宝镜像,加速下载速度</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install -g cnpm --registry=https://registry.npm.taobao.org</span><br></pre></td></tr></table></figure>
<h4 id="在前端项目路径下执行打包指令"><a href="#在前端项目路径下执行打包指令" class="headerlink" title="在前端项目路径下执行打包指令"></a>在前端项目路径下执行打包指令</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm run build</span><br><span class="line"><span class="comment">#安装了淘宝镜像</span></span><br><span class="line">cnpm run build</span><br></pre></td></tr></table></figure>
<p>dish（build）目录的文件拷贝到宿主机的/home/fn1/renren-vue、/home/fn2/renren-vue、/home/fn3/renren-vue的目录下面</p>
<h4 id="创建3节点的Nginx，部署前端项目"><a href="#创建3节点的Nginx，部署前端项目" class="headerlink" title="创建3节点的Nginx，部署前端项目"></a>创建3节点的Nginx，部署前端项目</h4><h5 id="nginx-第一个节点"><a href="#nginx-第一个节点" class="headerlink" title="nginx 第一个节点"></a>nginx 第一个节点</h5><p>宿主机/home/fn1/nginx.conf的配置文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">user  nginx;</span><br><span class="line">worker_processes  1;</span><br><span class="line">error_log  /var/<span class="built_in">log</span>/nginx/error.log warn;</span><br><span class="line">pid        /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       /etc/nginx/mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format  main  <span class="string">'$remote_addr - $remote_user [$time_local] "$request" '</span></span><br><span class="line">                      <span class="string">'$status $body_bytes_sent "$http_referer" '</span></span><br><span class="line">                      <span class="string">'"$http_user_agent" "$http_x_forwarded_for"'</span>;</span><br><span class="line"></span><br><span class="line">    access_log  /var/<span class="built_in">log</span>/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    <span class="comment">#tcp_nopush     on;</span></span><br><span class="line"></span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#gzip  on;</span></span><br><span class="line">	</span><br><span class="line">	proxy_redirect          off;</span><br><span class="line">	proxy_set_header        Host <span class="variable">$host</span>;</span><br><span class="line">	proxy_set_header        X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">	proxy_set_header        X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">	client_max_body_size    10m;</span><br><span class="line">	client_body_buffer_size   128k;</span><br><span class="line">	proxy_connect_timeout   5s;</span><br><span class="line">	proxy_send_timeout      5s;</span><br><span class="line">	proxy_read_timeout      5s;</span><br><span class="line">	proxy_buffer_size        4k;</span><br><span class="line">	proxy_buffers           4 32k;</span><br><span class="line">	proxy_busy_buffers_size  64k;</span><br><span class="line">	proxy_temp_file_write_size 64k;</span><br><span class="line">	</span><br><span class="line">	server &#123;</span><br><span class="line">		listen 6501;</span><br><span class="line">		server_name  192.168.99.104;</span><br><span class="line">		location  /  &#123;</span><br><span class="line">			root  /home/fn1/renren-vue;</span><br><span class="line">			index  index.html;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#启动第fn1节点</span></span><br><span class="line">docker run -it -d --name fn1 -v /home/fn1/nginx.conf:/etc/nginx/nginx.conf -v /home/fn1/renren-vue:/home/fn1/renren-vue --privileged --net=host nginx</span><br></pre></td></tr></table></figure></p>
<h5 id="nginx-第二个节点"><a href="#nginx-第二个节点" class="headerlink" title="nginx 第二个节点"></a>nginx 第二个节点</h5><p>宿主机/home/fn2/nginx.conf的配置文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">user  nginx;</span><br><span class="line">worker_processes  1;</span><br><span class="line">error_log  /var/<span class="built_in">log</span>/nginx/error.log warn;</span><br><span class="line">pid        /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       /etc/nginx/mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format  main  <span class="string">'$remote_addr - $remote_user [$time_local] "$request" '</span></span><br><span class="line">                      <span class="string">'$status $body_bytes_sent "$http_referer" '</span></span><br><span class="line">                      <span class="string">'"$http_user_agent" "$http_x_forwarded_for"'</span>;</span><br><span class="line"></span><br><span class="line">    access_log  /var/<span class="built_in">log</span>/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    <span class="comment">#tcp_nopush     on;</span></span><br><span class="line"></span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#gzip  on;</span></span><br><span class="line">	</span><br><span class="line">	proxy_redirect          off;</span><br><span class="line">	proxy_set_header        Host <span class="variable">$host</span>;</span><br><span class="line">	proxy_set_header        X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">	proxy_set_header        X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">	client_max_body_size    10m;</span><br><span class="line">	client_body_buffer_size   128k;</span><br><span class="line">	proxy_connect_timeout   5s;</span><br><span class="line">	proxy_send_timeout      5s;</span><br><span class="line">	proxy_read_timeout      5s;</span><br><span class="line">	proxy_buffer_size        4k;</span><br><span class="line">	proxy_buffers           4 32k;</span><br><span class="line">	proxy_busy_buffers_size  64k;</span><br><span class="line">	proxy_temp_file_write_size 64k;</span><br><span class="line">	</span><br><span class="line">	server &#123;</span><br><span class="line">		listen 6502;</span><br><span class="line">		server_name  192.168.99.104;</span><br><span class="line">		location  /  &#123;</span><br><span class="line">			root  /home/fn2/renren-vue;</span><br><span class="line">			index  index.html;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#启动第fn2节点</span></span><br><span class="line">docker run -it -d --name fn2 -v /home/fn2/nginx.conf:/etc/nginx/nginx.conf -v /home/fn2/renren-vue:/home/fn2/renren-vue --privileged --net=host nginx</span><br></pre></td></tr></table></figure></p>
<h5 id="nginx-第三个节点"><a href="#nginx-第三个节点" class="headerlink" title="nginx 第三个节点"></a>nginx 第三个节点</h5><p>宿主机/home/fn3/nginx.conf的配置文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">user  nginx;</span><br><span class="line">worker_processes  1;</span><br><span class="line">error_log  /var/<span class="built_in">log</span>/nginx/error.log warn;</span><br><span class="line">pid        /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       /etc/nginx/mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format  main  <span class="string">'$remote_addr - $remote_user [$time_local] "$request" '</span></span><br><span class="line">                      <span class="string">'$status $body_bytes_sent "$http_referer" '</span></span><br><span class="line">                      <span class="string">'"$http_user_agent" "$http_x_forwarded_for"'</span>;</span><br><span class="line"></span><br><span class="line">    access_log  /var/<span class="built_in">log</span>/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    <span class="comment">#tcp_nopush     on;</span></span><br><span class="line"></span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#gzip  on;</span></span><br><span class="line">	</span><br><span class="line">	proxy_redirect          off;</span><br><span class="line">	proxy_set_header        Host <span class="variable">$host</span>;</span><br><span class="line">	proxy_set_header        X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">	proxy_set_header        X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">	client_max_body_size    10m;</span><br><span class="line">	client_body_buffer_size   128k;</span><br><span class="line">	proxy_connect_timeout   5s;</span><br><span class="line">	proxy_send_timeout      5s;</span><br><span class="line">	proxy_read_timeout      5s;</span><br><span class="line">	proxy_buffer_size        4k;</span><br><span class="line">	proxy_buffers           4 32k;</span><br><span class="line">	proxy_busy_buffers_size  64k;</span><br><span class="line">	proxy_temp_file_write_size 64k;</span><br><span class="line">	</span><br><span class="line">	server &#123;</span><br><span class="line">		listen 6503;</span><br><span class="line">		server_name  192.168.99.104;</span><br><span class="line">		location  /  &#123;</span><br><span class="line">			root  /home/fn3/renren-vue;</span><br><span class="line">			index  index.html;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">启动fn3节点</span><br><span class="line"></span><br><span class="line"><span class="comment">#启动第fn3节点</span></span><br><span class="line">docker run -it -d --name fn3 -v /home/fn3/nginx.conf:/etc/nginx/nginx.conf -v /home/fn3/renren-vue:/home/fn3/renren-vue --privileged --net=host nginx</span><br></pre></td></tr></table></figure></p>
<h5 id="利用keepalived配置负载均衡"><a href="#利用keepalived配置负载均衡" class="headerlink" title="利用keepalived配置负载均衡"></a>利用keepalived配置负载均衡</h5><h6 id="ff1-keepalived-nginx节点"><a href="#ff1-keepalived-nginx节点" class="headerlink" title="ff1  keepalived-nginx节点"></a>ff1  keepalived-nginx节点</h6><p>宿主机/home/ff1/nginx.conf配置文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">user  nginx;</span><br><span class="line">worker_processes  1;</span><br><span class="line">error_log  /var/<span class="built_in">log</span>/nginx/error.log warn;</span><br><span class="line">pid        /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       /etc/nginx/mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format  main  <span class="string">'$remote_addr - $remote_user [$time_local] "$request" '</span></span><br><span class="line">                      <span class="string">'$status $body_bytes_sent "$http_referer" '</span></span><br><span class="line">                      <span class="string">'"$http_user_agent" "$http_x_forwarded_for"'</span>;</span><br><span class="line"></span><br><span class="line">    access_log  /var/<span class="built_in">log</span>/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    <span class="comment">#tcp_nopush     on;</span></span><br><span class="line"></span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#gzip  on;</span></span><br><span class="line">	</span><br><span class="line">	proxy_redirect          off;</span><br><span class="line">	proxy_set_header        Host <span class="variable">$host</span>;</span><br><span class="line">	proxy_set_header        X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">	proxy_set_header        X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">	client_max_body_size    10m;</span><br><span class="line">	client_body_buffer_size   128k;</span><br><span class="line">	proxy_connect_timeout   5s;</span><br><span class="line">	proxy_send_timeout      5s;</span><br><span class="line">	proxy_read_timeout      5s;</span><br><span class="line">	proxy_buffer_size        4k;</span><br><span class="line">	proxy_buffers           4 32k;</span><br><span class="line">	proxy_busy_buffers_size  64k;</span><br><span class="line">	proxy_temp_file_write_size 64k;</span><br><span class="line">	</span><br><span class="line">	upstream fn &#123;</span><br><span class="line">		server 192.168.99.104:6501;</span><br><span class="line">		server 192.168.99.104:6502;</span><br><span class="line">		server 192.168.99.104:6503;</span><br><span class="line">	&#125;</span><br><span class="line">	server &#123;</span><br><span class="line">        listen       6601;</span><br><span class="line">        server_name  192.168.99.104; </span><br><span class="line">        location / &#123;  </span><br><span class="line">            proxy_pass   http://fn;</span><br><span class="line">            index  index.html index.htm;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#启动ff1节点</span></span><br><span class="line">docker run -it -d --name ff1 -v /home/ff1/nginx.conf:/etc/nginx/nginx.conf --net=host --privileged nginx</span><br></pre></td></tr></table></figure></p>
<h6 id="ff2-keepalived-nginx节点"><a href="#ff2-keepalived-nginx节点" class="headerlink" title="ff2  keepalived-nginx节点"></a>ff2  keepalived-nginx节点</h6><p>宿主机/home/ff2/nginx.conf配置文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">user  nginx;</span><br><span class="line">worker_processes  1;</span><br><span class="line">error_log  /var/<span class="built_in">log</span>/nginx/error.log warn;</span><br><span class="line">pid        /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       /etc/nginx/mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format  main  <span class="string">'$remote_addr - $remote_user [$time_local] "$request" '</span></span><br><span class="line">                      <span class="string">'$status $body_bytes_sent "$http_referer" '</span></span><br><span class="line">                      <span class="string">'"$http_user_agent" "$http_x_forwarded_for"'</span>;</span><br><span class="line"></span><br><span class="line">    access_log  /var/<span class="built_in">log</span>/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    <span class="comment">#tcp_nopush     on;</span></span><br><span class="line"></span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#gzip  on;</span></span><br><span class="line">	</span><br><span class="line">	proxy_redirect          off;</span><br><span class="line">	proxy_set_header        Host <span class="variable">$host</span>;</span><br><span class="line">	proxy_set_header        X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">	proxy_set_header        X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">	client_max_body_size    10m;</span><br><span class="line">	client_body_buffer_size   128k;</span><br><span class="line">	proxy_connect_timeout   5s;</span><br><span class="line">	proxy_send_timeout      5s;</span><br><span class="line">	proxy_read_timeout      5s;</span><br><span class="line">	proxy_buffer_size        4k;</span><br><span class="line">	proxy_buffers           4 32k;</span><br><span class="line">	proxy_busy_buffers_size  64k;</span><br><span class="line">	proxy_temp_file_write_size 64k;</span><br><span class="line">	</span><br><span class="line">	upstream fn &#123;</span><br><span class="line">		server 192.168.99.104:6501;</span><br><span class="line">		server 192.168.99.104:6502;</span><br><span class="line">		server 192.168.99.104:6503;</span><br><span class="line">	&#125;</span><br><span class="line">	server &#123;</span><br><span class="line">        listen       6602;</span><br><span class="line">        server_name  192.168.99.104; </span><br><span class="line">        location / &#123;  </span><br><span class="line">            proxy_pass   http://fn;</span><br><span class="line">            index  index.html index.htm;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#启动ff2节点</span></span><br><span class="line">docker run -it -d --name ff2 -v /home/ff2/nginx.conf:/etc/nginx/nginx.conf --net=host --privileged nginx</span><br></pre></td></tr></table></figure></p>
<h5 id="配置双机热备"><a href="#配置双机热备" class="headerlink" title="配置双机热备"></a>配置双机热备</h5><h6 id="ff1节点安装keepalived"><a href="#ff1节点安装keepalived" class="headerlink" title="ff1节点安装keepalived"></a>ff1节点安装keepalived</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#进入ff1节点</span></span><br><span class="line">docker <span class="built_in">exec</span> -it ff1 bash</span><br><span class="line"><span class="comment">#更新软件包</span></span><br><span class="line">apt-get update</span><br><span class="line"><span class="comment">#安装VIM</span></span><br><span class="line">apt-get install vim</span><br><span class="line"><span class="comment">#安装Keepalived</span></span><br><span class="line">apt-get install keepalived</span><br><span class="line"><span class="comment">#编辑Keepalived配置文件(如下)</span></span><br><span class="line">vim /etc/keepalived/keepalived.conf</span><br><span class="line"><span class="comment">#启动Keepalived</span></span><br><span class="line">service keepalived start</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens33</span><br><span class="line">    virtual_router_id 52</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 123456</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.99.152</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">virtual_server 192.168.99.151 6701 &#123;</span><br><span class="line">    delay_loop 3</span><br><span class="line">    lb_algo rr</span><br><span class="line">    lb_kind NAT</span><br><span class="line">    persistence_timeout 50</span><br><span class="line">    protocol TCP</span><br><span class="line">    real_server 192.168.99.104 6601 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="ff2节点安装keepalived"><a href="#ff2节点安装keepalived" class="headerlink" title="ff2节点安装keepalived"></a>ff2节点安装keepalived</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#进入ff2节点</span></span><br><span class="line">docker <span class="built_in">exec</span> -it ff2 bash</span><br><span class="line"><span class="comment">#更新软件包</span></span><br><span class="line">apt-get update</span><br><span class="line"><span class="comment">#安装VIM</span></span><br><span class="line">apt-get install vim</span><br><span class="line"><span class="comment">#安装Keepalived</span></span><br><span class="line">apt-get install keepalived</span><br><span class="line"><span class="comment">#编辑Keepalived配置文件(如下)</span></span><br><span class="line">vim /etc/keepalived/keepalived.conf</span><br><span class="line"><span class="comment">#启动Keepalived</span></span><br><span class="line">service keepalived start</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens33</span><br><span class="line">    virtual_router_id 52</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 123456</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.99.152</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">virtual_server 192.168.99.151 6701 &#123;</span><br><span class="line">    delay_loop 3</span><br><span class="line">    lb_algo rr</span><br><span class="line">    lb_kind NAT</span><br><span class="line">    persistence_timeout 50</span><br><span class="line">    protocol TCP</span><br><span class="line">    real_server 192.168.99.104 6602 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="多台虚拟机安装docker-swarm-集群"><a href="#多台虚拟机安装docker-swarm-集群" class="headerlink" title="多台虚拟机安装docker swarm 集群"></a>多台虚拟机安装docker swarm 集群</h3><p>上面只是在一台虚拟机安装集群，不过实际应用上，是在多台虚拟机安装集群，<br>docker有三服务:</p>
<p>docker-machine：容器服务</p>
<p>docker-compose:脚本执行服务，简化脚本编写</p>
<p>docker-swarm：容器集群技术</p>
<h4 id="docker-swarm-去中心化的设计"><a href="#docker-swarm-去中心化的设计" class="headerlink" title="docker-swarm 去中心化的设计"></a>docker-swarm 去中心化的设计</h4><p>docker-swarm 集群节点有俩种节点：</p>
<p>1、manager节点管理集群的，本身承担worker节点工作，可以有多个manager节点，但同时只有一个manager节点工作，一个manager节点挂掉，会选择新的manager节点工作</p>
<p>2、work节点:工作节点，部署容器项目，有多个work节点</p>
<h4 id="创建swarm集群"><a href="#创建swarm集群" class="headerlink" title="创建swarm集群"></a>创建swarm集群</h4><p>命令<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker swarm init</span><br></pre></td></tr></table></figure></p>
<p>后面添加的参数，可加-可不加:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">--listen-addr ip:port <span class="comment">#管理者节点，一个swarm必须有管理者节点，可以选择多个管理者节点ip</span></span><br><span class="line"></span><br><span class="line">--advertise-addr <span class="comment">#广播地址，其他节点通过ip加入到集群</span></span><br></pre></td></tr></table></figure></p>
<h4 id="加入swarm集群"><a href="#加入swarm集群" class="headerlink" title="加入swarm集群"></a>加入swarm集群</h4><p>在主机器上执行下面命令，会输出加入manager，work 命令<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker swarm join-token manager <span class="comment"># 以manager身份加入</span></span><br><span class="line"></span><br><span class="line">docker swarm join-token manager <span class="comment"># 以work身份加入</span></span><br></pre></td></tr></table></figure></p>
<p>比如:第一个命令 docker swarm join .…. 是以work身份加入集群，<br>第二个命令 docker swarm join .…. 是以manager身份加入集群，<br><img src="images/docker24.jpg" alt=""></p>
<h4 id="查看swarm集群节点"><a href="#查看swarm集群节点" class="headerlink" title="查看swarm集群节点"></a>查看swarm集群节点</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker node ls <span class="comment">#只能在manager节点执行</span></span><br></pre></td></tr></table></figure>
<h4 id="查看swarm集群网络"><a href="#查看swarm集群网络" class="headerlink" title="查看swarm集群网络"></a>查看swarm集群网络</h4><p>创建集群时，集群会生成一个共享网络，这个只是manag节点管理集群的网络，ingress<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network ls</span><br></pre></td></tr></table></figure></p>
<p><img src="images/docker25.jpg" alt=""></p>
<h4 id="创建swarm集群容器通讯共享网络"><a href="#创建swarm集群容器通讯共享网络" class="headerlink" title="创建swarm集群容器通讯共享网络"></a>创建swarm集群容器通讯共享网络</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network create -d overlay --attachable swarm_test</span><br></pre></td></tr></table></figure>
<p><img src="images/docker26.jpg" alt=""></p>
<h4 id="创建pxc集群"><a href="#创建pxc集群" class="headerlink" title="创建pxc集群"></a>创建pxc集群</h4><p>下载安装pxc镜像<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull percona/percona-xtradb-cluster</span><br></pre></td></tr></table></figure></p>
<p>假如5个mysql数据库，分布安装在四台虚拟主机，俩台manager，俩台work，一台manager主机安装俩个数据库，其他每台机器安装一个数据库</p>
<h5 id="创建第一个pxc容器-1"><a href="#创建第一个pxc容器-1" class="headerlink" title="创建第一个pxc容器"></a>创建第一个pxc容器</h5><p>主要是设置共享网络–net=swarm_test<br><img src="images/docker27.jpg" alt=""></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 3306:3306 -e MYSQL_ROOT_PASSWORD=root -e CLUSTER_NAME=PXC -e XTRABACKUP_PASSWORD=root -v v1:/var/lib/mysql -v backup:/data --privileged --name=node1 --net=swarm_test  pxc</span><br></pre></td></tr></table></figure>
<p>3306:3306:3307是宿主机端口，3306为容器mysql端口，为了在外面能访问到容器mysql，需要把端口映射到宿主机上</p>
<p>1、MYSQL_ROOT_PASSWORD=root：设置mysql 的root账户密码</p>
<p>2、CLUSTER_NAME=PXC:集群名称</p>
<p>3、XTRABACKUP_PASSWORD=root:mysql 之间通讯的密码</p>
<p>4、-v v1:/var/lib/mysql -v backup:/data :v1是docker卷,映射宿主机docker卷和容器的目录，每一个容器一个docker卷</p>
<p>5、–privileged:赋予容器修改宿主机目录文件的权限</p>
<p>6、–name=node1:容器名称</p>
<p>7、–net=swarm_test:共享网络ip地址</p>
<p>8、pxc:镜像名称</p>
<h5 id="创建其他pxc容器-1"><a href="#创建其他pxc容器-1" class="headerlink" title="创建其他pxc容器"></a>创建其他pxc容器</h5><p>创建其他容器和第一个容器有所不同，主要添加CLUSTER_JOIN=node1 ，意思是和node1（第一个容器）容器同步数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 3307:3306 -e MYSQL_ROOT_PASSWORD=root -e CLUSTER_NAME=PXC -e XTRABACKUP_PASSWORD=root  -e  CLUSTER_JOIN=node1 -v v2:/var/lib/mysql -v backup:/data --privileged --name=node2 --net=swarm_test  pxc</span><br><span class="line"></span><br><span class="line">docker run -d -p 3306:3306 -e MYSQL_ROOT_PASSWORD=root -e CLUSTER_NAME=PXC -e XTRABACKUP_PASSWORD=root  -e  CLUSTER_JOIN=node1 -v v3:/var/lib/mysql -v backup:/data --privileged --name=node3 --net=swarm_test  pxc</span><br><span class="line"></span><br><span class="line">docker run -d -p 3306:3306 -e MYSQL_ROOT_PASSWORD=root -e CLUSTER_NAME=PXC -e XTRABACKUP_PASSWORD=root  -e  CLUSTER_JOIN=node1 -v v4:/var/lib/mysql -v backup:/data --privileged --name=node4 --net=swarm_test  pxc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker run -d -p 3306:3306 -e MYSQL_ROOT_PASSWORD=root -e CLUSTER_NAME=PXC -e XTRABACKUP_PASSWORD=root  -e  CLUSTER_JOIN=node1 -v v5:/var/lib/mysql -v backup:/data --privileged --name=node5 --net=swarm_test  pxc</span><br></pre></td></tr></table></figure>
<p>注意事项<br>1、3306:3306:3308，因为宿主机的不同，每台映射到宿主机的端口可以一样</p>
<p>2、 CLUSTER_JOIN=node1:添加关联第一台容器</p>
<p>3、 -v v2:/var/lib/mysql：v2是docker卷</p>
<p>4、–name=node2:每台容器名称都不一样</p>
<p>5、–net=swarm_test:共享网络ip地址</p>
<h5 id="查看节点容器swarm-test共享网络ip"><a href="#查看节点容器swarm-test共享网络ip" class="headerlink" title="查看节点容器swarm_test共享网络ip"></a>查看节点容器swarm_test共享网络ip</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker inspect node1</span><br></pre></td></tr></table></figure>
<p>“IPAdress”:”10.0.0.2”-共享swarm_test共享网络容器ip</p>
<h4 id="删除集群节点"><a href="#删除集群节点" class="headerlink" title="删除集群节点"></a>删除集群节点</h4><p>1、删除虚拟机上的容器</p>
<p>2、退出集群</p>
<p>3、删除集群<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service docker stop</span><br></pre></td></tr></table></figure></p>
<h5 id="主动退出集群，"><a href="#主动退出集群，" class="headerlink" title="主动退出集群，"></a>主动退出集群，</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker swarm leave --force <span class="comment"># manager 退出集群必须使用--force 参数</span></span><br></pre></td></tr></table></figure>
<h5 id="被动退出集群"><a href="#被动退出集群" class="headerlink" title="被动退出集群"></a>被动退出集群</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker  node demote 9v8gylom..... <span class="comment"># manager节点先降级成work</span></span><br><span class="line"></span><br><span class="line">docker node rm 9v8gylom..... <span class="comment"># 删除节点</span></span><br><span class="line"></span><br><span class="line">docker node ls <span class="comment"># 查看当前集群有多少节点，节点情况</span></span><br></pre></td></tr></table></figure>
<p><img src="images/docker28.jpg" alt=""></p>
<h3 id="docker图形界面"><a href="#docker图形界面" class="headerlink" title="docker图形界面"></a>docker图形界面</h3><p>portainer管理集群，网络，容器</p>
<h4 id="下载portainer镜像"><a href="#下载portainer镜像" class="headerlink" title="下载portainer镜像"></a>下载portainer镜像</h4><p><img src="images/docker29.jpg" alt=""><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull portainer/portainer</span><br></pre></td></tr></table></figure></p>
<h4 id="开放docker网络管理端口，所有主机都修改"><a href="#开放docker网络管理端口，所有主机都修改" class="headerlink" title="开放docker网络管理端口，所有主机都修改"></a>开放docker网络管理端口，所有主机都修改</h4><p><img src="images/docker30.jpg" alt=""><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/sysconfig/docker</span><br><span class="line">添加如下内容,开放2375端口</span><br><span class="line">OPTIONS=<span class="string">'-Htcp://0.0.0.0:2375 -H unix:///var/run/docker.sock'</span></span><br><span class="line">重启docker service</span><br><span class="line">service docker restart</span><br></pre></td></tr></table></figure></p>
<p>启动portainer 容器，所有主机都要执行<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 9000:9000 portainer/portainer -H tcp:192.168.157.196:2375</span><br></pre></td></tr></table></figure></p>
<p> tcp:192.168.157.196:2375：portainer安装在那台宿主机上，宿主机的ip,管理虚拟机</p>
<p> 访问地址端口9000，注册账号密码192.168.157.196:9000: 管理镜像、容器、网络、数据卷等<br> <img src="images/docker31.jpg" alt=""></p>
<h4 id="虚拟机创建"><a href="#虚拟机创建" class="headerlink" title="虚拟机创建"></a>虚拟机创建</h4><p>默认创建了192.168.157.196还要创建其他虚拟机</p>
<p>点击左侧菜单:Endpoints 添加其他虚拟机，点左侧上面CHANCE ENVIRONMENT,切换虚拟机<br> <img src="images/docker32.jpg" alt=""></p>
<h4 id="swarm创建"><a href="#swarm创建" class="headerlink" title="swarm创建"></a>swarm创建</h4><p>在portainaer无法创建swarm，具体步骤查看上面创建swarm集群，在shell里面执行：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker swarm init</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>查看页面左侧菜单swarm</p>
<p> <img src="images/docker33.jpg" alt=""></p>
<p>创建共享网络swarm_test</p>
<p> <img src="images/docker34.jpg" alt=""></p>
<h4 id="容器创建"><a href="#容器创建" class="headerlink" title="容器创建"></a>容器创建</h4><p>1、创建数据卷<br> <img src="images/docker37.jpg" alt=""><br>2、创建容器<br>容器界面<br> <img src="images/docker35.jpg" alt=""><br> 参数:volume:数据卷，network：网络，env:-e 参数，runtime&amp;resources：权限–privileged ，点击Deploy the container 创建容器<br> <img src="images/docker36.jpg" alt=""></p>
<p> 注意work节点 看不到swarm-test网络，需要在命令行执行创建</p>
<p> 部署方案haproxy ,keepalived<br>  <img src="images/docker39.jpg" alt=""></p>
<h3 id="云平台部署"><a href="#云平台部署" class="headerlink" title="云平台部署"></a>云平台部署</h3>
      
    </main>
    <footer class="post-footer">
      
    </footer>
  </article>
  
  <article class="index-post card" itemscope itemtype="http://schema.org/Article">
    <div class="post-block">
      <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/26/concurrencyPlan/concurrency_plan/">
      <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
        <meta itemprop="name" content="龙门小左">
        <meta itemprop="description" content="">
        <meta itemprop="image" content="/images/avatar.png">
      </span>
      <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
        <meta itemprop="name" content="程序猿的日常">
      </span>
    </div>
    <header class="post-header">
      <h1 class="post-title" itemprop="name headline">
        <a class="post-title-link post-title-link-external" href="/2018/06/26/concurrencyPlan/concurrency_plan/" itemprop="url">JAVA并发编程与高并发解决方案 - 高并发解决方案</a>
      </h1>
      <div class="post-meta">
        
        <span class="post-date">
          <i class="far fa-calendar-plus"></i><span><time title="post-date" itemprop="dateCreated datePublished" datetime="2018-06-26T10:00:00+08:00">2018-06-26 10:00:00</time></span>
        </span>
        
        
        
      </div>
    </header>
    <main class="post-main" itemprop="articleBody">
      
      <h1 id="JAVA并发编程与高并发解决方案-高并发解决方案"><a href="#JAVA并发编程与高并发解决方案-高并发解决方案" class="headerlink" title="JAVA并发编程与高并发解决方案 - 高并发解决方案"></a>JAVA并发编程与高并发解决方案 - 高并发解决方案</h1><table>
<thead>
<tr>
<th style="text-align:center">版本</th>
<th style="text-align:center">作者</th>
<th style="text-align:center">内容</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">2018.06.26</td>
<td style="text-align:center">huangzuo</td>
<td style="text-align:center">首次发布</td>
</tr>
</tbody>
</table>
<h2 id="学习内容简介"><a href="#学习内容简介" class="headerlink" title="学习内容简介"></a>学习内容简介</h2><pre><code>本章节主要大概介绍了高并发环境下主要处理思路和手段，能够应对何种高并发环境使用什么样的思路和手段方法。主要思路和手段方法有下面几种:
1.扩容、
2.缓存、
3.队列、
4.拆分、
5.服务降级与熔断、
6.数据库切库、
7.分库分表 etc.
</code></pre><p><em>Jimin</em> <a href="https://www.imooc.com/t/5980627#Article" target="_blank" rel="noopener">https://www.imooc.com/t/5980627#Article</a>  手记</p>
<hr>
<h3 id="扩容"><a href="#扩容" class="headerlink" title="扩容"></a>扩容</h3><p>  垂直扩容(纵向扩展):提高系统部件能力。对单个服务器，提高cpu速度或者增加内存、存储空间等。但单个服务器扩容能力是有限</p>
<p>  水平扩容(横向扩容)：增加服务器</p>
<hr>
<h3 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h3><p>服务器和数据库的资源是有限的，如何使用有限的资源支持更多的吞吐量，一个有效的方法是使用缓存，下面四个环节都可以使用缓存中的数据，从而减少对服务器的访问和计算量，提高并发量</p>
<p>用户通过浏览器访问网站，主要路径有:下面图四个节点，每个节点都有缓存，这里只是描述服务端和数据库的缓存<br><img src="images/19.jpg" alt=""></p>
<h4 id="缓存特征"><a href="#缓存特征" class="headerlink" title="缓存特征"></a>缓存特征</h4><p>缓存数据是从数据库中取的部分数据，缓存中的数据是有限，并有时间等限制，还要保持缓存中的数据和数据库中数据的一致性，所以不得不关注缓存中的一些特征</p>
<p>1、命中数:在缓存中能查到数据，不用到数据库查找</p>
<p>2、没有命中数:在缓存中查不到到数据，要到数据库查找，可能是因为缓存中根本不存在或者过期等</p>
<p>3、命中率:命中数/(命中数+没有命中数)</p>
<p>  命中率越高表示使用缓存的收益越高， 应用性能越好，响应的时间越短，吞吐量会变得越高，抗并发的能力也越强，在高并发的互联网环境中，缓存命中率至关重要</p>
<p>4、最大元素(空间):代表着缓存可以存放最大元素的数量，一旦缓存中元素数量超过这个值，缓存中的数据超过了支持最大的空间，将会触发缓存清空策略，根据不同的场景设置合理的最大值，能提高缓存命中率</p>
<p>当最大空间值用满，如何保证在稳定服务同时，提高命中率</p>
<p>5、清空策略</p>
<pre><code>FIFO:先进先出,在缓存最大空间值用满，根据创建时间，最先创建的缓存，会被清出去，在数据保持实时性环境下可以使用

LFU:最少使用策略，无论是否过期，根据最少用次数的数据被清空，在高频数据场景下使用

LRU:最近最少策略，无论是否过期，最近时间，最少用的被清空，在热点的时间环境下使用，保存热点的缓存

过期时间：设置过期时间清空策略

随机：随机策略etc
</code></pre><p>一般缓存清空策略使用LRU</p>
<h4 id="缓存命中率影响因素"><a href="#缓存命中率影响因素" class="headerlink" title="缓存命中率影响因素"></a>缓存命中率影响因素</h4><pre><code>1、业务场景和业务需求：写少读多业务场景，实时性要求越低，越适合缓存，缓存时间越长，命中率越高，互联网大多数应用都适合缓存

2、缓存的设计(粒度和策略):粒度越小缓存命中率越高，粒度:数据类型-单个对象或者集合，缓存单个对象命中率比集合高，缓存的更新策略影响命中率，当数据发生变化时，直接更新数据比移徐和让缓存过期命中率更高，系统复杂度会变得更高

3、缓存容量和基础设施:缓存容量越高，命中率越高，分布式缓存比单个应用内置缓存命中率高，考虑系统容量规划、是否扩展，不同中间件和框架效率和稳定性存在差异

4、当缓存发生故障时，需要避免缓存失效，并最大程度降低影响，通过一致性hash算法或者节点冗余提高高可用避免这个问题

4、并发越高，缓存的命中率就越高
</code></pre><h4 id="提高缓存命中率"><a href="#提高缓存命中率" class="headerlink" title="提高缓存命中率"></a>提高缓存命中率</h4><p>  从架构师的角度，应用尽可能通过缓存获取数据，并避免缓存失效，需要从业务需求，缓存粒度，缓存策略，技术选型各个方面综合考虑权衡。尽可能高频访问，时效要求不高的热点任务</p>
<h4 id="缓存分类和应用场景"><a href="#缓存分类和应用场景" class="headerlink" title="缓存分类和应用场景"></a>缓存分类和应用场景</h4><pre><code>本地缓存:应用中的缓存组件，编程实现(成员变量，局部变量，静态变量) Guava Cache
      优点：应用和cache在同一个进程内部，请求缓存非常快速，没有过多的网络开销，在单应用中不需要集群支持下、无需互相通知情况下，使用本地缓存比较合适
      缺点：多个应用无法共享缓存，各节点都需要维护单独的缓存，对内存是一种浪费

分布式缓存：Memcache 、redis
</code></pre><h4 id="高并发场景下缓存常见的问题"><a href="#高并发场景下缓存常见的问题" class="headerlink" title="高并发场景下缓存常见的问题"></a>高并发场景下缓存常见的问题</h4><h5 id="缓存一致性"><a href="#缓存一致性" class="headerlink" title="缓存一致性"></a>缓存一致性</h5><p>   当数据时效很高的场景下，需要保证缓存中的数据和数据库的数据一致性、缓存节点和副本保持一致性，不能出现差异现象，比较依赖缓存的过期和更新策略，数据库数据发生更改主动更新缓存中的数，或者移徐对应的缓存，这时候可能出现缓存问题<br><img src="images/24.png" alt=""></p>
<h5 id="缓存并发问题"><a href="#缓存并发问题" class="headerlink" title="缓存并发问题"></a>缓存并发问题</h5><p>缓存过期后，将尝试从后台数据库获取数据，在高并发场景下有可能多个请求并发去从数据库获取数据，对数据库造成极大的冲击，甚至导致雪崩的现象。当缓存某个key在被更新时，同时也可能大量被获取，导致数据一致性</p>
<p>解决方式:锁的机制，在缓存更新或过期的场景下，先尝试获取锁，获取数据库的数据，其他的请求只需要等待一点时间<br><img src="images/25.png" alt=""></p>
<h5 id="缓存穿透-击穿-问题"><a href="#缓存穿透-击穿-问题" class="headerlink" title="缓存穿透(击穿)问题"></a>缓存穿透(击穿)问题</h5><p>在高并发场景下，如果缓存中的某个key，被高并发的访问，没有命中，出于对容错性考虑，会尝试从后端数据库获取数据，导致大量的请求到达数据库，而当该key对应的数据为空的情况下，导致数据库产生很多不必要的查询操作，从而导致了巨大的冲击和压力</p>
<p>避免这种情况:</p>
<pre><code>1、缓存空对象、或者空集合，避免请求穿透到后台，同时也要保持时效性，这个适合命中率不高，但可能被频繁访问的数据

2、单独过滤处理，对所有可能对应数据为空的key进行统一的存放，在请求前统一拦截，这样避免请求穿透到后台数据库，比较适合命中率不高，但是更新不频繁的数据
</code></pre><p><img src="images/26.png" alt=""></p>
<h5 id="缓存的雪崩现象"><a href="#缓存的雪崩现象" class="headerlink" title="缓存的雪崩现象"></a>缓存的雪崩现象</h5><p>缓存颠簸问题：比雪崩更轻微的故障，但是在一段时间内，对系统也会造成冲击和性能影响，一般由于缓存节点故障导致，解决方法：通过一致性hash算法</p>
<p>缓存雪崩现象:由于缓存原因，导致大量请求到达后台数据库，从而导致数据库发生崩溃、系统发生崩溃</p>
<p>原因：缓存并发、缓存穿透、恶意攻击等。某个时间点内，系统预加载的缓存，周期性集中失效也有可能导致雪崩</p>
<p>解决方式:要设置不同的缓存过期时间，避免缓存集中失效。通过限流，降级，熔断等手段降低影响，通过多级缓存避免这种雪崩灾难，多加强压力测试，尽早发现问题</p>
<p><img src="images/27.png" alt=""></p>
<hr>
<h3 id="队列"><a href="#队列" class="headerlink" title="队列"></a>队列</h3><p>高并发之消息队列，企业IT系统内部通讯手段<br><img src="images/plan2.jpg" alt=""></p>
<p>短信发送场景：开始发送短信请求流程A-发送消息A1到队列-消息A1被处理-反馈消息A1处理结果到数据库。消息队列中可以设置发送短信速度和发送失败重发机制等,</p>
<p>好处:</p>
<pre><code>* 异步解耦，短信发送过程不需要关注，直接执行发送短信之后的事情

* 保持最终一致性，保证最终发送给用户，只是不是那么及时

* 假如发送完成短信还要发送邮件。有消息队列,不需要同步等待，直接并行处理，让核心流程更快结束,增强业务系统异步处理能力，减少甚至机乎不可能出现的并发现象
</code></pre><p><img src="images/plan1.jpg" alt=""></p>
<h4 id="消息队列的特性"><a href="#消息队列的特性" class="headerlink" title="消息队列的特性"></a>消息队列的特性</h4><ul>
<li><p>业务无关：不需要考虑上层业务模型，只做消息分发，上层不同业务模块反而要依赖消息队列定义的规范进行通信</p>
</li>
<li><p>FIFO:先投递先到达</p>
</li>
<li><p>容灾：节点的动态增删和消息的持久化</p>
</li>
<li><p>性能方面：吞吐量提升，系统内部通讯效率提高</p>
</li>
</ul>
<h4 id="为什么需要消息队列"><a href="#为什么需要消息队列" class="headerlink" title="为什么需要消息队列"></a>为什么需要消息队列</h4><ul>
<li>生成和消费的速度或稳定性等因素不一致。例如:业务系统触发发送短信的申请，但是短信发送模块速度跟不上，需要将来不及处理的消息暂存在队列里面，缓存压力，，消息发送模块就可以慢慢从消息队列里获取消息进行处理</li>
</ul>
<h4 id="消息队列的好处"><a href="#消息队列的好处" class="headerlink" title="消息队列的好处"></a>消息队列的好处</h4><ul>
<li><p>业务解耦：最本质问题，一个事物只关心核心流程，需要依赖其他系统但不是那么重要事情，有通知即可，不需要等待结果。基于消息模型关心通知，不是处理</p>
</li>
<li><p>最终一致性：俩个系统状态保持最终一致性，要么成功，要么失败，一定的延迟达到最终一致性。成功、失败、不确定</p>
</li>
<li><p>广播:只关心把消息发送到队列，每当有新的业务方接入，只需要接入到队列，不需要重新调试，接入方自己处理即可</p>
</li>
<li><p>错峰与流控: 转储俩个系统之间通讯的内容，等下游系统有能力处理这些消息，再处理消息，比如:大量用户访问网站请求，数据库一时处理不来那么多请求，可先把数据缓存在消息队列</p>
</li>
</ul>
<h4 id="消息队列场景"><a href="#消息队列场景" class="headerlink" title="消息队列场景"></a>消息队列场景</h4><ul>
<li><p>消息队列不是万能的，对于需要强事物保证、而且延迟很敏感的，RPC远程调用优于消息队列</p>
</li>
<li><p>对于一些无关痛痒，对于别人很重要，对自己不是那么关心的事情，可以使用消息队列</p>
</li>
<li><p>支持最终一致性的消息队列能够用来处理延迟不那么敏感的分布式事物场景</p>
</li>
<li><p>上下游系统处理能力存在差距的时候，利用消息队列做通用的漏斗，在下游有能力处理的时候，再进行分发，同时如果下游有很多系统关心上游发出的消息,使用消息队列的广播</p>
</li>
</ul>
<h4 id="队列-kafka"><a href="#队列-kafka" class="headerlink" title="队列-kafka"></a>队列-kafka</h4><p><img src="images/28.png" alt="kafka"><br>kafka：高性能、跨语言、分布式发布订阅消息队列系统</p>
<p>特性:</p>
<ul>
<li>快速持久化</li>
<li>高吞吐</li>
<li>分布式</li>
</ul>
<p>定义</p>
<pre><code>broker：集群上一个或者多个服务器，服务器称为broker

topic:每条发布到kafka集群消息都有一个类别，这个类别就是topic，物理上不同topic消息是分开存储，一个topic逻辑上保存在一个或多个broker上，但用户只需指定topic就可以生产消费数据，不关心数据存储在那里

partition:物理上的概念，每一个topic包含一个或者多个partition

producer:负责向kafka集群发送消息

comsumer:负责消费kafka集群的消息

comsumer-group:多个comsumer属于一个comsumer-group
</code></pre><p>流程：producer 根据partition算法，将消息发布到指定的partition上面，kafka集群接受到producer发过来的消息之后，将消息持久化到硬盘，并保留消息指定时长，producer不关心消息是否消费，comsumer从kafka集群获取数据，并控制消息的offset(0,1,2) ，comsumer每消费一个消息offset加一，comsumer能控制offset，消息的状态是由comsumer控制，comsumer可以跟踪、重设offset值,comsumer可以任意读取不同offset位置的值</p>
<h4 id="队列-RabbitMQ"><a href="#队列-RabbitMQ" class="headerlink" title="队列-RabbitMQ"></a>队列-RabbitMQ</h4><p><img src="images/plan3.jpg" alt="RabbitMQ"><br>定义</p>
<pre><code>l、Exchange:消息先发到Exchange，处理完决定怎样，发送到Queue，Exchange和Queue是多对多关系
2、Client(producer)发送消息到Exchange
3、Queue:消息队列，Exchange发送消息到Queue
4、Client(cosumer)从Queue消费消息
</code></pre><hr>
<h3 id="应用拆分"><a href="#应用拆分" class="headerlink" title="应用拆分"></a>应用拆分</h3><p>单个服务器再优化，处理能力是有上限的，将一个应用拆分成多个系统应用，多部署几台服务器</p>
<p>比如股票系统：用户信息、开户、股票、行情、交易、订单…用户不同时间段访问的功能频率差别很大，拆分如下几个系统-交易中心、账户中心、用户中心、行情中心、通知中心</p>
<p><img src="images/plan4.jpg" alt="应用拆分"></p>
<h4 id="应用拆分基本原则"><a href="#应用拆分基本原则" class="headerlink" title="应用拆分基本原则"></a>应用拆分基本原则</h4><pre><code>业务优先:每个系统都会安装业务分成多个模块，每个模块有包含多个业务相关的功能，在系统拆分时，优先考虑按照业务边界拆分

循序渐进:边拆分边测试

兼顾技术：重构、分层

可靠测试
</code></pre><h4 id="应用拆分思考"><a href="#应用拆分思考" class="headerlink" title="应用拆分思考"></a>应用拆分思考</h4><pre><code>1、应用之间的通信:RPC（dubbo等）、消息队列、restful

2、应用之间数据库设计:每个应用都有独立的数据库，共同的数据可以放到common数据库中

3、避免事务操作跨应用，分布式事务消耗资源，尽量避免事务操作，降低应用之间的耦合度，应用之间要互不影响
</code></pre><h4 id="应用拆分组件"><a href="#应用拆分组件" class="headerlink" title="应用拆分组件"></a>应用拆分组件</h4><h5 id="服务化Dubbo"><a href="#服务化Dubbo" class="headerlink" title="服务化Dubbo"></a>服务化Dubbo</h5><p><img src="images/29.png" alt="Dubbo"></p>
<pre><code>流程:
1、初始化:provider-start启动，通过register向registry注册服务(zookeeper)，consumer -subscribe向registry中心订阅服务，不断尝试订阅直到订阅到服务，provider对于consumer是透明的，consumer多次请求相同的服务，可能由不同的provider提供,实现了软负载
2、producer 注册了新的服务，通过notify通知到consumer

3、monitor:通过异步监控，可选，需要单独配置，不影响服务调用

4、consumer通过invoke调用producer接口
</code></pre><h5 id="微服务"><a href="#微服务" class="headerlink" title="微服务"></a>微服务</h5><p><img src="images/plan5.jpg" alt="微服务"></p>
<pre><code>微服务是架构概念，将功能分解在各个离散的服务中，以实现对解决方案的解耦，并提供更加灵活服务支持，微服务把一个大型单个应用程序和服务拆分成数个甚至数十个支持的微服务，可扩展单个组件，而不是整个应用程序堆栈从而满足服务等级协议，微服务是围绕业务领域组件创建应用，这些应用可以独立开发、管理、迭代，在分摊的组件中使用云架构和平台部署和管理服务，使产品交付变得更加简单，微服务使用功能比较明确、业务比较精炼的服务解决更大更实际的问题
</code></pre><p><img src="images/30.png" alt="微服务"></p>
<pre><code>微服务:独立的服务共同组成整个系统，每个服务单独部署，每个服务跑在自己的进程中，每个服务为独立业务开发，分布式管理，非常强调隔离性
</code></pre><h5 id="微服务标准"><a href="#微服务标准" class="headerlink" title="微服务标准"></a>微服务标准</h5><pre><code>1、分布式服务组成的系统

2、按照业务而不是技术划分组织

3、有生命的产品而不是项目

4、强服务个体，弱通信

5、自动化运维

6、高度容错

7、可以快速演化、迭代
</code></pre><h5 id="微服务要解决的问题"><a href="#微服务要解决的问题" class="headerlink" title="微服务要解决的问题"></a>微服务要解决的问题</h5><pre><code>1、客户端如何访问不同的服务？按功能拆分成独立服务，跑在独立的虚拟机上，是独立的java进程，客户端如何去访问，后台n多个服务?API Gateway 代理统一提供服务入口,让微服务对前台透明，同时可以聚合后台服务，提供安全、过滤、流控api等管理功能

2、每个服务之间如何通信？

  异步:消息队列(kafka)

  同步:一致性强，容易出现一些调用问题，特别是调用层次多的时候，有俩种同步方法：RPC、rest
  RPC-比如dubbo，传输协议更高效，安全更可控，特别在一个公司内部，如果有统一的开发规范和统一的服务框架，开发效率就会更加明显
  rest-比如spring boot,一般rest基于http更容易实现也更容易被接受，服务端实现技术也更灵活些，各个语言也能支持，同时能跨客户端，对客户端没有特殊要求，主要封装了http的apk就能调用，所以使用相对广些

3、如此多的服务如何实现？在微服务架构中，一般每个服务都是有多个拷贝作为负载均衡，一个服务可能随时下线，也可能应对临时增加访问的压力，临时增加新的服务节点，服务之间如何感知，如何管理，这是服务发现的问题，基本上是通过zookeeper等类似技术做注册等信息分布式管理，服务上线时，将自己的信息注册到zookeeper上，通过心跳维持常连接，实时更新那些信息，服务调用者通过zookeeper寻址，根据定制的算法，找到服务，还可以将服务的信息缓存在本地，提高性能，当服务发现时，zookeeper会通知服务客户端

4、服务挂了，怎么办？分布式网络是不可靠的，通过微服务拆分能降低风险，不过没有特别的保证，结局是很惨，相关手段:重试机制、应用的限流、熔断机制、负载均衡、系统降级等
</code></pre><hr>
<h3 id="应用限流"><a href="#应用限流" class="headerlink" title="应用限流"></a>应用限流</h3><p><img src="images/31.png" alt="应用限流"><br>限制一段时间内的应用流量，控制某段时间内某段代码被执行的次数</p>
<p>比如某段时间突然有130w~140w 的数据插入到数据库导致的后果</p>
<pre><code>1、网络的开销，很可能直接把带宽打满，导致其他请求无法正常传输和处理

2、数据库负载突然增高，导致无法处理某些数据库操作，也可能出现没有足够的连接，导致某些数据插入失败或者查询失败

3、数据库做了主从设计，插入到主库的数据还要同步到从库数据，这时瞬间插入大量的数据，会导致主库和从库延迟特别大，这时通过从库查询到的数据不准确的概率也会跟着提升
</code></pre><p>通过特殊的手段限流放慢插入数据库的手段，会怎么样？？<br>比如：以恒定的速率，每秒400条速率插入主库，正常同步</p>
<h4 id="限流"><a href="#限流" class="headerlink" title="限流"></a>限流</h4><pre><code>1、限制总并发数
2、限制瞬时的并发数
3、限制时间窗口内的平均速率etc
</code></pre><h4 id="限流的算法"><a href="#限流的算法" class="headerlink" title="限流的算法:"></a>限流的算法:</h4><ul>
<li>计算器法<br>对应A接口，每一分钟访问的次数不能超过100次</li>
</ul>
<p><img src="images/32.png" alt="应用限流"></p>
<p>问题:只是限制0~1、1~2访问100次，出现了边界问题，比如0:59~1:01之间次数出现可能超过100次</p>
<p><img src="images/plan6.jpg" alt="限流"></p>
<ul>
<li><p>滑动窗口法</p>
<p>滑动窗口法是计算器法进化，0~1分为小6格，每格10秒钟，每过完一格，0~1向前滑动一小格，每次都会计算当前格和已经执行的5格次数总数是否超过100次，一直在向前面滑动。当前的10秒钟的访问的次数和已经访问的50秒钟的访问的次数加起来不能超过100次<br><img src="images/33.png" alt="应用限流"></p>
</li>
<li><p>漏桶算法<br><img src="images/34.png" alt="应用限流"><br>无法预计桶留进来的水有多少，也不法预计留进来的水速度有多快，但是可以控制流出去的水的速率，桶满以后多余的水会溢出去，漏桶算法限制了请求的速度，使用漏桶算法，可以保证接口会以一个恒定的速率来处理请求</p>
</li>
<li><p>令牌桶算法<br><img src="images/35.png" alt="应用限流"></p>
</li>
</ul>
<p>固定容量的桶，桶里面放着令牌，桶一开始是空的，令牌以一定的速率往桶里面填充，知道达到桶的容量，多余的令牌会被丢弃掉，当一个请求过来，会从桶里面移除一个令牌，如果没有令牌请求无法通过，有令牌请求就可以继续执行。允许流量的突发，下次突发，需要填充满桶</p>
<hr>
<h3 id="服务降级与熔断"><a href="#服务降级与熔断" class="headerlink" title="服务降级与熔断"></a>服务降级与熔断</h3><h4 id="服务降级"><a href="#服务降级" class="headerlink" title="服务降级"></a>服务降级</h4><pre><code>比如:12306抢票，在抢票高峰的时候，明明票还有，但是查询出来的列表确是空的，等高峰过后，再来查询列表恢复正常。高峰查询过程中出现的问题，要么超时、要么网络问题导致查询失败，这里很可能采用了服务降级处理，呈现给用户的并不是系统内部出错提示而是空的列表

服务降级含义:当服务器压力巨增的时候，根据当前业务情况及流量，对一些服务、页面有策略的降级，以处缓解服务器资源的压力，以保障核心任务正常运行，同时也保障了部分甚至大部分客户得到正确的响应。服务降级技术上来说是：如果当前请求处理不了或者出错，给一个默认的返回。整体资源不够了，忍痛将某些服务关闭，等度过高峰期再开启
</code></pre><p>服务降级分类</p>
<ul>
<li><p>自动降级:超时、失败数次、故障、限流</p>
<pre><code>超时:配置好超时时间和超时重制次数机制，并使用异步机制探测恢复情况
失败次数：一些不稳定的API，当失败调用的次数达到一定的值之后，自动降级，同样使用异步机制探测恢复情况
故障:比如远程服务挂掉了，可能是网络故障、DNS故障、http服务返回错误状态码，RPC返回抛出异常等，这时服务直接降级
限流：当访问量达到限制点的时候，后续访问会被降级，返回的信息可以是,排队页面\无货、错误页等等
</code></pre></li>
</ul>
<ul>
<li><p>人工降级:秒杀、双11大促等</p>
<pre><code>手动设置，将某些服务降级，以保障在某段时间内系统核心服务的正常运行，通常在代码里面做开关控制
</code></pre></li>
</ul>
<p>服务降级的处理方案:</p>
<pre><code>默认值：比如库存服务挂了，返回默认现货
兜底数据：广告挂了，返回提前准备的静态页面
缓存:一般使用之前暂时缓存的数据
</code></pre><h4 id="服务熔断"><a href="#服务熔断" class="headerlink" title="服务熔断"></a>服务熔断</h4><pre><code>软件系统由于某些原因，使得服务出现过载的现象，为了防止造成整个系统故障，从而采用一种保护策施，可称为过载保护   
</code></pre><h4 id="服务降级和服务熔断"><a href="#服务降级和服务熔断" class="headerlink" title="服务降级和服务熔断"></a>服务降级和服务熔断</h4><p>共性:目的、最终表现、粒度、自治</p>
<p>区别:</p>
<pre><code>触发原因:服务熔断-指某个服务特别是下游服务发生故障引起的。服务降级-整体负荷考虑的
管理目标层次:熔断-框架级别的处理，每个微服务都需要，降级-需要对业务有层级之分，都是从最外围开始的
实现方式:服务熔断是服务降级的一种实现
</code></pre><h4 id="服务降级要考虑的问题"><a href="#服务降级要考虑的问题" class="headerlink" title="服务降级要考虑的问题"></a>服务降级要考虑的问题</h4><ul>
<li><p>那些服务是核心服务，那些服务是非核心服务</p>
</li>
<li><p>那些服务是否支持降级、降级策略</p>
</li>
<li><p>业务放通场景、策略</p>
</li>
</ul>
<h4 id="Hystric-类帮助服务降级、熔断"><a href="#Hystric-类帮助服务降级、熔断" class="headerlink" title="Hystric 类帮助服务降级、熔断"></a>Hystric 类帮助服务降级、熔断</h4><ul>
<li><p>提供失败回退(Fallback)和优雅的服务降级机制</p>
</li>
<li><p>提供近实时的监控、报警和运维控制手段</p>
</li>
</ul>
<p><img src="images/plan7.jpg" alt="应用限流"></p>
<p> 在分布式系统中，外部用户发起请求访问服务器，服务依赖第三方资源，由于第三方发生故障，导致请求发生问题，我们避免不了导致调用第三方失败的原因，但我们尽可能避免调用第三方依赖失败造成的影响，提前做好应急措施，遇到问题可以及时启动应急预案，让系统自我调节。如果不能及时有效隔离有问题第三方依赖，因为这个单点故障而阻塞，产生雪崩的效益，整个应用服务器将不能正常对外提供服务</p>
<hr>
<h3 id="数据库切库、分库、分表"><a href="#数据库切库、分库、分表" class="headerlink" title="数据库切库、分库、分表"></a>数据库切库、分库、分表</h3><p>数据库瓶颈</p>
<pre><code>1、单个库数据量太大(1T~2T)：多个库
2、单个数据库服务器压力过大、读写速度瓶颈：多个库、读写分离
3、单个表数据量过大：分表，大表拆分多个小表
</code></pre><h4 id="数据库切库"><a href="#数据库切库" class="headerlink" title="数据库切库"></a>数据库切库</h4><pre><code>大多数采用读写分离技术，一个主库多个从库，主库负责数据更新、实时查询，从库负责非实时数据查询，实际数据库都是读多、写少，读取数据通常耗时比较长，占用CPU比较多,多个从库采取负载均衡，有效减轻主库的压力，把数据分发到从库可保持系统的健壮性
</code></pre><h5 id="如何方便使读写分离"><a href="#如何方便使读写分离" class="headerlink" title="如何方便使读写分离"></a>如何方便使读写分离</h5><p>直接定义多个数据库连接</p>
<pre><code>1、动态数据源切换-切库，在程序运行时，把数据源植入到程序中，让指定的程序选择连接主库还是从库操作，主要技术：spring aop 、注解等

2、自定义注解完成数据库切库-代码实现，网址 https://www.imooc.com/article/22556
</code></pre><h5 id="数据库支持多个数据源与分库"><a href="#数据库支持多个数据源与分库" class="headerlink" title="数据库支持多个数据源与分库"></a>数据库支持多个数据源与分库</h5><p>共同点:底层多个数据库提供服务</p>
<p>不同点：</p>
<pre><code>分库：在应用拆分时，每个应用对应一个数据库
多个数据源:一个应用对应多个数据库
</code></pre><p>多个数据源的轻松支持手记:<a href="https://www.imooc.com/article/22609" target="_blank" rel="noopener">https://www.imooc.com/article/22609</a></p>
<hr>
<h3 id="数据库分表"><a href="#数据库分表" class="headerlink" title="数据库分表"></a>数据库分表</h3><p>什么时候考虑分表：当一个表数据量很大，大到我们做了sql优化、索引，基本的操作速度慢到影响使用，要预先考虑分表</p>
<p>分表好处:</p>
<pre><code>1、分表后，单表的并发能力提高了，磁盘IO性能也提高了，写操作效率也会跟着提高
2、查询一次时间变短，数据发布在不同文件，磁盘IO性能会跟着提高，同时读写锁影响的数据量变少，，插入数据库数据需要重新建立的索引的数据变少
</code></pre><h4 id="分表策略"><a href="#分表策略" class="headerlink" title="分表策略"></a>分表策略</h4><p> 横向(水平)分表与纵向（垂直）分表</p>
<ul>
<li><p>横向(水平)分表</p>
<p>  把大的表结构横向切割为同样结构的不同的表，表结构是完成一样根据某些规则划分表的数据，比如根据id\表数量 取模把数据平均划分到不同的表上</p>
</li>
</ul>
<ul>
<li><p>纵向（垂直）分表</p>
<pre><code>将本来可以在一张表的内容，人为划分为多个不同的表，通常根据数据的活跃度进行分离，因为不同活跃的数据，处理方式是不同的
</code></pre></li>
</ul>
<h4 id="数据库分表-mybatis-分表插件-shardbatis2-0-手记"><a href="#数据库分表-mybatis-分表插件-shardbatis2-0-手记" class="headerlink" title="数据库分表:mybatis 分表插件 shardbatis2.0-手记"></a>数据库分表:mybatis 分表插件 shardbatis2.0-手记</h4><h3 id="高可用一些手段"><a href="#高可用一些手段" class="headerlink" title="高可用一些手段"></a>高可用一些手段</h3><ul>
<li><p>任务调度系统分布式：elastic-job+zookeeper,无中心化的分布式定时调度框架，基于数据库高可用方案，数据库没有分布式协调功能</p>
</li>
<li><p>主备切换：apache curator+zookeeper 分布式锁实现</p>
</li>
<li><p>监控报警机制-看手记</p>
</li>
</ul>

      
    </main>
    <footer class="post-footer">
      
    </footer>
  </article>
  
  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fas fa-angle-right"></i></a>
  </nav>
  
  
</div>

          </div>
          
          
          
<aside class="sidebar" id="sidebar" style="background: url(/images/sidebar_background.png);">
  
  <div class="search">
    <div class="form-group">
      <i class="fas fa-search"></i><input type="search" id="search-input" name="q" results="0" placeholder="搜索" class="form-control"/>
    </div>
  </div>
  <div class="search-result-box" id="search-result"></div>
  
  
<div class="info sidebar-item" id="info">
  
  <img class="author-avatar" src="/images/avatar.png" alt="龙门小左">
  
  <h1 class="author-name">龙门小左</h1>
  <h2 class="author-description"> </h2>
  <div class="site-count">
    
    <div class="archives-count">
      <div class="site-count-title">歸檔</div>
      <div><a href="/archives/">20</a></div>
    </div>
    
    
    
  </div>
  
  <div class="rss">
    <a class="rss-link button sidebar-item" href="/atom.xml"><i class="fas fa-rss"></i>RSS</a>
  </div>
  
</div>


  <div class="sidebar-sticky">
    
    
    
<hr>
<div class="social-link sidebar-item">
  <div><i class="far fa-address-card"></i>社交鏈接</p></div>
  <ul>
    
    <li><i class="fas fa-envelope"></i><a href="mailto:youremail@youremailhost" target="_blank">E-Mail</a></li>
    
    <li><i class="fab fa-github"></i><a href="https://github.com/" target="_blank">GitHub</a></li>
    
    <li><i class="fab fa-weibo"></i><a href="https://weibo.com/" target="_blank">Weibo</a></li>
    
  </ul>
</div>


    
    
    
<hr>
<div class="blogroll sidebar-item">
  <div><i class="fas fa-link"></i>友情鏈接</div>
  <ul>
    
    <li><a href="https://github.com/" target="_blank">GitHub</a></li>
    
    <li><a href="https://developer.mozilla.org/" target="_blank">MDN</a></li>
    
    <li><a href="https://mozilla.github.io/nunjucks/" target="_blank">Nunjucks</a></li>
    
  </ul>
</div>


    
  </div>
</aside>


          
        </div>
      </div>
    </main>
    
<footer id="footer" class="footer" style="background: #33363b;">
  <div class="container">
    <div class="back-to-top">
      <a id="back-to-top"><i class="fas fa-angle-double-up"></i></a>
    </div>
    <div class="footer-container">
      <div class="footer-left">
        <div class="copyright">
          <span class="author">龙门小左</span><span class="year"><i class="far fa-copyright"></i>2018</span>
        </div>
        
        
<div class="busuanzi">
  <span id="busuanzi_container_site_pv"><i class="fas fa-eye"></i><span id="busuanzi_value_site_pv"></span></span><span id="busuanzi_container_site_uv"><i class="fas fa-user"></i><span id="busuanzi_value_site_uv"></span></span><span id="busuanzi_container_page_pv"><i class="far fa-file-alt"></i><span id="busuanzi_value_page_pv"></span></span>
</div>


        
      </div>
      <div class="footer-right">
        <div class="custom-info">
          
          托管于<i class="fab fa-github-alt"></i><a href="https://pages.github.com/" target="_blank">GitHub Pages</a>
          
        </div>
        <div class="powered-by">
          由 <a href="https://hexo.io/" target="_blank">Hexo</a> 強力驅動 | 主題 <a href="https://github.com/AlynxZhou/hexo-theme-aria/" target="_blank">ARIA</a>
        </div>
      </div>
    </div>
  </div>
</footer>


  </body>
</html>
